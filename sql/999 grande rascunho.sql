SELECT
  l.ORDEM_PRODUCAO OP
, count(DISTINCT NUMERO_ORDEM) OS
FROM pcpc_040 l
--WHERE l.NUMERO_ORDEM = 134
GROUP BY
  l.ORDEM_PRODUCAO
;

SELECT
  l.NUMERO_ORDEM OS
, count(l.ORDEM_CONFECCAO) LOTES
, sum(l.QTDE_PECAS_PROG) QTD
FROM pcpc_040 l
WHERE l.ORDEM_PRODUCAO = 309
  AND l.NUMERO_ORDEM <> 0
GROUP BY
  l.NUMERO_ORDEM
ORDER BY
  l.NUMERO_ORDEM
;

SELECT
  l.NUMERO_ORDEM OS
, count(DISTINCT l.ORDEM_PRODUCAO) OP
FROM pcpc_040 l
--WHERE l.NUMERO_ORDEM = 134
GROUP BY
  l.NUMERO_ORDEM
ORDER BY
  2 DESC
;

        SELECT
 		  l.ORDEM_PRODUCAO
        , CASE WHEN dos.NUMERO_ORDEM IS NULL
          THEN '0'
          ELSE l.NUMERO_ORDEM || ' (' || eos.DESCRICAO || ')'
          END OS
        , l.PROCONF_GRUPO REF
        , l.PROCONF_SUBGRUPO TAM
        , l.PROCONF_ITEM COR
        , COALESCE(
          ( SELECT
              LISTAGG(le.CODIGO_ESTAGIO || ' - ' || ed.DESCRICAO, ' & ')
              WITHIN GROUP (ORDER BY le.CODIGO_ESTAGIO)
            FROM PCPC_040 le
            JOIN MQOP_005 ed
              ON ed.CODIGO_ESTAGIO = le.CODIGO_ESTAGIO
            WHERE le.PERIODO_PRODUCAO = l.PERIODO_PRODUCAO
              AND le.ORDEM_CONFECCAO = l.ORDEM_CONFECCAO
              AND le.QTDE_EM_PRODUCAO_PACOTE <> 0
          )
          , 'FINALIZADO'
          ) EST
        , l.PERIODO_PRODUCAO PERIODO
        , l.ORDEM_CONFECCAO OC
        , l.QTDE_PROGRAMADA QTD
        FROM (
          SELECT
            os.PERIODO_PRODUCAO
          , os.ORDEM_CONFECCAO
          , os.PROCONF_GRUPO
          , os.PROCONF_SUBGRUPO
          , os.PROCONF_ITEM
          , os.ORDEM_PRODUCAO
          , max( os.NUMERO_ORDEM ) NUMERO_ORDEM
          , max( os.QTDE_PROGRAMADA ) QTDE_PROGRAMADA
          FROM PCPC_040 os
          WHERE 1=1
            --AND os.ORDEM_PRODUCAO = 288
            AND os.NUMERO_ORDEM = 238
          GROUP BY
            os.PERIODO_PRODUCAO
          , os.ORDEM_CONFECCAO
          , os.PROCONF_GRUPO
          , os.PROCONF_SUBGRUPO
          , os.PROCONF_ITEM
          , os.ORDEM_PRODUCAO
        ) l
        LEFT JOIN PCPC_040 dos
          ON l.NUMERO_ORDEM <> 0
         AND dos.PERIODO_PRODUCAO = l.PERIODO_PRODUCAO
         AND dos.ORDEM_CONFECCAO = l.ORDEM_CONFECCAO
         AND dos.NUMERO_ORDEM = l.NUMERO_ORDEM
        LEFT JOIN MQOP_005 eos
          ON eos.CODIGO_ESTAGIO = dos.CODIGO_ESTAGIO
        LEFT JOIN BASI_220 t
          ON t.TAMANHO_REF = l.PROCONF_SUBGRUPO
        ORDER BY
          l.ORDEM_PRODUCAO
        , l.NUMERO_ORDEM
        , l.PROCONF_GRUPO
        , l.PROCONF_ITEM
        , t.ORDEM_TAMANHO
        , l.PERIODO_PRODUCAO
        , l.ORDEM_CONFECCAO
;


        SELECT
          os.NUMERO_ORDEM OS
        , os.CODIGO_SERVICO || '-' || s.DESC_TERCEIRO SERV
        , os.CGCTERC_FORNE9 CNPJ9
        , os.CGCTERC_FORNE4 CNPJ4
        , os.CGCTERC_FORNE2 CNPJ2
        , f.NOME_FANTASIA NOME
        , CASE os.SITUACAO_ORDEM
          WHEN 1 THEN '1-Aberta'
          WHEN 2 THEN '2-Em Processo'
          WHEN 3 THEN '3-Baixa Parcial'
          WHEN 4 THEN '4-Baixa Total'
          ELSE '-'
          END SITUACAO
        , os.COD_CANC_ORDEM || '-' || c.DESCR_CANC_ORDEM CANC
        , count(l.ORDEM_CONFECCAO) LOTES
        , sum(l.QTDE_PECAS_PROG) QTD
        FROM OBRF_080 os
        JOIN OBRF_070 s
          ON s.CODIGO_TERCEIRO = os.CODIGO_SERVICO
        JOIN SUPR_010 f
          ON f.FORNECEDOR9 = os.CGCTERC_FORNE9
         AND f.FORNECEDOR4 = os.CGCTERC_FORNE4
        JOIN OBRF_087 c
          ON c.COD_CANC_ORDEM = os.COD_CANC_ORDEM
        JOIN pcpc_040 l
          ON l.NUMERO_ORDEM = os.NUMERO_ORDEM
        WHERE 1=1
          AND (os.NUMERO_ORDEM = 239 OR 0=0)
          AND (l.PERIODO_PRODUCAO = 1719 OR 0=0)
          AND (l.ORDEM_CONFECCAO = 03600 OR 0=0)
          AND (l.ORDEM_PRODUCAO = 120 OR 0=10)
          AND l.NUMERO_ORDEM <> 0
        GROUP BY
          os.NUMERO_ORDEM
        , os.CODIGO_SERVICO
        , s.DESC_TERCEIRO
        , os.CGCTERC_FORNE9
        , os.CGCTERC_FORNE4
        , os.CGCTERC_FORNE2
        , f.NOME_FANTASIA
        , os.SITUACAO_ORDEM
        , os.COD_CANC_ORDEM
        , c.DESCR_CANC_ORDEM
        ORDER BY
          os.NUMERO_ORDEM
;


        SELECT
          ll.EST
        , (SELECT
              cast( SUM( lp.QTDE_PECAS_PROD ) / SUM( lp.QTDE_PECAS_PROG ) * 100
                    AS NUMERIC(10,2) )
            FROM pcpc_040 lp
            WHERE lp.ORDEM_PRODUCAO = ll.ORDEM_PRODUCAO
              AND lp.SEQ_OPERACAO = ll.SEQ_OPERACAO
          ) PERC
        , (SELECT
              SUM( lp.QTDE_PECAS_PROD )
            FROM pcpc_040 lp
            WHERE lp.ORDEM_PRODUCAO = ll.ORDEM_PRODUCAO
              AND lp.SEQ_OPERACAO = ll.SEQ_OPERACAO
          ) PROD
        , (SELECT
              count(*)
            FROM pcpc_040 lp
            WHERE lp.ORDEM_PRODUCAO = ll.ORDEM_PRODUCAO
              AND lp.SEQ_OPERACAO = ll.SEQ_OPERACAO
              AND lp.QTDE_EM_PRODUCAO_PACOTE <> 0
          ) LOTES
        FROM
        (
        SELECT DISTINCT
          l.ORDEM_PRODUCAO
        , l.SEQ_OPERACAO
        , l.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO EST
        FROM pcpc_040 l
        JOIN MQOP_005 e
          ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
        WHERE l.ORDEM_PRODUCAO = 1046
        ORDER BY
          l.SEQ_OPERACAO
        ) ll
;


SELECT
  i.TAMANHO
, i.SORTIMENTO
, i.QUANTIDADE
, i.*
FROM PCPC_021 i
WHERE i.ORDEM_PRODUCAO = 1536
ORDER BY
  i.SEQUENCIA_TAMANHO
, i.SORTIMENTO
;

SELECT DISTINCT
  i.TAMANHO
, i.SEQUENCIA_TAMANHO
FROM PCPC_021 i
WHERE i.ORDEM_PRODUCAO = 1536
ORDER BY
  i.SEQUENCIA_TAMANHO
;

SELECT
  i.SORTIMENTO
, max( p.DESCRICAO_15 ) DESCR
FROM PCPC_021 i
JOIN pcpc_020 op
  ON op.ORDEM_PRODUCAO = i.ORDEM_PRODUCAO
LEFT JOIN basi_010 p
  ON p.NIVEL_ESTRUTURA = 1
 AND p.GRUPO_ESTRUTURA = op.REFERENCIA_PECA
 AND p.ITEM_ESTRUTURA = i.SORTIMENTO
WHERE i.ORDEM_PRODUCAO = 1536
GROUP BY
  i.SORTIMENTO
ORDER BY
  2
;

SELECT
  *
FROM BASI_010
;

UPDATE pcpc_040 l
SET
  l.NUMERO_ORDEM = 0
, l.SEQ_ORDEM_SERV = 0

SELECT DISTINCT
  l.ORDEM_PRODUCAO
, l.NUMERO_ORDEM
, l.SEQ_ORDEM_SERV
, l.PERIODO_PRODUCAO
, l.ORDEM_CONFECCAO
, l.*
FROM pcpc_040 l
WHERE 1=1
  --AND l.ORDEM_PRODUCAO = 297
  AND l.NUMERO_ORDEM = 595
  --AND l.CODIGO_ESTAGIO = 39
  AND l.PERIODO_PRODUCAO = 1727
  AND l.ORDEM_CONFECCAO IN (
    7900
  , 7814
  --, 4096
  )
  AND l.NUMERO_ORDEM <> 0
  AND l.SEQ_ORDEM_SERV <> 0
;

SELECT
  DISTINCT
  s.PRODSAI_NIVEL99
, s.PRODSAI_GRUPO
, s.PRODSAI_SUBGRUPO
, s.PRODSAI_ITEM
, s.*
FROM OBRF_082 s
WHERE s.NUMERO_ORDEM = 589
ORDER BY
  s.SEQUENCIA
, s.PRODSAI_NIVEL99
, s.PRODSAI_GRUPO
, s.PRODSAI_SUBGRUPO
, s.PRODSAI_ITEM
;

SELECT
  s.PRODORD_NIVEL99
, s.PRODORD_GRUPO
, s.PRODORD_SUBGRUPO
, s.PRODORD_ITEM
, s.*
FROM OBRF_081 s
WHERE s.NUMERO_ORDEM = 589
ORDER BY
  s.PRODORD_NIVEL99
, s.PRODORD_GRUPO
, s.PRODORD_SUBGRUPO
, s.PRODORD_ITEM
;

SELECT DISTINCT
  s.PRODORD_SUBGRUPO
, tam.ORDEM_TAMANHO
FROM OBRF_081 s
LEFT JOIN BASI_220 tam
  ON tam.TAMANHO_REF = s.PRODORD_SUBGRUPO
WHERE s.NUMERO_ORDEM = 589
ORDER BY
  tam.ORDEM_TAMANHO
;

SELECT
  s.PRODORD_GRUPO || ' - ' || s.PRODORD_ITEM SORTIMENTO
, s.PRODORD_GRUPO || ' - ' || s.PRODORD_ITEM || ' - ' || max( p.DESCRICAO_15 ) DESCR
FROM OBRF_081 s
LEFT JOIN basi_010 p
  ON p.NIVEL_ESTRUTURA = 1
 AND p.GRUPO_ESTRUTURA = s.PRODORD_GRUPO
 AND p.ITEM_ESTRUTURA = s.PRODORD_ITEM
WHERE s.NUMERO_ORDEM = 589
GROUP BY
  s.PRODORD_GRUPO
, s.PRODORD_ITEM
ORDER BY
  2
;

SELECT
  s.PRODORD_GRUPO || ' - ' || s.PRODORD_ITEM SORTIMENTO
, s.PRODORD_SUBGRUPO TAMANHO
, s.QTDE_ARECEBER QUANTIDADE
FROM OBRF_081 s
WHERE s.NUMERO_ORDEM = 463
ORDER BY
  s.PRODORD_NIVEL99
, s.PRODORD_GRUPO
, s.PRODORD_SUBGRUPO
, s.PRODORD_ITEM
;

SELECT
  os.NUMERO_ORDEM OS
, count(DISTINCT os.ORDEM_PRODUCAO) OP
FROM PCPC_040 os
GROUP BY
  os.NUMERO_ORDEM
ORDER BY
  2 DESC
;

        SELECT DISTINCT
          os.NUMERO_ORDEM OS
        , os.CODIGO_SERVICO
        , os.CGCTERC_FORNE9 CNPJ9
        , os.CGCTERC_FORNE4 CNPJ4
        , os.CGCTERC_FORNE2 CNPJ2
        , CASE os.SITUACAO_ORDEM
          WHEN 1 THEN '1-Aberta'
          WHEN 2 THEN '2-Em Processo'
          WHEN 3 THEN '3-Baixa Parcial'
          WHEN 4 THEN '4-Baixa Total'
          ELSE '-'
          END SITUACAO
        , os.COD_CANC_ORDEM
        , os.data_emissao
        , os.
        FROM OBRF_080 os
        WHERE os.NUMERO_ORDEM = 589
;

SELECT
  x.CODIGO_ROLO
, x.ORDEM_PRODUCAO
, x.ROLO_ESTOQUE
, x.*
FROM PCPT_020 x -- cadastro de rolos
WHERE 1=1
  AND x.PANOACAB_GRUPO = 'MA004'
--  AND x.ORDEM_PRODUCAO <> 0
--  AND x.CODIGO_ROLO = 370
--WHERE x.NUMERO_ROLO = 8080
--   OR x.NUMERO_LOTE = 8080
--   OR x.NR_VOLUME = 8080
--   OR x.NR_SOLIC_VOLUME = 8080
--   OR x.NUMERO_PROGRAMA = 8080
--   OR x.NR_ROLO_ORIGEM = 8080
--   OR x.NUMERO_TUBETE = 8080
ORDER BY
  x.CODIGO_ROLO
;


SELECT
  x.*
FROM PCPT_021 x -- rolos - informações não utilizadas
WHERE 1=1
;

SELECT
  x.*
FROM PCPT_060 x -- faturamento de rolo - porém, quase nenhum dado
WHERE 1=1
;

SELECT
  x.*
FROM PCPT_025 x -- confirmação de rolo
--WHERE x.PANO_INI_GRUPO = 'MA004'
--  AND x.ORDEM_PRODUCAO <> 0
--  AND x.CODIGO_ROLO = 3648
--   OR x.NUMROLO_PER_TECE = 8080
--   OR x.NUMROLO_PER_TECE = 8080
--   OR x.NUMROLO_PER_TECE = 8080
--   OR x.NUMROLO_PER_TECE = 8080
;

SELECT
  x.GRUPO_PRODUTO
, x.ORDEM_PRODUCAO
, x.*
FROM TMRP_141 x -- reserva de rolo para OP
WHERE 1=1
  AND x.GRUPO_PRODUTO = 'MA005'
--  AND x.CODIGO_ROLO = 3648
--  AND x.ORDEM_PRODUCAO <> 0
;


SELECT
  x.*
FROM PCPT_020 x -- cadastro de rolos
WHERE x.PANOACAB_GRUPO = 'MA004'
  AND x.ROLO_ESTOQUE = 3
;

UPDATE PCPT_020 x -- cadastro de rolos
SET
x.ROLO_ESTOQUE = 1
WHERE x.PANOACAB_GRUPO = 'MA004'
  AND x.ROLO_ESTOQUE = 3
;

SELECT
  x.*
FROM TMRP_141 x -- reserva de rolo para OP
WHERE x.GRUPO_PRODUTO = 'MA004'
;

SELECT
  i.CODIGO_BARRAS
, i.*
FROM BASI_010 i
WHERE i.GRUPO_ESTRUTURA = '0679A'
  AND i.CODIGO_BARRAS IS NOT NULL
;

MERGE INTO BASI_010 dest
USING(
	SELECT
	  ori.*
	FROM BASI_010 ori
	WHERE ori.GRUPO_ESTRUTURA = '0679A'
	  AND ori.CODIGO_BARRAS IS NOT NULL
	) orig
ON (dest.NIVEL_ESTRUTURA = orig.NIVEL_ESTRUTURA
AND dest.GRUPO_ESTRUTURA = '0679O'
AND dest.SUBGRU_ESTRUTURA = orig.SUBGRU_ESTRUTURA
AND dest.ITEM_ESTRUTURA = orig.ITEM_ESTRUTURA
)
WHEN MATCHED THEN
    update set dest.CODIGO_BARRAS = orig.CODIGO_BARRAS
--WHEN NOT MATCHED THEN
--    insert (xyz) values (orig.xyz)
;

SELECT
  i.CODIGO_BARRAS
, i.*
FROM BASI_010 i
WHERE i.GRUPO_ESTRUTURA IN ( '0679A', '0679O')
  AND i.CODIGO_BARRAS IS NOT NULL
ORDER BY
  i.SUBGRU_ESTRUTURA
, i.ITEM_ESTRUTURA
, i.GRUPO_ESTRUTURA
;

SELECT
  count(*)
FROM HIST_010 h
;

SELECT
  h.*
FROM HIST_010 h
;


SELECT
  i.CODIGO_BARRAS
, i.*
FROM BASI_010 i
WHERE i.GRUPO_ESTRUTURA = 'M761R'
  AND i.CODIGO_BARRAS IS NOT NULL
;

MERGE INTO BASI_010 dest
USING(
	SELECT
	  ori.*
	FROM BASI_010 ori
	WHERE ori.GRUPO_ESTRUTURA = 'M761R'
	  AND ori.CODIGO_BARRAS IS NOT NULL
	) orig
ON (dest.NIVEL_ESTRUTURA = orig.NIVEL_ESTRUTURA
AND dest.GRUPO_ESTRUTURA = '7611U'
AND dest.SUBGRU_ESTRUTURA = orig.SUBGRU_ESTRUTURA
AND dest.ITEM_ESTRUTURA = orig.ITEM_ESTRUTURA
)
WHEN MATCHED THEN
    update set dest.CODIGO_BARRAS = orig.CODIGO_BARRAS
--WHEN NOT MATCHED THEN
--    insert (xyz) values (orig.xyz)
;

SELECT
  i.CODIGO_BARRAS
, i.*
FROM BASI_010 i
WHERE i.GRUPO_ESTRUTURA IN ( 'M761R', '7611U')
  AND i.CODIGO_BARRAS IS NOT NULL
ORDER BY
  i.SUBGRU_ESTRUTURA
, i.ITEM_ESTRUTURA
, i.GRUPO_ESTRUTURA
;

SELECT
  x.CODIGO_ROLO
, x.PANOACAB_NIVEL99
, x.PANOACAB_GRUPO
, x.PANOACAB_SUBGRUPO
, x.PANOACAB_ITEM
FROM PCPT_020 x -- cadastro de rolos
WHERE x.CODIGO_ROLO = 253
;

SELECT
  i.*
FROM basi_010 i
WHERE i.DESCRICAO_15 LIKE '%ROYAL%'
  AND i.ITEM_ESTRUTURA = '0000AZ'
ORDER BY
  i.NIVEL_ESTRUTURA
, i.DESCRICAO_15
;


SELECT
*
FROM dba_locks
;

SELECT
  o.*
FROM OBRF_080 o
WHERE o.NUMERO_ORDEM = 1391
;

DELETE
FROM OBRF_080 o
WHERE o.NUMERO_ORDEM = 1391
;

SELECT DISTINCT
  l.*
FROM pcpc_040 l -- lotes nos estágios
WHERE l.NUMERO_ORDEM = 1391
;

UPDATE pcpc_040 l -- lotes nos estágios
SET
  l.NUMERO_ORDEM = 0
WHERE l.NUMERO_ORDEM = 1391
;

SELECT DISTINCT
  l.*
FROM pcpc_040 l -- lotes nos estágios
WHERE l.ORDEM_PRODUCAO = 3596
;

SELECT
  i.CODIGO_BARRAS
, i.*
FROM BASI_010 i
WHERE i.GRUPO_ESTRUTURA = '05200'
  AND i.ITEM_ESTRUTURA = '0000ME'
--  AND i.CODIGO_BARRAS IS NOT NULL
;


SELECT
  op.DATA_ENTRADA_CORTE
, op.*
FROM PCPC_020 op -- OP capa
WHERE op.ORDEM_PRODUCAO = 2004
;

SELECT
  op.d
, COALESCE(
  ( SELECT
      MIN( le.CODIGO_ESTAGIO ) CODIGO_ESTAGIO
    FROM PCPC_040 le
    JOIN MQOP_005 ed
      ON ed.CODIGO_ESTAGIO = le.CODIGO_ESTAGIO
    WHERE le.PERIODO_PRODUCAO = l.PERIODO_PRODUCAO
      AND le.ORDEM_CONFECCAO = l.ORDEM_CONFECCAO
      AND le.QTDE_EM_PRODUCAO_PACOTE <> 0
  )
  , 9999
  ) EST_NUM
, l.ORDEM_PRODUCAO OP
, op.SITUACAO OP_SITUACAO
, CASE WHEN dos.NUMERO_ORDEM IS NULL
  THEN '0'
  ELSE l.NUMERO_ORDEM || ' (' || eos.DESCRICAO || ')'
  END OS
, l.PROCONF_GRUPO REF
, l.PROCONF_SUBGRUPO TAM
, l.PROCONF_ITEM COR
, COALESCE(
  ( SELECT
      LISTAGG(le.CODIGO_ESTAGIO || ' - ' || ed.DESCRICAO, ' & ')
      WITHIN GROUP (ORDER BY le.CODIGO_ESTAGIO)
    FROM PCPC_040 le
    JOIN MQOP_005 ed
      ON ed.CODIGO_ESTAGIO = le.CODIGO_ESTAGIO
    WHERE le.PERIODO_PRODUCAO = l.PERIODO_PRODUCAO
      AND le.ORDEM_CONFECCAO = l.ORDEM_CONFECCAO
      AND le.QTDE_EM_PRODUCAO_PACOTE <> 0
  )
  , 'FINALIZADO'
  ) EST
, l.PERIODO_PRODUCAO PERIODO
, l.ORDEM_CONFECCAO OC
, l.QTDE_PECAS_PROG QTD
, l.QTDE_PECAS_PROD PROD1Q
, l.QTDE_CONSERTO CONSERTO
, l.QTDE_PECAS_2A PROD2Q
, l.QTDE_PERDAS PERDA
, r.NARRATIVA
, CASE WHEN l.DIVISAO = 0 THEN dp.DIVISAO_PRODUCAO
  ELSE l.DIVISAO END DIVISAO
, CASE WHEN l.DIVISAO = 0 THEN dp.DESCRICAO
  ELSE di.DESCRICAO END DESCRICAO_DIVISAO
FROM (
  SELECT
    os.PERIODO_PRODUCAO
  , os.ORDEM_CONFECCAO
  , os.PROCONF_GRUPO
  , os.PROCONF_SUBGRUPO
  , os.PROCONF_ITEM
  , os.ORDEM_PRODUCAO
  , max( os.NUMERO_ORDEM ) NUMERO_ORDEM
  , max( os.QTDE_PECAS_PROG ) QTDE_PECAS_PROG
  , max( os.QTDE_PECAS_PROD ) QTDE_PECAS_PROD
  , max( os.QTDE_CONSERTO ) QTDE_CONSERTO
  , max( os.QTDE_PECAS_2A ) QTDE_PECAS_2A
  , max( os.QTDE_PERDAS ) QTDE_PERDAS
  , max( CASE WHEN os.CODIGO_FAMILIA < 1000
         THEN os.CODIGO_FAMILIA
         ELSE 0 END ) DIVISAO
  FROM PCPC_040 os
  WHERE 1=1
    AND (os.ORDEM_PRODUCAO = 2004)
--    AND (os.NUMERO_ORDEM = %s or %s IS NULL)
--    AND (os.ORDEM_CONFECCAO >= %s or %s IS NULL)
--    AND (os.ORDEM_CONFECCAO <= %s or %s IS NULL)
--    AND (os.PROCONF_SUBGRUPO = %s OR %s IS NULL)
--    AND (os.PROCONF_ITEM = %s OR %s IS NULL)
  GROUP BY
    os.PERIODO_PRODUCAO
  , os.ORDEM_CONFECCAO
  , os.PROCONF_GRUPO
  , os.PROCONF_SUBGRUPO
  , os.PROCONF_ITEM
  , os.ORDEM_PRODUCAO
) l
LEFT JOIN PCPC_040 dos
  ON l.NUMERO_ORDEM <> 0
 AND dos.PERIODO_PRODUCAO = l.PERIODO_PRODUCAO
 AND dos.ORDEM_CONFECCAO = l.ORDEM_CONFECCAO
 AND dos.NUMERO_ORDEM = l.NUMERO_ORDEM
LEFT JOIN MQOP_005 eos
  ON eos.CODIGO_ESTAGIO = dos.CODIGO_ESTAGIO
LEFT JOIN BASI_220 t
  ON t.TAMANHO_REF = l.PROCONF_SUBGRUPO
JOIN BASI_010 r
  ON r.NIVEL_ESTRUTURA = 1
 AND r.GRUPO_ESTRUTURA = l.PROCONF_GRUPO
 AND r.SUBGRU_ESTRUTURA = l.PROCONF_SUBGRUPO
 AND r.ITEM_ESTRUTURA = l.PROCONF_ITEM
LEFT JOIN BASI_180 di -- divisao de producao - unidade
  ON di.DIVISAO_PRODUCAO = l.DIVISAO
LEFT JOIN OBRF_080 osc -- OS capa
  ON l.NUMERO_ORDEM <> 0
 AND osc.NUMERO_ORDEM = l.NUMERO_ORDEM
LEFT JOIN BASI_180 dp -- divisao de producao - unidade
  ON dp.FACCIONISTA9 = osc.CGCTERC_FORNE9
 AND dp.FACCIONISTA4 = osc.CGCTERC_FORNE4
 AND dp.FACCIONISTA2 = osc.CGCTERC_FORNE2
JOIN PCPC_020 op -- OP capa
  ON op.ordem_producao = l.ORDEM_PRODUCAO
;

SELECT
  i.CODIGO_BARRAS
, i.*
FROM BASI_010 i
WHERE i.GRUPO_ESTRUTURA = '02577'
--  AND i.SUBGRU_ESTRUTURA = 'M'
  AND i.ITEM_ESTRUTURA = '0000PR'
--  AND i.CODIGO_BARRAS IS NOT NULL
;

SELECT
  CURRENT_DATE
, f.DATA_EMISSAO
, f.NUMERO_DANF_NFE
, f.*
FROM fatu_050 f
WHERE 1=1
--  AND f.NUM_NOTA_FISCAL IN (059341)
  AND f.COD_STATUS = 990
  AND f.DATA_EMISSAO < CURRENT_DATE - 7
ORDER BY
  f.DATA_EMISSAO DESC
;

UPDATE fatu_050 f
SET
  f.COD_STATUS = 101
, f.MSG_STATUS = 'Cancelamento de NF-e homologado'
WHERE f.COD_STATUS = 990
  AND f.DATA_EMISSAO < CURRENT_DATE - 3
;

SELECT
  o.DATA_ENTRADA_CORTE
, l.*
, o.*
FROM pcpc_040 l
JOIN PCPC_020 o
  ON o.ORDEM_PRODUCAO = l.ORDEM_PRODUCAO
WHERE l.PROCONF_NIVEL99 = 1
  AND o.SITUACAO IN (2, 4)
  AND o.DATA_ENTRADA_CORTE >= '01/10/2017'
ORDER BY
  o.DATA_ENTRADA_CORTE
;

SELECT
  i.CODIGO_BARRAS
, i.*
FROM BASI_010 i
LEFT JOIN BASI_220 t -- tamanhos
  ON t.TAMANHO_REF = i.SUBGRU_ESTRUTURA
WHERE i.GRUPO_ESTRUTURA = '0687U'
  AND i.ITEM_ESTRUTURA = '0000BR'
--  AND i.CODIGO_BARRAS IS NOT NULL
ORDER BY
  t.ORDEM_TAMANHO
;

SELECT
  i.CODIGO_BARRAS
, i.*
FROM BASI_010 i
WHERE i.GRUPO_ESTRUTURA = '0695U'
  AND i.ITEM_ESTRUTURA in ('0000CB')
--  AND i.CODIGO_BARRAS IS NOT NULL
ORDER BY
  i.ITEM_ESTRUTURA
, i.SUBGRU_ESTRUTURA
;

SELECT
  e.CODIGO_ESTAGIO
, e.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO ESTAGIO
, l.PERIODO_PRODUCAO PERIODO
, p.DATA_INI_PERIODO DATA_INI
, p.DATA_FIM_PERIODO DATA_FIM
, r.COLECAO || ' - ' || c.DESCR_COLECAO COLECAO
, l.PROCONF_GRUPO REF
, l.ORDEM_PRODUCAO OP
, l.SEQ_OPERACAO SEQ
, o.DATA_ENTRADA_CORTE DT_CORTE
, SUM( l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD) QTD
, COUNT(*) LOTES
FROM MQOP_005 e
JOIN PCPC_040 l
  ON l.CODIGO_ESTAGIO = e.CODIGO_ESTAGIO
JOIN BASI_030 r -- cadastro de produtos
  ON r.NIVEL_ESTRUTURA = l.PROCONF_NIVEL99
 AND r.REFERENCIA = l.PROCONF_GRUPO
JOIN BASI_140 c -- cadastro de coleções de produtos
  ON c.COLECAO = r.COLECAO
 AND ( %s is NULL or c.COLECAO = %s )
JOIN PCPC_020 o
  ON o.ORDEM_PRODUCAO = l.ORDEM_PRODUCAO
JOIN PCPC_010 p
  ON p.AREA_PERIODO = 1
 AND p.PERIODO_PRODUCAO = l.PERIODO_PRODUCAO
WHERE l.QTDE_EM_PRODUCAO_PACOTE <> 0
  AND o.SITUACAO = 4 -- Ordens em produção
--  AND ( %s is NULL or e.CODIGO_ESTAGIO = %s )
--  AND l.PERIODO_PRODUCAO >= %s
--  AND l.PERIODO_PRODUCAO <= %s
  AND ( o.DATA_ENTRADA_CORTE >= '01/05/2017' )
  AND ( o.DATA_ENTRADA_CORTE <= '01/06/2017' )
GROUP BY
  e.CODIGO_ESTAGIO
, e.DESCRICAO
, l.PERIODO_PRODUCAO
, p.DATA_INI_PERIODO
, p.DATA_FIM_PERIODO
, l.PROCONF_GRUPO
, r.COLECAO
, c.DESCR_COLECAO
, l.ORDEM_PRODUCAO
, l.SEQ_OPERACAO
, o.DATA_ENTRADA_CORTE
ORDER BY
  e.CODIGO_ESTAGIO
, l.PERIODO_PRODUCAO
, r.COLECAO
, l.PROCONF_GRUPO
, l.ORDEM_PRODUCAO
;

SELECT
  x.*
FROM PCPT_025 x -- confirmação de rolo
;

DELETE
FROM PCPT_025 x -- confirmação de rolo
;

SELECT
  x.*
FROM TMRP_141 x -- reserva de rolo para OP
;

DELETE
FROM TMRP_141 x -- reserva de rolo para OP
;

SELECT
  x.*
FROM PCPT_020 x -- cadastro de rolos
WHERE x.ROLO_ESTOQUE = 3
;

UPDATE PCPT_020 x -- cadastro de rolos
SET
  x.ROLO_ESTOQUE = 1
WHERE x.ROLO_ESTOQUE = 3
;

SELECT
  COALESCE(
  ( SELECT
      MIN( le.CODIGO_ESTAGIO ) CODIGO_ESTAGIO
    FROM PCPC_040 le
    JOIN MQOP_005 ed
      ON ed.CODIGO_ESTAGIO = le.CODIGO_ESTAGIO
    WHERE le.PERIODO_PRODUCAO = l.PERIODO_PRODUCAO
      AND le.ORDEM_CONFECCAO = l.ORDEM_CONFECCAO
      AND le.QTDE_EM_PRODUCAO_PACOTE <> 0
  )
  , 9999
  ) EST_NUM
, l.ORDEM_PRODUCAO OP
, op.SITUACAO OP_SITUACAO
, CASE WHEN dos.NUMERO_ORDEM IS NULL
  THEN '0'
  ELSE l.NUMERO_ORDEM || ' (' || eos.DESCRICAO || ')'
  END OS
, l.PROCONF_GRUPO REF
, l.PROCONF_SUBGRUPO TAM
, l.PROCONF_ITEM COR
, COALESCE(
  ( SELECT
      LISTAGG(le.CODIGO_ESTAGIO || ' - ' || ed.DESCRICAO, ' & ')
      WITHIN GROUP (ORDER BY le.CODIGO_ESTAGIO)
    FROM PCPC_040 le
    JOIN MQOP_005 ed
      ON ed.CODIGO_ESTAGIO = le.CODIGO_ESTAGIO
    WHERE le.PERIODO_PRODUCAO = l.PERIODO_PRODUCAO
      AND le.ORDEM_CONFECCAO = l.ORDEM_CONFECCAO
      AND le.QTDE_EM_PRODUCAO_PACOTE <> 0
  )
  , 'FINALIZADO'
  ) EST
, l.PERIODO_PRODUCAO PERIODO
, l.ORDEM_CONFECCAO OC
, l.QTDE_PECAS_PROG QTD
, r.NARRATIVA
, CASE WHEN l.DIVISAO = 0 THEN dp.DIVISAO_PRODUCAO
  ELSE l.DIVISAO END DIVISAO
, CASE WHEN l.DIVISAO = 0 THEN dp.DESCRICAO
  ELSE di.DESCRICAO END DESCRICAO_DIVISAO
FROM (
  SELECT
    os.PERIODO_PRODUCAO
  , os.ORDEM_CONFECCAO
  , os.PROCONF_GRUPO
  , os.PROCONF_SUBGRUPO
  , os.PROCONF_ITEM
  , os.ORDEM_PRODUCAO
  , max( os.NUMERO_ORDEM ) NUMERO_ORDEM
  , max( os.QTDE_PECAS_PROG ) QTDE_PECAS_PROG
  , max( CASE WHEN os.CODIGO_FAMILIA < 1000
         THEN os.CODIGO_FAMILIA
         ELSE 0 END ) DIVISAO
  FROM PCPC_040 os
  WHERE 1=1
    AND (os.ORDEM_PRODUCAO = 183)-- or %s IS NULL)
--    AND (os.NUMERO_ORDEM = %s or %s IS NULL)
--    AND (os.ORDEM_CONFECCAO >= %s or %s IS NULL)
--    AND (os.ORDEM_CONFECCAO <= %s or %s IS NULL)
--    AND (os.PROCONF_SUBGRUPO = %s OR %s IS NULL)
--    AND (os.PROCONF_ITEM = %s OR %s IS NULL)
  GROUP BY
    os.PERIODO_PRODUCAO
  , os.ORDEM_CONFECCAO
  , os.PROCONF_GRUPO
  , os.PROCONF_SUBGRUPO
  , os.PROCONF_ITEM
  , os.ORDEM_PRODUCAO
) l
LEFT JOIN PCPC_040 dos
  ON l.NUMERO_ORDEM <> 0
 AND dos.PERIODO_PRODUCAO = l.PERIODO_PRODUCAO
 AND dos.ORDEM_CONFECCAO = l.ORDEM_CONFECCAO
 AND dos.NUMERO_ORDEM = l.NUMERO_ORDEM
LEFT JOIN MQOP_005 eos
  ON eos.CODIGO_ESTAGIO = dos.CODIGO_ESTAGIO
LEFT JOIN BASI_220 t
  ON t.TAMANHO_REF = l.PROCONF_SUBGRUPO
JOIN BASI_010 r
  ON r.NIVEL_ESTRUTURA = 1
 AND r.GRUPO_ESTRUTURA = l.PROCONF_GRUPO
 AND r.SUBGRU_ESTRUTURA = l.PROCONF_SUBGRUPO
 AND r.ITEM_ESTRUTURA = l.PROCONF_ITEM
LEFT JOIN BASI_180 di -- divisao de producao - unidade
  ON di.DIVISAO_PRODUCAO = l.DIVISAO
LEFT JOIN OBRF_080 osc -- OS capa
  ON l.NUMERO_ORDEM <> 0
 AND osc.NUMERO_ORDEM = l.NUMERO_ORDEM
LEFT JOIN BASI_180 dp -- divisao de producao - unidade
  ON dp.FACCIONISTA9 = osc.CGCTERC_FORNE9
 AND dp.FACCIONISTA4 = osc.CGCTERC_FORNE4
 AND dp.FACCIONISTA2 = osc.CGCTERC_FORNE2
JOIN PCPC_020 op -- OP capa
  ON op.ordem_producao = l.ORDEM_PRODUCAO
ORDER BY
  l.ORDEM_CONFECCAO
;

SELECT
  i.CODIGO_BARRAS
, i.*
FROM BASI_010 i
WHERE i.GRUPO_ESTRUTURA = '0620S'
  AND i.SUBGRU_ESTRUTURA = 'G'
  AND i.ITEM_ESTRUTURA = '0000BC'
--  AND i.CODIGO_BARRAS IS NOT NULL
;

SELECT DISTINCT
  l.ORDEM_PRODUCAO
, l.NUMERO_ORDEM
, l.SEQ_ORDEM_SERV
, l.PERIODO_PRODUCAO
, l.ORDEM_CONFECCAO
, l.PROCONF_GRUPO
, l.PROCONF_SUBGRUPO
, l.PROCONF_ITEM
, l.*
FROM pcpc_040 l
WHERE 1=1
  --AND l.ORDEM_PRODUCAO = 297
  AND l.NUMERO_ORDEM = 1399
--  AND l.CODIGO_ESTAGIO = 39
--  AND l.PERIODO_PRODUCAO = 1721
--  AND l.ORDEM_CONFECCAO IN (
--    3679
--  , 3708
--  )
--  AND l.NUMERO_ORDEM <> 0
--  AND l.SEQ_ORDEM_SERV <> 0
;

SELECT
  DISTINCT
  s.PRODORD_NIVEL99
, s.PRODORD_GRUPO
, s.PRODORD_SUBGRUPO
, s.PRODORD_ITEM
, s.SEQUENCIA
, s.SEQ_NOTA_SAIDA
, s.SEQUENCIA_ORIGEM
--, s.*
FROM OBRF_081 s
WHERE s.NUMERO_ORDEM = 1399
ORDER BY
  s.PRODORD_NIVEL99
, s.PRODORD_GRUPO
, s.PRODORD_SUBGRUPO
, s.PRODORD_ITEM
;

SELECT
  o.*
FROM OBRF_081_LOG o
WHERE o.NUMERO_ORDEM = 1388
;

DELETE
FROM OBRF_081_LOG o
WHERE o.NUMERO_ORDEM = 1388
;

SELECT
  s.*
FROM OBRF_082 s
WHERE s.NUMERO_ORDEM = 1388
;

DELETE
FROM OBRF_082 s
WHERE s.NUMERO_ORDEM = 1388
;

SELECT
  s.*
FROM OBRF_081 s
WHERE s.NUMERO_ORDEM = 1388
;

SELECT
  s.*
FROM OBRF_080 s
WHERE s.NUMERO_ORDEM = 1388
;

DELETE
FROM OBRF_080 s
WHERE s.NUMERO_ORDEM = 1388
;

SELECT DISTINCT
  l.NUMERO_ORDEM
, l.*
FROM pcpc_040 l -- lotes nos estágios
WHERE 1=1
--  AND l.NUMERO_ORDEM = 1391
  AND l.PERIODO_PRODUCAO = 1747
  AND l.ORDEM_CONFECCAO = 3107
;

SELECT
  o.*
FROM OBRF_081_LOG o
WHERE o.NUMERO_ORDEM = 1393
;

DELETE
FROM OBRF_081_LOG o
WHERE o.NUMERO_ORDEM = 1393
;

SELECT
  s.*
FROM OBRF_082 s
WHERE s.NUMERO_ORDEM = 1393
;

DELETE
FROM OBRF_082 s
WHERE s.NUMERO_ORDEM = 1393
;

SELECT
  s.*
FROM OBRF_081 s
WHERE s.NUMERO_ORDEM = 1393
;

-- está vazia

SELECT
  s.*
FROM OBRF_080 s
WHERE s.NUMERO_ORDEM = 1393
;

DELETE
FROM OBRF_080 s
WHERE s.NUMERO_ORDEM = 1393
;

SELECT
  l.*
FROM pcpc_040 l -- lotes nos estágios
WHERE l.NUMERO_ORDEM = 1393
;

SELECT
  r.SEQ_OPERACAO SEQ
, r.CODIGO_OPERACAO || ' - ' || o.NOME_OPERACAO OPERACAO
, r.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO ESTAGIO
, CASE WHEN r.IND_ESTAGIO_GARGALO = 1
  THEN 'Gargalo'
  ELSE ' '
  END GARGALO
, r.*
FROM MQOP_050 r -- roteiro
JOIN MQOP_005 e -- estagio
  ON e.CODIGO_ESTAGIO = r.CODIGO_ESTAGIO
JOIN MQOP_040 o -- operacao
  ON o.CODIGO_OPERACAO = r.CODIGO_OPERACAO
WHERE r.NIVEL_ESTRUTURA = 1
  AND r.GRUPO_ESTRUTURA = 'M725S'
--  AND r.NUMERO_ALTERNATI = %s
--  AND r.NUMERO_ROTEIRO = %s
ORDER BY
  r.SEQ_OPERACAO
;

SELECT
  s.*
FROM OBRF_082 s
WHERE s.NUMERO_ORDEM = 1476
;

SELECT
  p.PEDIDO_VENDA PEDIDO
, c.NOME_CLIENTE
  || ' (' || lpad(c.CGC_9, 8, '0')
  || '/' || lpad(c.CGC_4, 4, '0')
  || '-' || lpad(c.CGC_2, 2, '0')
  || ')' CLIENTE
, i.CD_IT_PE_NIVEL99 NIVEL
, i.CD_IT_PE_GRUPO REF
, i.CD_IT_PE_ITEM COR
, i.CD_IT_PE_SUBGRUPO TAM
, i.QTDE_PEDIDA QTD
, coalesce( ip.REF_CLIENTE, '-') INFADPROD
, coalesce( rtc.CODIGO_BARRAS, ' ') EAN
, rtc.NARRATIVA
FROM PEDI_100 p -- pedido de venda
LEFT JOIN PEDI_010 c
  ON c.CGC_9 = p.CLI_PED_CGC_CLI9
 AND c.CGC_4 = p.CLI_PED_CGC_CLI4
JOIN PEDI_110 i -- item de pedido de venda
  ON i.PEDIDO_VENDA = p.PEDIDO_VENDA
JOIN BASI_010 rtc -- item (ref+tam+cor)
  on rtc.NIVEL_ESTRUTURA = i.CD_IT_PE_NIVEL99
 AND rtc.GRUPO_ESTRUTURA = i.CD_IT_PE_GRUPO
 AND rtc.SUBGRU_ESTRUTURA = i.CD_IT_PE_SUBGRUPO
 AND rtc.ITEM_ESTRUTURA = i.CD_IT_PE_ITEM
LEFT JOIN ESTQ_400 ip -- item - informações por cliente
  ON ip.CLIENTE9 = CLI_PED_CGC_CLI9
 AND ip.CLIENTE4 = CLI_PED_CGC_CLI4
 AND ip.NIVEL_ESTRUTURA = i.CD_IT_PE_NIVEL99
 AND ip.GRUPO_ESTRUTURA = i.CD_IT_PE_GRUPO
 AND ip.SUBGRUPO_ESTRUTURA = i.CD_IT_PE_SUBGRUPO
 AND ip.ITEM_ESTRUTURA = i.CD_IT_PE_ITEM
LEFT JOIN BASI_220 t -- tamanhos
  ON t.TAMANHO_REF = i.CD_IT_PE_SUBGRUPO
WHERE p.PEDIDO_VENDA = 1000
ORDER BY
  p.PEDIDO_VENDA
, p.CLI_PED_CGC_CLI9
, p.CLI_PED_CGC_CLI4
, i.CD_IT_PE_NIVEL99
, i.CD_IT_PE_GRUPO
, i.CD_IT_PE_ITEM
, t.ORDEM_TAMANHO
, i.CD_IT_PE_SUBGRUPO
;

SELECT DISTINCT
  i.CD_IT_PE_SUBGRUPO TAM
, t.ORDEM_TAMANHO
FROM PEDI_110 i -- item de pedido de venda
LEFT JOIN BASI_220 t -- tamanhos
  ON t.TAMANHO_REF = i.CD_IT_PE_SUBGRUPO
WHERE i.PEDIDO_VENDA = 1000
ORDER BY
  t.ORDEM_TAMANHO
;

SELECT
  i.CD_IT_PE_GRUPO || ' - ' || i.CD_IT_PE_ITEM SORTIMENTO
, i.CD_IT_PE_GRUPO || ' - ' || i.CD_IT_PE_ITEM || ' - ' ||
  max( rtc.DESCRICAO_15 ) DESCR
FROM PEDI_110 i -- item de pedido de venda
JOIN BASI_010 rtc -- item (ref+tam+cor)
  on rtc.NIVEL_ESTRUTURA = i.CD_IT_PE_NIVEL99
 AND rtc.GRUPO_ESTRUTURA = i.CD_IT_PE_GRUPO
 AND rtc.SUBGRU_ESTRUTURA = i.CD_IT_PE_SUBGRUPO
 AND rtc.ITEM_ESTRUTURA = i.CD_IT_PE_ITEM
WHERE i.PEDIDO_VENDA = 1000
GROUP BY
  i.CD_IT_PE_GRUPO
, i.CD_IT_PE_ITEM
ORDER BY
  2
;

SELECT
  i.CD_IT_PE_GRUPO || ' - ' || i.CD_IT_PE_ITEM SORTIMENTO
, i.CD_IT_PE_SUBGRUPO TAMANHO
, i.QTDE_PEDIDA QUANTIDADE
FROM PEDI_110 i -- item de pedido de venda
WHERE i.PEDIDO_VENDA = 1000
;

SELECT
  c.*
FROM BASI_040 c -- combinações de cor e tamanho de componentes de alternativa de estrutura
JOIN
(
SELECT DISTINCT
  e.NIVEL_ITEM
, e.GRUPO_ITEM
, e.ALTERNATIVA_ITEM
FROM BASI_050 e -- componentes de alternativas de estrutura
WHERE e.NIVEL_ITEM = 1
--  AND e.GRUPO_ITEM = '110VO'
--  AND e.ALTERNATIVA_ITEM = 6
  AND e.ESTAGIO = 40
) alt
  ON c.NIVEL_ITEM = alt.NIVEL_ITEM
 AND c.GRUPO_ITEM = alt.GRUPO_ITEM
 AND c.ALTERNATIVA_ITEM = alt.ALTERNATIVA_ITEM
--WHERE c.ESTAGIO <> 40
ORDER BY
  c.NIVEL_ITEM
, c.GRUPO_ITEM
, c.ALTERNATIVA_ITEM
;

DELETE FROM BASI_040 cd
WHERE cd.ROWID IN (
  SELECT
    c.ROWID
  FROM BASI_040 c -- combinações de cor e tamanho de componentes de alternativa de estrutura
  JOIN
  (
    SELECT DISTINCT
      e.NIVEL_ITEM
    , e.GRUPO_ITEM
    , e.ALTERNATIVA_ITEM
    FROM BASI_050 e -- componentes de alternativas de estrutura
    WHERE e.NIVEL_ITEM = 1
--      AND e.GRUPO_ITEM = '110VO'
    --  AND e.ALTERNATIVA_ITEM = 6
      AND e.ESTAGIO = 40
  ) alt
    ON c.NIVEL_ITEM = alt.NIVEL_ITEM
   AND c.GRUPO_ITEM = alt.GRUPO_ITEM
   AND c.ALTERNATIVA_ITEM = alt.ALTERNATIVA_ITEM
  --WHERE c.ESTAGIO <> 40
)
;


DELETE FROM BASI_050 cd
WHERE cd.ROWID IN (
  SELECT
    c.ROWID
--    c.*
  FROM
  (
    SELECT DISTINCT
      e.NIVEL_ITEM
    , e.GRUPO_ITEM
    , e.ALTERNATIVA_ITEM
    FROM BASI_050 e -- componentes de alternativas de estrutura
    WHERE e.NIVEL_ITEM = 1
--      AND e.GRUPO_ITEM = '110VO'
    --  AND e.ALTERNATIVA_ITEM = 6
      AND e.ESTAGIO = 40
  ) alt
  JOIN BASI_050 c -- componentes de alternativa de estrutura
    ON c.NIVEL_ITEM = alt.NIVEL_ITEM
   AND c.GRUPO_ITEM = alt.GRUPO_ITEM
   AND c.ALTERNATIVA_ITEM = alt.ALTERNATIVA_ITEM
)
;

SELECT
  a.NIVEL
, a.GRUPO
, a.ALTERNATIVA
, count(*)
FROM BASI_070 a -- alternativas de estrutura
JOIN BASI_050 c -- componentes de alternativa de estrutura
  ON c.NIVEL_ITEM = a.NIVEL
 AND c.GRUPO_ITEM = a.GRUPO
 AND c.ALTERNATIVA_ITEM = a.ALTERNATIVA
WHERE a.NIVEL = 1
GROUP BY
  a.NIVEL
, a.GRUPO
, a.ALTERNATIVA
HAVING
  count(*) = 0
;


SELECT
  r.NIVEL_ESTRUTURA
, r.GRUPO_ESTRUTURA
, r.NUMERO_ALTERNATI
, a.GRUPO tab_alt
, c.GRUPO_ITEM tab_compo
FROM MQOP_050 r -- operaçẽs das alternativas de roteiro
LEFT JOIN BASI_070 a -- alternativas de estrutura
  ON a.NIVEL = r.NIVEL_ESTRUTURA
 AND a.GRUPO = r.GRUPO_ESTRUTURA
 AND a.ALTERNATIVA = r.NUMERO_ALTERNATI
LEFT JOIN BASI_050 c -- componentes de alternativa de estrutura
  ON c.NIVEL_ITEM = r.NIVEL_ESTRUTURA
 AND c.GRUPO_ITEM = r.GRUPO_ESTRUTURA
 AND c.ALTERNATIVA_ITEM = r.NUMERO_ALTERNATI
WHERE r.NIVEL_ESTRUTURA = 1
  AND (
    a.ALTERNATIVA IS NULL
    OR c.ALTERNATIVA_ITEM IS NULL
  )

--  AND r.GRUPO_ESTRUTURA LIKE 'F%'
--  AND (  r.NUMERO_ROTEIRO = 6
--      OR r.NUMERO_ALTERNATI = 6 )
;

SELECT
  ro.*
--  ro.ROWID
--, rr.NIVEL_ESTRUTURA
--, rr.GRUPO_ESTRUTURA
--, rr.NUMERO_ALTERNATI
--, ro.SEQ_OPERACAO
FROM MQOP_050 ro -- operaçẽs das alternativas de roteiro
JOIN (
SELECT DISTINCT
  r.NIVEL_ESTRUTURA
, r.GRUPO_ESTRUTURA
, r.NUMERO_ALTERNATI
FROM MQOP_050 r -- operaçẽs das alternativas de roteiro
LEFT JOIN BASI_050 c -- componentes de alternativa de estrutura
  ON c.NIVEL_ITEM = r.NIVEL_ESTRUTURA
 AND c.GRUPO_ITEM = r.GRUPO_ESTRUTURA
 AND c.ALTERNATIVA_ITEM = r.NUMERO_ALTERNATI
WHERE r.NIVEL_ESTRUTURA = 1
  AND c.ALTERNATIVA_ITEM IS NULL
) rr
  ON rr.NIVEL_ESTRUTURA = ro.NIVEL_ESTRUTURA
 AND rr.GRUPO_ESTRUTURA = ro.GRUPO_ESTRUTURA
 AND rr.NUMERO_ALTERNATI = ro.NUMERO_ALTERNATI
ORDER BY
  rr.NIVEL_ESTRUTURA
, rr.GRUPO_ESTRUTURA
, rr.NUMERO_ALTERNATI
, ro.SEQ_OPERACAO
;

DELETE FROM MQOP_050 rod
WHERE rod.ROWID IN (
  SELECT
    ro.ROWID
  FROM MQOP_050 ro -- operaçẽs das alternativas de roteiro
  JOIN (
    SELECT DISTINCT
      r.NIVEL_ESTRUTURA
    , r.GRUPO_ESTRUTURA
    , r.NUMERO_ALTERNATI
    FROM MQOP_050 r -- operaçẽs das alternativas de roteiro
    LEFT JOIN BASI_050 c -- componentes de alternativa de estrutura
      ON c.NIVEL_ITEM = r.NIVEL_ESTRUTURA
     AND c.GRUPO_ITEM = r.GRUPO_ESTRUTURA
     AND c.ALTERNATIVA_ITEM = r.NUMERO_ALTERNATI
    WHERE r.NIVEL_ESTRUTURA = 1
      AND c.ALTERNATIVA_ITEM IS NULL
  ) rr
    ON rr.NIVEL_ESTRUTURA = ro.NIVEL_ESTRUTURA
   AND rr.GRUPO_ESTRUTURA = ro.GRUPO_ESTRUTURA
   AND rr.NUMERO_ALTERNATI = ro.NUMERO_ALTERNATI
)
;

-- referência sem operações de roteiro
SELECT
  r.NIVEL_ESTRUTURA
, r.REFERENCIA
, ro.GRUPO_ESTRUTURA
FROM BASI_030 r -- referencia (produto)
LEFT JOIN MQOP_050 ro -- operaçẽs das alternativas de roteiro
  ON ro.NIVEL_ESTRUTURA = r.NIVEL_ESTRUTURA
 AND ro.GRUPO_ESTRUTURA = r.REFERENCIA
WHERE ro.GRUPO_ESTRUTURA IS NULL
;

SELECT
--  r.RESPONSAVEL
--,
  count( DISTINCT i.GRUPO_ESTRUTURA )
FROM BASI_010 i -- item
JOIN BASI_030 r -- referencia (produto)
  ON r.NIVEL_ESTRUTURA = i.NIVEL_ESTRUTURA
 AND r.REFERENCIA = i.GRUPO_ESTRUTURA
WHERE i.NIVEL_ESTRUTURA = 1
  AND i.DATA_CADASTRO <= '01.06.2017'
  AND r.RESPONSAVEL IS NULL
;

SELECT
  i.*
FROM BASI_030 i -- referencia (produto)
WHERE i.NIVEL_ESTRUTURA = 1
--  AND i.dt >= '11.12.2017'
;

-- itens de referência sem operações de roteiro e sem componentes de alternativa
SELECT
  i.NIVEL_ESTRUTURA
, i.GRUPO_ESTRUTURA
, i.SUBGRU_ESTRUTURA
, i.ITEM_ESTRUTURA
, ro.GRUPO_ESTRUTURA
, e.GRUPO_ITEM
FROM BASI_010 i -- referencia (produto)
LEFT JOIN MQOP_050 ro -- operaçẽs das alternativas de roteiro
  ON ro.NIVEL_ESTRUTURA = i.NIVEL_ESTRUTURA
 AND ro.GRUPO_ESTRUTURA = i.GRUPO_ESTRUTURA
LEFT JOIN BASI_050 e -- componentes de alternativas de estrutura
  ON e.NIVEL_ITEM = i.NIVEL_ESTRUTURA
 AND e.GRUPO_ITEM = i.GRUPO_ESTRUTURA
WHERE 1=1
--  AND ro.GRUPO_ESTRUTURA <> e.GRUPO_ITEM
  AND (
    ro.GRUPO_ESTRUTURA IS NULL
    OR e.GRUPO_ITEM IS NULL
  )
;


SELECT
  TRUNC( ( lnumber + 2 )/ 3 ) steplnumber
, lote.PROCONF_ITEM
, lote.PROCONF_SUBGRUPO
, MIN( lote.PERIODO_PRODUCAO ) PERIODO_PRODUCAO
, COUNT( lote.ORDEM_CONFECCAO ) OCN
, MIN( lote.ORDEM_CONFECCAO ) OCI
, MAX( lote.ORDEM_CONFECCAO ) OCF
FROM (
SELECT
  row_number() over(
    partition BY
      l.PROCONF_ITEM
    , l.ORDEM_TAMANHO
    order BY
      l.ORDEM_CONFECCAO
  ) lnumber
, l.*
FROM (
SELECT DISTINCT
    os.PERIODO_PRODUCAO
  , os.PROCONF_ITEM
  , t.ORDEM_TAMANHO
  , os.PROCONF_SUBGRUPO
  , os.ORDEM_CONFECCAO
  FROM PCPC_040 os
  LEFT JOIN BASI_220 t -- tamanhos
    ON t.TAMANHO_REF = os.PROCONF_SUBGRUPO
  WHERE os.ORDEM_PRODUCAO = 4000
    AND os.PROCONF_ITEM = '0000PE'
  GROUP BY
    os.PERIODO_PRODUCAO
  , os.PROCONF_ITEM
  , t.ORDEM_TAMANHO
  , os.PROCONF_SUBGRUPO
  , os.ORDEM_CONFECCAO
) l
) lote
GROUP BY
  lote.PROCONF_ITEM
, lote.ORDEM_TAMANHO
, lote.PROCONF_SUBGRUPO
, TRUNC( ( lnumber + 2 )/ 3 )
ORDER BY
  lote.PROCONF_ITEM
, lote.ORDEM_TAMANHO
, 1
;


SELECT
  ll.lnumber
, ll.PERIODO_PRODUCAO
, ll.PROCONF_ITEM
, ll.PROCONF_SUBGRUPO
, MIN(ll.ORDEM_CONFECCAO) OC1
, CASE COUNT(ll.ORDEM_CONFECCAO)
  WHEN 1 THEN NULL
  WHEN 2 THEN MAX(ll.ORDEM_CONFECCAO)
  WHEN 3 THEN AVG(ll.ORDEM_CONFECCAO)
  END OC2
, CASE WHEN COUNT(ll.ORDEM_CONFECCAO) = 3
  THEN MAX(ll.ORDEM_CONFECCAO)
  ELSE NULL
  END OC3
FROM (
SELECT DISTINCT
  TRUNC( (
    row_number()
      over(
      partition BY
        os.PROCONF_ITEM
      , t.ORDEM_TAMANHO
      order BY
        os.ORDEM_CONFECCAO
      )
    + 2 )/ 3 ) lnumber
  , os.PERIODO_PRODUCAO
  , os.PROCONF_ITEM
  , t.ORDEM_TAMANHO
  , os.PROCONF_SUBGRUPO
  , os.ORDEM_CONFECCAO
  FROM PCPC_040 os
  LEFT JOIN BASI_220 t -- tamanhos
    ON t.TAMANHO_REF = os.PROCONF_SUBGRUPO
  WHERE os.ORDEM_PRODUCAO = 4000
    AND os.PROCONF_ITEM = '0000PE'
  GROUP BY
    os.PERIODO_PRODUCAO
  , os.PROCONF_ITEM
  , t.ORDEM_TAMANHO
  , os.PROCONF_SUBGRUPO
  , os.ORDEM_CONFECCAO
) ll
GROUP BY
  ll.PERIODO_PRODUCAO
, ll.PROCONF_ITEM
, ll.ORDEM_TAMANHO
, ll.PROCONF_SUBGRUPO
, ll.lnumber
ORDER BY
  ll.PERIODO_PRODUCAO
, ll.PROCONF_ITEM
, ll.ORDEM_TAMANHO
, ll.PROCONF_SUBGRUPO
, ll.lnumber
;


WITH lotes AS (
SELECT DISTINCT
  TRUNC( (
    row_number()
      over(
      partition BY
        os.PROCONF_ITEM
      , t.ORDEM_TAMANHO
      order BY
        os.ORDEM_CONFECCAO
      )
    + 2 )/ 3 ) PACOTE
, os.ORDEM_PRODUCAO OP
, op.SITUACAO
, os.PERIODO_PRODUCAO PERIODO
, os.PROCONF_GRUPO REF
, os.PROCONF_ITEM COR
, t.ORDEM_TAMANHO TAMORD
, os.PROCONF_SUBGRUPO TAM
, os.ORDEM_CONFECCAO OC
, r.NARRATIVA
FROM PCPC_040 os
LEFT JOIN BASI_220 t -- tamanhos
  ON t.TAMANHO_REF = os.PROCONF_SUBGRUPO
JOIN PCPC_020 op -- OP capa
  ON op.ordem_producao = os.ORDEM_PRODUCAO
JOIN BASI_010 r
  ON r.NIVEL_ESTRUTURA = 1
 AND r.GRUPO_ESTRUTURA = os.PROCONF_GRUPO
 AND r.SUBGRU_ESTRUTURA = os.PROCONF_SUBGRUPO
 AND r.ITEM_ESTRUTURA = os.PROCONF_ITEM
WHERE 1=1
--  AND (os.ORDEM_PRODUCAO = %s or %s IS NULL)
--  AND (os.PROCONF_SUBGRUPO = %s OR %s IS NULL)
--  AND (os.PROCONF_ITEM = %s OR %s IS NULL)
  AND os.ORDEM_PRODUCAO = 4000
  AND os.PROCONF_ITEM = '0000PE'
GROUP BY
  os.ORDEM_PRODUCAO
, op.SITUACAO
, os.PERIODO_PRODUCAO
, os.PROCONF_GRUPO
, os.PROCONF_ITEM
, t.ORDEM_TAMANHO
, os.PROCONF_SUBGRUPO
, os.ORDEM_CONFECCAO
, r.NARRATIVA
)
SELECT
  ll.OP
, ll.SITUACAO
, ll.PERIODO
, ll.REF
, ll.COR
, ll.TAM
, ll.NARRATIVA
, ll.pacote
, MIN(ll.OC) OC1
, CASE COUNT(ll.OC)
  WHEN 1 THEN NULL
  WHEN 2 THEN MAX(ll.OC)
  WHEN 3 THEN AVG(ll.OC)
  END OC2
, CASE WHEN COUNT(ll.OC) = 3
  THEN MAX(ll.OC)
  ELSE NULL
  END OC3
FROM lotes ll
GROUP BY
  ll.OP
, ll.SITUACAO
, ll.PERIODO
, ll.REF
, ll.COR
, ll.TAMORD
, ll.TAM
, ll.NARRATIVA
, ll.pacote
ORDER BY
  ll.OP
, ll.SITUACAO
, ll.PERIODO
, ll.REF
, ll.COR
, ll.TAMORD
, ll.NARRATIVA
, ll.pacote
;


SELECT
  ll.OP
, ll.SITUACAO
, ll.PERIODO
, ll.REF
, ll.COR
, ll.TAM
, ll.NARRATIVA
, ll.pacote
, MIN(ll.OC) OC1
, CASE COUNT(ll.OC)
  WHEN 1 THEN NULL
  WHEN 2 THEN MAX(ll.OC)
  WHEN 3 THEN AVG(ll.OC)
  END OC2
, CASE WHEN COUNT(ll.OC) = 3
  THEN MAX(ll.OC)
  ELSE NULL
  END OC3
FROM (
SELECT DISTINCT
  TRUNC( (
    row_number()
      over(
      partition BY
        os.PROCONF_ITEM
      , t.ORDEM_TAMANHO
      order BY
        os.ORDEM_CONFECCAO
      )
    + 2 )/ 3 ) PACOTE
, os.ORDEM_PRODUCAO OP
, op.SITUACAO
, os.PERIODO_PRODUCAO PERIODO
, os.PROCONF_GRUPO REF
, os.PROCONF_ITEM COR
, t.ORDEM_TAMANHO TAMORD
, os.PROCONF_SUBGRUPO TAM
, os.ORDEM_CONFECCAO OC
, r.NARRATIVA
FROM PCPC_040 os
LEFT JOIN BASI_220 t -- tamanhos
  ON t.TAMANHO_REF = os.PROCONF_SUBGRUPO
JOIN PCPC_020 op -- OP capa
  ON op.ordem_producao = os.ORDEM_PRODUCAO
JOIN BASI_010 r
  ON r.NIVEL_ESTRUTURA = 1
 AND r.GRUPO_ESTRUTURA = os.PROCONF_GRUPO
 AND r.SUBGRU_ESTRUTURA = os.PROCONF_SUBGRUPO
 AND r.ITEM_ESTRUTURA = os.PROCONF_ITEM
WHERE 1=1
--  AND (os.ORDEM_PRODUCAO = %s or %s IS NULL)
--  AND (os.PROCONF_SUBGRUPO = %s OR %s IS NULL)
--  AND (os.PROCONF_ITEM = %s OR %s IS NULL)
  AND os.ORDEM_PRODUCAO = 4000
  AND os.PROCONF_ITEM = '0000PE'
GROUP BY
  os.ORDEM_PRODUCAO
, op.SITUACAO
, os.PERIODO_PRODUCAO
, os.PROCONF_GRUPO
, os.PROCONF_ITEM
, t.ORDEM_TAMANHO
, os.PROCONF_SUBGRUPO
, os.ORDEM_CONFECCAO
, r.NARRATIVA
) ll
GROUP BY
  ll.OP
, ll.SITUACAO
, ll.PERIODO
, ll.REF
, ll.COR
, ll.TAMORD
, ll.TAM
, ll.NARRATIVA
, ll.pacote
ORDER BY
  ll.OP
, ll.SITUACAO
, ll.PERIODO
, ll.REF
, ll.COR
, ll.TAMORD
, ll.NARRATIVA
, ll.pacote
;


WITH Table_qtd_lotes AS (
SELECT
  ll.OP
, ll.SITUACAO
, ll.PERIODO
, ll.REF
, ll.COR
, ll.TAM
, ll.NARRATIVA
, ll.pacote
, MIN(ll.OC) OC1
, CASE COUNT(ll.OC)
  WHEN 1 THEN NULL
  WHEN 2 THEN MAX(ll.OC)
  WHEN 3 THEN AVG(ll.OC)
  END OC2
, CASE WHEN COUNT(ll.OC) = 3
  THEN MAX(ll.OC)
  ELSE NULL
  END OC3
FROM (
SELECT DISTINCT
  TRUNC( (
    row_number()
      over(
      partition BY
        os.PROCONF_ITEM
      , t.ORDEM_TAMANHO
      order BY
        os.ORDEM_CONFECCAO
      )
    + 2 )/ 3 ) PACOTE
, os.ORDEM_PRODUCAO OP
, op.SITUACAO
, os.PERIODO_PRODUCAO PERIODO
, os.PROCONF_GRUPO REF
, os.PROCONF_ITEM COR
, t.ORDEM_TAMANHO TAMORD
, os.PROCONF_SUBGRUPO TAM
, os.ORDEM_CONFECCAO OC
, r.NARRATIVA
FROM PCPC_040 os
LEFT JOIN BASI_220 t -- tamanhos
  ON t.TAMANHO_REF = os.PROCONF_SUBGRUPO
JOIN PCPC_020 op -- OP capa
  ON op.ordem_producao = os.ORDEM_PRODUCAO
JOIN BASI_010 r
  ON r.NIVEL_ESTRUTURA = 1
 AND r.GRUPO_ESTRUTURA = os.PROCONF_GRUPO
 AND r.SUBGRU_ESTRUTURA = os.PROCONF_SUBGRUPO
 AND r.ITEM_ESTRUTURA = os.PROCONF_ITEM
WHERE 1=1
--  AND (os.ORDEM_PRODUCAO = %s or %s IS NULL)
--  AND (os.PROCONF_SUBGRUPO = %s OR %s IS NULL)
--  AND (os.PROCONF_ITEM = %s OR %s IS NULL)
  AND os.ORDEM_PRODUCAO = 4000
  AND os.PROCONF_ITEM = '0000PE'
GROUP BY
  os.ORDEM_PRODUCAO
, op.SITUACAO
, os.PERIODO_PRODUCAO
, os.PROCONF_GRUPO
, os.PROCONF_ITEM
, t.ORDEM_TAMANHO
, os.PROCONF_SUBGRUPO
, os.ORDEM_CONFECCAO
, r.NARRATIVA
) ll
GROUP BY
  ll.OP
, ll.SITUACAO
, ll.PERIODO
, ll.REF
, ll.COR
, ll.TAMORD
, ll.TAM
, ll.NARRATIVA
, ll.pacote
ORDER BY
  ll.OP
, ll.SITUACAO
, ll.PERIODO
, ll.REF
, ll.COR
, ll.TAMORD
, ll.NARRATIVA
, ll.pacote
)
select * from Table_qtd_lotes where rownum <= 4
;


                SELECT
                  f.NUM_NOTA_FISCAL NF
                , f.BASE_ICMS VALOR
                , f.QTDE_EMBALAGENS VOLUMES
                , f.DATA_AUTORIZACAO_NFE FATURAMENTO
                , CAST( COALESCE( '0' || f.COD_STATUS, '0' ) AS INT )
                  COD_STATUS
                , COALESCE( f.MSG_STATUS, ' ' ) MSG_STATUS
                , f.SITUACAO_NFISC SITUACAO
                , f.NATOP_NF_NAT_OPER NAT
                , f.NATOP_NF_EST_OPER UF
                , n.DESCR_NAT_OPER NATUREZA
                , f.CGC_9 CNPJ9
                , f.CGC_4 CNPJ4
                , f.CGC_2 CNPJ2
                , c.NOME_CLIENTE CLIENTE
                , COALESCE(
                    CASE WHEN f.TRANSPOR_FORNE9
                            + f.TRANSPOR_FORNE4
                            + f.TRANSPOR_FORNE2 = 0
                    THEN 'O PROPRIO'
                    ELSE COALESCE( t.NOME_FANTASIA
                                 , '(' || f.TRANSPOR_FORNE9 || '/' ||
                                   f.TRANSPOR_FORNE4 || '-' ||
                                   f.TRANSPOR_FORNE2 || ')' )
                    END
                  , '-') TRANSP
                , f.PEDIDO_VENDA PEDIDO
                , coalesce(p.COD_PED_CLIENTE, '') PED_CLIENTE
                FROM FATU_050 f
                LEFT JOIN PEDI_100 p
                  ON p.PEDIDO_VENDA = f.PEDIDO_VENDA
                JOIN PEDI_010 c
                  ON c.CGC_9 = f.CGC_9
                 AND c.CGC_4 = f.CGC_4
                 AND c.CGC_2 = f.CGC_2
                JOIN PEDI_080 n
                  ON n.NATUR_OPERACAO = f.NATOP_NF_NAT_OPER
                 AND n.ESTADO_NATOPER = f.NATOP_NF_EST_OPER
                LEFT JOIN SUPR_010 t
                  ON t.TIPO_FORNECEDOR = 31 -- transportadora
                 AND t.FORNECEDOR9 = f.TRANSPOR_FORNE9
                 AND t.FORNECEDOR4 = f.TRANSPOR_FORNE4
                 AND t.FORNECEDOR2 = f.TRANSPOR_FORNE2
                --WHERE rownum = 1
                ORDER BY
                  f.NUM_NOTA_FISCAL DESC
;


SELECT
  h.USUARIO_SISTEMA
, h.MAQUINA_REDE
FROM HIST_010 h
GROUP BY
  h.USUARIO_SISTEMA
, h.MAQUINA_REDE
ORDER BY
  h.USUARIO_SISTEMA
, h.MAQUINA_REDE
;

SELECT
  min(h.DATA_OCORR)
, max(h.DATA_OCORR)
FROM HIST_010 h
;

SELECT DISTINCT
  h.USUARIO_SISTEMA
FROM HIST_010 h
WHERE h.APLICACAO <> 'python@INTRANET'
;

SELECT
  u.ATIVO_INATIVO
, u.*
FROM HDOC_030 u
WHERE u.USUARIO NOT IN
(
SELECT DISTINCT
  h.USUARIO_SISTEMA
FROM HIST_010 h
WHERE h.APLICACAO <> 'python@INTRANET'
)
;

SELECT DISTINCT
  h.USUARIO_SISTEMA
, h.NOME_PROGRAMA
FROM HIST_010 h
ORDER BY
  h.USUARIO_SISTEMA
, h.NOME_PROGRAMA
;

SELECT DISTINCT
  h.*
FROM HIST_010 h
WHERE h.NOME_PROGRAMA = 'SQL'
;

SELECT DISTINCT
  h.APLICACAO
, h.NOME_PROGRAMA
, h.MAQUINA_REDE
FROM HIST_010 h
;

SELECT DISTINCT
  h.USUARIO_SISTEMA
, h.MAQUINA_REDE
FROM HIST_010 h
WHERE h.NOME_PROGRAMA <> 'SQL'
ORDER BY
  h.USUARIO_SISTEMA
, h.MAQUINA_REDE
;

SELECT
  ll.PCPC040_PERCONF
, ll.PCPC040_ORDCONF
, ll.PCPC040_ESTCONF
, count(*)
--, ll.*
FROM PCPC_045 ll
--WHERE ll.PCPC040_PERCONF = 1750
--  AND ll.PCPC040_ORDCONF = 216
GROUP BY
  ll.PCPC040_PERCONF
, ll.PCPC040_ORDCONF
, ll.PCPC040_ESTCONF
ORDER BY
  4 DESC
;

SELECT
  ll.PCPC040_PERCONF
, ll.PCPC040_ORDCONF
, ll.PCPC040_ESTCONF
, ll.DATA_INSERCAO
, max(ll.DATA_INSERCAO)
    over(
      partition BY
	    ll.PCPC040_PERCONF
	  , ll.PCPC040_ORDCONF
      )
FROM PCPC_045 ll
WHERE ll.PCPC040_PERCONF = 1750
  AND ll.PCPC040_ORDCONF = 216
;

SELECT
  ll.PCPC040_PERCONF
, ll.PCPC040_ORDCONF
, ll.DATA_INSERCAO
, count(*)
FROM PCPC_045 ll
GROUP BY
  ll.PCPC040_PERCONF
, ll.PCPC040_ORDCONF
, ll.DATA_INSERCAO
ORDER BY
  4 DESC
;


SELECT
  CURRENT_DATE
--, CURRENT_TIME
, CURRENT_TIMESTAMP
, ll.*
FROM PCPC_045 ll
;

SELECT
  t.*
FROM (
SELECT
  ll.PCPC040_PERCONF
, ll.PCPC040_ORDCONF
, ll.PCPC040_ESTCONF
--, l.SEQ_OPERACAO
--, ll.DATA_PRODUCAO
--, ll.HORA_PRODUCAO
--, ll.*
FROM PCPC_045 ll
JOIN pcpc_040 l
  ON l.PERIODO_PRODUCAO = ll.PCPC040_PERCONF
 AND l.ORDEM_CONFECCAO = ll.PCPC040_ORDCONF
 AND l.CODIGO_ESTAGIO = ll.PCPC040_ESTCONF
WHERE ll.PCPC040_PERCONF = 1720
  AND ll.PCPC040_ORDCONF = 1041
ORDER BY
  ll.DATA_INSERCAO DESC
, l.SEQ_OPERACAO DESC
) t
WHERE rownum = 1
;


SELECT
  0
, PERIODO_PRODUCAO, ORDEM_CONFECCAO, CODIGO_ESTAGIO, PROCONF_NIVEL99, PROCONF_GRUPO, PROCONF_SUBGRUPO, PROCONF_ITEM, QTDE_PECAS_PROG
, QTDE_PECAS_PROD ---------
, QTDE_CONSERTO, QTDE_PECAS_2A, ESTAGIO_ANTERIOR, SITUACAO_ORDEM, NUMERO_ORDEM, SEQ_ORDEM_SERV, DIV_PROD_INT, ORDEM_PRODUCAO, QTDE_PERDAS, QTDE_PROGRAMADA, SEQUENCIA_ESTAGIO
, ESTAGIO_DEPENDE, USUARIO, CODIGO_FAMILIA, POSICAO_FILA, POSICAO_FILA_MANUAL, SEQ_OPERACAO, DATA_PREV_INICIO, QTDE_PESSOAS_PREV, CODIGO_BALANCEIO, NUM_PACOTE_I
, NUM_PACOTE_F, NUMERO_ID_TMRP_650, EXPORTADO_PMS, EXECUTA_TRIGGER, SEQUENCIA_ENFESTO, EXCLUI_PACOTE, SEQ_QUEBRA, DATA_ALTERACAO
, QTDE_EM_PRODUCAO_PACOTE ---------
, QTDE_A_PRODUZIR_PACOTE ---------
, QTDE_DISPONIVEL_BAIXA ---------
, SITUACAO_EM_PROD_A_PROD, QTDE_PECAS_PROD_RECALC, QTDE_CONSERTO_RECALC, QTDE_PECAS_2A_RECALC, QTDE_PERDAS_RECALC, NOME_PROGRAMA_CRIACAO
, NOME_PROGRAMA ---------
, CODIGO_EMPRESA
FROM SYSTEXTIL.PCPC_040
WHERE PERIODO_PRODUCAO=1743 AND ORDEM_CONFECCAO=10128 AND CODIGO_ESTAGIO=51
UNION
SELECT
  1
, PERIODO_PRODUCAO, ORDEM_CONFECCAO, CODIGO_ESTAGIO, PROCONF_NIVEL99, PROCONF_GRUPO, PROCONF_SUBGRUPO, PROCONF_ITEM, QTDE_PECAS_PROG
, 0 QTDE_PECAS_PROD ---------
, QTDE_CONSERTO, QTDE_PECAS_2A, ESTAGIO_ANTERIOR, SITUACAO_ORDEM, NUMERO_ORDEM, SEQ_ORDEM_SERV, DIV_PROD_INT, ORDEM_PRODUCAO, QTDE_PERDAS, QTDE_PROGRAMADA, SEQUENCIA_ESTAGIO
, ESTAGIO_DEPENDE, USUARIO, CODIGO_FAMILIA, POSICAO_FILA, POSICAO_FILA_MANUAL, SEQ_OPERACAO, DATA_PREV_INICIO, QTDE_PESSOAS_PREV, CODIGO_BALANCEIO, NUM_PACOTE_I
, NUM_PACOTE_F, NUMERO_ID_TMRP_650, EXPORTADO_PMS, EXECUTA_TRIGGER, SEQUENCIA_ENFESTO, EXCLUI_PACOTE, SEQ_QUEBRA, DATA_ALTERACAO
, QTDE_PECAS_PROD QTDE_EM_PRODUCAO_PACOTE ---------
, QTDE_PECAS_PROD QTDE_A_PRODUZIR_PACOTE ---------
, QTDE_PECAS_PROD QTDE_DISPONIVEL_BAIXA ---------
, SITUACAO_EM_PROD_A_PROD, QTDE_PECAS_PROD_RECALC, QTDE_CONSERTO_RECALC, QTDE_PECAS_2A_RECALC, QTDE_PERDAS_RECALC, NOME_PROGRAMA_CRIACAO
, 'pcpc_f046' NOME_PROGRAMA ---------
, CODIGO_EMPRESA
FROM SYSTEXTIL.PCPC_040
WHERE PERIODO_PRODUCAO=1743 AND ORDEM_CONFECCAO=10128 AND CODIGO_ESTAGIO=51
;


SELECT
  le.*
FROM pcpc_040 le
WHERE le.PERIODO_PRODUCAO = 1743
  AND le.ORDEM_CONFECCAO IN (10127, 10128)
  AND le.CODIGO_ESTAGIO in (48, 51)
;


SELECT
  l2.*
FROM pcpc_045 l2
WHERE l2.PCPC040_PERCONF = 1743
  AND l2.PCPC040_ORDCONF IN (10127, 10128)
  AND l2.PCPC040_ESTCONF in (51)
;


SELECT
  l2.*
FROM pcpc_045 l2
JOIN pcpc_040 l
  ON l.PERIODO_PRODUCAO = l2.PCPC040_PERCONF
 AND l.ORDEM_CONFECCAO = l2.PCPC040_ORDCONF
 AND l.CODIGO_ESTAGIO = l2.PCPC040_ESTCONF
WHERE l.ORDEM_PRODUCAO = 3160
--  AND l.QTDE_PECAS_PROD <> 0
--  AND l2.PCPC040_ORDCONF NOT IN (10127, 10128)
  AND l2.PCPC040_ESTCONF = 51
ORDER BY
  l2.PCPC040_ORDCONF
, l2.SEQUENCIA
;


UPDATE SYSTEXTIL.PCPC_045
SET
  PROCESSO_SYSTEXTIL='pcpc_f046'
, USUARIO_SYSTEXTIL='ROSANGELA_PCP'
WHERE PCPC040_PERCONF=1743
  AND PCPC040_ORDCONF=10128
  AND PCPC040_ESTCONF=51
  AND SEQUENCIA=2
;

SELECT
  p.*
FROM HDOC_036 p
WHERE p.DESCRICAO like '%Estorn%'
;

UPDATE SYSTEXTIL.PCPC_040
SET
  PROCONF_NIVEL99 = PROCONF_NIVEL99
, PROCONF_GRUPO = PROCONF_GRUPO
, PROCONF_SUBGRUPO = PROCONF_SUBGRUPO
, PROCONF_ITEM = PROCONF_ITEM
, QTDE_PECAS_PROG = QTDE_PECAS_PROG
, QTDE_PECAS_PROD = 40 ----------------
, QTDE_CONSERTO = QTDE_CONSERTO
, QTDE_PECAS_2A = QTDE_PECAS_2A
, ESTAGIO_ANTERIOR = ESTAGIO_ANTERIOR
, SITUACAO_ORDEM = SITUACAO_ORDEM
, NUMERO_ORDEM = NUMERO_ORDEM
, SEQ_ORDEM_SERV = SEQ_ORDEM_SERV
, DIV_PROD_INT = DIV_PROD_INT
, ORDEM_PRODUCAO = ORDEM_PRODUCAO
, QTDE_PERDAS = QTDE_PERDAS
, QTDE_PROGRAMADA = QTDE_PROGRAMADA
, SEQUENCIA_ESTAGIO = SEQUENCIA_ESTAGIO
, ESTAGIO_DEPENDE = ESTAGIO_DEPENDE
, USUARIO = USUARIO
, CODIGO_FAMILIA = CODIGO_FAMILIA
, POSICAO_FILA = POSICAO_FILA
, POSICAO_FILA_MANUAL = POSICAO_FILA_MANUAL
, SEQ_OPERACAO = SEQ_OPERACAO
, DATA_PREV_INICIO = DATA_PREV_INICIO
, QTDE_PESSOAS_PREV = QTDE_PESSOAS_PREV
, CODIGO_BALANCEIO = CODIGO_BALANCEIO
, NUM_PACOTE_I = NUM_PACOTE_I
, NUM_PACOTE_F = NUM_PACOTE_F
, NUMERO_ID_TMRP_650 = NUMERO_ID_TMRP_650
, EXPORTADO_PMS = EXPORTADO_PMS
, EXECUTA_TRIGGER = EXECUTA_TRIGGER
, SEQUENCIA_ENFESTO = SEQUENCIA_ENFESTO
, EXCLUI_PACOTE = EXCLUI_PACOTE
, SEQ_QUEBRA = SEQ_QUEBRA
, DATA_ALTERACAO = DATA_ALTERACAO
, QTDE_EM_PRODUCAO_PACOTE = 0 ----------------
, QTDE_A_PRODUZIR_PACOTE = 0 ----------------
, QTDE_DISPONIVEL_BAIXA = 0 ----------------
, SITUACAO_EM_PROD_A_PROD = SITUACAO_EM_PROD_A_PROD
, QTDE_PECAS_PROD_RECALC = QTDE_PECAS_PROD_RECALC
, QTDE_CONSERTO_RECALC = QTDE_CONSERTO_RECALC
, QTDE_PECAS_2A_RECALC = QTDE_PECAS_2A_RECALC
, QTDE_PERDAS_RECALC = QTDE_PERDAS_RECALC
, NOME_PROGRAMA_CRIACAO = NOME_PROGRAMA_CRIACAO
, NOME_PROGRAMA = 'pcpc_f230' ----------------
, CODIGO_EMPRESA = CODIGO_EMPRESA
WHERE PERIODO_PRODUCAO = 1743
  AND ORDEM_CONFECCAO = 10128
  AND CODIGO_ESTAGIO = 51
;

INSERT INTO SYSTEXTIL.PCPC_045
(PCPC040_PERCONF, PCPC040_ORDCONF, PCPC040_ESTCONF, SEQUENCIA, DATA_PRODUCAO, HORA_PRODUCAO, QTDE_PRODUZIDA, QTDE_PECAS_2A, QTDE_CONSERTO, TURNO_PRODUCAO, TIPO_ENTRADA_ORD, NOTA_ENTR_ORDEM, SERIE_NF_ENT_ORD, SEQ_NF_ENTR_ORD, ORDEM_PRODUCAO, CODIGO_USUARIO, QTDE_PERDAS, NUMERO_DOCUMENTO, CODIGO_DEPOSITO, CODIGO_FAMILIA, CODIGO_INTERVALO, EXECUTA_TRIGGER, DATA_INSERCAO, PROCESSO_SYSTEXTIL, NUMERO_VOLUME, NR_OPERADORES, ATZ_PODE_PRODUZIR, ATZ_EM_PROD, ATZ_A_PROD, EFICIENCIA_INFORMADA, USUARIO_SYSTEXTIL, CODIGO_OCORRENCIA, COD_OCORRENCIA_ESTORNO, SOLICITACAO_CONSERTO, NUMERO_SOLICITACAO, NUMERO_ORDEM)
SELECT
  PCPC040_PERCONF
, PCPC040_ORDCONF
, PCPC040_ESTCONF
, SEQUENCIA+1 -- SEQUENCIA
, CURRENT_DATE -- DATA_PRODUCAO
, CURRENT_DATE -- HORA_PRODUCAO
, -QTDE_PRODUZIDA -- QTDE_PRODUZIDA
, QTDE_PECAS_2A
, QTDE_CONSERTO
, TURNO_PRODUCAO
, TIPO_ENTRADA_ORD
, NOTA_ENTR_ORDEM
, SERIE_NF_ENT_ORD
, SEQ_NF_ENTR_ORD
, ORDEM_PRODUCAO
, CODIGO_USUARIO
, QTDE_PERDAS
, NUMERO_DOCUMENTO
, CODIGO_DEPOSITO
, CODIGO_FAMILIA
, CODIGO_INTERVALO
, EXECUTA_TRIGGER
, CURRENT_DATE -- DATA_INSERCAO
, 'pcpc_f046' -- PROCESSO_SYSTEXTIL
, NUMERO_VOLUME
, NR_OPERADORES
, ATZ_PODE_PRODUZIR
, ATZ_EM_PROD
, ATZ_A_PROD
, EFICIENCIA_INFORMADA
, USUARIO_SYSTEXTIL
, CODIGO_OCORRENCIA
, COD_OCORRENCIA_ESTORNO
, SOLICITACAO_CONSERTO
, NUMERO_SOLICITACAO
, NUMERO_ORDEM
FROM SYSTEXTIL.PCPC_045
WHERE PCPC040_PERCONF=1743
  AND PCPC040_ORDCONF=10128
  AND PCPC040_ESTCONF=51
  AND SEQUENCIA=1
;


INSERT INTO SYSTEXTIL.PCPC_045
(PCPC040_PERCONF, PCPC040_ORDCONF, PCPC040_ESTCONF, SEQUENCIA, DATA_PRODUCAO, HORA_PRODUCAO, QTDE_PRODUZIDA, QTDE_PECAS_2A, QTDE_CONSERTO, TURNO_PRODUCAO, TIPO_ENTRADA_ORD, NOTA_ENTR_ORDEM, SERIE_NF_ENT_ORD, SEQ_NF_ENTR_ORD, ORDEM_PRODUCAO, CODIGO_USUARIO, QTDE_PERDAS, NUMERO_DOCUMENTO, CODIGO_DEPOSITO, CODIGO_FAMILIA, CODIGO_INTERVALO, EXECUTA_TRIGGER, DATA_INSERCAO, PROCESSO_SYSTEXTIL, NUMERO_VOLUME, NR_OPERADORES, ATZ_PODE_PRODUZIR, ATZ_EM_PROD, ATZ_A_PROD, EFICIENCIA_INFORMADA, USUARIO_SYSTEXTIL, CODIGO_OCORRENCIA, COD_OCORRENCIA_ESTORNO, SOLICITACAO_CONSERTO, NUMERO_SOLICITACAO, NUMERO_ORDEM)
SELECT
  l2.PCPC040_PERCONF
, l2.PCPC040_ORDCONF
, l2.PCPC040_ESTCONF
, l2.SEQUENCIA+1 -- SEQUENCIA
, CURRENT_DATE -- DATA_PRODUCAO
, CURRENT_DATE -- HORA_PRODUCAO
, -l2.QTDE_PRODUZIDA -- QTDE_PRODUZIDA
, l2.QTDE_PECAS_2A
, l2.QTDE_CONSERTO
, l2.TURNO_PRODUCAO
, l2.TIPO_ENTRADA_ORD
, l2.NOTA_ENTR_ORDEM
, l2.SERIE_NF_ENT_ORD
, l2.SEQ_NF_ENTR_ORD
, l2.ORDEM_PRODUCAO
, l2.CODIGO_USUARIO
, l2.QTDE_PERDAS
, l2.NUMERO_DOCUMENTO
, l2.CODIGO_DEPOSITO
, l2.CODIGO_FAMILIA
, l2.CODIGO_INTERVALO
, l2.EXECUTA_TRIGGER
, CURRENT_DATE -- DATA_INSERCAO
, 'pcpc_f046' -- PROCESSO_SYSTEXTIL
, l2.NUMERO_VOLUME
, l2.NR_OPERADORES
, l2.ATZ_PODE_PRODUZIR
, l2.ATZ_EM_PROD
, l2.ATZ_A_PROD
, l2.EFICIENCIA_INFORMADA
, l2.USUARIO_SYSTEXTIL
, l2.CODIGO_OCORRENCIA
, l2.COD_OCORRENCIA_ESTORNO
, l2.SOLICITACAO_CONSERTO
, l2.NUMERO_SOLICITACAO
, l2.NUMERO_ORDEM
FROM pcpc_045 l2
JOIN pcpc_040 l
  ON l.PERIODO_PRODUCAO = l2.PCPC040_PERCONF
 AND l.ORDEM_CONFECCAO = l2.PCPC040_ORDCONF
 AND l.CODIGO_ESTAGIO = l2.PCPC040_ESTCONF
WHERE l.ORDEM_PRODUCAO = 3160
  AND l.QTDE_PECAS_PROD <> 0
  AND l2.PCPC040_ORDCONF NOT IN (10127, 10128)
  AND l2.PCPC040_ESTCONF = 51
;

UPDATE SYSTEXTIL.PCPC_045 l2
SET
  l2.CODIGO_USUARIO = 99001
, l2.PROCESSO_SYSTEXTIL='pcpc_f046'
, l2.USUARIO_SYSTEXTIL='ANSELMO_SIS'
WHERE l2.PCPC040_PERCONF=1743
  AND l2.PCPC040_ORDCONF in
  (
  SELECT
    l.ORDEM_CONFECCAO
  FROM pcpc_040 l
  WHERE l.ORDEM_PRODUCAO = 3160
  )
  AND l2.PCPC040_ESTCONF=51
  AND l2.SEQUENCIA=2
;

SELECT
  o.*
FROM OBRF_082 o
WHERE o.NUMERO_ORDEM = 1486
;

SELECT DISTINCT
  l.SITUACAO_EM_PROD_A_PROD
, count(*)
FROM PCPC_040 l
--WHERE l.ORDEM_PRODUCAO = 4053
GROUP BY
  l.SITUACAO_EM_PROD_A_PROD
;

SELECT DISTINCT
  l.QTDE_PROGRAMADA
, l.QTDE_PECAS_PROG
, l.*
FROM PCPC_040 l
WHERE l.ORDEM_PRODUCAO >= 3981
  AND l.QTDE_PROGRAMADA <> l.QTDE_PECAS_PROG
;

SELECT DISTINCT
  l.CODIGO_FAMILIA
, l.PROCONF_GRUPO
, l.PROCONF_SUBGRUPO
, l.PROCONF_ITEM
, l.ORDEM_CONFECCAO
, l.QTDE_PROGRAMADA
, l.QTDE_PECAS_PROG
, l.CODIGO_ESTAGIO
, l.*
FROM PCPC_040 l
WHERE 1=1
  AND l.ORDEM_PRODUCAO = 3981
--  AND l.QTDE_PROGRAMADA <> l.QTDE_PECAS_PROG
  AND l.CODIGO_ESTAGIO = 27
ORDER BY
  l.PROCONF_GRUPO
, l.PROCONF_SUBGRUPO
, l.PROCONF_ITEM
, l.ORDEM_CONFECCAO
, l.CODIGO_ESTAGIO
;

SELECT
l21.CODIGO_FAMILIA
, l21.PERIODO_PRODUCAO
, l21.ORDEM_CONFECCAO
, l33.*
FROM PCPC_040 l21
JOIN pcpc_040 l33
ON l33.PERIODO_PRODUCAO = l21.PERIODO_PRODUCAO
AND l33.ORDEM_CONFECCAO = l21.ORDEM_CONFECCAO
JOIN pcpc_020 o
ON o.ORDEM_PRODUCAO = l21.ORDEM_PRODUCAO
WHERE o.ALTERNATIVA_PECA = 1
AND l21.CODIGO_ESTAGIO = 21
AND l21.CODIGO_FAMILIA <> 0
AND l33.CODIGO_ESTAGIO = 33
AND l33.CODIGO_FAMILIA = 0
AND (  l33.QTDE_PECAS_PROD <> 0
  OR l33.QTDE_CONSERTO <> 0
  OR l33.QTDE_PECAS_2A <> 0
  OR l33.QTDE_PERDAS <> 0
)
--ORDER BY l21.ORDEM_PRODUCAO DESC
;

UPDATE PCPC_040 l
SET
  l.CODIGO_FAMILIA = 1400
WHERE l.PERIODO_PRODUCAO = 1720
  AND l.ORDEM_CONFECCAO = 2507
  AND l.CODIGO_ESTAGIO = 33
;

SELECT
  *
FROM BASI_140
;

SELECT
  i.CODIGO_BARRAS
, i.*
FROM basi_010 i
WHERE i.NIVEL_ESTRUTURA = 1
  AND i.GRUPO_ESTRUTURA = '0620S'
  AND i.ITEM_ESTRUTURA IN ('0000MA')
;


SELECT
  x.GRUPO_PRODUTO
, x.ORDEM_PRODUCAO
, x.*
FROM TMRP_141 x -- reserva de rolo para OP
WHERE 1=1
--  AND x.GRUPO_PRODUTO = '0620S'
--  AND x.CODIGO_ROLO = 3648
  AND x.ORDEM_PRODUCAO = 3886
;

SELECT
  x.CODIGO_ROLO
, x.ORDEM_PRODUCAO
, x.ROLO_ESTOQUE
, x.*
FROM PCPT_020 x -- cadastro de rolos
WHERE 1=1
  AND x.PANOACAB_GRUPO = 'MA002'
--  AND x.ORDEM_PRODUCAO <> 0
--  AND x.CODIGO_ROLO = 370
--WHERE x.NUMERO_ROLO = 8080
--   OR x.NUMERO_LOTE = 8080
--   OR x.NR_VOLUME = 8080
--   OR x.NR_SOLIC_VOLUME = 8080
--   OR x.NUMERO_PROGRAMA = 8080
--   OR x.NR_ROLO_ORIGEM = 8080
--   OR x.NUMERO_TUBETE = 8080
  AND x.ROLO_ESTOQUE = 3
ORDER BY
  x.CODIGO_ROLO
;

SELECT
  i.CODIGO_BARRAS
, i.*
FROM basi_010 i
WHERE i.NIVEL_ESTRUTURA = 1
  AND i.GRUPO_ESTRUTURA = '00251'
  AND i.ITEM_ESTRUTURA IN ('0000AZ')
--  AND i.SUBGRU_ESTRUTURA IN ('GG')
ORDER BY
  i.ITEM_ESTRUTURA
, i.SUBGRU_ESTRUTURA
;

SELECT
  f.NUM_NOTA_FISCAL NF
, f.BASE_ICMS VALOR
, f.QTDE_EMBALAGENS VOLUMES
, f.DATA_AUTORIZACAO_NFE FATURAMENTO
, CAST( COALESCE( '0' || f.COD_STATUS, '0' ) AS INT )
  COD_STATUS
, COALESCE( f.MSG_STATUS, ' ' ) MSG_STATUS
, f.SITUACAO_NFISC SITUACAO
, f.NATOP_NF_NAT_OPER NAT
, f.NATOP_NF_EST_OPER UF
, n.DESCR_NAT_OPER NATUREZA
, f.CGC_9 CNPJ9
, f.CGC_4 CNPJ4
, f.CGC_2 CNPJ2
, c.NOME_CLIENTE CLIENTE
, COALESCE(
    CASE WHEN f.TRANSPOR_FORNE9
            + f.TRANSPOR_FORNE4
            + f.TRANSPOR_FORNE2 = 0
    THEN 'O PROPRIO'
    ELSE COALESCE( t.NOME_FANTASIA
                 , '(' || f.TRANSPOR_FORNE9 || '/' || f.TRANSPOR_FORNE4 || '-' || f.TRANSPOR_FORNE2 || ')' )
    END
  , '-' ) TRANSP
, f.TRANSPOR_FORNE9
, f.TRANSPOR_FORNE4
, f.TRANSPOR_FORNE2
FROM FATU_050 f
JOIN PEDI_010 c
  ON c.CGC_9 = f.CGC_9
 AND c.CGC_4 = f.CGC_4
 AND c.CGC_2 = f.CGC_2
JOIN PEDI_080 n
  ON n.NATUR_OPERACAO = f.NATOP_NF_NAT_OPER
 AND n.ESTADO_NATOPER = f.NATOP_NF_EST_OPER
LEFT JOIN SUPR_010 t
  ON t.TIPO_FORNECEDOR = 31 -- transportadora
 AND t.FORNECEDOR9 = f.TRANSPOR_FORNE9
 AND t.FORNECEDOR4 = f.TRANSPOR_FORNE4
 AND t.FORNECEDOR2 = f.TRANSPOR_FORNE2
--WHERE rownum = 1
WHERE
  f.NUM_NOTA_FISCAL = 61284
ORDER BY
  f.NUM_NOTA_FISCAL DESC
;


SELECT
  x.GRUPO_PRODUTO
, x.ORDEM_PRODUCAO
, x.*
FROM TMRP_141 x -- reserva de rolo para OP
WHERE 1=1
--  AND x.GRUPO_PRODUTO = 'MA005'
  AND x.CODIGO_ROLO = 9584
--  AND x.ORDEM_PRODUCAO <> 0
;


SELECT
  x.CODIGO_ROLO
, x.ORDEM_PRODUCAO
, x.ROLO_ESTOQUE
, x.*
FROM PCPT_020 x -- cadastro de rolos
WHERE 1=1
--  AND x.PANOACAB_GRUPO = 'MA004'
--  AND x.ORDEM_PRODUCAO <> 0
  AND x.CODIGO_ROLO = 9584
--WHERE x.NUMERO_ROLO = 8080
--   OR x.NUMERO_LOTE = 8080
--   OR x.NR_VOLUME = 8080
--   OR x.NR_SOLIC_VOLUME = 8080
--   OR x.NUMERO_PROGRAMA = 8080
--   OR x.NR_ROLO_ORIGEM = 8080
--   OR x.NUMERO_TUBETE = 8080
ORDER BY
  x.CODIGO_ROLO
;

UPDATE PCPT_020 x
SET
  x.ROLO_ESTOQUE = 1
WHERE x.CODIGO_ROLO = 9584
;

SELECT
  x.*
FROM PCPT_025 x -- confirmação de rolo
WHERE x.CODIGO_ROLO = 9584
;


SELECT
  x.*
FROM TMRP_141 x -- reserva de rolo para OP
WHERE x.CODIGO_ROLO = 9584
;


SELECT
  x.CODIGO_ROLO
, x.ORDEM_PRODUCAO
, x.ROLO_ESTOQUE
, x.*
FROM PCPT_020 x -- cadastro de rolos
WHERE x.CODIGO_ROLO = 9584
;


                SELECT
                  f.NUM_NOTA_FISCAL NF
                , f.BASE_ICMS VALOR
                , f.QTDE_EMBALAGENS VOLUMES
                , f.DATA_AUTORIZACAO_NFE FATURAMENTO
                , CAST( COALESCE( '0' || f.COD_STATUS, '0' ) AS INT )
                  COD_STATUS
                , COALESCE( f.MSG_STATUS, ' ' ) MSG_STATUS
                , f.SITUACAO_NFISC SITUACAO
                , f.NATOP_NF_NAT_OPER NAT
                , f.NATOP_NF_EST_OPER UF
                , n.DESCR_NAT_OPER NATUREZA
                , f.CGC_9 CNPJ9
                , f.CGC_4 CNPJ4
                , f.CGC_2 CNPJ2
                , c.NOME_CLIENTE CLIENTE
                , COALESCE(
                    CASE WHEN f.TRANSPOR_FORNE9
                            + f.TRANSPOR_FORNE4
                            + f.TRANSPOR_FORNE2 = 0
                    THEN 'O PROPRIO'
                    ELSE COALESCE( t.NOME_FANTASIA
                                 , '(' || f.TRANSPOR_FORNE9 || '/' ||
                                   f.TRANSPOR_FORNE4 || '-' ||
                                   f.TRANSPOR_FORNE2 || ')' )
                    END
                  , '-') TRANSP
                , f.PEDIDO_VENDA PEDIDO
                , p.COD_PED_CLIENTE PED_CLIENTE
                FROM FATU_050 f
                JOIN PEDI_100 p
                  ON p.PEDIDO_VENDA = f.PEDIDO_VENDA
                JOIN PEDI_010 c
                  ON c.CGC_9 = f.CGC_9
                 AND c.CGC_4 = f.CGC_4
                 AND c.CGC_2 = f.CGC_2
                JOIN PEDI_080 n
                  ON n.NATUR_OPERACAO = f.NATOP_NF_NAT_OPER
                 AND n.ESTADO_NATOPER = f.NATOP_NF_EST_OPER
                LEFT JOIN SUPR_010 t
                  ON t.TIPO_FORNECEDOR = 31 -- transportadora
                 AND t.FORNECEDOR9 = f.TRANSPOR_FORNE9
                 AND t.FORNECEDOR4 = f.TRANSPOR_FORNE4
                 AND t.FORNECEDOR2 = f.TRANSPOR_FORNE2
                --WHERE rownum = 1
                ORDER BY
                  f.NUM_NOTA_FISCAL DESC
;

        WITH Table_qtd_lotes AS (
        SELECT
          ll.OP
        , ll.COR
        , ll.TAM
        , ll.pacote
        , MIN(ll.OC) OC1
        , CASE COUNT(ll.OC)
          WHEN 1 THEN NULL
          WHEN 2 THEN MAX(ll.OC)
          WHEN 3 THEN AVG(ll.OC)
          END OC2
        , CASE WHEN COUNT(ll.OC) = 3
          THEN MAX(ll.OC)
          ELSE NULL
          END OC3
        FROM (
        SELECT DISTINCT
          TRUNC( (
            row_number()
              over(
              partition BY
                os.PROCONF_ITEM
              , os.PROCONF_SUBGRUPO
              order BY
                os.ORDEM_CONFECCAO
              )
            + 2 )/ 3 ) PACOTE
        , os.ORDEM_PRODUCAO OP
        , os.PROCONF_ITEM COR
        , os.PROCONF_SUBGRUPO TAM
        , os.ORDEM_CONFECCAO OC
        FROM PCPC_040 os
        WHERE os.ORDEM_PRODUCAO = 4000
        GROUP BY
          os.ORDEM_PRODUCAO
        , os.PROCONF_ITEM
        , os.PROCONF_SUBGRUPO
        , os.ORDEM_CONFECCAO
        ) ll
        GROUP BY
          ll.OP
        , ll.COR
        , ll.TAM
        , ll.pacote
        )
        select
          tb.*
        , ( SELECT
			  max( os.QTDE_PECAS_PROG )
			FROM PCPC_040 os
			WHERE os.PERIODO_PRODUCAO = o.PERIODO_PRODUCAO
			  AND os.ORDEM_CONFECCAO = tb.OC1
		  )	QTD1
        , ( SELECT
			  max( os.QTDE_PECAS_PROG )
			FROM PCPC_040 os
			WHERE os.PERIODO_PRODUCAO = o.PERIODO_PRODUCAO
			  AND os.ORDEM_CONFECCAO = tb.OC2
		  )	QTD2
        , ( SELECT
			  max( os.QTDE_PECAS_PROG )
			FROM PCPC_040 os
			WHERE os.PERIODO_PRODUCAO = o.PERIODO_PRODUCAO
			  AND os.ORDEM_CONFECCAO = tb.OC3
		  )	QTD3
        , o.SITUACAO
        , o.PERIODO_PRODUCAO PERIODO
        , o.REFERENCIA_PECA REF
        , t.ORDEM_TAMANHO TAMORD
        , r.NARRATIVA
        from Table_qtd_lotes tb
        JOIN PCPC_020 o -- OP capa
          ON o.ORDEM_PRODUCAO = tb.OP
        JOIN BASI_220 t -- tamanhos
          ON t.TAMANHO_REF = tb.TAM
        JOIN BASI_010 r
          ON r.NIVEL_ESTRUTURA = 1
         AND r.GRUPO_ESTRUTURA = o.REFERENCIA_PECA
         AND r.SUBGRU_ESTRUTURA = tb.TAM
         AND r.ITEM_ESTRUTURA = tb.COR
        ORDER BY
          tb.COR
        , t.ORDEM_TAMANHO
        , tb.pacote
;


  SELECT
    max( os.QTDE_PECAS_PROG ) QTD1
  FROM PCPC_040 os
  WHERE os.PERIODO_PRODUCAO = 1750
    AND os.ORDEM_CONFECCAO = 6709
;

insert into hdoc_035
(codigo_programa, descricao, programa_menu, item_menu_def)
values
('spdf_f001', 'Produtos em Processos', 0, 1)
;

insert into hdoc_033
(usu_prg_cdusu, usu_prg_empr_usu, programa, nome_menu, item_menu, ordem_menu, incluir, modificar, excluir, procurar)
values
('INTERSYS', 1, 'spdf_f001', 'obrf_menu', 1 , 2, 'S', 'S', 'S', 'S')
;

insert into hdoc_033
(usu_prg_cdusu, usu_prg_empr_usu, programa, nome_menu, item_menu, ordem_menu, incluir, modificar, excluir, procurar)
values
('TREINAMENTO', 1, 'spdf_f001', 'obrf_menu', 1 , 2, 'S', 'S', 'S', 'S')
;

SELECT
  x.ROLO_ESTOQUE
, x.TRANSACAO_CARDEX
, x.DATA_CARDEX
, x.*
FROM PCPT_020 x -- cadastro de rolos
WHERE 1=1
--  AND x.ROLO_ESTOQUE = 3
--  AND x.CODIGO_ROLO = 1009 -- 11443
  AND x.CODIGO_ROLO = 11443
ORDER BY
  x.CODIGO_ROLO DESC
;

SELECT
  x.*
FROM PCPT_025 x -- confirmação de rolo
WHERE x.CODIGO_ROLO = 11843
;


-- produtos com roteiro fluxo 1 de PA
SELECT
  r.NIVEL_ESTRUTURA
, r.RESPONSAVEL
, r.REFERENCIA
, r.COLECAO
, r.*
FROM basi_030 r -- referência
WHERE r.NIVEL_ESTRUTURA = 1
  AND r.RESPONSAVEL IS NOT NULL
  AND r.REFERENCIA < 'A'o.SITUACAO
  AND r.COLECAO IN (1, 2, 3, 4, 8, 13, 14, 15)
;

SELECT
  r.*
FROM basi_030 r -- referência
WHERE r.NIVEL_ESTRUTURA = 1
  AND r.RESPONSAVEL IS NOT NULL
  AND r.REFERENCIA < 'A'
  AND r.COLECAO IN (1, 2, 3, 4, 8, 13, 14, 15)
  AND rownum <= 2

-- roteiros (lista de operações de uma alternativa de produto)
SELECT
  rot.*
FROM MQOP_050 rot
WHERE rot.GRUPO_ESTRUTURA = '0617M'
--  AND rot.NUMERO_ROTEIRO = 1
ORDER BY
  rot.NUMERO_ROTEIRO
, rot.SEQ_OPERACAO
;

-- roteiros de produtos selecionados (lista de operações de uma alternativa de produto)
SELECT
  rot.*
FROM MQOP_050 rot
JOIN
(
SELECT
  r.*
FROM basi_030 r -- referência
WHERE r.NIVEL_ESTRUTURA = 1
  AND r.RESPONSAVEL IS NOT NULL
  AND r.REFERENCIA < 'A'
  AND r.COLECAO IN (1, 2, 3, 4, 8, 13, 14, 15)
  AND rownum = 1
) ref ON rot.GRUPO_ESTRUTURA = REF.REFERENCIA
;

-- capa de roteiro - onde define o nome dos roteiros das alternativas de referências
SELECT
  rot.*
FROM BASI_070 rot
WHERE rot.GRUPO = 'Z01PA'
;

-- cadastro de estágios
SELECT
  rot.*
FROM MQOP_005 rot
;

-- cadastro de operações
SELECT
  rot.*
FROM MQOP_040 rot
;

-- capa de roteiros de produtos selecionados
SELECT
  rot.*
FROM BASI_070 rot
JOIN
(
SELECT
  r.*
FROM basi_030 r -- referência
WHERE r.NIVEL_ESTRUTURA = 1
  AND r.RESPONSAVEL IS NOT NULL
  AND r.REFERENCIA < 'A'
  AND r.COLECAO IN (1, 2, 3, 4, 8, 13, 14, 15)
  AND rownum = 1
) ref ON rot.GRUPO = REF.REFERENCIA
;

SELECT
  rotp.NIVEL_ESTRUTURA
, rotp.GRUPO_ESTRUTURA
, rotp.SUBGRU_ESTRUTURA
, rotp.ITEM_ESTRUTURA
, rotp.NUMERO_ALTERNATI
, rotp.NUMERO_ROTEIRO
, rotp.SEQ_OPERACAO
, rotp.CODIGO_OPERACAO
, rotp.MINUTOS
, rotp.CODIGO_ESTAGIO
, rotp.CENTRO_CUSTO
, rotp.SEQUENCIA_ESTAGIO
, rotp.ESTAGIO_ANTERIOR
, rotp.ESTAGIO_DEPENDE
, rotp.SEPARA_OPERACAO
, rotp.MINUTOS_HOMEM
, rotp.CCUSTO_HOMEM
, rotp.NUMERO_CORDAS
, rotp.NUMERO_ROLOS
, rotp.VELOCIDADE
, rotp.CODIGO_FAMILIA
, rotp.OBSERVACAO
, rotp.TIPO_PROCESSO
, rotp.PECAS_1_HORA
, rotp.PECAS_8_HORAS
, rotp.CUSTO_MINUTO
, rotp.PERC_EFICIENCIA
, rotp.TEMPERATURA
, rotp.TEMPO_LOTE_PRODUCAO
, rotp.PECAS_LOTE_PRODUCAO
, rotp.TIME_CELULA
, rotp.CODIGO_APARELHO
, rotp.PERC_EFIC_ROT
, rotp.NUMERO_OPERADORAS
, rotp.CONSIDERA_EFIC
, rotp.SEQ_OPERACAO_AGRUPADORA
, rotp.CODIGO_PARTE_PECA
, rotp.SEQ_JUNCAO_PARTE_PECA
, rotp.SITUACAO
, rotp.PERC_PERDAS
, rotp.PERC_CUSTOS
, rotp.IND_ESTAGIO_GARGALO
FROM SYSTEXTIL.MQOP_050 rotp
WHERE rotp.GRUPO_ESTRUTURA='Z01PA'
--  AND rotp.NUMERO_ROTEIRO=1
;

SELECT
  rotp.NIVEL_ESTRUTURA nivel
, rotp.GRUPO_ESTRUTURA ref
, rotp.SUBGRU_ESTRUTURA tam
, rotp.ITEM_ESTRUTURA cor
, rotp.NUMERO_ALTERNATI alt
, rotp.NUMERO_ROTEIRO roteiro
, rotp.SEQ_OPERACAO seq_op
, rotp.IND_ESTAGIO_GARGALO gargalo
, rotp.CODIGO_OPERACAO operacao
, rotp.CODIGO_ESTAGIO estagio
, rotp.SEQUENCIA_ESTAGIO seq_est
FROM SYSTEXTIL.MQOP_050 rotp
WHERE rotp.GRUPO_ESTRUTURA='Z01PA'
--  AND rotp.NUMERO_ROTEIRO=1
ORDER BY
  rotp.GRUPO_ESTRUTURA
, rotp.NUMERO_ROTEIRO
, rotp.SEQ_OPERACAO
;

SELECT
  rotp.NIVEL_ESTRUTURA
, ref.REFERENCIA GRUPO_ESTRUTURA
, rotp.SUBGRU_ESTRUTURA
, rotp.ITEM_ESTRUTURA
, rotp.NUMERO_ALTERNATI
, rotp.NUMERO_ROTEIRO
, rotp.SEQ_OPERACAO
, rotp.CODIGO_OPERACAO
, rotp.MINUTOS
, rotp.CODIGO_ESTAGIO
, rotp.CENTRO_CUSTO
, rotp.SEQUENCIA_ESTAGIO
, rotp.ESTAGIO_ANTERIOR
, rotp.ESTAGIO_DEPENDE
, rotp.SEPARA_OPERACAO
, rotp.MINUTOS_HOMEM
, rotp.CCUSTO_HOMEM
, rotp.NUMERO_CORDAS
, rotp.NUMERO_ROLOS
, rotp.VELOCIDADE
, rotp.CODIGO_FAMILIA
, rotp.OBSERVACAO
, rotp.TIPO_PROCESSO
, rotp.PECAS_1_HORA
, rotp.PECAS_8_HORAS
, rotp.CUSTO_MINUTO
, rotp.PERC_EFICIENCIA
, rotp.TEMPERATURA
, rotp.TEMPO_LOTE_PRODUCAO
, rotp.PECAS_LOTE_PRODUCAO
, rotp.TIME_CELULA
, rotp.CODIGO_APARELHO
, rotp.PERC_EFIC_ROT
, rotp.NUMERO_OPERADORAS
, rotp.CONSIDERA_EFIC
, rotp.SEQ_OPERACAO_AGRUPADORA
, rotp.CODIGO_PARTE_PECA
, rotp.SEQ_JUNCAO_PARTE_PECA
, rotp.SITUACAO
, rotp.PERC_PERDAS
, rotp.PERC_CUSTOS
, rotp.IND_ESTAGIO_GARGALO
FROM SYSTEXTIL.MQOP_050 rotp
,
(
SELECT
  r.*
FROM basi_030 r -- referência
WHERE r.NIVEL_ESTRUTURA = 1
  AND r.RESPONSAVEL IS NOT NULL
  AND r.REFERENCIA < 'A'
  AND r.COLECAO IN (1, 2, 3, 4, 8, 13, 14, 15)
  AND rownum = 1
) ref
WHERE rotp.GRUPO_ESTRUTURA='Z01PA' AND rotp.NUMERO_ROTEIRO=1
;

INSERT INTO SYSTEXTIL.MQOP_050
(NIVEL_ESTRUTURA, GRUPO_ESTRUTURA, SUBGRU_ESTRUTURA, ITEM_ESTRUTURA, NUMERO_ALTERNATI, NUMERO_ROTEIRO, SEQ_OPERACAO, CODIGO_OPERACAO, MINUTOS, CODIGO_ESTAGIO, CENTRO_CUSTO, SEQUENCIA_ESTAGIO, ESTAGIO_ANTERIOR, ESTAGIO_DEPENDE, SEPARA_OPERACAO, MINUTOS_HOMEM, CCUSTO_HOMEM, NUMERO_CORDAS, NUMERO_ROLOS, VELOCIDADE, CODIGO_FAMILIA, OBSERVACAO, TIPO_PROCESSO, PECAS_1_HORA, PECAS_8_HORAS, CUSTO_MINUTO, PERC_EFICIENCIA, TEMPERATURA, TEMPO_LOTE_PRODUCAO, PECAS_LOTE_PRODUCAO, TIME_CELULA, CODIGO_APARELHO, PERC_EFIC_ROT, NUMERO_OPERADORAS, CONSIDERA_EFIC, SEQ_OPERACAO_AGRUPADORA, CODIGO_PARTE_PECA, SEQ_JUNCAO_PARTE_PECA, SITUACAO, PERC_PERDAS, PERC_CUSTOS, IND_ESTAGIO_GARGALO)
SELECT
  rotp.NIVEL_ESTRUTURA
, ref.REFERENCIA GRUPO_ESTRUTURA
, rotp.SUBGRU_ESTRUTURA
, rotp.ITEM_ESTRUTURA
, rotp.NUMERO_ALTERNATI
, rotp.NUMERO_ROTEIRO
, rotp.SEQ_OPERACAO
, rotp.CODIGO_OPERACAO
, rotp.MINUTOS
, rotp.CODIGO_ESTAGIO
, rotp.CENTRO_CUSTO
, rotp.SEQUENCIA_ESTAGIO
, rotp.ESTAGIO_ANTERIOR
, rotp.ESTAGIO_DEPENDE
, rotp.SEPARA_OPERACAO
, rotp.MINUTOS_HOMEM
, rotp.CCUSTO_HOMEM
, rotp.NUMERO_CORDAS
, rotp.NUMERO_ROLOS
, rotp.VELOCIDADE
, rotp.CODIGO_FAMILIA
, rotp.OBSERVACAO
, rotp.TIPO_PROCESSO
, rotp.PECAS_1_HORA
, rotp.PECAS_8_HORAS
, rotp.CUSTO_MINUTO
, rotp.PERC_EFICIENCIA
, rotp.TEMPERATURA
, rotp.TEMPO_LOTE_PRODUCAO
, rotp.PECAS_LOTE_PRODUCAO
, rotp.TIME_CELULA
, rotp.CODIGO_APARELHO
, rotp.PERC_EFIC_ROT
, rotp.NUMERO_OPERADORAS
, rotp.CONSIDERA_EFIC
, rotp.SEQ_OPERACAO_AGRUPADORA
, rotp.CODIGO_PARTE_PECA
, rotp.SEQ_JUNCAO_PARTE_PECA
, rotp.SITUACAO
, rotp.PERC_PERDAS
, rotp.PERC_CUSTOS
, rotp.IND_ESTAGIO_GARGALO
FROM SYSTEXTIL.MQOP_050 rotp
,
(
SELECT
  r.*
FROM basi_030 r -- referência
WHERE r.NIVEL_ESTRUTURA = 1
  AND r.RESPONSAVEL IS NOT NULL
  AND r.REFERENCIA < 'A'
  AND r.COLECAO IN (1, 2, 3, 4, 8, 13, 14, 15)
  AND rownum = 1
) ref
WHERE rotp.GRUPO_ESTRUTURA='Z01PA'
--  AND rotp.NUMERO_ROTEIRO=1
;

INSERT INTO SYSTEXTIL.MQOP_050
(NIVEL_ESTRUTURA, GRUPO_ESTRUTURA, SUBGRU_ESTRUTURA, ITEM_ESTRUTURA, NUMERO_ALTERNATI, NUMERO_ROTEIRO, SEQ_OPERACAO, CODIGO_OPERACAO, MINUTOS, CODIGO_ESTAGIO, CENTRO_CUSTO, SEQUENCIA_ESTAGIO, ESTAGIO_ANTERIOR, ESTAGIO_DEPENDE, SEPARA_OPERACAO, MINUTOS_HOMEM, CCUSTO_HOMEM, NUMERO_CORDAS, NUMERO_ROLOS, VELOCIDADE, CODIGO_FAMILIA, OBSERVACAO, TIPO_PROCESSO, PECAS_1_HORA, PECAS_8_HORAS, CUSTO_MINUTO, PERC_EFICIENCIA, TEMPERATURA, TEMPO_LOTE_PRODUCAO, PECAS_LOTE_PRODUCAO, TIME_CELULA, CODIGO_APARELHO, PERC_EFIC_ROT, NUMERO_OPERADORAS, CONSIDERA_EFIC, SEQ_OPERACAO_AGRUPADORA, CODIGO_PARTE_PECA, SEQ_JUNCAO_PARTE_PECA, SITUACAO, PERC_PERDAS, PERC_CUSTOS, IND_ESTAGIO_GARGALO)
VALUES('1', '0617M', '000', '000000', 3, 3, 3, 18, 0, 18, 0, 1, 0, 0, NULL, 0, 0, 0, 0, 0, 0, NULL, 0, 0, 0, 0, 0, 0, 0, 0, 0, NULL, 0, 0, 0, 0, NULL, 0, 0, 0, 0, 1);
INSERT INTO SYSTEXTIL.MQOP_050
(NIVEL_ESTRUTURA, GRUPO_ESTRUTURA, SUBGRU_ESTRUTURA, ITEM_ESTRUTURA, NUMERO_ALTERNATI, NUMERO_ROTEIRO, SEQ_OPERACAO, CODIGO_OPERACAO, MINUTOS, CODIGO_ESTAGIO, CENTRO_CUSTO, SEQUENCIA_ESTAGIO, ESTAGIO_ANTERIOR, ESTAGIO_DEPENDE, SEPARA_OPERACAO, MINUTOS_HOMEM, CCUSTO_HOMEM, NUMERO_CORDAS, NUMERO_ROLOS, VELOCIDADE, CODIGO_FAMILIA, OBSERVACAO, TIPO_PROCESSO, PECAS_1_HORA, PECAS_8_HORAS, CUSTO_MINUTO, PERC_EFICIENCIA, TEMPERATURA, TEMPO_LOTE_PRODUCAO, PECAS_LOTE_PRODUCAO, TIME_CELULA, CODIGO_APARELHO, PERC_EFIC_ROT, NUMERO_OPERADORAS, CONSIDERA_EFIC, SEQ_OPERACAO_AGRUPADORA, CODIGO_PARTE_PECA, SEQ_JUNCAO_PARTE_PECA, SITUACAO, PERC_PERDAS, PERC_CUSTOS, IND_ESTAGIO_GARGALO)
VALUES('1', '0617M', '000', '000000', 3, 3, 6, 21, 0, 21, 0, 2, 0, 0, NULL, 0, 0, 0, 0, 0, 0, NULL, 0, 0, 0, 0, 0, 0, 0, 0, 0, NULL, 0, 0, 0, 0, NULL, 0, 0, 0, 0, 1);
INSERT INTO SYSTEXTIL.MQOP_050
(NIVEL_ESTRUTURA, GRUPO_ESTRUTURA, SUBGRU_ESTRUTURA, ITEM_ESTRUTURA, NUMERO_ALTERNATI, NUMERO_ROTEIRO, SEQ_OPERACAO, CODIGO_OPERACAO, MINUTOS, CODIGO_ESTAGIO, CENTRO_CUSTO, SEQUENCIA_ESTAGIO, ESTAGIO_ANTERIOR, ESTAGIO_DEPENDE, SEPARA_OPERACAO, MINUTOS_HOMEM, CCUSTO_HOMEM, NUMERO_CORDAS, NUMERO_ROLOS, VELOCIDADE, CODIGO_FAMILIA, OBSERVACAO, TIPO_PROCESSO, PECAS_1_HORA, PECAS_8_HORAS, CUSTO_MINUTO, PERC_EFICIENCIA, TEMPERATURA, TEMPO_LOTE_PRODUCAO, PECAS_LOTE_PRODUCAO, TIME_CELULA, CODIGO_APARELHO, PERC_EFIC_ROT, NUMERO_OPERADORAS, CONSIDERA_EFIC, SEQ_OPERACAO_AGRUPADORA, CODIGO_PARTE_PECA, SEQ_JUNCAO_PARTE_PECA, SITUACAO, PERC_PERDAS, PERC_CUSTOS, IND_ESTAGIO_GARGALO)
VALUES('1', '0617M', '000', '000000', 3, 3, 10, 24, 0, 24, 0, 3, 0, 0, NULL, 0, 0, 0, 0, 0, 0, NULL, 0, 0, 0, 0, 0, 0, 0, 0, 0, NULL, 0, 0, 0, 0, NULL, 0, 0, 0, 0, 1);
INSERT INTO SYSTEXTIL.MQOP_050
(NIVEL_ESTRUTURA, GRUPO_ESTRUTURA, SUBGRU_ESTRUTURA, ITEM_ESTRUTURA, NUMERO_ALTERNATI, NUMERO_ROTEIRO, SEQ_OPERACAO, CODIGO_OPERACAO, MINUTOS, CODIGO_ESTAGIO, CENTRO_CUSTO, SEQUENCIA_ESTAGIO, ESTAGIO_ANTERIOR, ESTAGIO_DEPENDE, SEPARA_OPERACAO, MINUTOS_HOMEM, CCUSTO_HOMEM, NUMERO_CORDAS, NUMERO_ROLOS, VELOCIDADE, CODIGO_FAMILIA, OBSERVACAO, TIPO_PROCESSO, PECAS_1_HORA, PECAS_8_HORAS, CUSTO_MINUTO, PERC_EFICIENCIA, TEMPERATURA, TEMPO_LOTE_PRODUCAO, PECAS_LOTE_PRODUCAO, TIME_CELULA, CODIGO_APARELHO, PERC_EFIC_ROT, NUMERO_OPERADORAS, CONSIDERA_EFIC, SEQ_OPERACAO_AGRUPADORA, CODIGO_PARTE_PECA, SEQ_JUNCAO_PARTE_PECA, SITUACAO, PERC_PERDAS, PERC_CUSTOS, IND_ESTAGIO_GARGALO)
VALUES('1', '0617M', '000', '000000', 3, 3, 20, 54, 0, 54, 0, 4, 0, 0, NULL, 0, 0, 0, 0, 0, 0, NULL, 0, 0, 0, 0, 0, 0, 0, 0, 0, NULL, 0, 0, 0, 0, NULL, 0, 0, 0, 0, 0);
INSERT INTO SYSTEXTIL.MQOP_050
(NIVEL_ESTRUTURA, GRUPO_ESTRUTURA, SUBGRU_ESTRUTURA, ITEM_ESTRUTURA, NUMERO_ALTERNATI, NUMERO_ROTEIRO, SEQ_OPERACAO, CODIGO_OPERACAO, MINUTOS, CODIGO_ESTAGIO, CENTRO_CUSTO, SEQUENCIA_ESTAGIO, ESTAGIO_ANTERIOR, ESTAGIO_DEPENDE, SEPARA_OPERACAO, MINUTOS_HOMEM, CCUSTO_HOMEM, NUMERO_CORDAS, NUMERO_ROLOS, VELOCIDADE, CODIGO_FAMILIA, OBSERVACAO, TIPO_PROCESSO, PECAS_1_HORA, PECAS_8_HORAS, CUSTO_MINUTO, PERC_EFICIENCIA, TEMPERATURA, TEMPO_LOTE_PRODUCAO, PECAS_LOTE_PRODUCAO, TIME_CELULA, CODIGO_APARELHO, PERC_EFIC_ROT, NUMERO_OPERADORAS, CONSIDERA_EFIC, SEQ_OPERACAO_AGRUPADORA, CODIGO_PARTE_PECA, SEQ_JUNCAO_PARTE_PECA, SITUACAO, PERC_PERDAS, PERC_CUSTOS, IND_ESTAGIO_GARGALO)
VALUES('1', '0617M', '000', '000000', 3, 3, 30, 48, 0, 48, 0, 5, 0, 0, NULL, 0, 0, 0, 0, 0, 0, NULL, 0, 0, 0, 0, 0, 0, 0, 0, 0, NULL, 0, 0, 0, 0, NULL, 0, 0, 0, 0, 0);
INSERT INTO SYSTEXTIL.MQOP_050
(NIVEL_ESTRUTURA, GRUPO_ESTRUTURA, SUBGRU_ESTRUTURA, ITEM_ESTRUTURA, NUMERO_ALTERNATI, NUMERO_ROTEIRO, SEQ_OPERACAO, CODIGO_OPERACAO, MINUTOS, CODIGO_ESTAGIO, CENTRO_CUSTO, SEQUENCIA_ESTAGIO, ESTAGIO_ANTERIOR, ESTAGIO_DEPENDE, SEPARA_OPERACAO, MINUTOS_HOMEM, CCUSTO_HOMEM, NUMERO_CORDAS, NUMERO_ROLOS, VELOCIDADE, CODIGO_FAMILIA, OBSERVACAO, TIPO_PROCESSO, PECAS_1_HORA, PECAS_8_HORAS, CUSTO_MINUTO, PERC_EFICIENCIA, TEMPERATURA, TEMPO_LOTE_PRODUCAO, PECAS_LOTE_PRODUCAO, TIME_CELULA, CODIGO_APARELHO, PERC_EFIC_ROT, NUMERO_OPERADORAS, CONSIDERA_EFIC, SEQ_OPERACAO_AGRUPADORA, CODIGO_PARTE_PECA, SEQ_JUNCAO_PARTE_PECA, SITUACAO, PERC_PERDAS, PERC_CUSTOS, IND_ESTAGIO_GARGALO)
VALUES('1', '0617M', '000', '000000', 3, 3, 40, 57, 0, 57, 0, 6, 0, 0, NULL, 0, 0, 0, 0, 0, 0, NULL, 0, 0, 0, 0, 0, 0, 0, 0, 0, NULL, 0, 0, 0, 0, NULL, 0, 0, 0, 0, 0);
INSERT INTO SYSTEXTIL.MQOP_050
(NIVEL_ESTRUTURA, GRUPO_ESTRUTURA, SUBGRU_ESTRUTURA, ITEM_ESTRUTURA, NUMERO_ALTERNATI, NUMERO_ROTEIRO, SEQ_OPERACAO, CODIGO_OPERACAO, MINUTOS, CODIGO_ESTAGIO, CENTRO_CUSTO, SEQUENCIA_ESTAGIO, ESTAGIO_ANTERIOR, ESTAGIO_DEPENDE, SEPARA_OPERACAO, MINUTOS_HOMEM, CCUSTO_HOMEM, NUMERO_CORDAS, NUMERO_ROLOS, VELOCIDADE, CODIGO_FAMILIA, OBSERVACAO, TIPO_PROCESSO, PECAS_1_HORA, PECAS_8_HORAS, CUSTO_MINUTO, PERC_EFICIENCIA, TEMPERATURA, TEMPO_LOTE_PRODUCAO, PECAS_LOTE_PRODUCAO, TIME_CELULA, CODIGO_APARELHO, PERC_EFIC_ROT, NUMERO_OPERADORAS, CONSIDERA_EFIC, SEQ_OPERACAO_AGRUPADORA, CODIGO_PARTE_PECA, SEQ_JUNCAO_PARTE_PECA, SITUACAO, PERC_PERDAS, PERC_CUSTOS, IND_ESTAGIO_GARGALO)
VALUES('1', '0617M', '000', '000000', 3, 3, 50, 60, 0, 60, 0, 7, 0, 0, NULL, 0, 0, 0, 0, 0, 0, NULL, 0, 0, 0, 0, 0, 0, 0, 0, 0, NULL, 0, 0, 0, 0, NULL, 0, 0, 0, 0, 0);
INSERT INTO SYSTEXTIL.MQOP_050
(NIVEL_ESTRUTURA, GRUPO_ESTRUTURA, SUBGRU_ESTRUTURA, ITEM_ESTRUTURA, NUMERO_ALTERNATI, NUMERO_ROTEIRO, SEQ_OPERACAO, CODIGO_OPERACAO, MINUTOS, CODIGO_ESTAGIO, CENTRO_CUSTO, SEQUENCIA_ESTAGIO, ESTAGIO_ANTERIOR, ESTAGIO_DEPENDE, SEPARA_OPERACAO, MINUTOS_HOMEM, CCUSTO_HOMEM, NUMERO_CORDAS, NUMERO_ROLOS, VELOCIDADE, CODIGO_FAMILIA, OBSERVACAO, TIPO_PROCESSO, PECAS_1_HORA, PECAS_8_HORAS, CUSTO_MINUTO, PERC_EFICIENCIA, TEMPERATURA, TEMPO_LOTE_PRODUCAO, PECAS_LOTE_PRODUCAO, TIME_CELULA, CODIGO_APARELHO, PERC_EFIC_ROT, NUMERO_OPERADORAS, CONSIDERA_EFIC, SEQ_OPERACAO_AGRUPADORA, CODIGO_PARTE_PECA, SEQ_JUNCAO_PARTE_PECA, SITUACAO, PERC_PERDAS, PERC_CUSTOS, IND_ESTAGIO_GARGALO)
VALUES('1', '0617M', '000', '000000', 3, 3, 70, 63, 0, 63, 0, 8, 0, 0, NULL, 0, 0, 0, 0, 0, 0, NULL, 0, 0, 0, 0, 0, 0, 0, 0, 0, NULL, 0, 0, 0, 0, NULL, 0, 0, 0, 0, 0);
INSERT INTO SYSTEXTIL.MQOP_050
(NIVEL_ESTRUTURA, GRUPO_ESTRUTURA, SUBGRU_ESTRUTURA, ITEM_ESTRUTURA, NUMERO_ALTERNATI, NUMERO_ROTEIRO, SEQ_OPERACAO, CODIGO_OPERACAO, MINUTOS, CODIGO_ESTAGIO, CENTRO_CUSTO, SEQUENCIA_ESTAGIO, ESTAGIO_ANTERIOR, ESTAGIO_DEPENDE, SEPARA_OPERACAO, MINUTOS_HOMEM, CCUSTO_HOMEM, NUMERO_CORDAS, NUMERO_ROLOS, VELOCIDADE, CODIGO_FAMILIA, OBSERVACAO, TIPO_PROCESSO, PECAS_1_HORA, PECAS_8_HORAS, CUSTO_MINUTO, PERC_EFICIENCIA, TEMPERATURA, TEMPO_LOTE_PRODUCAO, PECAS_LOTE_PRODUCAO, TIME_CELULA, CODIGO_APARELHO, PERC_EFIC_ROT, NUMERO_OPERADORAS, CONSIDERA_EFIC, SEQ_OPERACAO_AGRUPADORA, CODIGO_PARTE_PECA, SEQ_JUNCAO_PARTE_PECA, SITUACAO, PERC_PERDAS, PERC_CUSTOS, IND_ESTAGIO_GARGALO)
VALUES('1', '0617M', '000', '000000', 3, 3, 80, 66, 0, 66, 0, 9, 0, 0, NULL, 0, 0, 0, 0, 0, 0, NULL, 0, 0, 0, 0, 0, 0, 0, 0, 0, NULL, 0, 0, 0, 0, NULL, 0, 0, 0, 0, 0);

-- -- -- -- --
SELECT
  t.*
FROM DBA_TABLES t
WHERE t.table_name like '%DBA%'
;

-- -- -- -- --
SELECT
  t.*
FROM dba_tab_columns t
JOIN dba_tab_columns t2
  ON t2.TABLE_NAME = t.TABLE_NAME
WHERE t.OWNER = 'SYSTEXTIL'
  AND t.COLUMN_NAME like '%CODIGO_FAMILIA%'
  AND t2.OWNER = 'SYSTEXTIL'
  AND t2.COLUMN_NAME like '%ORDEM_CONFECCAO%'
;


-- pesquisa
SELECT
  *
FROM BASI_070 t
WHERE t.GRUPO = 'Z01PA'
;

-- apagar operações de roteiros antes de inserir
DELETE FROM MQOP_050 ro -- roteiro operações
WHERE ro.GRUPO_ESTRUTURA IN (
SELECT
  r.REFERENCIA
FROM basi_030 r -- referência
WHERE r.NIVEL_ESTRUTURA = 1
  AND r.RESPONSAVEL IS NOT NULL
  AND r.REFERENCIA < 'A'
  AND r.COLECAO IN (1, 2, 3, 4, 8, 13, 14, 15)
  AND rownum = 1
)
;

-- capa de roteiro
SELECT
  rc.NIVEL
, rc.GRUPO
, rc.ITEM
, rc.ROTEIRO
, rc.SUBGRUPO
, rc.ALTERNATIVA
, rc.DESCRICAO
, rc.LARGURA
, rc.GRAMATURA
, rc.RENDIMENTO
FROM BASI_070 rc -- roteiro capa
WHERE rc.NIVEL='1'
--  AND rc.GRUPO='Z01PA'
  AND rc.GRUPO='0617M'
--  AND rc.ITEM='000000'
--  AND rc.ROTEIRO=1
--  AND rc.SUBGRUPO='000'
--  AND rc.ALTERNATIVA=1
;

--
SELECT
  rc.NIVEL
, REF.REFERENCIA GRUPO
, rc.ITEM
, rc.ROTEIRO
, rc.SUBGRUPO
, rc.ALTERNATIVA
, rc.DESCRICAO
, rc.LARGURA
, rc.GRAMATURA
, rc.RENDIMENTO
FROM BASI_070 rc -- roteiro capa
,
(
SELECT
  r.*
FROM basi_030 r -- referência
WHERE r.NIVEL_ESTRUTURA = 1
  AND r.RESPONSAVEL IS NOT NULL
  AND r.REFERENCIA < 'A'
  AND r.COLECAO IN (1, 2, 3, 4, 8, 13, 14, 15)
  AND rownum = 1
) ref
WHERE rc.NIVEL='1'
  AND rc.GRUPO='Z01PA'
;

-- apagar capa de roteiro - onde define o nome dos roteiros das alternativas de referências
DELETE FROM BASI_070 rc -- roteiro operações
WHERE rc.GRUPO IN (
SELECT
  r.REFERENCIA
FROM basi_030 r -- referência
WHERE r.NIVEL_ESTRUTURA = 1
  AND r.RESPONSAVEL IS NOT NULL
  AND r.REFERENCIA < 'A'
  AND r.COLECAO IN (1, 2, 3, 4, 8, 13, 14, 15)
  AND rownum = 1
)
;

INSERT INTO SYSTEXTIL.BASI_070
(NIVEL, GRUPO, ITEM, ROTEIRO, SUBGRUPO, ALTERNATIVA, DESCRICAO, LARGURA, GRAMATURA, RENDIMENTO)
SELECT
  rc.NIVEL
, REF.REFERENCIA GRUPO
, rc.ITEM
, rc.ROTEIRO
, rc.SUBGRUPO
, rc.ALTERNATIVA
, rc.DESCRICAO
, rc.LARGURA
, rc.GRAMATURA
, rc.RENDIMENTO
FROM BASI_070 rc -- roteiro capa
,
(
SELECT
  r.*
FROM basi_030 r -- referência
WHERE r.NIVEL_ESTRUTURA = 1
  AND r.RESPONSAVEL IS NOT NULL
  AND r.REFERENCIA < 'A'
  AND r.COLECAO IN (1, 2, 3, 4, 8, 13, 14, 15)
  AND rownum = 1
) ref
WHERE rc.NIVEL='1'
  AND rc.GRUPO='Z01PA'
;

--
-- trabalhando as capas da segunda referência da seleção
--

SELECT
  rc.NIVEL
, rc.GRUPO
, rc.ITEM
, rc.ROTEIRO
, rc.SUBGRUPO
, rc.ALTERNATIVA
, rc.DESCRICAO
, rc.LARGURA
, rc.GRAMATURA
, rc.RENDIMENTO
FROM BASI_070 rc -- roteiro capa
WHERE rc.GRUPO IN (
	SELECT
	  REFERENCIA
	from
	(
		SELECT
		  rownum row_num
		, r.*
		FROM basi_030 r -- referência
		WHERE r.NIVEL_ESTRUTURA = 1
		  AND r.RESPONSAVEL IS NOT NULL
		  AND r.REFERENCIA < 'A'
		  AND r.COLECAO IN (1, 2, 3, 4, 8, 13, 14, 15)
	)
	WHERE row_num = 2
)
;

-- apagar capa de roteiro - onde define o nome dos roteiros das alternativas de referências
DELETE FROM BASI_070 rc -- roteiro operações
WHERE rc.GRUPO IN (
	SELECT
	  REFERENCIA
	from
	(
		SELECT
		  rownum row_num
		, r.*
		FROM basi_030 r -- referência
		WHERE r.NIVEL_ESTRUTURA = 1
		  AND r.RESPONSAVEL IS NOT NULL
		  AND r.REFERENCIA < 'A'
		  AND r.COLECAO IN (1, 2, 3, 4, 8, 13, 14, 15)
	)
	WHERE row_num = 2
)
;

INSERT INTO SYSTEXTIL.BASI_070
(NIVEL, GRUPO, ITEM, ROTEIRO, SUBGRUPO, ALTERNATIVA, DESCRICAO, LARGURA, GRAMATURA, RENDIMENTO)
SELECT
  rc.NIVEL
, REF.REFERENCIA GRUPO
, rc.ITEM
, rc.ROTEIRO
, rc.SUBGRUPO
, rc.ALTERNATIVA
, rc.DESCRICAO
, rc.LARGURA
, rc.GRAMATURA
, rc.RENDIMENTO
FROM BASI_070 rc -- roteiro capa
,
(
	SELECT
	  *
	from
	(
		SELECT
		  rownum row_num
		, r.*
		FROM basi_030 r -- referência
		WHERE r.NIVEL_ESTRUTURA = 1
		  AND r.RESPONSAVEL IS NOT NULL
		  AND r.REFERENCIA < 'A'
		  AND r.COLECAO IN (1, 2, 3, 4, 8, 13, 14, 15)
	)
	WHERE row_num = 2
) ref
WHERE rc.NIVEL='1'
  AND rc.GRUPO='Z01PA'
;

--
-- trabalhando as capas de todas as referências da seleção
--

-- produtos selecionados
SELECT
  r.NIVEL_ESTRUTURA
, r.RESPONSAVEL
, r.REFERENCIA
, r.COLECAO
, r.*
FROM basi_030 r -- referência
WHERE r.NIVEL_ESTRUTURA = 1
  AND r.RESPONSAVEL IS NOT NULL
--  AND r.REFERENCIA < 'A'
--  AND r.REFERENCIA like 'A%'
--  AND r.REFERENCIA like 'B%'
--  AND r.REFERENCIA like 'M%'
  AND r.REFERENCIA like 'F%'
--  AND (
--     r.REFERENCIA like 'E%'
--  OR r.REFERENCIA like 'Q%'
--  OR r.REFERENCIA like 'N%'
--  OR r.REFERENCIA like 'M%'
--  OR r.REFERENCIA like 'L%'
--  OR r.REFERENCIA like 'P%'
--  )
--  AND (
--	 r.REFERENCIA like 'T%'
--  OR r.REFERENCIA like 'R%'
--  )
--  AND r.COLECAO IN (9, 10, 11, 12)
--  AND r.COLECAO IN (1, 2, 3, 4)
--  AND r.COLECAO IN (1, 2, 3, 4, 13, 14, 15)
--    AND r.COLECAO IN (9, 10, 11, 12, 16, 17)
--  AND r.COLECAO IN (7)
  AND r.COLECAO IN (8)
ORDER BY
  r.REFERENCIA
;

-- seleciona capas padrão
SELECT
  rc.NIVEL
, rc.GRUPO
, rc.ITEM
, rc.ROTEIRO
, rc.SUBGRUPO
, rc.ALTERNATIVA
, rc.DESCRICAO
, rc.LARGURA
, rc.GRAMATURA
, rc.RENDIMENTO
FROM BASI_070 rc -- roteiro capa
--WHERE rc.GRUPO = '00613'
WHERE rc.GRUPO = 'Z01PA'
ORDER BY
  rc.GRUPO
, rc.ROTEIRO
;

-- seleciona capa de roteiro existente - onde define o nome dos roteiros das alternativas de referências
SELECT
  rc.NIVEL
, rc.GRUPO
, rc.ITEM
, rc.ROTEIRO
, rc.SUBGRUPO
, rc.ALTERNATIVA
, rc.DESCRICAO
, rc.LARGURA
, rc.GRAMATURA
, rc.RENDIMENTO
FROM BASI_070 rc -- roteiro capa
WHERE rc.GRUPO IN (
	SELECT
	  r.REFERENCIA
	FROM basi_030 r -- referência
	WHERE r.NIVEL_ESTRUTURA = 1
	  AND r.RESPONSAVEL IS NOT NULL
	  AND r.REFERENCIA < 'A'
	  AND r.COLECAO IN (1, 2, 3, 4, 13, 14, 15)
)
  AND rc.ROTEIRO IN (1, 3)
;

-- apagar capa de roteiro - onde define o nome dos roteiros das alternativas de referências
DELETE FROM BASI_070 rc -- roteiro operações
WHERE rc.GRUPO IN (
	SELECT
	  r.REFERENCIA
	FROM basi_030 r -- referência
	WHERE r.NIVEL_ESTRUTURA = 1
	  AND r.RESPONSAVEL IS NOT NULL
	  AND r.REFERENCIA < 'A'
	  AND r.COLECAO IN (1, 2, 3, 4, 13, 14, 15)
)
  AND rc.ROTEIRO IN (1, 3)
;

-- inserir capa de roteiro - onde define o nome dos roteiros das alternativas de referências
INSERT INTO SYSTEXTIL.BASI_070
(NIVEL, GRUPO, ITEM, ROTEIRO, SUBGRUPO, ALTERNATIVA, DESCRICAO, LARGURA, GRAMATURA, RENDIMENTO)
SELECT
  rc.NIVEL
, REF.REFERENCIA GRUPO
, rc.ITEM
, rc.ROTEIRO
, rc.SUBGRUPO
, rc.ALTERNATIVA
, rc.DESCRICAO
, rc.LARGURA
, rc.GRAMATURA
, rc.RENDIMENTO
FROM BASI_070 rc -- roteiro capa
,
(
	SELECT
	  r.REFERENCIA
	FROM basi_030 r -- referência
	WHERE r.NIVEL_ESTRUTURA = 1
	  AND r.RESPONSAVEL IS NOT NULL
	  AND r.REFERENCIA < 'A'
	  AND r.COLECAO IN (1, 2, 3, 4, 13, 14, 15)
) ref
WHERE rc.NIVEL='1'
  AND rc.GRUPO='Z01PA'
  AND rc.ROTEIRO IN (1, 3)
;

--
-- trabalhando as lista de operações (roteiro) de uma alternativa de produto
--

-- verifica gargalos
SELECT
  rotp.GRUPO_ESTRUTURA
, rotp.NUMERO_ROTEIRO
, rotp.SEQ_OPERACAO
, rotp.IND_ESTAGIO_GARGALO
, rotp.CODIGO_OPERACAO
, rotp.NIVEL_ESTRUTURA
, rotp.SUBGRU_ESTRUTURA
, rotp.ITEM_ESTRUTURA
, rotp.NUMERO_ALTERNATI
FROM SYSTEXTIL.MQOP_050 rotp
--WHERE rotp.GRUPO_ESTRUTURA='Z01PA'
--WHERE rotp.GRUPO_ESTRUTURA='Z01PG'
--WHERE rotp.GRUPO_ESTRUTURA='Z01PB'
--WHERE rotp.GRUPO_ESTRUTURA='Z01MD'
WHERE rotp.GRUPO_ESTRUTURA='Z01MP'
--WHERE rotp.GRUPO_ESTRUTURA='00103'
--  AND rotp.NUMERO_ROTEIRO=1
ORDER BY
  rotp.GRUPO_ESTRUTURA
, rotp.NUMERO_ROTEIRO
, rotp.SEQ_OPERACAO
;

-- seleciona lista de operações (roteiro) de uma alternativa de produto
SELECT
  rop.NIVEL_ESTRUTURA
, rop.GRUPO_ESTRUTURA
, rop.SUBGRU_ESTRUTURA
, rop.ITEM_ESTRUTURA
, rop.NUMERO_ALTERNATI
, rop.NUMERO_ROTEIRO
, rop.SEQ_OPERACAO
, rop.CODIGO_OPERACAO
, rop.MINUTOS
, rop.CODIGO_ESTAGIO
, rop.CENTRO_CUSTO
, rop.SEQUENCIA_ESTAGIO
, rop.ESTAGIO_ANTERIOR
, rop.ESTAGIO_DEPENDE
, rop.SEPARA_OPERACAO
, rop.MINUTOS_HOMEM
, rop.CCUSTO_HOMEM
, rop.NUMERO_CORDAS
, rop.NUMERO_ROLOS
, rop.VELOCIDADE
, rop.CODIGO_FAMILIA
, rop.OBSERVACAO
, rop.TIPO_PROCESSO
, rop.PECAS_1_HORA
, rop.PECAS_8_HORAS
, rop.CUSTO_MINUTO
, rop.PERC_EFICIENCIA
, rop.TEMPERATURA
, rop.TEMPO_LOTE_PRODUCAO
, rop.PECAS_LOTE_PRODUCAO
, rop.TIME_CELULA
, rop.CODIGO_APARELHO
, rop.PERC_EFIC_ROT
, rop.NUMERO_OPERADORAS
, rop.CONSIDERA_EFIC
, rop.SEQ_OPERACAO_AGRUPADORA
, rop.CODIGO_PARTE_PECA
, rop.SEQ_JUNCAO_PARTE_PECA
, rop.SITUACAO
, rop.PERC_PERDAS
, rop.PERC_CUSTOS
, rop.IND_ESTAGIO_GARGALO
FROM MQOP_050 rop
WHERE rop.GRUPO_ESTRUTURA IN (
	SELECT
	  r.REFERENCIA
	FROM basi_030 r -- referência
	WHERE r.NIVEL_ESTRUTURA = 1
	  AND r.RESPONSAVEL IS NOT NULL
	  AND r.REFERENCIA < 'A'
	  AND r.COLECAO IN (1, 2, 3, 4, 13, 14, 15)
)
  AND rop.NUMERO_ROTEIRO IN (1, 3)
ORDER BY
  rop.GRUPO_ESTRUTURA
, rop.NUMERO_ROTEIRO
, rop.SEQ_OPERACAO
;

-- apagar lista de operações (roteiro) de uma alternativa de produto
DELETE FROM MQOP_050 rop -- lista de operações de um roteiro
WHERE rop.GRUPO_ESTRUTURA IN (
	SELECT
	  r.REFERENCIA
	FROM basi_030 r -- referência
	WHERE r.NIVEL_ESTRUTURA = 1
	  AND r.RESPONSAVEL IS NOT NULL
	  AND r.REFERENCIA < 'A'
	  AND r.COLECAO IN (1, 2, 3, 4, 13, 14, 15)
)
  AND rop.NUMERO_ROTEIRO IN (1, 3)
;

-- inserir capa de roteiro - onde define o nome dos roteiros das alternativas de referências
INSERT INTO MQOP_050
(NIVEL_ESTRUTURA, GRUPO_ESTRUTURA, SUBGRU_ESTRUTURA, ITEM_ESTRUTURA, NUMERO_ALTERNATI, NUMERO_ROTEIRO, SEQ_OPERACAO, CODIGO_OPERACAO, MINUTOS, CODIGO_ESTAGIO, CENTRO_CUSTO, SEQUENCIA_ESTAGIO, ESTAGIO_ANTERIOR, ESTAGIO_DEPENDE, SEPARA_OPERACAO, MINUTOS_HOMEM, CCUSTO_HOMEM, NUMERO_CORDAS, NUMERO_ROLOS, VELOCIDADE, CODIGO_FAMILIA, OBSERVACAO, TIPO_PROCESSO, PECAS_1_HORA, PECAS_8_HORAS, CUSTO_MINUTO, PERC_EFICIENCIA, TEMPERATURA, TEMPO_LOTE_PRODUCAO, PECAS_LOTE_PRODUCAO, TIME_CELULA, CODIGO_APARELHO, PERC_EFIC_ROT, NUMERO_OPERADORAS, CONSIDERA_EFIC, SEQ_OPERACAO_AGRUPADORA, CODIGO_PARTE_PECA, SEQ_JUNCAO_PARTE_PECA, SITUACAO, PERC_PERDAS, PERC_CUSTOS, IND_ESTAGIO_GARGALO)
SELECT
  rop.NIVEL_ESTRUTURA
, REF.REFERENCIA GRUPO_ESTRUTURA
, rop.SUBGRU_ESTRUTURA
, rop.ITEM_ESTRUTURA
, rop.NUMERO_ALTERNATI
, rop.NUMERO_ROTEIRO
, rop.SEQ_OPERACAO
, rop.CODIGO_OPERACAO
, rop.MINUTOS
, rop.CODIGO_ESTAGIO
, rop.CENTRO_CUSTO
, rop.SEQUENCIA_ESTAGIO
, rop.ESTAGIO_ANTERIOR
, rop.ESTAGIO_DEPENDE
, rop.SEPARA_OPERACAO
, rop.MINUTOS_HOMEM
, rop.CCUSTO_HOMEM
, rop.NUMERO_CORDAS
, rop.NUMERO_ROLOS
, rop.VELOCIDADE
, rop.CODIGO_FAMILIA
, rop.OBSERVACAO
, rop.TIPO_PROCESSO
, rop.PECAS_1_HORA
, rop.PECAS_8_HORAS
, rop.CUSTO_MINUTO
, rop.PERC_EFICIENCIA
, rop.TEMPERATURA
, rop.TEMPO_LOTE_PRODUCAO
, rop.PECAS_LOTE_PRODUCAO
, rop.TIME_CELULA
, rop.CODIGO_APARELHO
, rop.PERC_EFIC_ROT
, rop.NUMERO_OPERADORAS
, rop.CONSIDERA_EFIC
, rop.SEQ_OPERACAO_AGRUPADORA
, rop.CODIGO_PARTE_PECA
, rop.SEQ_JUNCAO_PARTE_PECA
, rop.SITUACAO
, rop.PERC_PERDAS
, rop.PERC_CUSTOS
, rop.IND_ESTAGIO_GARGALO
FROM MQOP_050 rop
,
(
	SELECT
	  r.REFERENCIA
	FROM basi_030 r -- referência
	WHERE r.NIVEL_ESTRUTURA = 1
	  AND r.RESPONSAVEL IS NOT NULL
	  AND r.REFERENCIA < 'A'
	  AND r.COLECAO IN (1, 2, 3, 4, 13, 14, 15)
) ref
WHERE rop.NIVEL_ESTRUTURA = '1'
  AND rop.GRUPO_ESTRUTURA = 'Z01PA'
  AND rop.NUMERO_ROTEIRO IN (1, 3)
;


WITH Table_qtd_lotes AS (
SELECT
  COALESCE(
  ( SELECT
      MIN( le.CODIGO_ESTAGIO ) CODIGO_ESTAGIO
    FROM PCPC_040 le
    JOIN MQOP_005 ed
      ON ed.CODIGO_ESTAGIO = le.CODIGO_ESTAGIO
    WHERE le.PERIODO_PRODUCAO = l.PERIODO_PRODUCAO
      AND le.ORDEM_CONFECCAO = l.ORDEM_CONFECCAO
      AND le.QTDE_EM_PRODUCAO_PACOTE <> 0
  )
  , 9999
  ) EST_NUM
, l.ORDEM_PRODUCAO OP
, op.SITUACAO OP_SITUACAO
, CASE WHEN dos.NUMERO_ORDEM IS NULL
  THEN '0'
  ELSE l.NUMERO_ORDEM || ' (' || eos.DESCRICAO || ')'
  END OS
, l.PROCONF_GRUPO REF
, l.PROCONF_SUBGRUPO TAM
, t.ORDEM_TAMANHO
, l.PROCONF_ITEM COR
, COALESCE(
  ( SELECT
      LISTAGG(le.CODIGO_ESTAGIO || ' - ' || ed.DESCRICAO, ' & ')
      WITHIN GROUP (ORDER BY le.CODIGO_ESTAGIO)
    FROM PCPC_040 le
    JOIN MQOP_005 ed
      ON ed.CODIGO_ESTAGIO = le.CODIGO_ESTAGIO
    WHERE le.PERIODO_PRODUCAO = l.PERIODO_PRODUCAO
      AND le.ORDEM_CONFECCAO = l.ORDEM_CONFECCAO
      AND le.QTDE_EM_PRODUCAO_PACOTE <> 0
  )
  , 'FINALIZADO'
  ) EST
, l.PERIODO_PRODUCAO PERIODO
, l.ORDEM_CONFECCAO OC
, l.QTDE_PECAS_PROG QTD
, l.QTDE_PECAS_PROD PROD1Q
, l.QTDE_CONSERTO CONSERTO
, l.QTDE_PECAS_2A PROD2Q
, l.QTDE_PERDAS PERDA
, r.NARRATIVA
, ref.COLECAO
, CASE WHEN l.DIVISAO = 0 THEN dp.DIVISAO_PRODUCAO
  ELSE l.DIVISAO END DIVISAO
, CASE WHEN l.DIVISAO = 0 THEN dp.DESCRICAO
  ELSE di.DESCRICAO END DESCRICAO_DIVISAO
, op.DATA_ENTRADA_CORTE
, ( SELECT
    MIN( l1.ORDEM_CONFECCAO )
  FROM PCPC_040 l1
  WHERE l1.ORDEM_PRODUCAO   = l.ORDEM_PRODUCAO
    AND l1.PERIODO_PRODUCAO = l.PERIODO_PRODUCAO
    AND l1.PROCONF_GRUPO    = l.PROCONF_GRUPO
    AND l1.PROCONF_SUBGRUPO = l.PROCONF_SUBGRUPO
    AND l1.PROCONF_ITEM     = l.PROCONF_ITEM
) OC1
FROM (
  SELECT
    os.PERIODO_PRODUCAO
  , os.ORDEM_CONFECCAO
  , os.PROCONF_GRUPO
  , os.PROCONF_SUBGRUPO
  , os.PROCONF_ITEM
  , os.ORDEM_PRODUCAO
  , max( os.NUMERO_ORDEM ) NUMERO_ORDEM
  , max( os.QTDE_PECAS_PROG ) QTDE_PECAS_PROG
  , max( os.QTDE_PECAS_PROD ) QTDE_PECAS_PROD
  , max( os.QTDE_CONSERTO ) QTDE_CONSERTO
  , max( os.QTDE_PECAS_2A ) QTDE_PECAS_2A
  , max( os.QTDE_PERDAS ) QTDE_PERDAS
  , max( CASE WHEN os.CODIGO_FAMILIA < 1000
         THEN os.CODIGO_FAMILIA
         ELSE 0 END ) DIVISAO
  FROM PCPC_040 os
  WHERE 1=1
    AND (os.ORDEM_PRODUCAO = 4432)
--    AND (os.ORDEM_PRODUCAO = %s or %s IS NULL)
--    AND (os.NUMERO_ORDEM = %s or %s IS NULL)
--    AND (os.ORDEM_CONFECCAO >= %s or %s IS NULL)
--    AND (os.ORDEM_CONFECCAO <= %s or %s IS NULL)
--    AND (os.PROCONF_SUBGRUPO = %s OR %s IS NULL)
--    AND (os.PROCONF_ITEM = %s OR %s IS NULL)
  GROUP BY
    os.PERIODO_PRODUCAO
  , os.ORDEM_CONFECCAO
  , os.PROCONF_GRUPO
  , os.PROCONF_SUBGRUPO
  , os.PROCONF_ITEM
  , os.ORDEM_PRODUCAO
) l
LEFT JOIN PCPC_040 dos
  ON l.NUMERO_ORDEM <> 0
 AND dos.PERIODO_PRODUCAO = l.PERIODO_PRODUCAO
 AND dos.ORDEM_CONFECCAO = l.ORDEM_CONFECCAO
 AND dos.NUMERO_ORDEM = l.NUMERO_ORDEM
LEFT JOIN MQOP_005 eos
  ON eos.CODIGO_ESTAGIO = dos.CODIGO_ESTAGIO
LEFT JOIN BASI_220 t
  ON t.TAMANHO_REF = l.PROCONF_SUBGRUPO
JOIN BASI_030 ref
  ON ref.NIVEL_ESTRUTURA = 1
 AND ref.REFERENCIA = l.PROCONF_GRUPO
JOIN BASI_010 r
  ON r.NIVEL_ESTRUTURA = 1
 AND r.GRUPO_ESTRUTURA = l.PROCONF_GRUPO
 AND r.SUBGRU_ESTRUTURA = l.PROCONF_SUBGRUPO
 AND r.ITEM_ESTRUTURA = l.PROCONF_ITEM
LEFT JOIN BASI_180 di -- divisao de producao - unidade
  ON di.DIVISAO_PRODUCAO = l.DIVISAO
LEFT JOIN OBRF_080 osc -- OS capa
  ON l.NUMERO_ORDEM <> 0
 AND osc.NUMERO_ORDEM = l.NUMERO_ORDEM
LEFT JOIN BASI_180 dp -- divisao de producao - unidade
  ON dp.FACCIONISTA9 = osc.CGCTERC_FORNE9
 AND dp.FACCIONISTA4 = osc.CGCTERC_FORNE4
 AND dp.FACCIONISTA2 = osc.CGCTERC_FORNE2
JOIN PCPC_020 op -- OP capa
  ON op.ordem_producao = l.ORDEM_PRODUCAO
ORDER BY
  l.ORDEM_PRODUCAO
, l.NUMERO_ORDEM
, l.PROCONF_GRUPO
, l.PROCONF_ITEM
, t.ORDEM_TAMANHO
, l.PERIODO_PRODUCAO
, l.ORDEM_CONFECCAO
)
select * from Table_qtd_lotes
--where rownum <= %s
;

SELECT
  ref.NIVEL_ESTRUTURA
, ref.COLECAO
FROM BASI_030 REF
;

SELECT
  o.OBSERVACAO
, o.OBSERVACAO2
, r.NUMERO_MOLDE
, case
  when o.REFERENCIA_PECA <= '99999' then 'PA'
  when o.REFERENCIA_PECA <= 'B9999' then 'PG'
  else 'MD'
  end TIPO_REF
, CASE
  WHEN o.ORDEM_PRINCIPAL <> 0 THEN 'Filha de'
  WHEN ofi.ORDEM_PRODUCAO IS NOT NULL THEN 'Mãe de'
  ELSE 'Avulsa'
  END TIPO_OP
, coalesce( ofi.ORDEM_PRODUCAO, o.ORDEM_PRINCIPAL ) OP_REL
, o.SITUACAO ||
  CASE
  WHEN o.SITUACAO = 2 THEN '-Ordem conf. gerada'
  WHEN o.SITUACAO = 4 THEN '-Ordens em produção'
  WHEN o.SITUACAO = 9 THEN '-Ordem cancelada'
  ELSE ' '
  END SITUACAO
, o.COD_CANCELAMENTO ||
  CASE
  WHEN o.COD_CANCELAMENTO = 0 THEN ''
  ELSE '-' || COALESCE(c.DESCRICAO, '')
  END CANCELAMENTO
, o.ALTERNATIVA_PECA ALTERNATIVA
, o.ROTEIRO_PECA ROTEIRO
, o.REFERENCIA_PECA REF
, COALESCE(
  CASE WHEN o.REFERENCIA_PECA < 'C0000' THEN
    CAST( CAST( regexp_replace(o.REFERENCIA_PECA, '[^0-9]', '')
                AS INTEGER ) AS VARCHAR2(5) )
  ELSE
    ( SELECT
        CAST( MAX(
          CASE WHEN ec.GRUPO_ITEM IS NULL THEN 0
          ELSE CAST( regexp_replace(ec.GRUPO_ITEM, '[^0-9]', '')
                     AS INTEGER )
          END
        ) AS VARCHAR2(5) )
        FROM BASI_050 ec
        JOIN BASI_030 rr
          ON rr.NIVEL_ESTRUTURA = ec.NIVEL_ITEM
         AND rr.REFERENCIA = ec.GRUPO_ITEM
         AND rr.RESPONSAVEL IS NOT NULL
        WHERE ec.NIVEL_COMP = 1
          AND ec.GRUPO_COMP = o.REFERENCIA_PECA
    )
  END
  , ' ' ) MODELO
, ( SELECT
      COUNT( DISTINCT l.ORDEM_CONFECCAO )
    FROM pcpc_040 l
    WHERE l.ORDEM_PRODUCAO = o.ORDEM_PRODUCAO
  ) LOTES
, ( SELECT
      SUM( l.QTDE_PECAS_PROG )
    FROM pcpc_040 l
    WHERE l.ORDEM_PRODUCAO = o.ORDEM_PRODUCAO
      AND l.SEQ_OPERACAO = (
        SELECT
          MAX( ls.SEQ_OPERACAO )
        FROM pcpc_040 ls
        WHERE ls.ORDEM_PRODUCAO = l.ORDEM_PRODUCAO
      )
  ) QTD
, o.DATA_PROGRAMACAO DT_DIGITACAO
, o.DATA_ENTRADA_CORTE DT_CORTE
, o.PERIODO_PRODUCAO PERIODO
, p.DATA_INI_PERIODO PERIODO_INI
, p.DATA_FIM_PERIODO PERIODO_FIM
, o.DEPOSITO_ENTRADA || ' - ' || d.DESCRICAO DEPOSITO
, o.PEDIDO_VENDA PEDIDO
, COALESCE(ped.COD_PED_CLIENTE, ' ') PED_CLIENTE
FROM PCPC_020 o
JOIN PCPC_010 p
  ON p.AREA_PERIODO = 1
 AND p.PERIODO_PRODUCAO = o.PERIODO_PRODUCAO
LEFT JOIN pcpt_050 c
  ON c.COD_CANCELAMENTO = o.COD_CANCELAMENTO
LEFT JOIN PCPC_020 ofi
  ON ofi.ORDEM_PRINCIPAL = o.ORDEM_PRODUCAO
JOIN BASI_205 d
  ON d.CODIGO_DEPOSITO = o.DEPOSITO_ENTRADA
LEFT JOIN PEDI_100 ped -- pedido de venda
  ON ped.PEDIDO_VENDA = o.PEDIDO_VENDA
JOIN basi_030 r
  ON r.NIVEL_ESTRUTURA = 1
 AND r.REFERENCIA = o.REFERENCIA_PECA
WHERE o.ORDEM_PRODUCAO = 4673
;

--

SELECT
  l21.CODIGO_FAMILIA
, l21.PERIODO_PRODUCAO
, l21.ORDEM_CONFECCAO
, l33.*
FROM PCPC_040 l21
JOIN pcpc_040 l33
  ON l33.PERIODO_PRODUCAO = l21.PERIODO_PRODUCAO
 AND l33.ORDEM_CONFECCAO = l21.ORDEM_CONFECCAO
JOIN pcpc_020 o
  ON o.ORDEM_PRODUCAO = l21.ORDEM_PRODUCAO
WHERE o.ALTERNATIVA_PECA = 1
  AND l21.CODIGO_ESTAGIO = 21
  AND l21.CODIGO_FAMILIA <> 0
  AND l33.CODIGO_ESTAGIO = 33
  AND l33.CODIGO_FAMILIA = 0
  AND (  l33.QTDE_PECAS_PROD <> 0
      OR l33.QTDE_CONSERTO <> 0
      OR l33.QTDE_PECAS_2A <> 0
      OR l33.QTDE_PERDAS <> 0
      )
--ORDER BY l21.ORDEM_PRODUCAO DESC
;

SELECT
  *
FROM pcpc_020 o
WHERE o.ORDEM_PRODUCAO = 4708
;

SELECT
  o.ORDEM_PRODUCAO
, o.CODIGO_FAMILIA
, o.ORDEM_CONFECCAO
, o.*
FROM PCPC_040 o
WHERE o.CODIGO_FAMILIA <> 0
  AND o.CODIGO_ESTAGIO = 54
ORDER BY
  o.ORDEM_PRODUCAO DESC
;

--

SELECT
  i.CODIGO_BARRAS
, i.*
FROM basi_010 i
WHERE i.NIVEL_ESTRUTURA = 1
  AND i.GRUPO_ESTRUTURA = '02577'
  AND i.ITEM_ESTRUTURA IN ('0000RO')
;

--

SELECT
  l.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO EST
, l.QTDE_PROGRAMADA Q_P
, l.QTDE_EM_PRODUCAO_PACOTE Q_EP
, l.QTDE_A_PRODUZIR_PACOTE Q_AP
, l.CODIGO_FAMILIA FAMI
, l.NUMERO_ORDEM OS
, coalesce(d.USUARIO_SYSTEXTIL, ' ') USU
, TO_CHAR(d.DATA_INSERCAO, 'DD/MM/YYYY HH24:MI') DT
, coalesce(d.PROCESSO_SYSTEXTIL || ' - ' || p.DESCRICAO, ' ') PRG
, d.*
FROM PCPC_040 l
JOIN MQOP_005 e
  ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
LEFT JOIN PCPC_045 d
  ON d.PCPC040_PERCONF = l.PERIODO_PRODUCAO
 AND d.PCPC040_ORDCONF = l.ORDEM_CONFECCAO
 AND d.PCPC040_ESTCONF = l.CODIGO_ESTAGIO
 AND d.ORDEM_PRODUCAO = 3486
LEFT JOIN HDOC_036 p
  ON p.CODIGO_PROGRAMA = d.PROCESSO_SYSTEXTIL
 AND p.LOCALE = 'pt_BR'
WHERE l.PERIODO_PRODUCAO = 1748
  AND l.ORDEM_CONFECCAO = 5167
ORDER BY
  l.SEQ_OPERACAO
, d.SEQUENCIA
;

SELECT
  l2.*
FROM pcpc_045 l2
JOIN pcpc_040 l
  ON l.PERIODO_PRODUCAO = l2.PCPC040_PERCONF
 AND l.ORDEM_CONFECCAO = l2.PCPC040_ORDCONF
 AND l.CODIGO_ESTAGIO = l2.PCPC040_ESTCONF
WHERE l.ORDEM_PRODUCAO = 3486
--  AND l.QTDE_PECAS_PROD <> 0coalesce(d.USUARIO_SYSTEXTIL, ' ') USU
, TO_CHAR(d.DATA_INSERCAO, 'DD/MM/YYYY HH24:MI') DT
--  AND l2.PCPC040_ORDCONF NOT IN (10127, 10128)
  AND l2.PCPC040_ORDCONF = 5165
--  AND l2.PCPC040_ESTCONF = 51
ORDER BY
  l2.PCPC040_ORDCONF
, l2.SEQUENCIA
;

INSERT INTO SYSTEXTIL.PCPC_045
(PCPC040_PERCONF, PCPC040_ORDCONF, PCPC040_ESTCONF, SEQUENCIA, DATA_PRODUCAO, HORA_PRODUCAO, QTDE_PRODUZIDA, QTDE_PECAS_2A, QTDE_CONSERTO, TURNO_PRODUCAO, TIPO_ENTRADA_ORD, NOTA_ENTR_ORDEM, SERIE_NF_ENT_ORD, SEQ_NF_ENTR_ORD, ORDEM_PRODUCAO, CODIGO_USUARIO, QTDE_PERDAS, NUMERO_DOCUMENTO, CODIGO_DEPOSITO, CODIGO_FAMILIA, CODIGO_INTERVALO, EXECUTA_TRIGGER, DATA_INSERCAO, PROCESSO_SYSTEXTIL, NUMERO_VOLUME, NR_OPERADORES, ATZ_PODE_PRODUZIR, ATZ_EM_PROD, ATZ_A_PROD, EFICIENCIA_INFORMADA, USUARIO_SYSTEXTIL, CODIGO_OCORRENCIA, COD_OCORRENCIA_ESTORNO, SOLICITACAO_CONSERTO, NUMERO_SOLICITACAO, NUMERO_ORDEM)
SELECT
  l2.PCPC040_PERCONF
, l2.PCPC040_ORDCONF
, l2.PCPC040_ESTCONF
, l2.SEQUENCIA+1 -- SEQUENCIA
, CURRENT_DATE -- DATA_PRODUCAO
, CURRENT_DATE -- HORA_PRODUCAO
, -l2.QTDE_PRODUZIDA -- QTDE_PRODUZIDA
, l2.QTDE_PECAS_2A
, l2.QTDE_CONSERTO
, l2.TURNO_PRODUCAO
, l2.TIPO_ENTRADA_ORD
, l2.NOTA_ENTR_ORDEM
, l2.SERIE_NF_ENT_ORD
, l2.SEQ_NF_ENTR_ORD
, l2.ORDEM_PRODUCAO
, l2.CODIGO_USUARIO
, l2.QTDE_PERDAS
, l2.NUMERO_DOCUMENTO
, l2.CODIGO_DEPOSITO
, l2.CODIGO_FAMILIA
, l2.CODIGO_INTERVALO
, l2.EXECUTA_TRIGGER
, CURRENT_DATE -- DATA_INSERCAO
, 'pcpc_f046' -- PROCESSO_SYSTEXTIL
, l2.NUMERO_VOLUME
, l2.NR_OPERADORES
, l2.ATZ_PODE_PRODUZIR
, l2.ATZ_EM_PROD
, l2.ATZ_A_PROD
, l2.EFICIENCIA_INFORMADA
, l2.USUARIO_SYSTEXTIL
, l2.CODIGO_OCORRENCIA
, l2.COD_OCORRENCIA_ESTORNO
, l2.SOLICITACAO_CONSERTO
, l2.NUMERO_SOLICITACAO
, l2.NUMERO_ORDEM
FROM pcpc_045 l2
JOIN pcpc_040 l
  ON l.PERIODO_PRODUCAO = l2.PCPC040_PERCONF
 AND l.ORDEM_CONFECCAO = l2.PCPC040_ORDCONF
 AND l.CODIGO_ESTAGIO = l2.PCPC040_ESTCONF
WHERE l.ORDEM_PRODUCAO = 3486
  AND l.QTDE_PECAS_PROD <> 0
--  AND l2.PCPC040_ORDCONF NOT IN (10127, 10128)
  AND l2.PCPC040_ORDCONF IN (5165)
  AND l2.PCPC040_ESTCONF = 51
;

UPDATE SYSTEXTIL.PCPC_045 l2
SET
  l2.CODIGO_USUARIO = 99001coalesce(d.USUARIO_SYSTEXTIL, ' ') USU
, TO_CHAR(d.DATA_INSERCAO, 'DD/MM/YYYY HH24:MI') DT
--, l2.PROCESSO_SYSTEXTIL='pcpc_f046'
, l2.USUARIO_SYSTEXTIL='ANSELMO_SIS'
WHERE l2.PCPC040_PERCONF=1748
  AND l2.PCPC040_ORDCONF in
  (
  SELECT
    l.ORDEM_CONFECCAO
  FROM pcpc_040 l
  WHERE l.ORDEM_PRODUCAO = 3486
  )
  AND l2.PCPC040_ORDCONF IN (5165)
  AND l2.PCPC040_ESTCONF=51
  AND l2.SEQUENCIA=2
;

INSERT INTO SYSTEXTIL.PCPC_045
(PCPC040_PERCONF, PCPC040_ORDCONF, PCPC040_ESTCONF, SEQUENCIA, DATA_PRODUCAO, HORA_PRODUCAO, QTDE_PRODUZIDA, QTDE_PECAS_2A, QTDE_CONSERTO, TURNO_PRODUCAO, TIPO_ENTRADA_ORD, NOTA_ENTR_ORDEM, SERIE_NF_ENT_ORD, SEQ_NF_ENTR_ORD, ORDEM_PRODUCAO, CODIGO_USUARIO, QTDE_PERDAS, NUMERO_DOCUMENTO, CODIGO_DEPOSITO, CODIGO_FAMILIA, CODIGO_INTERVALO, EXECUTA_TRIGGER, DATA_INSERCAO, PROCESSO_SYSTEXTIL, NUMERO_VOLUME, NR_OPERADORES, ATZ_PODE_PRODUZIR, ATZ_EM_PROD, ATZ_A_PROD, EFICIENCIA_INFORMADA, USUARIO_SYSTEXTIL, CODIGO_OCORRENCIA, COD_OCORRENCIA_ESTORNO, SOLICITACAO_CONSERTO, NUMERO_SOLICITACAO, NUMERO_ORDEM)
SELECT
  l2.PCPC040_PERCONF
, l2.PCPC040_ORDCONF
, l2.PCPC040_ESTCONF
, l2.SEQUENCIA+1 -- SEQUENCIA
, CURRENT_DATE -- DATA_PRODUCAO
, CURRENT_DATE -- HORA_PRODUCAO
, -l2.QTDE_PRODUZIDA -- QTDE_PRODUZIDA
, l2.QTDE_PECAS_2A
, l2.QTDE_CONSERTOcoalesce(d.USUARIO_SYSTEXTIL, ' ') USU
, TO_CHAR(d.DATA_INSERCAO, 'DD/MM/YYYY HH24:MI') DT
, l2.TURNO_PRODUCAO
, l2.TIPO_ENTRADA_ORD
, l2.NOTA_ENTR_ORDEM
, l2.SERIE_NF_ENT_ORD
, l2.SEQ_NF_ENTR_ORD
, l2.ORDEM_PRODUCAO
, l2.CODIGO_USUARIO
, l2.QTDE_PERDAS
, l2.NUMERO_DOCUMENTO
, l2.CODIGO_DEPOSITO
, l2.CODIGO_FAMILIA
, l2.CODIGO_INTERVALO
, l2.EXECUTA_TRIGGER
, CURRENT_DATE -- DATA_INSERCAO
, 'pcpc_f046' -- PROCESSO_SYSTEXTIL
, l2.NUMERO_VOLUME
, l2.NR_OPERADORES
, l2.ATZ_PODE_PRODUZIR
, l2.ATZ_EM_PROD
, l2.ATZ_A_PROD
, l2.EFICIENCIA_INFORMADA
, l2.USUARIO_SYSTEXTIL
, l2.CODIGO_OCORRENCIA
, l2.COD_OCORRENCIA_ESTORNO
, l2.SOLICITACAO_CONSERTO
, l2.NUMERO_SOLICITACAO
, l2.NUMERO_ORDEM
FROM pcpc_045 l2
JOIN pcpc_040 l
  ON l.PERIODO_PRODUCAO = l2.PCPC040_PERCONF
 AND l.ORDEM_CONFECCAO = l2.PCPC040_ORDCONF
 AND l.CODIGO_ESTAGIO = l2.PCPC040_ESTCONF
WHERE l.ORDEM_PRODUCAO = 3486
  AND l.QTDE_PECAS_PROD <> 0
--  AND l2.PCPC040_ORDCONF NOT IN (10127, 10128)
  AND l2.PCPC040_ORDCONF NOT IN (5165)
  AND l2.PCPC040_ESTCONF = 51
            filtra_colecao = None
        data = models.op_pendente(cursor, estagio, periodo_de, periodo_ate,
                                  data_de, data_ate, filtra_colecao, situacao)
        context = {}
;

UPDATE SYSTEXTIL.PCPC_045 l2
SET
  l2.CODIGO_USUARIO = 99001
--, l2.PROCESSO_SYSTEXTIL='pcpc_f046'
, l2.USUARIO_SYSTEXTIL='ANSELMO_SIS'
WHERE l2.PCPC040_PERCONF=1748
  AND l2.PCPC040_ORDCONF in
  (
  SELECT
    l.ORDEM_CONFECCAO
  FROM pcpc_040 l
  WHERE l.ORDEM_PRODUCAO = 3486
  )
--  AND l2.PCPC040_ORDCONF IN (5165)
  AND l2.PCPC040_ESTCONF=51
  AND l2.SEQUENCIA=2
;

SELECT
  x.*
FROM BASI_180 x
;

SELECT
--  sum( x.QTDE_PECAS_PROD )
  x.*
FROM PCPC_040 x
--UPDATE PCPC_040 x
--SET
--  x.
WHERE 1=1
  AND x.CODIGO_ESTAGIO = 27
  AND (x.PERIODO_PRODUCAO*100000)+x.ORDEM_CONFECCAO IN
(

SELECT
--  sum( x.QTDE_PRODUZIDA )
--  ,
  (x.PCPC040_PERCONF*100000)+x.PCPC040_ORDCONF
, x.*
FROM PCPC_045 x

UPDATE PCPC_045 x
SET
  x.TURNO_PRODUCAO = 2
WHERE 1=1
  AND x.PCPC040_ESTCONF = 27
  AND x.DATA_INSERCAO >= to_date('21-02-2018 00:00', 'dd-mm-yyyy hh24:mi')
  AND x.DATA_INSERCAO <= to_date('21-02-2018 08:29', 'dd-mm-yyyy hh24:mi')

  )
;

SELECT
  x.*
FROM PCPC_040 x
WHERE 1=1
  AND x.ORDEM_PRODUCAO = 4217
--  AND x.
;


SELECT
  case
  when o.REFERENCIA_PECA <= '99999' then 'PA'
  when o.REFERENCIA_PECA <= 'B9999' then 'PG'
  else 'MD'
  end TIPO_REF
, ( SELECT
      coalesce( max( l.CODIGO_FAMILIA || '-' || div.DESCRICAO ), ' ' )
    FROM pcpc_040 l
    LEFT JOIN BASI_180 div
      ON div.DIVISAO_PRODUCAO = l.CODIGO_FAMILIA
    WHERE l.ORDEM_PRODUCAO = o.ORDEM_PRODUCAO
      AND l.CODIGO_FAMILIA > 1
      AND l.CODIGO_FAMILIA < 1000
  ) UNIDADE
, CASE
  WHEN o.ORDEM_PRINCIPAL <> 0 THEN 'Filha de'
  WHEN ofi.ORDEM_PRODUCAO IS NOT NULL THEN 'Mãe de'
  ELSE 'Avulsa'
  END TIPO_OPcoalesce(d.USUARIO_SYSTEXTIL, ' ') USU
, TO_CHAR(d.DATA_INSERCAO, 'DD/MM/YYYY HH24:MI') DT
, coalesce( ofi.ORDEM_PRODUCAO, o.ORDEM_PRINCIPAL ) OP_REL
, o.SITUACAO ||
  CASE
  WHEN o.SITUACAO = 2 THEN '-Ordem conf. gerada'
  WHEN o.SITUACAO = 4 THEN '-Ordens em produção'
  WHEN o.SITUACAO = 9 THEN '-Ordem cancelada'
  ELSE ' '
  END SITUACAO
, o.COD_CANCELAMENTO ||
  CASE
  WHEN o.COD_CANCELAMENTO = 0 THEN ''
  ELSE '-' || COALESCE(c.DESCRICAO, '')
  END CANCELAMENTO
, o.ALTERNATIVA_PECA ALTERNATIVA
, o.ROTEIRO_PECA ROTEIRO
, o.REFERENCIA_PECA REF
, COALESCE(
  CASE WHEN o.REFERENCIA_PECA < 'C0000' THEN
    CAST( CAST( regexp_replace(o.REFERENCIA_PECA, '[^0-9]', '')
                AS INTEGER ) AS VARCHAR2(5) )
  ELSE
    ( SELECT
        CAST( MAX(
          CASE WHEN ec.GRUPO_ITEM IS NULL THEN 0
          ELSE CAST( regexp_replace(ec.GRUPO_ITEM, '[^0-9]', '')
                     AS INTEGER )
          END
        ) AS VARCHAR2(5) )
        FROM BASI_050 ec
        JOIN BASI_030 rr
          ON rr.NIVEL_ESTRUTURA = ec.NIVEL_ITEM
         AND rr.REFERENCIA = ec.GRUPO_ITEM
         AND rr.RESPONSAVEL IS NOT NULL
        WHERE ec.NIVEL_COMP = 1
          AND ec.GRUPO_COMP = o.REFERENCIA_PECA
    )
  END
  , ' ' ) MODELO
, ( SELECT
      COUNT( DISTINCT l.ORDEM_CONFECCAO )
    FROM pcpc_040 l
    WHERE l.ORDEM_PRODUCAO = o.ORDEM_PRODUCAO
  ) LOTES
, ( SELECT
      SUM( l.QTDE_PECAS_PROG )
    FROM pcpc_040 l
    WHERE l.ORDEM_PRODUCAO = o.ORDEM_PRODUCAO
      AND l.SEQ_OPERACAO = (
        SELECT
          MAX( ls.SEQ_OPERACAO )
        FROM pcpc_040 ls
        WHERE ls.ORDEM_PRODUCAO = l.ORDEM_PRODUCAO
      )
  ) QTD
, o.DATA_PROGRAMACAO DT_DIGITACAO
, o.DATA_ENTRADA_CORTE DT_CORTE
, o.PERIODO_PRODUCAO PERIODO
, p.DATA_INI_PERIODO PERIODO_INI
, p.DATA_FIM_PERIODO PERIODO_FIM
, o.DEPOSITO_ENTRADA || ' - ' || d.DESCRICAO DEPOSITO
, o.PEDIDO_VENDA PEDIDO
, COALESCE(ped.COD_PED_CLIENTE, ' ') PED_CLIENTE
, r.NUMERO_MOLDE MOLDE
, o.OBSERVACAO
, o.OBSERVACAO2
FROM PCPC_020 o
JOIN PCPC_010 p
  ON p.AREA_PERIODO = 1
 AND p.PERIODO_PRODUCAO = o.PERIODO_PRODUCAO
LEFT JOIN pcpt_050 c
  ON c.COD_CANCELAMENTO = o.COD_CANCELAMENTO
LEFT JOIN PCPC_020 ofi
  ON ofi.ORDEM_PRINCIPAL = o.ORDEM_PRODUCAO
JOIN BASI_205 d
  ON d.CODIGO_DEPOSITO = o.DEPOSITO_ENTRADA
LEFT JOIN PEDI_100 ped -- pedido de venda
  ON ped.PEDIDO_VENDA = o.PEDIDO_VENDA
JOIN basi_030 r
  ON r.NIVEL_ESTRUTURA = 1
 AND r.REFERENCIA = o.REFERENCIA_PECA
WHERE o.ORDEM_PRODUCAO = 4217
;

SELECT
  rotp.GRUPO_ESTRUTURA
, rotp.NUMERO_ROTEIRO
, rotp.SEQ_OPERACAO
, rotp.IND_ESTAGIO_GARGALO
, rotp.CODIGO_OPERACAO
, rotp.NIVEL_ESTRUTURA
, rotp.SUBGRU_ESTRUTURA
, rotp.ITEM_ESTRUTURA
, rotp.NUMERO_ALTERNATI
FROM SYSTEXTIL.MQOP_050 rotp
WHERE rotp.GRUPO_ESTRUTURA='Z01MD'
--  AND rotp.NUMERO_ROTEIRO=1
ORDER BY
  rotp.GRUPO_ESTRUTURA
, rotp.NUMERO_ROTEIRO
, rotp.SEQ_OPERACAO
;

SELECT
  i.CODIGO_BARRAS
, i.*
FROM basi_010 i
WHERE i.NIVEL_ESTRUTURA = 1
  AND i.GRUPO_ESTRUTURA = '00254'
  AND i.ITEM_ESTRUTURA IN ('0000PR')
--  AND i.SUBGRU_ESTRUTURA IN ('GG')
ORDER BY
  i.ITEM_ESTRUTURA
, i.SUBGRU_ESTRUTURA
;

SELECT
  i.*
FROM basi_030 i
WHERE i.CONTA_ESTOQUE = 20
;

SELECT
  o.DATA_ENTRADA_CORTE
, o.*
FROM PCPC_020 o
WHERE 1=1
--  AND o.ORDEM_PRODUCAO = 3444
  AND o.DATA_ENTRADA_CORTE = TO_DATE('20/02/2018','DD/MM/YYYY')
  AND o.SITUACAO IN (2, 4)
;

SELECT DISTINCT
  l.*
FROM PCPC_040 l
WHERE l.PERIODO_PRODUCAO = 1740
  AND l.ORDEM_CONFECCAO = 100
;

SELECT
  l.PERIODO_PRODUCAO
, l.ORDEM_CONFECCAO
, l.CODIGO_ESTAGIO
, l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A - l.QTDE_PERDAS - l.QTDE_CONSERTO Q_A_PROD
, l.QTDE_PECAS_PROG Q_PROG
, l.QTDE_A_PRODUZIR_PACOTE Q_AP
, l.QTDE_EM_PRODUCAO_PACOTE Q_EP
, l.QTDE_PECAS_PROD Q_PROD
, l.QTDE_PECAS_2A Q_2A
, l.QTDE_PERDAS Q_PERDA
, l.QTDE_CONSERTO Q_CONSERTO
, o.*
FROM PCPC_020 o -- OP
JOIN PCPC_040 l -- lote
  ON l.ORDEM_PRODUCAO = o.ORDEM_PRODUCAO
WHERE 1=1
  AND o.SITUACAO IN (2, 4)
--  AND o.ORDEM_PRODUCAO = 3444
  AND o.DATA_ENTRADA_CORTE = TO_DATE('20/02/2018','DD/MM/YYYY')
  AND l.PERIODO_PRODUCAO = 1807
  AND l.ORDEM_CONFECCAO = 3261
  AND (l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A - l.QTDE_PERDAS - l.QTDE_CONSERTO) > 0
;

SELECT DISTINCT
  e.SEQUENCIA
, e.NIVEL_COMP NIVEL
, e.GRUPO_COMP REF
, r.DESCR_REFERENCIA DESCR
, e.SUB_COMP TAM
, e.ITEM_COMP COR
, e.ALTERNATIVA_COMP ALTERN
, e.CONSUMO
, e.ESTAGIO || '-' || es.DESCRICAO ESTAGIO
, (
  SELECT
    LISTAGG(ee.ITEM_ITEM, ', ')
      WITHIN GROUP (ORDER BY ee.ITEM_ITEM)
  FROM BASI_050 ee
  WHERE ee.SEQUENCIA = e.SEQUENCIA
    AND ee.NIVEL_ITEM = e.NIVEL_ITEM
    AND ee.GRUPO_ITEM = e.GRUPO_ITEM
    AND ee.ALTERNATIVA_ITEM = e.ALTERNATIVA_ITEM
    AND ee.NIVEL_COMP = e.NIVEL_COMP
    AND ee.GRUPO_COMP = e.GRUPO_COMP
    AND ee.SUB_COMP = e.SUB_COMP
    AND ee.ITEM_COMP = e.ITEM_COMP
  ) COR_REF
FROM BASI_050 e
LEFT JOIN basi_030 r
  ON r.NIVEL_ESTRUTURA = e.NIVEL_COMP
 AND r.REFERENCIA = e.GRUPO_COMP
LEFT JOIN MQOP_005 es
  ON es.CODIGO_ESTAGIO = e.ESTAGIO
WHERE e.NIVEL_ITEM = 1
  AND e.GRUPO_ITEM = 'M809S'
  AND e.ALTERNATIVA_ITEM = 7
ORDER BY
  e.SEQUENCIA
;

SELECT
  l.PERIODO_PRODUCAO
, l.ORDEM_CONFECCAO
, o.REFERENCIA_PECA
, o.ALTERNATIVA_PECA
, l.CODIGO_ESTAGIO
, l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A - l.QTDE_PERDAS - l.QTDE_CONSERTO Q_A_PROD
, ia.*
FROM PCPC_020 o -- OP
JOIN PCPC_040 l -- lote
  ON l.ORDEM_PRODUCAO = o.ORDEM_PRODUCAO
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = 1
 AND ia.GRUPO_ITEM = o.REFERENCIA_PECA
 AND ia.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND ia.ESTAGIO = l.CODIGO_ESTAGIO
WHERE 1=1
  AND o.SITUACAO IN (2, 4)
--  AND o.ORDEM_PRODUCAO = 3444
  AND o.DATA_ENTRADA_CORTE = TO_DATE('20/02/2018','DD/MM/YYYY')
  AND l.PERIODO_PRODUCAO = 1807
  AND l.ORDEM_CONFECCAO = 3261
  AND (l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A - l.QTDE_PERDAS - l.QTDE_CONSERTO) > 0
ORDER BY
  l.SEQUENCIA_ESTAGIO
;

SELECT
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, ia.SUB_COMP
, ia.ITEM_COMP
, ia.CONSUMO
, l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A - l.QTDE_PERDAS - l.QTDE_CONSERTO Q_A_PROD
, ia.CONSUMO * (l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A - l.QTDE_PERDAS - l.QTDE_CONSERTO) Q_NECESSIDADE
FROM PCPC_020 o -- OP
JOIN PCPC_040 l -- lote
  ON l.ORDEM_PRODUCAO = o.ORDEM_PRODUCAO
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = 1
 AND ia.GRUPO_ITEM = o.REFERENCIA_PECA
 AND ia.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND ia.ESTAGIO = l.CODIGO_ESTAGIO
WHERE 1=1
  AND o.SITUACAO IN (2, 4)
--  AND o.ORDEM_PRODUCAO = 3444
  AND o.DATA_ENTRADA_CORTE = TO_DATE('20/02/2018','DD/MM/YYYY')
  AND l.PERIODO_PRODUCAO = 1807
  AND l.ORDEM_CONFECCAO = 3261
  AND (l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A - l.QTDE_PERDAS - l.QTDE_CONSERTO) > 0
ORDER BY
  l.SEQUENCIA_ESTAGIO
;

SELECT
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, ia.SEQUENCIA
, ia.GRUPO_ITEM
, o.ALTERNATIVA_PECA
, ia.SUB_COMP
, ia.ITEM_COMP
, sum( ia.CONSUMO * (l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A - l.QTDE_PERDAS - l.QTDE_CONSERTO) ) Q_NECESSIDADE
FROM PCPC_020 o -- OP
JOIN PCPC_040 l -- lote
  ON l.ORDEM_PRODUCAO = o.ORDEM_PRODUCAO
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = 1
 AND ia.NIVEL_COMP <> 1
 AND ia.GRUPO_ITEM = o.REFERENCIA_PECA
 AND ia.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND ia.ESTAGIO = l.CODIGO_ESTAGIO
WHERE 1=1
  AND o.SITUACAO IN (2, 4)
--  AND o.ORDEM_PRODUCAO = 3444
  AND o.DATA_ENTRADA_CORTE = TO_DATE('01/03/2018','DD/MM/YYYY')
--  AND l.PERIODO_PRODUCAO = 1807
--  AND l.ORDEM_CONFECCAO = 3261
  AND (l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A - l.QTDE_PERDAS - l.QTDE_CONSERTO) > 0
GROUP BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, ia.SEQUENCIA
, ia.GRUPO_ITEM
, o.ALTERNATIVA_PECA
, ia.SUB_COMP
, ia.ITEM_COMP
ORDER BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, ia.SEQUENCIA
, ia.GRUPO_ITEM
, o.ALTERNATIVA_PECA
, ia.SUB_COMP
, ia.ITEM_COMP
;

SELECT
  co.*
FROM BASI_040 co -- combinação
WHERE co.GRUPO_ITEM = 'M717R'
  AND co.ALTERNATIVA_ITEM = 1
  AND co.SEQUENCIA = 10
;

SELECT
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, ia.SEQUENCIA
, ia.GRUPO_ITEM
, o.ALTERNATIVA_PECA
, ia.SUB_COMP SUB_COMP_ORI
, CASE WHEN ia.SUB_COMP = '000'
  THEN co.SUB_COMP
  ELSE ia.SUB_COMP
  END SUB_COMP
, ia.ITEM_COMP ITEM_COMP_ORI
, CASE WHEN ia.ITEM_COMP = '000000'
  THEN co.ITEM_COMP
  ELSE ia.ITEM_COMP
  END ITEM_COMP
, sum( ia.CONSUMO * (l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A - l.QTDE_PERDAS - l.QTDE_CONSERTO) ) Q_NECESSIDADE
FROM PCPC_020 o -- OP
JOIN PCPC_040 l -- lote
  ON l.ORDEM_PRODUCAO = o.ORDEM_PRODUCAO
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = 1
 AND ia.NIVEL_COMP <> 1
 AND ia.GRUPO_ITEM = o.REFERENCIA_PECA
 AND ia.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND ia.ESTAGIO = l.CODIGO_ESTAGIO
LEFT JOIN BASI_040 co -- combinação
  ON ( ia.ITEM_COMP = '000000' OR ia.SUB_COMP = '000')
 AND co.GRUPO_ITEM = ia.GRUPO_ITEM
 AND co.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND co.SEQUENCIA = ia.SEQUENCIA
 AND ( ( ia.ITEM_COMP = '000000'
	   AND co.ITEM_ITEM = l.PROCONF_ITEM
       )
     OR
       ( ia.SUB_COMP = '000'
       AND co.SUB_ITEM = l.PROCONF_SUBGRUPO
       )
     )
WHERE 1=1
  AND o.SITUACAO IN (2, 4)
--  AND o.ORDEM_PRODUCAO = 3444
  AND o.DATA_ENTRADA_CORTE = TO_DATE('01/03/2018','DD/MM/YYYY')
--  AND l.PERIODO_PRODUCAO = 1807
--  AND l.ORDEM_CONFECCAO = 3261
  AND (l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A - l.QTDE_PERDAS - l.QTDE_CONSERTO) > 0
--  AND ia.GRUPO_COMP = 'TC004'
--  AND ia.GRUPO_COMP = 'TR018'
GROUP BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, ia.SEQUENCIA
, ia.GRUPO_ITEM
, o.ALTERNATIVA_PECA
, ia.SUB_COMP
, co.SUB_COMP
, ia.ITEM_COMP
, co.ITEM_COMP
ORDER BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, ia.SEQUENCIA
, ia.GRUPO_ITEM
, o.ALTERNATIVA_PECA
, ia.SUB_COMP
, co.SUB_COMP
, ia.ITEM_COMP
, co.ITEM_COMP
;

SELECT
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, CASE WHEN ia.SUB_COMP = '000'
  THEN co.SUB_COMP
  ELSE ia.SUB_COMP
  END SUB_COMP
, CASE WHEN ia.ITEM_COMP = '000000'
  THEN co.ITEM_COMP
  ELSE ia.ITEM_COMP
  END ITEM_COMP
, sum( ia.CONSUMO * (l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A - l.QTDE_PERDAS - l.QTDE_CONSERTO) ) Q_NECESSIDADE
FROM PCPC_020 o -- OP
JOIN PCPC_040 l -- lote
  ON l.ORDEM_PRODUCAO = o.ORDEM_PRODUCAO
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = 1
 AND ia.NIVEL_COMP <> 1
 AND ia.GRUPO_ITEM = o.REFERENCIA_PECA
 AND ia.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND ia.ESTAGIO = l.CODIGO_ESTAGIO
LEFT JOIN BASI_040 co -- combinação
  ON ( ia.ITEM_COMP = '000000' OR ia.SUB_COMP = '000')
 AND co.GRUPO_ITEM = ia.GRUPO_ITEM
 AND co.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND co.SEQUENCIA = ia.SEQUENCIA
 AND ( ( ia.ITEM_COMP = '000000'
	   AND co.ITEM_ITEM = l.PROCONF_ITEM
       )
     OR
       ( ia.SUB_COMP = '000'
       AND co.SUB_ITEM = l.PROCONF_SUBGRUPO
       )
     )
JOIN basi_030 r -- referencia
  ON r.NIVEL_ESTRUTURA = ia.NIVEL_COMP
 AND r.REFERENCIA = ia.GRUPO_COMP
WHERE 1=1
  AND o.SITUACAO IN (2, 4)
  AND o.ORDEM_PRODUCAO = 3445
--  AND o.DATA_ENTRADA_CORTE = TO_DATE('01/03/2018','DD/MM/YYYY')
--  AND l.PERIODO_PRODUCAO = 1807
--  AND l.ORDEM_CONFECCAO = 3261
  AND (l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A - l.QTDE_PERDAS - l.QTDE_CONSERTO) > 0
--  AND ia.GRUPO_COMP = 'TC004'
--  AND ia.GRUPO_COMP = 'TR018'
  AND o.REFERENCIA_PECA = '00256'
  AND r.CONTA_ESTOQUE = 28
GROUP BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, CASE WHEN ia.ITEM_COMP = '000000'
  THEN co.ITEM_COMP
  ELSE ia.ITEM_COMP
  END
, CASE WHEN ia.SUB_COMP = '000'
  THEN co.SUB_COMP
  ELSE ia.SUB_COMP
  END
ORDER BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, 4
, 3
;

SELECT
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, CASE WHEN ia.ITEM_COMP = '000000'
  THEN coc.ITEM_COMP
  ELSE ia.ITEM_COMP
  END ITEM_COMP
, CASE WHEN ia.SUB_COMP = '000'
  THEN cot.SUB_COMP
  ELSE ia.SUB_COMP
  END SUB_COMP
, sum( ia.CONSUMO * (l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A - l.QTDE_PERDAS - l.QTDE_CONSERTO) ) Q_NECESSIDADE
FROM PCPC_020 o -- OP
JOIN PCPC_040 l -- lote
  ON l.ORDEM_PRODUCAO = o.ORDEM_PRODUCAO
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = 1
 AND ia.NIVEL_COMP <> 1
 AND ia.GRUPO_ITEM = o.REFERENCIA_PECA
 AND ia.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND ia.ESTAGIO = l.CODIGO_ESTAGIO
LEFT JOIN BASI_040 coc -- combinação cor
  ON ia.ITEM_COMP = '000000'
 AND coc.GRUPO_ITEM = ia.GRUPO_ITEM
 AND coc.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND coc.SEQUENCIA = ia.SEQUENCIA
 AND coc.ITEM_ITEM = l.PROCONF_ITEM
LEFT JOIN BASI_040 cot -- combinação tamanho
  ON ia.SUB_COMP = '000'
 AND cot.GRUPO_ITEM = ia.GRUPO_ITEM
 AND cot.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND cot.SEQUENCIA = ia.SEQUENCIA
 AND cot.SUB_ITEM = l.PROCONF_SUBGRUPO
JOIN basi_030 r -- referencia
  ON r.NIVEL_ESTRUTURA = ia.NIVEL_COMP
 AND r.REFERENCIA = ia.GRUPO_COMP
WHERE 1=1
  AND o.SITUACAO IN (2, 4)
  AND (l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A - l.QTDE_PERDAS - l.QTDE_CONSERTO) > 0
  AND o.ORDEM_PRODUCAO = 3448
--  AND o.DATA_ENTRADA_CORTE = TO_DATE('01/03/2018','DD/MM/YYYY')
--  AND l.PERIODO_PRODUCAO = 1807
--  AND l.ORDEM_CONFECCAO = 3261
--  AND ia.GRUPO_COMP = 'TC004'
--  AND ia.GRUPO_COMP = 'TR018'
--  AND o.REFERENCIA_PECA = '00256'
--  AND r.CONTA_ESTOQUE = 28
GROUP BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, CASE WHEN ia.ITEM_COMP = '000000'
  THEN coc.ITEM_COMP
  ELSE ia.ITEM_COMP
  END
, CASE WHEN ia.SUB_COMP = '000'
  THEN cot.SUB_COMP
  ELSE ia.SUB_COMP
  END
ORDER BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, 4
, 3
;

DELETE FROM BASI_070 rc -- capa de roteiro
--SELECT * FROM BASI_070 rc -- capa de roteiro
WHERE rc.NIVEL='1'
  AND rc.GRUPO IN
(
	SELECT
	  r.REFERENCIA
	FROM basi_030 r -- referência
	WHERE r.NIVEL_ESTRUTURA = 1
	  AND r.RESPONSAVEL IS NOT NULL
    AND (
       r.REFERENCIA like 'E%'
    OR r.REFERENCIA like 'Q%'
    OR r.REFERENCIA like 'N%'
    OR r.REFERENCIA like 'M%'
    OR r.REFERENCIA like 'L%'
    OR r.REFERENCIA like 'P%'
    )
    AND r.COLECAO IN (9, 10, 11, 12)
)
  AND rc.ROTEIRO IN (4)
;

INSERT INTO SYSTEXTIL.BASI_070
(NIVEL, GRUPO, ITEM, ROTEIRO, SUBGRUPO, ALTERNATIVA, DESCRICAO, LARGURA, GRAMATURA, RENDIMENTO)
SELECT
  rc.NIVEL
, REF.REFERENCIA GRUPO
, rc.ITEM
, rc.ROTEIRO
, rc.SUBGRUPO
, rc.ALTERNATIVA
, rc.DESCRICAO
, rc.LARGURA
, rc.GRAMATURA
, rc.RENDIMENTO
FROM BASI_070 rc -- roteiro capa
,
(
	SELECT
	  r.REFERENCIA
	FROM basi_030 r -- referência
	WHERE r.NIVEL_ESTRUTURA = 1
	  AND r.RESPONSAVEL IS NOT NULL
    AND (
       r.REFERENCIA like 'E%'
    OR r.REFERENCIA like 'Q%'
    OR r.REFERENCIA like 'N%'
    OR r.REFERENCIA like 'M%'
    OR r.REFERENCIA like 'L%'
    OR r.REFERENCIA like 'P%'
    )
    AND r.COLECAO IN (9, 10, 11, 12)
) ref
WHERE rc.NIVEL='1'
  AND rc.GRUPO='Z01MD'
  AND rc.ROTEIRO IN (4)
;

DELETE FROM MQOP_050 rop -- lista de operações de um roteiro
--SELECT * FROM MQOP_050 rop -- lista de operações de um roteiro
WHERE rop.NIVEL_ESTRUTURA = '1'
  AND rop.GRUPO_ESTRUTURA IN (
	SELECT
	  r.REFERENCIA
	FROM basi_030 r -- referência
	WHERE r.NIVEL_ESTRUTURA = 1
	  AND r.RESPONSAVEL IS NOT NULL
    AND (
       r.REFERENCIA like 'E%'
    OR r.REFERENCIA like 'Q%'
    OR r.REFERENCIA like 'N%'
    OR r.REFERENCIA like 'M%'
    OR r.REFERENCIA like 'L%'
    OR r.REFERENCIA like 'P%'
    )
    AND r.COLECAO IN (9, 10, 11, 12)
)
  AND rop.NUMERO_ROTEIRO IN (4)
;

INSERT INTO MQOP_050
(NIVEL_ESTRUTURA, GRUPO_ESTRUTURA, SUBGRU_ESTRUTURA, ITEM_ESTRUTURA, NUMERO_ALTERNATI, NUMERO_ROTEIRO, SEQ_OPERACAO, CODIGO_OPERACAO, MINUTOS, CODIGO_ESTAGIO, CENTRO_CUSTO, SEQUENCIA_ESTAGIO, ESTAGIO_ANTERIOR, ESTAGIO_DEPENDE, SEPARA_OPERACAO, MINUTOS_HOMEM, CCUSTO_HOMEM, NUMERO_CORDAS, NUMERO_ROLOS, VELOCIDADE, CODIGO_FAMILIA, OBSERVACAO, TIPO_PROCESSO, PECAS_1_HORA, PECAS_8_HORAS, CUSTO_MINUTO, PERC_EFICIENCIA, TEMPERATURA, TEMPO_LOTE_PRODUCAO, PECAS_LOTE_PRODUCAO, TIME_CELULA, CODIGO_APARELHO, PERC_EFIC_ROT, NUMERO_OPERADORAS, CONSIDERA_EFIC, SEQ_OPERACAO_AGRUPADORA, CODIGO_PARTE_PECA, SEQ_JUNCAO_PARTE_PECA, SITUACAO, PERC_PERDAS, PERC_CUSTOS, IND_ESTAGIO_GARGALO)
SELECT
  rop.NIVEL_ESTRUTURA
, REF.REFERENCIA GRUPO_ESTRUTURA
, rop.SUBGRU_ESTRUTURA
, rop.ITEM_ESTRUTURA
, rop.NUMERO_ALTERNATI
, rop.NUMERO_ROTEIRO
, rop.SEQ_OPERACAO
, rop.CODIGO_OPERACAO
, rop.MINUTOS
, rop.CODIGO_ESTAGIO
, rop.CENTRO_CUSTO
, rop.SEQUENCIA_ESTAGIO
, rop.ESTAGIO_ANTERIOR
, rop.ESTAGIO_DEPENDE
, rop.SEPARA_OPERACAO
, rop.MINUTOS_HOMEM
, rop.CCUSTO_HOMEM
, rop.NUMERO_CORDAS
, rop.NUMERO_ROLOS
, rop.VELOCIDADE
, rop.CODIGO_FAMILIA
, rop.OBSERVACAO
, rop.TIPO_PROCESSO
, rop.PECAS_1_HORA
, rop.PECAS_8_HORAS
, rop.CUSTO_MINUTO
, rop.PERC_EFICIENCIA
, rop.TEMPERATURA
, rop.TEMPO_LOTE_PRODUCAO
, rop.PECAS_LOTE_PRODUCAO
, rop.TIME_CELULA
, rop.CODIGO_APARELHO
, rop.PERC_EFIC_ROT
, rop.NUMERO_OPERADORAS
, rop.CONSIDERA_EFIC
, rop.SEQ_OPERACAO_AGRUPADORA
, rop.CODIGO_PARTE_PECA
, rop.SEQ_JUNCAO_PARTE_PECA
, rop.SITUACAO
, rop.PERC_PERDAS
, rop.PERC_CUSTOS
, rop.IND_ESTAGIO_GARGALO
FROM MQOP_050 rop
,
(
	SELECT
	  r.REFERENCIA
	FROM basi_030 r -- referência
	WHERE r.NIVEL_ESTRUTURA = 1
	  AND r.RESPONSAVEL IS NOT NULL
    AND (
       r.REFERENCIA like 'E%'
    OR r.REFERENCIA like 'Q%'
    OR r.REFERENCIA like 'N%'
    OR r.REFERENCIA like 'M%'
    OR r.REFERENCIA like 'L%'
    OR r.REFERENCIA like 'P%'
    )
    AND r.COLECAO IN (9, 10, 11, 12)
) ref
WHERE rop.NIVEL_ESTRUTURA = '1'
  AND rop.GRUPO_ESTRUTURA = 'Z01MD'
	AND rop.NUMERO_ROTEIRO IN (4)
;

SELECT
  i.CODIGO_BARRAS
, i.*
FROM basi_010 i
WHERE i.NIVEL_ESTRUTURA = 1
  AND i.GRUPO_ESTRUTURA = '01033'
  AND i.ITEM_ESTRUTURA IN ('0000PR')
;

SELECT
  o.*
FROM PCPC_020 o -- OP
WHERE o.ORDEM_PRODUCAO >= 4484
;

UPDATE PCPC_020
SET SITUACAO=4, COD_CANCELAMENTO=0, DT_CANCELAMENTO=NULL
WHERE ORDEM_PRODUCAO=4484;
;

UPDATE PCPC_020
SET SITUACAO=4, COD_CANCELAMENTO=0, DT_CANCELAMENTO=NULL
WHERE ORDEM_PRODUCAO=4485;
;


BR  P 7896896285378
BR  M 7896896285385
BR  G 7896896285392
BR GG 7896896285408

UPDATE BASI_010 SET CODIGO_BARRAS='7896896285378' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0254X' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896285385' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0254X' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896285392' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0254X' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896285408' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0254X' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000BR';

CB  P 7896896285415
CB  M 7896896285422
CB  G 7896896285439
CB GG 7896896285446

UPDATE BASI_010 SET CODIGO_BARRAS='7896896285415' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0254X' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000CB';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896285422' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0254X' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000CB';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896285439' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0254X' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000CB';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896285446' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0254X' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000CB';

ME  P 7896896289369
ME  M 7896896289352
ME  G 7896896289345
ME GG 7896896289338

UPDATE BASI_010 SET CODIGO_BARRAS='7896896289369' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0254X' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896289352' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0254X' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896289345' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0254X' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896289338' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0254X' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000ME';

PR  P 7896896285453
PR  M 7896896285460
PR  G 7896896285477
PR GG 7896896285484

UPDATE BASI_010 SET CODIGO_BARRAS='7896896285453' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0254X' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896285460' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0254X' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896285477' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0254X' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896285484' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0254X' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000PR';

UPDATE BASI_010 SET CODIGO_BARRAS='7899618835660' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0251A' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618835677' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0251A' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618835653' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0251A' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618835646' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0251A' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618835745' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0251A' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000PE';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618835752' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0251A' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000PE';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618835738' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0251A' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000PE';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618835721' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0251A' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000PE';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618835707' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0251A' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000VI';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618835714' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0251A' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000VI';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618835691' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0251A' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000VI';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618835684' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0251A' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000VI';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618835783' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0251A' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000VM';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618835790' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0251A' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000VM';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618835776' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0251A' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000VM';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618835769' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0251A' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000VM';

UPDATE BASI_010 SET CODIGO_BARRAS='7896896258440' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0271A' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896258457' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0271A' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896258396' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0271A' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896258389' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0271A' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836247' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0271A' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000CZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836254' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0271A' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000CZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836230' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0271A' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000CZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836223' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0271A' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000CZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836162' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0271A' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836179' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0271A' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836155' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0271A' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836148' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0271A' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000MA';

UPDATE BASI_010 SET CODIGO_BARRAS='7896896233911' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0809B' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896233928' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0809B' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896233935' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0809B' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896233942' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0809B' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896228788' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0809B' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896228795' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0809B' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896233898' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0809B' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896233904' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0809B' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000BR';

SELECT
  c.*
FROM BASI_150 c
;

SELECT
  ia.NIVEL_COMP NIVEL
, ia.GRUPO_COMP REF
, CASE WHEN ia.ITEM_COMP = '000000'
  THEN coc.ITEM_COMP
  ELSE ia.ITEM_COMP
  END COR
, CASE WHEN ia.SUB_COMP = '000'
  THEN cot.SUB_COMP
  ELSE ia.SUB_COMP
  END TAM
--, regexp_replace(
--    LISTAGG(o.REFERENCIA_PECA, ', ')
--    WITHIN GROUP (ORDER BY o.REFERENCIA_PECA)
--  , '([^,]+)(, \1)+', '\1') as REFS
--, regexp_replace(
--    LISTAGG(o.ORDEM_PRODUCAO, ', ')
--    WITHIN GROUP (ORDER BY o.ORDEM_PRODUCAO)
--  , '([^,]+)(, \1)+', '\1') as OPS
--, dbms_lob.substr(
--    ltrim(
--      REGEXP_REPLACE(
--        REPLACE(
--          REPLACE(
--            XMLAGG(
--              XMLELEMENT("A",o.ORDEM_PRODUCAO)
--              ORDER BY o.ORDEM_PRODUCAO
--            ).getClobVal()
--          , '<A>'
--          , '-'
--          )
--        , '</A>'
--        , ''
--        )
--      , '([^-]*)(-\1)+($|-)'
--      , '\1\3'
--      )
--    ,'-'
--    )
--  , 4000
--  , 1) as OPS
--, dbms_lob.substr(
--            XMLAGG(
--              XMLELEMENT("A",o.ORDEM_PRODUCAO)
--              ORDER BY o.ORDEM_PRODUCAO
--            ).getClobVal()
--  , 4000
--  , 1) as OPS
, REGEXP_REPLACE(
    REGEXP_REPLACE(
      REPLACE(
            XMLAGG(
              XMLELEMENT("A",(' '||o.REFERENCIA_PECA))
              ORDER BY o.REFERENCIA_PECA
            ).getClobVal()
      , '</A><A>'
      , ','
      )
    , '([^,]+)(,\1)+'
    , '\1'
    )
  , '</?A> ?'
  , ''
  )
  as REFS
, REGEXP_REPLACE(
    REGEXP_REPLACE(
      REPLACE(
            XMLAGG(
              XMLELEMENT("A",(' '||o.ORDEM_PRODUCAO))
              ORDER BY o.ORDEM_PRODUCAO
            ).getClobVal()
      , '</A><A>'
      , ','
      )
    , '([^,]+)(,\1)+'
    , '\1'
    )
  , '</?A> ?'
  , ''
  )
  as OPS
, sum( ia.CONSUMO *
       ( l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A
       - l.QTDE_PERDAS - l.QTDE_CONSERTO
       )
     ) QTD
FROM PCPC_020 o -- OP
JOIN PCPC_040 l -- lote
  ON l.ORDEM_PRODUCAO = o.ORDEM_PRODUCAO
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = 1
 AND ia.NIVEL_COMP <> 1
 AND ia.GRUPO_ITEM = o.REFERENCIA_PECA
 AND ia.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND ia.ESTAGIO = l.CODIGO_ESTAGIO
LEFT JOIN BASI_040 coc -- combinação cor
  ON ia.ITEM_COMP = '000000'
 AND coc.GRUPO_ITEM = ia.GRUPO_ITEM
 AND coc.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND coc.SEQUENCIA = ia.SEQUENCIA
 AND coc.ITEM_ITEM = l.PROCONF_ITEM
LEFT JOIN BASI_040 cot -- combinação tamanho
  ON ia.SUB_COMP = '000'
 AND cot.GRUPO_ITEM = ia.GRUPO_ITEM
 AND cot.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND cot.SEQUENCIA = ia.SEQUENCIA
 AND cot.SUB_ITEM = l.PROCONF_SUBGRUPO
JOIN basi_030 r -- referencia
  ON r.NIVEL_ESTRUTURA = ia.NIVEL_COMP
 AND r.REFERENCIA = ia.GRUPO_COMP
JOIN basi_030 ref -- referencia
  ON ref.NIVEL_ESTRUTURA = 1
 AND ref.REFERENCIA = o.REFERENCIA_PECA
WHERE o.SITUACAO IN (2, 4)
  AND ( l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A
  - l.QTDE_PERDAS - l.QTDE_CONSERTO
  ) > 0
--  AND o.ORDEM_PRODUCAO >= 3445
--  AND o.ORDEM_PRODUCAO <= 3455
--   -- filtro_op
  AND o.DATA_ENTRADA_CORTE >= TO_DATE('01/03/2018','DD/MM/YYYY') -- filtro_data_corte
  AND o.DATA_ENTRADA_CORTE <= TO_DATE('01/03/2018','DD/MM/YYYY') -- filtro_data_corte
--  AND l.PERIODO_PRODUCAO = 1807
--  AND l.ORDEM_CONFECCAO = 3261
--  AND ia.GRUPO_COMP = 'TC004'
--  AND ia.GRUPO_COMP = 'TR018'
--  AND o.REFERENCIA_PECA = '00256'
   -- filtro_conta_estoque
   -- filtro_ref
GROUP BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, CASE WHEN ia.ITEM_COMP = '000000'
  THEN coc.ITEM_COMP
  ELSE ia.ITEM_COMP
  END
, CASE WHEN ia.SUB_COMP = '000'
  THEN cot.SUB_COMP
  ELSE ia.SUB_COMP
  END
ORDER BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, 3
, 4
;

WITH NESSECIDADE AS (
SELECT
  ia.NIVEL_COMP NIVEL
, ia.GRUPO_COMP REFI
, CASE WHEN ia.ITEM_COMP = '000000'
  THEN coc.ITEM_COMP
  ELSE ia.ITEM_COMP
  END COR
, CASE WHEN ia.SUB_COMP = '000'
  THEN cot.SUB_COMP
  ELSE ia.SUB_COMP
  END TAM
, r.UNIDADE_MEDIDA UNID
, o.REFERENCIA_PECA REFP
, o.ORDEM_PRODUCAO OP
, sum( ia.CONSUMO *
       ( l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A
       - l.QTDE_PERDAS - l.QTDE_CONSERTO
       )
     ) QTD
FROM PCPC_020 o -- OP
JOIN PCPC_040 l -- lote
  ON l.ORDEM_PRODUCAO = o.ORDEM_PRODUCAO
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = 1
 AND ia.NIVEL_COMP <> 1
 AND ia.GRUPO_ITEM = o.REFERENCIA_PECA
 AND ia.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND ia.ESTAGIO = l.CODIGO_ESTAGIO
LEFT JOIN BASI_040 coc -- combinação cor
  ON ia.ITEM_COMP = '000000'
 AND coc.GRUPO_ITEM = ia.GRUPO_ITEM
 AND coc.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND coc.SEQUENCIA = ia.SEQUENCIA
 AND coc.ITEM_ITEM = l.PROCONF_ITEM
LEFT JOIN BASI_040 cot -- combinação tamanho
  ON ia.SUB_COMP = '000'
 AND cot.GRUPO_ITEM = ia.GRUPO_ITEM
 AND cot.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND cot.SEQUENCIA = ia.SEQUENCIA
 AND cot.SUB_ITEM = l.PROCONF_SUBGRUPO
JOIN basi_030 r -- referencia
  ON r.NIVEL_ESTRUTURA = ia.NIVEL_COMP
 AND r.REFERENCIA = ia.GRUPO_COMP
JOIN basi_030 ref -- referencia
  ON ref.NIVEL_ESTRUTURA = 1
 AND ref.REFERENCIA = o.REFERENCIA_PECA
WHERE o.SITUACAO IN (2, 4)
  AND ( l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A
  - l.QTDE_PERDAS - l.QTDE_CONSERTO
  ) > 0
--  AND o.ORDEM_PRODUCAO = 3445
   -- filtro_op
  AND o.DATA_ENTRADA_CORTE >= TO_DATE('01/01/2018','DD/MM/YYYY') -- filtro_data_corte
  AND o.DATA_ENTRADA_CORTE <= TO_DATE('01/01/2019','DD/MM/YYYY') -- filtro_data_corte
--  AND o.DATA_ENTRADA_CORTE >= '2018-03-01' -- filtro_data_corte
--  AND o.DATA_ENTRADA_CORTE <= '2018-03-09' -- filtro_data_corte
--  AND l.PERIODO_PRODUCAO = 1807
--  AND l.ORDEM_CONFECCAO = 3261
--  AND ia.GRUPO_COMP = 'TC004'
--  AND ia.GRUPO_COMP = 'TR018'
--  AND o.REFERENCIA_PECA = '00256'
   -- filtro_conta_estoque
   -- filtro_ref
GROUP BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, CASE WHEN ia.ITEM_COMP = '000000'
  THEN coc.ITEM_COMP
  ELSE ia.ITEM_COMP
  END
, CASE WHEN ia.SUB_COMP = '000'
  THEN cot.SUB_COMP
  ELSE ia.SUB_COMP
  END
, r.UNIDADE_MEDIDA
, o.REFERENCIA_PECA
, o.ORDEM_PRODUCAO
ORDER BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, 3
, 4
, o.REFERENCIA_PECA
, o.ORDEM_PRODUCAO
)
SELECT
  n.NIVEL
, n.REFI
, n.COR
, n.TAM
, n.UNID
, REPLACE(
    REGEXP_REPLACE(
      LISTAGG('#'||n.REFP, ', ')
      WITHIN GROUP (ORDER BY n.REFP)
    , '([^,]+)(, \1)+'
    , '\1'
    )
  , '#'
  , ''
  )
  AS REFS
, REPLACE(
    REGEXP_REPLACE(
      LISTAGG('#'||n.OP, ', ')
      WITHIN GROUP (ORDER BY n.OP)
    , '([^,]+)(, \1)+'
    , '\1'
    )
  , '#'
  , ''
  )
  AS OPS
, sum( n.QTD ) QTD
FROM NESSECIDADE n
GROUP BY
  n.NIVEL
, n.REFI
, n.COR
, n.TAM
, n.UNID
ORDER BY
  n.NIVEL
, n.REFI
, n.COR
, n.TAM
;

WITH NESSECIDADE AS (
SELECT
  ia.NIVEL_COMP NIVEL
, ia.GRUPO_COMP REFI
, CASE WHEN ia.ITEM_COMP = '000000'
  THEN coc.ITEM_COMP
  ELSE ia.ITEM_COMP
  END COR
, CASE WHEN ia.SUB_COMP = '000'
  THEN cot.SUB_COMP
  ELSE ia.SUB_COMP
  END TAM
, r.DESCR_REFERENCIA DESCR
, r.UNIDADE_MEDIDA UNID
, o.REFERENCIA_PECA REFP
, o.ORDEM_PRODUCAO OP
, sum( ia.CONSUMO *
       ( l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A
       - l.QTDE_PERDAS - l.QTDE_CONSERTO
       )
     ) QTD
FROM PCPC_020 o -- OP
JOIN PCPC_040 l -- lote
  ON l.ORDEM_PRODUCAO = o.ORDEM_PRODUCAO
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = 1
 AND ia.NIVEL_COMP <> 1
 AND ia.GRUPO_ITEM = o.REFERENCIA_PECA
 AND ia.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND ia.ESTAGIO = l.CODIGO_ESTAGIO
LEFT JOIN BASI_040 coc -- combinação cor
  ON ia.ITEM_COMP = '000000'
 AND coc.GRUPO_ITEM = ia.GRUPO_ITEM
 AND coc.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND coc.SEQUENCIA = ia.SEQUENCIA
 AND coc.ITEM_ITEM = l.PROCONF_ITEM
LEFT JOIN BASI_040 cot -- combinação tamanho
  ON ia.SUB_COMP = '000'
 AND cot.GRUPO_ITEM = ia.GRUPO_ITEM
 AND cot.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND cot.SEQUENCIA = ia.SEQUENCIA
 AND cot.SUB_ITEM = l.PROCONF_SUBGRUPO
JOIN basi_030 r -- referencia
  ON r.NIVEL_ESTRUTURA = ia.NIVEL_COMP
 AND r.REFERENCIA = ia.GRUPO_COMP
JOIN basi_030 ref -- referencia
  ON ref.NIVEL_ESTRUTURA = 1
 AND ref.REFERENCIA = o.REFERENCIA_PECA
WHERE o.SITUACAO IN (2, 4)
  AND ( l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A
  - l.QTDE_PERDAS - l.QTDE_CONSERTO
  ) > 0
--  AND o.ORDEM_PRODUCAO = 3445
   -- filtro_op
  AND o.DATA_ENTRADA_CORTE >= TO_DATE('01/01/2018','DD/MM/YYYY') -- filtro_data_corte
  AND o.DATA_ENTRADA_CORTE <= TO_DATE('01/01/2019','DD/MM/YYYY') -- filtro_data_corte
--  AND o.DATA_ENTRADA_CORTE >= '2018-03-01' -- filtro_data_corte
--  AND o.DATA_ENTRADA_CORTE <= '2018-03-09' -- filtro_data_corte
--  AND l.PERIODO_PRODUCAO = 1807
--  AND l.ORDEM_CONFECCAO = 3261
--  AND ia.GRUPO_COMP = 'TC004'
--  AND ia.GRUPO_COMP = 'TR018'
--  AND o.REFERENCIA_PECA = '00256'
   -- filtro_conta_estoque
   -- filtro_ref
GROUP BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, CASE WHEN ia.ITEM_COMP = '000000'
  THEN coc.ITEM_COMP
  ELSE ia.ITEM_COMP
  END
, CASE WHEN ia.SUB_COMP = '000'
  THEN cot.SUB_COMP
  ELSE ia.SUB_COMP
  END
, r.DESCR_REFERENCIA
, r.UNIDADE_MEDIDA
, o.REFERENCIA_PECA
, o.ORDEM_PRODUCAO
ORDER BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, 3
, 4
, o.REFERENCIA_PECA
, o.ORDEM_PRODUCAO
)
SELECT
  n.NIVEL
, n.REFI
, n.DESCR
, n.COR
, n.TAM
, n.UNID
, REPLACE(
    REGEXP_REPLACE(
      LISTAGG('#'||n.REFP, ', ')
      WITHIN GROUP (ORDER BY n.REFP)
    , '([^,]+)(, \1)+'
    , '\1'
    )
  , '#'
  , ''
  )
  AS REFS
, REPLACE(
    REGEXP_REPLACE(
      LISTAGG('#'||n.OP, ', ')
      WITHIN GROUP (ORDER BY n.OP)
    , '([^,]+)(, \1)+'
    , '\1'
    )
  , '#'
  , ''
  )
  AS OPS
, sum( n.QTD ) QTD
FROM NESSECIDADE n
GROUP BY
  n.NIVEL
, n.REFI
, n.DESCR
, n.COR
, n.TAM
, n.UNID
ORDER BY
  n.NIVEL
, n.REFI
, n.COR
, n.TAM
;


SELECT
  le.*
FROM pcpc_040 le
WHERE le.PERIODO_PRODUCAO = 1805
  AND le.ORDEM_CONFECCAO IN (1586, 1587, 1588)
  AND le.CODIGO_ESTAGIO in (12, 15)
;

SELECT
  l2.*
FROM pcpc_045 l2
WHERE l2.PCPC040_PERCONF = 1805
  AND l2.PCPC040_ORDCONF IN (1586, 1587)
  AND l2.PCPC040_ESTCONF in (15)
;

SELECT
  l2.*
FROM pcpc_045 l2
JOIN pcpc_040 l
  ON l.PERIODO_PRODUCAO = l2.PCPC040_PERCONF
 AND l.ORDEM_CONFECCAO = l2.PCPC040_ORDCONF
 AND l.CODIGO_ESTAGIO = l2.PCPC040_ESTCONF
WHERE l.ORDEM_PRODUCAO = 4552
--  AND l.QTDE_PECAS_PROD <> 0
--  AND l2.PCPC040_ORDCONF NOT IN (10127, 10128)
  AND l2.PCPC040_ESTCONF = 15
ORDER BY
  l2.PCPC040_ORDCONF
, l2.SEQUENCIA
;

INSERT INTO SYSTEXTIL.PCPC_045
(PCPC040_PERCONF, PCPC040_ORDCONF, PCPC040_ESTCONF, SEQUENCIA, DATA_PRODUCAO, HORA_PRODUCAO, QTDE_PRODUZIDA, QTDE_PECAS_2A, QTDE_CONSERTO, TURNO_PRODUCAO, TIPO_ENTRADA_ORD, NOTA_ENTR_ORDEM, SERIE_NF_ENT_ORD, SEQ_NF_ENTR_ORD, ORDEM_PRODUCAO, CODIGO_USUARIO, QTDE_PERDAS, NUMERO_DOCUMENTO, CODIGO_DEPOSITO, CODIGO_FAMILIA, CODIGO_INTERVALO, EXECUTA_TRIGGER, DATA_INSERCAO, PROCESSO_SYSTEXTIL, NUMERO_VOLUME, NR_OPERADORES, ATZ_PODE_PRODUZIR, ATZ_EM_PROD, ATZ_A_PROD, EFICIENCIA_INFORMADA, USUARIO_SYSTEXTIL, CODIGO_OCORRENCIA, COD_OCORRENCIA_ESTORNO, SOLICITACAO_CONSERTO, NUMERO_SOLICITACAO, NUMERO_ORDEM)
SELECT
  l2.PCPC040_PERCONF
, l2.PCPC040_ORDCONF
, l2.PCPC040_ESTCONF
, l2.SEQUENCIA+1 -- SEQUENCIA
, CURRENT_DATE -- DATA_PRODUCAO
, CURRENT_DATE -- HORA_PRODUCAO
, -l2.QTDE_PRODUZIDA -- QTDE_PRODUZIDA
, l2.QTDE_PECAS_2A
, l2.QTDE_CONSERTO
, l2.TURNO_PRODUCAO
, l2.TIPO_ENTRADA_ORD
, l2.NOTA_ENTR_ORDEM
, l2.SERIE_NF_ENT_ORD
, l2.SEQ_NF_ENTR_ORD
, l2.ORDEM_PRODUCAO
, l2.CODIGO_USUARIO
, l2.QTDE_PERDAS
, l2.NUMERO_DOCUMENTOBASI_015
, l2.CODIGO_DEPOSITO
, l2.CODIGO_FAMILIA
, l2.CODIGO_INTERVALO
, l2.EXECUTA_TRIGGER
, CURRENT_DATE -- DATA_INSERCAO
, 'pcpc_f046' -- PROCESSO_SYSTEXTIL
, l2.NUMERO_VOLUME
, l2.NR_OPERADORES
, l2.ATZ_PODE_PRODUZIR
, l2.ATZ_EM_PROD
, l2.ATZ_A_PROD
, l2.EFICIENCIA_INFORMADA
, l2.USUARIO_SYSTEXTIL
, l2.CODIGO_OCORRENCIA
, l2.COD_OCORRENCIA_ESTORNO
, l2.SOLICITACAO_CONSERTO
, l2.NUMERO_SOLICITACAO
, l2.NUMERO_ORDEM
FROM pcpc_045 l2
JOIN pcpc_040 l
  ON l.PERIODO_PRODUCAO = l2.PCPC040_PERCONF
 AND l.ORDEM_CONFECCAO = l2.PCPC040_ORDCONF
 AND l.CODIGO_ESTAGIO = l2.PCPC040_ESTCONF
WHERE l.ORDEM_PRODUCAO = 4552
  AND l.QTDE_PECAS_PROD <> 0
  AND l2.PCPC040_ORDCONF NOT IN (1586)
  AND l2.PCPC040_ESTCONF = 15
;


UPDATE SYSTEXTIL.PCPC_045 l2BASI_015
SET
  l2.CODIGO_USUARIO = 99001
, l2.PROCESSO_SYSTEXTIL='pcpc_f046'
, l2.USUARIO_SYSTEXTIL='ANSELMO_SIS'
WHERE l2.PCPC040_PERCONF=1805
  AND l2.PCPC040_ORDCONF in
  (
  SELECT
    l.ORDEM_CONFECCAO
  FROM pcpc_040 l
  WHERE l.ORDEM_PRODUCAO = 4552
  )
  AND l2.PCPC040_ORDCONF NOT IN (1586)
  AND l2.PCPC040_ESTCONF=15
  AND l2.SEQUENCIA=1
;

CODIGO DE BARRA = 78968962 xxxx# para range (1)
                  78996188 xxxx# para range (2)
     ONDE  xxxx = codigo do produto, cor e tamanho especificados
              # = digito verificador do codigo de barras

706   c.unico (1)07066
      BR  EG /(1)43866 G  /(1)48069 GG /(1)48076 M  /(1)48052 P  /(1)48045
      CB  EG /(1)57122 G  /(1)57108 GG /(1)57115 M  /(1)57092 P  /(1)57085
      CH  EG /(1)43873 G  /(1)17409 GG /(1)17416 M  /(1)17393 P  /(1)17355
      MA  EG /(1)57177 G  /(1)57153 GG /(1)57160 M  /(1)57146 P  /(1)57139
      VI  EG /(1)57221 G  /(1)57207 GG /(1)57214 M  /(1)57191 P  /(1)57184

UPDATE BASI_010 SET CODIGO_BARRAS='7896896248045' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00706' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896248052' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00706' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896248069' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00706' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896248076' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00706' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000BR';

Ref.  Cor Tam/Cod.barras
-----------------------------------------------------------------------------
467   c.unico (2)39675
      CB  G  /(2)39705 GG /(2)39712 M  /(2)39699 P  /(2)39682
      PR  G  /(2)39743 GG /(2)39750 M  /(2)39736 P  /(2)39729

UPDATE BASI_010 SET CODIGO_BARRAS='7899618839682' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00467' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000CB';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839699' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00467' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000CB';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839705' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00467' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000CB';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839712' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00467' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000CB';

UPDATE BASI_010 SET CODIGO_BARRAS='7899618839729' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00467' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839736' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00467' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839743' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00467' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839750' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00467' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000PR';

Ref.  Cor Tam/Cod.barras
---------------------------------------------------------------------
270   c.unico (2)36018
      BR  G  /(2)36049 GG /(2)36056 M  /(2)36032 P  /(2)36025
      MA  G  /(2)36087 GG /(2)36094 M  /(2)36070 P  /(2)36063
      PR  G  /(2)36124 GG /(2)36131 M  /(2)36117 P  /(2)36100

UPDATE BASI_010 SET CODIGO_BARRAS='7899618836063' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00270' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836070' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00270' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836087' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00270' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836094' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00270' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000MA';


SELECT
  u.*
FROM HDOC_030 u
WHERE u.USUARIO = 'OHANA_FIN'
;

SELECT
  i.CODIGO_BARRAS
, i.*
FROM basi_010 i
WHERE i.NIVEL_ESTRUTURA = 1
  AND i.GRUPO_ESTRUTURA = '0458U'
  AND i.ITEM_ESTRUTURA IN ('0000PR')
;

WITH NESSECIDADE AS (
SELECT
  ia.NIVEL_COMP NIVEL
, ia.GRUPO_COMP REF
, CASE WHEN ia.ITEM_COMP = '000000'
  THEN coc.ITEM_COMP
  ELSE ia.ITEM_COMP
  END COR
, CASE WHEN ia.SUB_COMP = '000'
  THEN cot.SUB_COMP
  ELSE ia.SUB_COMP
  END TAM
, coalesce(parm.ESTOQUE_MINIMO, 0) STQ_MIN
, coalesce(parm.TEMPO_REPOSICAO, 0) REPOSICAO
, r.DESCR_REFERENCIA DESCR
, r.UNIDADE_MEDIDA UNID
, o.REFERENCIA_PECA REFP
, o.ORDEM_PRODUCAO OP
, sum( ia.CONSUMO *
       (
    ( l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A
    - l.QTDE_PERDAS - l.QTDE_CONSERTO )
       )
     ) QTD
FROM PCPC_020 o -- OP
JOIN PCPC_040 l -- lote
  ON l.ORDEM_PRODUCAO = o.ORDEM_PRODUCAO
LEFT JOIN PCPC_010 pcorte
  ON pcorte.AREA_PERIODO = 1
 AND o.DATA_ENTRADA_CORTE >= pcorte.DATA_INI_PERIODO
 AND o.DATA_ENTRADA_CORTE <= pcorte.DATA_FIM_PERIODO
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = 1
 AND ia.NIVEL_COMP <> 1
 AND ia.GRUPO_ITEM = o.REFERENCIA_PECA
 AND ia.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND ia.ESTAGIO = l.CODIGO_ESTAGIO
LEFT JOIN BASI_040 coc -- combinação cor
  ON ia.ITEM_COMP = '000000'
 AND coc.GRUPO_ITEM = ia.GRUPO_ITEM
 AND coc.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND coc.SEQUENCIA = ia.SEQUENCIA
 AND coc.ITEM_ITEM = l.PROCONF_ITEM
LEFT JOIN BASI_040 cot -- combinação tamanho
  ON ia.SUB_COMP = '000'
 AND cot.GRUPO_ITEM = ia.GRUPO_ITEM
 AND cot.ALTERNATIVA_ITEM = o.ALTERNATIVA_PECA
 AND cot.SEQUENCIA = ia.SEQUENCIA
 AND cot.SUB_ITEM = l.PROCONF_SUBGRUPO
JOIN basi_030 r -- referencia
  ON r.NIVEL_ESTRUTURA = ia.NIVEL_COMP
 AND r.REFERENCIA = ia.GRUPO_COMP
LEFT JOIN BASI_015 parm -- parâmetros de item
  ON parm.NIVEL_ESTRUTURA = ia.NIVEL_COMP
 AND parm.GRUPO_ESTRUTURA = ia.GRUPO_COMP
 AND parm.SUBGRU_ESTRUTURA = CASE WHEN ia.SUB_COMP = '000'
     THEN cot.SUB_COMP
     ELSE ia.SUB_COMP
     END
 AND parm.ITEM_ESTRUTURA = CASE WHEN ia.ITEM_COMP = '000000'
     THEN coc.ITEM_COMP
     ELSE ia.ITEM_COMP
     END
LEFT JOIN PCPC_010 pcompra
  ON pcompra.AREA_PERIODO = 1
 AND ( o.DATA_ENTRADA_CORTE
     - 7
     - coalesce(parm.TEMPO_REPOSICAO, 0)
     ) >= pcompra.DATA_INI_PERIODO
 AND ( o.DATA_ENTRADA_CORTE
     - 7
     - coalesce(parm.TEMPO_REPOSICAO, 0)
     ) <= pcompra.DATA_FIM_PERIODO
JOIN basi_030 ref -- referencia
  ON ref.NIVEL_ESTRUTURA = 1
 AND ref.REFERENCIA = o.REFERENCIA_PECA
WHERE o.SITUACAO IN (2, 4)
--  AND ( l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A
--  - l.QTDE_PERDAS - l.QTDE_CONSERTO
--  ) > 0
    AND (
    ( l.QTDE_PECAS_PROG - l.QTDE_PECAS_PROD - l.QTDE_PECAS_2A
    - l.QTDE_PERDAS - l.QTDE_CONSERTO )
 -- quais_insumos
    ) > 0
   -- filtro_op
--  AND o.DATA_ENTRADA_CORTE >= TO_DATE('11/03/2018','DD/MM/YYYY')
--  AND o.DATA_ENTRADA_CORTE <= TO_DATE('17/03/2018','DD/MM/YYYY')
--  AND pcorte.PERIODO_PRODUCAO = 1810
  AND ( o.DATA_ENTRADA_CORTE
      - 7
      - coalesce(parm.TEMPO_REPOSICAO, 0)
      ) >= TO_DATE('11/03/2018','DD/MM/YYYY')
  AND ( o.DATA_ENTRADA_CORTE
      - 7
      - coalesce(parm.TEMPO_REPOSICAO, 0)
      ) <= TO_DATE('17/03/2018','DD/MM/YYYY')
  AND pcompra.PERIODO_PRODUCAO = 1810
   -- filtro_data_corte
   -- filtro_data_corte_ate
     -- filtro_insumo
   -- filtro_conta_estoque
   -- filtro_ref
   -- filtro_conta_estoque_ref
   --filtro_colecao
GROUP BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, CASE WHEN ia.ITEM_COMP = '000000'
  THEN coc.ITEM_COMP
  ELSE ia.ITEM_COMP
  END
, CASE WHEN ia.SUB_COMP = '000'
  THEN cot.SUB_COMP
  ELSE ia.SUB_COMP
  END
, parm.ESTOQUE_MINIMO
, parm.TEMPO_REPOSICAO
, r.DESCR_REFERENCIA
, r.UNIDADE_MEDIDA
, o.REFERENCIA_PECA
, o.ORDEM_PRODUCAO
ORDER BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, 3
, 4
, o.REFERENCIA_PECA
, o.ORDEM_PRODUCAO
)
SELECT
  n.NIVEL
, n.REF
, n.DESCR
, n.COR
, n.TAM
, n.UNID
, n.STQ_MIN
, n.REPOSICAO
, REPLACE(
    REGEXP_REPLACE(
      LISTAGG('#'||n.REFP, ', ')
      WITHIN GROUP (ORDER BY n.REFP)
    , '([^,]+)(, @)+'
    , '@'
    )
  , '#'
  , ''
  )
  AS REFS
, REPLACE(
    REGEXP_REPLACE(
      LISTAGG('#'||n.OP, ', ')
      WITHIN GROUP (ORDER BY n.OP)
    , '([^,]+)(, @)+'
    , '@'
    )
  , '#'
  , ''
  )
  AS OPS
, sum( n.QTD ) QTD
FROM NESSECIDADE n
GROUP BY
  n.NIVEL
, n.REF
, n.DESCR
, n.COR
, n.TAM
, n.UNID
, n.STQ_MIN
, n.REPOSICAO
ORDER BY
  n.NIVEL
, n.REF
, n.COR
, n.TAM
;

SELECT
  p.DATA_INI_PERIODO
, p.DATA_FIM_PERIODO
, p.*
FROM PCPC_010 p
WHERE p.AREA_PERIODO = 1
  AND p.PERIODO_PRODUCAO = 1810
;

SELECT
  x.*
FROM SUPR_060 x -- insumo fornecedor tempo de reposição
WHERE x.ITEM_060_GRUPO = 'FI001'
;

SELECT
  x.*
FROM BASI_030 x -- capa inicial de produto
WHERE x.REFERENCIA = 'FI001'
;

SELECT
  x.*
FROM BASI_010 x -- Produto – item – ref/tam/cor
WHERE x.GRUPO_ESTRUTURA = 'FI001'
;

SELECT
  x.*
FROM BASI_015 x -- parâmetro de produto – ex. Estoque de segurança
WHERE x.GRUPO_ESTRUTURA = 'MA073'
;

SELECT
  x.*
FROM SUPR_090 x -- pedido de compra
WHERE x.PEDIDO_COMPRA = 2273 -- 2288
--ORDER BY
--  x.PEDIDO_COMPRA DESC
;

SELECT
  x.*
FROM SUPR_100 x -- item de pedido de compra
WHERE x.NUM_PED_COMPRA = 16341
--ORDER BY
--  x.NUM_PED_COMPRA DESC
;

SELECT
  x.*1
FROM SUPR_110 x -- detalhe de recebimentos de items de pedido de compra
WHERE 1=1
  AND x.CH_100_NUM_PED = 377
--  AND x.NR_NOTA_FISCAL = 429394
ORDER BY
  x.CH_100_NUM_PED
, x.CH_100_SEQ_PED
, x.DATA_ENTREGA
;
SELECT
  x.CH_100_NUM_PED
, x.CH_100_SEQ_PED
, count(*)
FROM SUPR_110 x -- detalhe de recebimentos de items de pedido de compra
GROUP BY
  x.CH_100_NUM_PED
, x.CH_100_SEQ_PED
ORDER BY
  3 DESC
;

SELECT
  x.*
FROM ORCM_050 x
--WHERE x.CH_100_NUM_PED_OLD = 377
;

SELECT
  x.ITEM_100_NIVEL99 VIVEL
, x.ITEM_100_GRUPO REF
, r.DESCR_REFERENCIA DESCR
, x.ITEM_100_SUBGRUPO TAM
, x.ITEM_100_ITEM COR
, x.SITUACAO_ITEM
, pc.COD_CANCELAMENTO
, x.DATA_PREV_ENTR DT_ENTREGA
, sum(x.QTDE_PEDIDA_ITEM) QTD_PEDIDA
, sum(x.QTDE_PEDIDA_ITEM)
  - sum(x.QTDE_SALDO_ITEM) QTD_RECEBIDA
, ROUND(
    (sum(x.QTDE_PEDIDA_ITEM) - sum(x.QTDE_SALDO_ITEM))
    / sum(x.QTDE_PEDIDA_ITEM) * 100
  , 1) P_RECEBIDO
, sum(GREATEST(x.QTDE_SALDO_ITEM, 0)) QTD_A_RECEBER_X
, sum(GREATEST(CASE WHEN pc.COD_CANCELAMENTO = 0 THEN x.QTDE_SALDO_ITEM ELSE 0 END, 0)) QTD_A_RECEBER
, ROUND(
    sum(GREATEST(CASE WHEN pc.COD_CANCELAMENTO = 0 THEN x.QTDE_SALDO_ITEM ELSE 0 END, 0))
    / sum(x.QTDE_PEDIDA_ITEM) * 100
  , 1) P_A_RECEBER
, REPLACE(
    REGEXP_REPLACE(
      LISTAGG('#'||x.NUM_PED_COMPRA, ', ')
      WITHIN GROUP (ORDER BY x.NUM_PED_COMPRA)
    , '([^,]+)(, @)+'
    , '@'
    )
  , '#'
  , ''
  )
  AS PEDIDOS
FROM SUPR_100 x -- item de pedido de compra
JOIN SUPR_090 pc -- pedido de compra
  ON pc.PEDIDO_COMPRA = x.NUM_PED_COMPRA
JOIN basi_030 r -- referencia
  ON r.NIVEL_ESTRUTURA = x.ITEM_100_NIVEL99
 AND r.REFERENCIA = x.ITEM_100_GRUPO
WHERE 1=1
--  AND x.NUM_PED_COMPRA = 16341
--  AND x.QTDE_SALDO_ITEM > 0
  AND x.ITEM_100_GRUPO = 'EL041'
GROUP BY
  x.ITEM_100_NIVEL99
, x.ITEM_100_GRUPO
, r.DESCR_REFERENCIA
, x.ITEM_100_SUBGRUPO
, x.ITEM_100_ITEM
, x.DATA_PREV_ENTR
, x.SITUACAO_ITEM
, pc.COD_CANCELAMENTO
ORDER BY
  x.ITEM_100_NIVEL99
, x.ITEM_100_GRUPO
, x.ITEM_100_SUBGRUPO
, x.ITEM_100_ITEM
, x.DATA_PREV_ENTR
;

WITH INSUMOS AS (
SELECT
  x.ITEM_100_NIVEL99 VIVEL
, x.ITEM_100_GRUPO REF
, x.ITEM_100_SUBGRUPO TAM
, x.ITEM_100_ITEM COR
, Row_Number() OVER (
    Order by
	  x.ITEM_100_NIVEL99
	, x.ITEM_100_GRUPO
	, x.ITEM_100_SUBGRUPO
	, x.ITEM_100_ITEM
  ) rno
FROM SUPR_100 x -- item de pedido de compra
WHERE x.QTDE_SALDO_ITEM > 0
GROUP BY
  x.ITEM_100_NIVEL99
, x.ITEM_100_GRUPO
, x.ITEM_100_SUBGRUPO
, x.ITEM_100_ITEM
)
SELECT
  i.*
FROM INSUMOS i
WHERE rno = 9
;

SELECT
  e.CDITEM_NIVEL99 NIVEL
, e.CDITEM_GRUPO REF
, e.CDITEM_SUBGRUPO TAM
, e.CDITEM_ITEM COR
, r.UNIDADE_MEDIDA UNID
, e.DEPOSITO
, d.DESCRICAO
, e.QTDE_ESTOQUE_ATU QUANT
, e.DATA_ULT_ENTRADA ULT_ENTRADA
, e.DATA_ULT_SAIDA ULT_SAIDA
, e.DT_INVENTARIO
--, e.*
FROM ESTQ_040 e -- estoque por depósito
JOIN basi_030 r -- referencia
  ON r.NIVEL_ESTRUTURA = e.CDITEM_NIVEL99
 AND r.REFERENCIA = e.CDITEM_GRUPO
JOIN BASI_205 d -- cadastro de depósitos
  ON d.CODIGO_DEPOSITO = e.DEPOSITO
WHERE e.CDITEM_NIVEL99 = 9
  AND e.CDITEM_GRUPO = 'CA001'
ORDER BY
  e.CDITEM_NIVEL99
, e.CDITEM_GRUPO
, e.CDITEM_SUBGRUPO
, e.CDITEM_ITEM
, e.DEPOSITO
;

SELECT
  r.*
FROM basi_030 r
;

UPDATE BASI_010 SET CODIGO_BARRAS='7896896248045' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00706' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896248052' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00706' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896248069' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00706' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896248076' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00706' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000BR';

UPDATE BASI_010 SET CODIGO_BARRAS='7899618839682' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00467' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000CB';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839699' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00467' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000CB';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839705' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00467' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000CB';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839712' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00467' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000CB';

UPDATE BASI_010 SET CODIGO_BARRAS='7899618839729' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00467' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839736' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00467' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839743' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00467' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839750' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00467' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000PR';

UPDATE BASI_010 SET CODIGO_BARRAS='7899618836063' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00270' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836070' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00270' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836087' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00270' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836094' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00270' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000MA';

SELECT
--  h.*
--  count(*)
  h.DESCRICAO_HISTORICO
, h.USUARIO_REDE
, h.APLICACAO
, h.NOME_PROGRAMA
, h.USUARIO_SISTEMA
FROM HIST_010 h
;


WITH words AS (
SELECT
  'aAb ' w
FROM DUAL
UNION
SELECT
  'aab' w
FROM DUAL
UNIONComo continuaremos pagando o que seria o valor da internet,
SELECT
  'Aab' w
FROM DUAL
)
SELECT
  w.*
FROM words w
--WHERE w.w = 'aAb'
ORDER BY
  w.w
;

SELECT
  u.*
FROM HDOC_030 u
WHERE u.USUARIO = 'LILIANE_IND'
;

SELECT DISTINCT
  substr(p.CLASSIFIC_FISCAL, 1, 4) ncm
FROM basi_010 p
WHERE p.NIVEL_ESTRUTURA = 1
;

SELECT
  l.ORDEM_PRODUCAO
, l.*
FROM PCPC_040 l
WHERE 1=1
  AND l.ORDEM_PRODUCAO IN (4886, 4888)
  AND l.CODIGO_ESTAGIO IN (27, 30)
--  AND l.ORDEM_CONFECCAO IN (4528, 4298)
  AND l.PERIODO_PRODUCAO = 1809
ORDER BY
  l.ORDEM_CONFECCAO
, l.CODIGO_ESTAGIO
;

UPDATE PCPC_040 l
SET
  l.ESTAGIO_ANTERIOR = 9
WHERE 1=1
  AND l.ORDEM_PRODUCAO = 4888
  AND l.CODIGO_ESTAGIO = 30
;

SELECT
  i.CODIGO_BARRAS
, i.*
FROM basi_010 i
WHERE i.NIVEL_ESTRUTURA = 1
  AND i.GRUPO_ESTRUTURA IN ('00272', '0272A')
--  AND i.ITEM_ESTRUTURA IN ('0000CB')
ORDER BY
  i.ITEM_ESTRUTURA
, i.SUBGRU_ESTRUTURA
, i.GRUPO_ESTRUTURA
;

-- insumos de uma OP
SELECT4627
  ref.REFERENCIA PRODUTO
, ia.GRUPO_COMP INSUMO
, sum(lote.QTDE_PECAS_PROG) QTD_PROD
, sum(ia.CONSUMO * lote.QTDE_PECAS_PROG) QTD_INSUMO
FROM BASI_030 ref -- referencia
JOIN PCPC_020 op -- OP
  ON op.REFERENCIA_PECA = ref.REFERENCIA
JOIN PCPC_040 lote -- lote
  ON lote.ORDEM_PRODUCAO = op.ORDEM_PRODUCAO
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = 1
 AND ia.NIVEL_COMP <> 1
 AND ia.GRUPO_ITEM = op.REFERENCIA_PECA
 AND ia.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
 AND ia.ESTAGIO = lote.CODIGO_ESTAGIO
WHERE op.SITUACAO IN (2, 4) -- não cancelada
--  AND op.DATA_ENTRADA_CORTE >= TO_DATE('11/03/2018','DD/MM/YYYY')
  AND op.ORDEM_PRODUCAO = 5278
GROUP BY
  ref.REFERENCIA
, ia.GRUPO_COMP
;

-- insumos (GRUPO) com necessidade
SELECT
  ia.NIVEL_COMP NIVEL
, ia.GRUPO_COMP REF
FROM BASI_030 ref -- referencia
JOIN PCPC_020 op -- OP
  ON op.REFERENCIA_PECA = ref.REFERENCIA
JOIN PCPC_040 lote -- lote
  ON lote.ORDEM_PRODUCAO = op.ORDEM_PRODUCAO
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = 1
 AND ia.NIVEL_COMP <> 1
 AND ia.GRUPO_ITEM = op.REFERENCIA_PECA
 AND ia.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
 AND ia.ESTAGIO = lote.CODIGO_ESTAGIO
LEFT JOIN BASI_040 coc -- combinação cor
  ON ia.ITEM_COMP = '000000'
 AND coc.GRUPO_ITEM = ia.GRUPO_ITEM
 AND coc.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
 AND coc.SEQUENCIA = ia.SEQUENCIA
 AND coc.ITEM_ITEM = lote.PROCONF_ITEM
LEFT JOIN BASI_040 cot -- combin4627ação tamanho
  ON ia.SUB_COMP = '000'
 AND cot.GRUPO_ITEM = ia.GRUPO_ITEM
 AND cot.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
 AND cot.SEQUENCIA = ia.SEQUENCIA
 AND cot.SUB_ITEM = lote.PROCONF_SUBGRUPO
WHERE op.SITUACAO IN (2, 4) -- não cancelada
  AND op.DATA_ENTRADA_CORTE >= TO_DATE('16/03/2018','DD/MM/YYYY')
--  AND op.ORDEM_PRODUCAO > 5078
GROUP BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
ORDER BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
;

SELECT
  i.NIVEL_ESTRUTURA NIVEL
, i.GRUPO_ESTRUTURA REF
, i.ITEM_ESTRUTURA COR
, i.SUBGRU_ESTRUTURA TAM
FROM BASI_010 i
WHERE i.NIVEL_ESTRUTURA = 2
  AND i.GRUPO_ESTRUTURA = 'MA001'
  AND i.ITEM_ESTRUTURA = '0000PR'
  AND i.SUBGRU_ESTRUTURA = 'UNI'
;
-- insumos (GRUPO) com necessidade
SELECT
  ia.NIVEL_COMP NIVEL
, ia.GRUPO_COMP REF
FROM BASI_030 ref -- referencia
JOIN PCPC_020 op -- OP
  ON op.REFERENCIA_PECA = ref.REFERENCIA
JOIN PCPC_040 lote -- lote
  ON lote.ORDEM_PRODUCAO = op.ORDEM_PRODUCAO
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = 1
 AND ia.NIVEL_COMP <> 1
 AND ia.GRUPO_ITEM = op.REFERENCIA_PECA
 AND ia.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
 AND ia.ESTAGIO = lote.CODIGO_ESTAGIO
LEFT JOIN BASI_040 coc -- combinação cor
  ON ia.ITEM_COMP = '000000'
 AND coc.GRUPO_ITEM = ia.GRUPO_ITEM
 AND coc.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
 AND coc.SEQUENCIA = ia.SEQUENCIA
 AND coc.ITEM_ITEM = lote.PROCONF_ITEM
LEFT JOIN BASI_040 cot -- combinação tamanho
  ON ia.SUB_COMP = '000'
 AND cot.GRUPO_ITEM = ia.GRUPO_ITEM
 AND cot.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
 AND cot.SEQUENCIA = ia.SEQUENCIA
 AND cot.SUB_ITEM = lote.PROCONF_SUBGRUPO
WHERE op.SITUACAO IN (2, 4) -- não cancelada
  AND op.DATA_ENTRADA_CORTE >= TO_DATE('16/03/2018','DD/MM/YYYY')
--  AND op.ORDEM_PRODUCAO > 5078
GROUP BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
ORDER BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
;

-- deleciona um insumo com descrições
SELECT
  i.NIVEL_ESTRUTURA NIVEL
, i.REFERENCIA REF
, i.DESCR_REFERENCIA DESCR
, ic.ITEM_ESTRUTURA COR
, ic.DESCRICAO_15 DESCR_COR
, it.TAMANHO_REF TAM
, it.DESCR_TAM_REFER DESCR_TAM
FROM BASI_030 i -- insumo
JOIN BASI_020 it -- insumo tamanho
  ON it.BASI030_NIVEL030 = i.NIVEL_ESTRUTURA
 AND it.BASI030_REFERENC = i.REFERENCIA
 AND it.TAMANHO_REF = 'UNI'
JOIN BASI_010 ic -- insumo cor
  ON ic.NIVEL_ESTRUTURA = i.NIVEL_ESTRUTURA
 AND ic.GRUPO_ESTRUTURA = i.REFERENCIA
 AND ic.SUBGRU_ESTRUTURA = it.TA4627MANHO_REF
 AND ic.ITEM_ESTRUTURA = '0000PT'
WHERE i.NIVEL_ESTRUTURA = 9
  AND i.REFERENCIA = 'ET001'
;

-- insumos (ITEM) com necessidade
SELECT
  ia.NIVEL_COMP NIVEL
, ia.GRUPO_COMP REF
, ins.DESCR_REFERENCIA DESCR
, ic.ITEM_ESTRUTURA COR
, ic.DESCRICAO_15 DESCR_COR
, it.TAMANHO_REF TAM
, it.DESCR_TAM_REFER DESCR_TAM
FROM BASI_030 ref -- referencia
JOIN PCPC_020 op -- OP
  ON op.REFERENCIA_PECA = ref.REFERENCIA
JOIN PCPC_040 lote -- lote
  ON lote.ORDEM_PRODUCAO = op.ORDEM_PRODUCAO
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = 1
 AND ia.NIVEL_COMP <> 1
 AND ia.GRUPO_ITEM = op.REFERENCIA_PECA
 AND ia.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
 AND ia.ESTAGIO = lote.CODIGO_ESTAGIO
JOIN BASI_030 ins -- insumo referencia
  ON ins.NIVEL_ESTRUTURA = ia.NIVEL_COMP
 AND ins.REFERENCIA = ia.GRUPO_COMP
LEFT JOIN BASI_040 cot -- combinação tamanho
  ON ia.SUB_COMP = '000'
 AND cot.GRUPO_ITEM = ia.GRUPO_ITEM
 AND cot.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
 AND cot.SEQUENCIA = ia.SEQUENCIA
 AND cot.SUB_ITEM = lote.PROCONF_SUBGRUPO
JOIN BASI_020 it -- insumo tamanho
  ON it.BASI030_NIVEL030 = ia.NIVEL_COMP
 AND it.BASI030_REFERENC = ia.GRUPO_COMP
 AND it.TAMANHO_REF
    = CASE WHEN ia.SUB_COMP = '000'
	  THEN cot.SUB_COMP
	  ELSE ia.SUB_COMP
	  END
LEFT JOIN BASI_040 coc -- combinação cor
  ON ia.ITEM_COMP = '000000'
 AND coc.GRUPO_ITEM = ia.GRUPO_ITEM
 AND coc.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
 AND coc.SEQUENCIA = ia.SEQUENCIA
 AND coc.ITEM_ITEM = lote.PROCONF_ITEM
JOIN BASI_010 ic -- insumo cor
  ON ic.NIVEL_ESTRUTURA = ia.NIVEL_COMP
 AND ic.GRUPO_ESTRUTURA = ia.GRUPO_COMP
 AND ic.SUBGRU_ESTRUTURA = it.TAMANHO_REF
 AND ic.ITEM_ESTRUTURA
	= CASE WHEN ia.ITEM_COMP = '000000'
	  THEN coc.ITEM_COMP
	  ELSE ia.ITEM_COMP
	  END
WHERE op.SITUACAO IN (2, 4) -- não cancelada
  AND op.DATA_ENTRADA_CORTE >= TO_DATE('16/03/2018','DD/MM/YYYY')
--  AND op.ORDEM_PRODUCAO > 5078
GROUP BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, ins.DESCR_REFERENCIA
, ic.ITEM_ESTRUTURA
, ic.DESCRICAO_15
, it.TAMANHO_REF
, it.DESCR_TAM_REFER
ORDER BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, ic.ITEM_ESTRUTURA
, it.TAMANHO_REF
;


-- necessidade por dia
SELECT
  TRUNC(op.DATA_ENTRADA_CORTE - 7, 'iw') SEMANA_DISPONIBILIDADE
--, sum(ia.CONSUMO * lote.QTDE_PECAS_PROG) QTD_INSUMO_TOTAL
, sum( ia.CONSUMO *
       (
    ( lote.QTDE_PECAS_PROG - lote.QTDE_PECAS_PROD - lote.QTDE_PECAS_2A
    - lote.QTDE_PERDAS - lote.QTDE_CONSERTO )
       )
     ) QTD_INSUMO
FROM BASI_030 ref -- referencia
JOIN PCPC_020 op -- OP
  ON op.REFERENCIA_PECA = ref.REFERENCIA
JOIN PCPC_040 lote -- lote
  ON lote.ORDEM_PRODUCAO = op.ORDEM_PRODUCAO
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = 1
 AND ia.NIVEL_COMP <> 1
 AND ia.GRUPO_ITEM = op.REFERENCIA_PECA
 AND ia.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
 AND ia.ESTAGIO = lote.CODIGO_ESTAGIO
LEFT JOIN BASI_040 coc -- combinação cor
  ON ia.ITEM_COMP = '000000'
 AND coc.GRUPO_ITEM = ia.GRUPO_ITEM
 AND coc.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
 AND coc.SEQUENCIA = ia.SEQUENCIA
 AND coc.ITEM_ITEM = lote.PROCONF_ITEM
LEFT JOIN BASI_040 cot -- combinação tamanho
  ON ia.SUB_COMP = '000'
 AND cot.GRUPO_ITEM = ia.GRUPO_ITEM
 AND cot.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
 AND cot.SEQUENCIA = ia.SEQUENCIA
 AND cot.SUB_ITEM = lote.PROCONF_SUBGRUPO
WHERE op.SITUACAO IN (2, 4) -- não cancelada
--  AND op.DATA_ENTRADA_CORTE >= sysdate -- TO_DATE('16/03/2018','DD/MM/YYYY')
  AND ia.NIVEL_COMP = 2
  AND ia.GRUPO_COMP = 'MA002'
  AND CASE WHEN ia.ITEM_COMP = '000000'
	  THEN coc.ITEM_COMP
	  ELSE ia.ITEM_COMP
	  END = '0000BR'
  AND CASE WHEN ia.SUB_COMP = '000'
	  THEN cot.SUB_COMP
	  ELSE ia.SUB_COMP
	  END = 'UNI'
--  AND op.ORDEM_PRODUCAO > 5078
GROUP BY
  TRUNC(op.DATA_ENTRADA_CORTE - 7, 'iw')
HAVING
  sum( ia.CONSUMO *
       (
    ( lote.QTDE_PECAS_PROG - lote.QTDE_PECAS_PROD - lote.QTDE_PECAS_2A
    - lote.QTDE_PERDAS - lote.QTDE_CONSERTO )
       )
     ) > 0
ORDER BY
  1
;

-- entragas de um item por dia
  TRUNC(x.DATA_PREV_ENTR, 'iw') SEMANA_ENTREGA
, sum(
    GREATEST(
      CASE WHEN pc.COD_CANCELAMENTO = 0
        THEN x.QTDE_SALDO_ITEM
        ELSE 0 END
    , 0)
  ) QTD_A_RECEBER
FROM SUPR_100 x -- item de pedido de compra
JOIN SUPR_090 pc -- pedido de compra
  ON pc.PEDIDO_COMPRA = x.NUM_PED_COMPRA
JOIN basi_030 r -- referencia
  ON r.NIVEL_ESTRUTURA = x.ITEM_100_NIVEL99
 AND r.REFERENCIA = x.ITEM_100_GRUPO
WHERE 1=1
  AND x.ITEM_100_NIVEL99 = 2
  AND x.ITEM_100_GRUPO = 'MA002'
  AND x.ITEM_100_SUBGRUPO = 'UNI'
  AND x.ITEM_100_ITEM = '0000BR'
GROUP BY
  x.ITEM_100_NIVEL99
, x.ITEM_100_GRUPO
, x.ITEM_100_SUBGRUPO
, x.ITEM_100_ITEM
, TRUNC(x.DATA_PREV_ENTR, 'iw')
HAVING
  ROUND(
    sum(
      GREATEST(
        CASE WHEN pc.COD_CANCELAMENTO = 0
          THEN x.QTDE_SALDO_ITEM
          ELSE 0 END
      , 0)
    ) / sum(x.QTDE_PEDIDA_ITEM) * 100
  , 1) >= 5
ORDER BY
  1
;

-- deleciona um insumo com descrições e parametros
SELECT
  i.NIVEL_ESTRUTURA NIVEL
, i.REFERENCIA REF
, i.DESCR_REFERENCIA DESCR
, ic.ITEM_ESTRUTURA COR
, ic.DESCRICAO_15 DESCR_COR
, it.TAMANHO_REF TAM
, it.DESCR_TAM_REFER DESCR_TAM
, coalesce(parm.ESTOQUE_MINIMO, 0) STQ_MIN
, coalesce(parm.TEMPO_REPOSICAO, 0) REPOSICAO
, coalesce(parm.LOTE_MULTIPLO, 0) LOTE_MULTIPLO
, i.UNIDADE_MEDIDA UNID
, COALESCE(e.DEPOSITO, 0) DEPOSITO
, COALESCE(e.QTDE_ESTOQUE_ATU, 0) QUANT
, e.DATA_ULT_ENTRADA ULT_ENTRADA
, e.DATA_ULT_SAIDA ULT_SAIDA
, e.DT_INVENTARIO
FROM BASI_030 i -- insumo
JOIN BASI_020 it -- insumo tamanho
  ON it.BASI030_NIVEL030 = i.NIVEL_ESTRUTURA
 AND it.BASI030_REFERENC = i.REFERENCIA
 AND it.TAMANHO_REF = 'UNI'
JOIN BASI_010 ic -- insumo cor
  ON ic.NIVEL_ESTRUTURA = i.NIVEL_ESTRUTURA
 AND ic.GRUPO_ESTRUTURA = i.REFERENCIA
 AND ic.SUBGRU_ESTRUTURA = it.TAMANHO_REF
 AND ic.ITEM_ESTRUTURA = '0000BR'
LEFT JOIN BASI_015 parm -- parâmetros de item
  ON parm.NIVEL_ESTRUTURA = i.NIVEL_ESTRUTURA
 AND parm.GRUPO_ESTRUTURA = i.REFERENCIA
 AND parm.SUBGRU_ESTRUTURA = it.TAMANHO_REF
 AND parm.ITEM_ESTRUTURA = ic.ITEM_ESTRUTURA
LEFT JOIN ESTQ_040 e -- estoque por depósito
  ON e.CDITEM_NIVEL99 = i.NIVEL_ESTRUTURA
 AND e.CDITEM_GRUPO = i.REFERENCIA
 AND e.CDITEM_SUBGRUPO = it.TAMANHO_REF
 AND e.CDITEM_ITEM = ic.ITEM_ESTRUTURA
 AND ( ( i.NIVEL_ESTRUTURA = 2
       AND e.DEPOSITO = 202 -- TECIDOS ESTOQUE
       )
     OR
       ( i.NIVEL_ESTRUTURA = 9
       AND
       	 ( ( i.CONTA_ESTOQUE = 22 -- FIOS
           AND e.DEPOSITO = 212 -- FIO TECELAGEM ESTOQUE
           )
         OR
           ( i.CONTA_ESTOQUE <> 22 -- NÃO FIOS
           AND e.DEPOSITO = 231 -- MAT PRIMA ESTOQUE
           )
         )
       )
     )
WHERE i.NIVEL_ESTRUTURA = 2
  AND i.REFERENCIA = 'MA002'
;

SELECT
  COALESCE(
  ( SELECT
      MIN( le.CODIGO_ESTAGIO ) CODIGO_ESTAGIO
    FROM PCPC_040 le
    JOIN MQOP_005 ed
      ON ed.CODIGO_ESTAGIO = le.CODIGO_ESTAGIO
    WHERE le.PERIODO_PRODUCAO = l.PERIODO_PRODUCAO
      AND le.ORDEM_CONFECCAO = l.ORDEM_CONFECCAO
      AND le.QTDE_EM_PRODUCAO_PACOTE <> 0
  )
  , 9999
  ) EST_NUM
, l.ORDEM_PRODUCAO OP
, r.NARRATIVA
, ref.DESCR_REFERENCIA || '-' || tam.DESCR_TAM_REFER || '-' || r.DESCRICAO_15 descricao
, op.SITUACAO OP_SITUACAO
, CASE WHEN dos.NUMERO_ORDEM IS NULL
  THEN '0'
  ELSE l.NUMERO_ORDEM || ' (' || eos.DESCRICAO || ')'
  END OS
, l.PROCONF_GRUPO REF
, l.PROCONF_SUBGRUPO TAM
, t.ORDEM_TAMANHO
, l.PROCONF_ITEM COR
, COALESCE(
  ( SELECT
      LISTAGG(le.CODIGO_ESTAGIO || ' - ' || ed.DESCRICAO, ' & ')
      WITHIN GROUP (ORDER BY le.CODIGO_ESTAGIO)
    FROM PCPC_040 le
    JOIN MQOP_005 ed
      ON ed.CODIGO_ESTAGIO = le.CODIGO_ESTAGIO
    WHERE le.PERIODO_PRODUCAO = l.PERIODO_PRODUCAO
      AND le.ORDEM_CONFECCAO = l.ORDEM_CONFECCAO
      AND le.QTDE_EM_PRODUCAO_PACOTE <> 0
  )
  , 'FINALIZADO'
  ) EST
, l.PERIODO_PRODUCAO PERIODO
, l.ORDEM_CONFECCAO OC
, l.QTDE_PECAS_PROG QTD
, l.QTDE_PECAS_PROD PROD1Q
, l.QTDE_CONSERTO CONSERTO
, l.QTDE_PECAS_2A PROD2Q
, l.QTDE_PERDAS PERDA
, r.NARRATIVA
, ref.COLECAO
, CASE WHEN l.DIVISAO = 0 THEN dp.DIVISAO_PRODUCAO
  ELSE l.DIVISAO END DIVISAO
, CASE WHEN l.DIVISAO = 0 THEN dp.DESCRICAO
  ELSE di.DESCRICAO END DESCRICAO_DIVISAO
, op.DATA_ENTRADA_CORTE
, ( SELECT
    MIN( l1.ORDEM_CONFECCAO )
  FROM PCPC_040 l1
  WHERE l1.ORDEM_PRODUCAO   = l.ORDEM_PRODUCAO
    AND l1.PERIODO_PRODUCAO = l.PERIODO_PRODUCAO
    AND l1.PROCONF_GRUPO    = l.PROCONF_GRUPO
    AND l1.PROCONF_SUBGRUPO = l.PROCONF_SUBGRUPO
    AND l1.PROCONF_ITEM     = l.PROCONF_ITEM
) OC1
FROM (
  SELECT
    os.PERIODO_PRODUCAO
  , os.ORDEM_CONFECCAO
  , os.PROCONF_GRUPO
  , os.PROCONF_SUBGRUPO
  , os.PROCONF_ITEM
  , os.ORDEM_PRODUCAO
  , max( os.NUMERO_ORDEM ) NUMERO_ORDEM
  , max( os.QTDE_PECAS_PROG ) QTDE_PECAS_PROG
  , max( os.QTDE_PECAS_PROD ) QTDE_PECAS_PROD
  , max( os.QTDE_CONSERTO ) QTDE_CONSERTO
  , max( os.QTDE_PECAS_2A ) QTDE_PECAS_2A
  , max( os.QTDE_PERDAS ) QTDE_PERDAS
  , max( CASE WHEN os.CODIGO_FAMILIA < 1000
         THEN os.CODIGO_FAMILIA
         ELSE 0 END ) DIVISAO
  FROM PCPC_040 os
  WHERE 1=1
    AND os.ORDEM_PRODUCAO = 4888
--    AND (os.ORDEM_PRODUCAO = %s or %s IS NULL)
--    AND (os.NUMERO_ORDEM = %s or %s IS NULL)
--    AND (os.ORDEM_CONFECCAO >= %s or %s IS NULL)
--    AND (os.ORDEM_CONFECCAO <= %s or %s IS NULL)
--    AND (os.PROCONF_SUBGRUPO = %s OR %s IS NULL)
--    AND (os.PROCONF_ITEM = %s OR %s IS NULL)
  GROUP BY
    os.PERIODO_PRODUCAO
  , os.ORDEM_CONFECCAO
  , os.PROCONF_GRUPO
  , os.PROCONF_SUBGRUPO
  , os.PROCONF_ITEM
  , os.ORDEM_PRODUCAO
) l
LEFT JOIN PCPC_040 dos
  ON l.NUMERO_ORDEM <> 0
 AND dos.PERIODO_PRODUCAO = l.PERIODO_PRODUCAO
 AND dos.ORDEM_CONFECCAO = l.ORDEM_CONFECCAO
 AND dos.NUMERO_ORDEM = l.NUMERO_ORDEM
LEFT JOIN MQOP_005 eos
  ON eos.CODIGO_ESTAGIO = dos.CODIGO_ESTAGIO
LEFT JOIN BASI_220 t
  ON t.TAMANHO_REF = l.PROCONF_SUBGRUPO
JOIN BASI_030 ref
  ON ref.NIVEL_ESTRUTURA = 1
 AND ref.REFERENCIA = l.PROCONF_GRUPO
JOIN BASI_020 tam
  ON tam.BASI030_NIVEL030 = 1
 AND tam.BASI030_REFERENC = l.PROCONF_GRUPO
 AND tam.TAMANHO_REF = l.PROCONF_SUBGRUPO
JOIN BASI_010 r
  ON r.NIVEL_ESTRUTURA = 1
 AND r.GRUPO_ESTRUTURA = l.PROCONF_GRUPO
 AND r.SUBGRU_ESTRUTURA = l.PROCONF_SUBGRUPO
 AND r.ITEM_ESTRUTURA = l.PROCONF_ITEM
LEFT JOIN BASI_180 di -- divisao de producao - unidade
  ON di.DIVISAO_PRODUCAO = l.DIVISAO
LEFT JOIN OBRF_080 osc -- OS capa
  ON l.NUMERO_ORDEM <> 0
 AND osc.NUMERO_ORDEM = l.NUMERO_ORDEM
LEFT JOIN BASI_180 dp -- divisao de producao - unidade
  ON dp.FACCIONISTA9 = osc.CGCTERC_FORNE9
 AND dp.FACCIONISTA4 = osc.CGCTERC_FORNE4
 AND dp.FACCIONISTA2 = osc.CGCTERC_FORNE2
JOIN PCPC_020 op -- OP capa
  ON op.ordem_producao = l.ORDEM_PRODUCAO
ORDER BY
  l.ORDEM_PRODUCAO
, l.NUMERO_ORDEM
, l.PROCONF_GRUPO
, t.ORDEM_TAMANHO
, l.PROCONF_ITEM
, l.PERIODO_PRODUCAO
, l.ORDEM_CONFECCAO
;

SELECT
  e.*
FROM ESTQ_040 e
WHERE e.CDITEM_NIVEL99 = 9
 AND e.CDITEM_GRUPO = 'CA002'
 AND e.CDITEM_SUBGRUPO = 'UNI'
 AND e.CDITEM_ITEM = '0000UN'
 AND e.DEPOSITO = 231
 AND e.LOTE_ACOMP = 1
;

SELECT
  e.*
FROM ESTQ_080 e
;

SELECT
  o.NUMERO_ORDEM
, nfs.NUM_NF_SAI
, nfs.QTDE_ESTRUTURA
, nfs.PRODSAI_NIVEL99
, nfs.PRODSAI_GRUPO
, nfs.PRODSAI_ITEM
, nfs.PRODSAI_SUBGRUPO
-- ...

SELECT
  TRUNC(coalesce(op.DATA_ENTRADA_CORTE, SYSDATE) - 7, 'iw')
    SEMANA_NECESSIDADE
, - sum( nfs.QTDE_ESTRUTURA ) QTD_INSUMO
FROM (
  SELECT UNIQUE
    os.NUMERO_ORDEM
  , l.ORDEM_PRODUCAO
  FROM OBRF_080 os
  JOIN pcpc_040 l
    ON l.NUMERO_ORDEM = os.NUMERO_ORDEM
  WHERE l.ORDEM_PRODUCAO = 5264
    AND l.NUMERO_ORDEM <> 0
) o
JOIN OBRF_082 nfs
  ON nfs.NUMERO_ORDEM = o.NUMERO_ORDEM
JOIN PCPC_020 op -- OP
  ON op.ORDEM_PRODUCAO = o.ORDEM_PRODUCAO
WHERE nfs.PRODSAI_NIVEL99 = 2
  AND nfs.PRODSAI_GRUPO = 'MA002'
  AND nfs.PRODSAI_ITEM = '0000BR'
  AND nfs.PRODSAI_SUBGRUPO = 'UNI'
GROUP BY
  TRUNC(coalesce(op.DATA_ENTRADA_CORTE, SYSDATE) - 7, 'iw')
ORDER BY
  TRUNC(coalesce(op.DATA_ENTRADA_CORTE, SYSDATE) - 7, 'iw')
;

WITH NECES AS (
SELECT
  TRUNC(coalesce(op.DATA_ENTRADA_CORTE, SYSDATE) - 7, 'iw')
    SEMANA_NECESSIDADE
, sum( ia.CONSUMO *
       (
    ( lote.QTDE_PECAS_PROG - lote.QTDE_PECAS_PROD - lote.QTDE_PECAS_2A
    - lote.QTDE_PERDAS - lote.QTDE_CONSERTO )
       )
     ) QTD_INSUMO
FROM BASI_030 ref -- referencia
JOIN PCPC_020 op -- OP
  ON op.REFERENCIA_PECA = ref.REFERENCIA
JOIN PCPC_040 lote -- lote
  ON lote.ORDEM_PRODUCAO = op.ORDEM_PRODUCAO
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = 1
 AND ia.NIVEL_COMP <> 1
 AND ia.GRUPO_ITEM = op.REFERENCIA_PECA
 AND ia.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
 AND ia.ESTAGIO = lote.CODIGO_ESTAGIO
LEFT JOIN BASI_040 coc -- combinação cor
  ON ia.ITEM_COMP = '000000'
 AND coc.GRUPO_ITEM = ia.GRUPO_ITEM
 AND coc.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
 AND coc.SEQUENCIA = ia.SEQUENCIA
 AND coc.ITEM_ITEM = lote.PROCONF_ITEM
LEFT JOIN BASI_040 cot -- combinação tamanho
  ON ia.SUB_COMP = '000'
 AND cot.GRUPO_ITEM = ia.GRUPO_ITEM
 AND cot.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
 AND cot.SEQUENCIA = ia.SEQUENCIA
 AND cot.SUB_ITEM = lote.PROCONF_SUBGRUPO
WHERE op.SITUACAO IN (2, 4) -- não cancelada
  AND ia.NIVEL_COMP = 2
  AND ia.GRUPO_COMP = 'MA002'
  AND CASE WHEN ia.ITEM_COMP = '000000'
      THEN coc.ITEM_COMP
      ELSE ia.ITEM_COMP
      END = '0000BR'
  AND CASE WHEN ia.SUB_COMP = '000'
      THEN cot.SUB_COMP
      ELSE ia.SUB_COMP
      END = 'UNI'
GROUP BY
  TRUNC(coalesce(op.DATA_ENTRADA_CORTE, SYSDATE) - 7, 'iw')
HAVING
  sum( ia.CONSUMO *
       (
    ( lote.QTDE_PECAS_PROG - lote.QTDE_PECAS_PROD - lote.QTDE_PECAS_2A
    - lote.QTDE_PERDAS - lote.QTDE_CONSERTO )
       )
     ) > 0
--
UNION
--
SELECT
  TRUNC(coalesce(op.DATA_ENTRADA_CORTE, SYSDATE) - 7, 'iw')
    SEMANA_NECESSIDADE
, - sum( nfs.QTDE_ESTRUTURA ) QTD
FROM (
  SELECT UNIQUE
    os.NUMERO_ORDEM
  , l.ORDEM_PRODUCAO
  FROM OBRF_080 os
  JOIN pcpc_040 l
    ON l.NUMERO_ORDEM = os.NUMERO_ORDEM
  WHERE l.ORDEM_PRODUCAO = 5264
    AND l.NUMERO_ORDEM <> 0
) o
JOIN OBRF_082 nfs
  ON nfs.NUMERO_ORDEM = o.NUMERO_ORDEM
JOIN PCPC_020 op -- OP
  ON op.ORDEM_PRODUCAO = o.ORDEM_PRODUCAO
WHERE nfs.PRODSAI_NIVEL99 = 2
  AND nfs.PRODSAI_GRUPO = 'MA002'
  AND nfs.PRODSAI_ITEM = '0000BR'
  AND nfs.PRODSAI_SUBGRUPO = 'UNI'
GROUP BY
  TRUNC(coalesce(op.DATA_ENTRADA_CORTE, SYSDATE) - 7, 'iw')
)
SELECT
  n.SEMANA_NECESSIDADE
, sum(n.QTD_INSUMO) QTD_INSUMO
FROM NECES n
GROUP BY
  n.SEMANA_NECESSIDADE
ORDER BY
  n.SEMANA_NECESSIDADE
;

SELECT
  i.CODIGO_BARRAS
, i.*
FROM basi_010 i
WHERE i.NIVEL_ESTRUTURA = 1
  AND i.GRUPO_ESTRUTURA = '05376'
  AND i.ITEM_ESTRUTURA IN ('0000BR')
;

UPDATE BASI_010 i
SET
  i.CODIGO_BARRAS = (
    SELECT
      ii.CODIGO_BARRAS
    FROM BASI_010 ii
    WHERE ii.NIVEL_ESTRUTURA=i.NIVEL_ESTRUTURA
      AND ii.GRUPO_ESTRUTURA=i.GRUPO_ESTRUTURA
      AND ii.SUBGRU_ESTRUTURA=i.SUBGRU_ESTRUTURA
      AND ii.ITEM_ESTRUTURA='0000BC'
  )
WHERE i.NIVEL_ESTRUTURA='1'
  AND i.GRUPO_ESTRUTURA='05376'
--  AND i.SUBGRU_ESTRUTURA='GG'
  AND i.ITEM_ESTRUTURA='0000BR'
;

SELECT
  l.ORDEM_PRODUCAO
, count(*)
FROM PCPC_040 l -- lote
WHERE l.SEQUENCIA_ESTAGIO = 1
  AND l.ORDEM_PRODUCAO >= 5000
GROUP BY
  l.ORDEM_PRODUCAO
ORDER BY
  2 DESC
;

WITH Table_qtd_lotes AS (
SELECT
  ll.OP
, ll.PERIODO
, ll.COR
, ll.TAM
, ll.PACOTE
, MIN(ll.OC) OC1
, COUNT(ll.OC) OC_COUNT
, MAX(ll.OC) OC_MAX
FROM (
  SELECT DISTINCT
    TRUNC( (
      row_number()
        over(
        partition BY
          os.PROCONF_ITEM
        , os.PROCONF_SUBGRUPO
        order BY
          os.ORDEM_CONFECCAO
        )
      - 1 )/ (
                CASE WHEN r.COLECAO = 5 -- camisa
                THEN 2
                ELSE 3
                END
             ) ) + 1 PACOTE
  , os.ORDEM_PRODUCAO OP
  , os.PERIODO_PRODUCAO PERIODO
  , os.PROCONF_ITEM COR
  , os.PROCONF_SUBGRUPO TAM
  , os.ORDEM_CONFECCAO OC
  , os.PROCONF_GRUPO
  FROM PCPC_040 os
  JOIN BASI_030 r
    ON r.REFERENCIA = os.PROCONF_GRUPO
  WHERE os.ORDEM_PRODUCAO = 5271
  GROUP BY
    os.ORDEM_PRODUCAO
  , os.PERIODO_PRODUCAO
  , os.PROCONF_GRUPO
  , r.COLECAO
  , os.PROCONF_ITEM
  , os.PROCONF_SUBGRUPO
  , os.ORDEM_CONFECCAO
) ll
GROUP BY
  ll.OP
, ll.PERIODO
, ll.COR
, ll.TAM
, ll.PACOTE
)
SELECT
  tb.*
--
, CASE tb.OC_COUNT
  WHEN 1 THEN NULL
  WHEN 2 THEN tb.OC_MAX
  WHEN 3 THEN
  (
    SELECT
      os_avg.ORDEM_CONFECCAO
    FROM PCPC_040 os_avg
    WHERE os_avg.ORDEM_PRODUCAO = tb.OP
      AND os_avg.PROCONF_ITEM = tb.COR
      AND os_avg.PROCONF_SUBGRUPO = tb.TAM
      AND os_avg.ORDEM_CONFECCAO > tb.OC1
      AND os_avg.ORDEM_CONFECCAO < tb.OC_MAX
      AND rownum = 1
  )
  END OC2
--
, CASE WHEN tb.OC_COUNT = 3
  THEN tb.OC_MAX
  ELSE NULL
  END OC3
--
, ( SELECT
      max( os.QTDE_PECAS_PROG )
    FROM PCPC_040 os
    WHERE os.PERIODO_PRODUCAO = tb.PERIODO
      AND os.ORDEM_CONFECCAO = tb.OC1
  )    QTD1
--
, CASE tb.OC_COUNT
  WHEN 1 THEN NULL
  WHEN 2 THEN
  ( SELECT
      max( os.QTDE_PECAS_PROG )
    FROM PCPC_040 os
    WHERE os.PERIODO_PRODUCAO = tb.PERIODO
      AND os.ORDEM_CONFECCAO = tb.OC_MAX
  )
  ELSE
  ( SELECT
      max( os.QTDE_PECAS_PROG )
    FROM PCPC_040 os
    WHERE os.PERIODO_PRODUCAO = tb.PERIODO
      AND os.ORDEM_CONFECCAO = (
        SELECT
          os_avg.ORDEM_CONFECCAO
        FROM PCPC_040 os_avg
        WHERE os_avg.ORDEM_PRODUCAO = tb.OP
          AND os_avg.PROCONF_ITEM = tb.COR
          AND os_avg.PROCONF_SUBGRUPO = tb.TAM
          AND os_avg.ORDEM_CONFECCAO > tb.OC1
          AND os_avg.ORDEM_CONFECCAO < tb.OC_MAX
          AND rownum = 1
      )
  )
  END QTD2
--
, CASE WHEN tb.OC_COUNT = 3
  THEN
  ( SELECT
      max( os.QTDE_PECAS_PROG )
    FROM PCPC_040 os
    WHERE os.PERIODO_PRODUCAO = tb.PERIODO
      AND os.ORDEM_CONFECCAO = tb.OC_MAX
  )
  ELSE NULL
  END QTD3
--
, o.SITUACAO
, o.REFERENCIA_PECA REF
, o.DATA_ENTRADA_CORTE
, t.ORDEM_TAMANHO TAMORD
, r.NARRATIVA
, ref.DESCR_REFERENCIA
, tam.DESCR_TAM_REFER DESCR_TAMANHO
, r.DESCRICAO_15 DESCR_COR
from Table_qtd_lotes tb
JOIN PCPC_020 o -- OP capa
  ON o.ORDEM_PRODUCAO = tb.OP
JOIN BASI_220 t -- tamanhos
  ON t.TAMANHO_REF = tb.TAM
JOIN BASI_030 ref
  ON ref.NIVEL_ESTRUTURA = 1
 AND ref.REFERENCIA = o.REFERENCIA_PECA
JOIN BASI_020 tam
  ON tam.BASI030_NIVEL030 = 1
 AND tam.BASI030_REFERENC = o.REFERENCIA_PECA
 AND tam.TAMANHO_REF = tb.TAM
JOIN BASI_010 r
  ON r.NIVEL_ESTRUTURA = 1
 AND r.GRUPO_ESTRUTURA = o.REFERENCIA_PECA
 AND r.SUBGRU_ESTRUTURA = tb.TAM
 AND r.ITEM_ESTRUTURA = tb.COR
ORDER BY
  tb.COR
, t.ORDEM_TAMANHO
, tb.PACOTE
;


WITH neces AS (

SELECT
  TRUNC(coalesce(op.DATA_ENTRADA_CORTE, SYSDATE) - 7, 'iw')
    SEMANA_NECESSIDADE
, op.REFERENCIA_PECA
, REF.DESCR_REFERENCIA
, op.ORDEM_PRODUCAO
, trunc(sum(
    ( lote.QTDE_PECAS_PROG - lote.QTDE_PECAS_PROD - lote.QTDE_PECAS_2A
    - lote.QTDE_PERDAS - lote.QTDE_CONSERTO )
     ) ) QTD_PRODUTO
, trunc(sum( ia.CONSUMO *
       (
    ( lote.QTDE_PECAS_PROG - lote.QTDE_PECAS_PROD - lote.QTDE_PECAS_2A
    - lote.QTDE_PERDAS - lote.QTDE_CONSERTO )
       )
     ) ) QTD_INSUMO
FROM BASI_030 ref -- referencia
JOIN PCPC_020 op -- OP
  ON op.REFERENCIA_PECA = ref.REFERENCIA
JOIN PCPC_040 lote -- lote
  ON lote.ORDEM_PRODUCAO = op.ORDEM_PRODUCAO
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = 1
 AND ia.NIVEL_COMP <> 1
 AND ia.GRUPO_ITEM = op.REFERENCIA_PECA
 AND (ia.SUB_ITEM = lote.PROCONF_SUBGRUPO OR ia.SUB_ITEM = '000')
 AND (ia.ITEM_ITEM = lote.PROCONF_ITEM OR ia.ITEM_ITEM = '000000')
 AND ia.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
 AND ia.ESTAGIO = lote.CODIGO_ESTAGIO
LEFT JOIN BASI_040 coc -- combinação cor
  ON ia.ITEM_COMP = '000000'
 AND coc.GRUPO_ITEM = ia.GRUPO_ITEM
 AND coc.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
 AND coc.SEQUENCIA = ia.SEQUENCIA
 AND coc.ITEM_ITEM = lote.PROCONF_ITEM
LEFT JOIN BASI_040 cot -- combinação tamanho
  ON ia.SUB_COMP = '000'
 AND cot.GRUPO_ITEM = ia.GRUPO_ITEM
 AND cot.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
 AND cot.SEQUENCIA = ia.SEQUENCIA
 AND cot.SUB_ITEM = lote.PROCONF_SUBGRUPO
WHERE op.SITUACAO IN (2, 4) -- não cancelada
  AND ia.NIVEL_COMP = 9
  AND ia.GRUPO_COMP = 'FI002'
  AND CASE WHEN ia.ITEM_COMP = '000000'
      THEN coc.ITEM_COMP
      ELSE ia.ITEM_COMP
      END = '0000UN'
  AND CASE WHEN ia.SUB_COMP = '000'
      THEN cot.SUB_COMP
      ELSE ia.SUB_COMP
      END = 'UNI'
  AND TRUNC(coalesce(op.DATA_ENTRADA_CORTE, SYSDATE) - 7, 'iw')
      = TO_DATE('26/03/2018','DD/MM/YYYY')
GROUP BY
  TRUNC(coalesce(op.DATA_ENTRADA_CORTE, SYSDATE) - 7, 'iw')
, op.REFERENCIA_PECA
, ref.DESCR_REFERENCIA
, op.ORDEM_PRODUCAO
HAVING
  sum( ia.CONSUMO *
       (
    ( lote.QTDE_PECAS_PROG - lote.QTDE_PECAS_PROD - lote.QTDE_PECAS_2A
    - lote.QTDE_PERDAS - lote.QTDE_CONSERTO )
       )
     ) > 0
ORDER BY
  TRUNC(coalesce(op.DATA_ENTRADA_CORTE, SYSDATE) - 7, 'iw')
, op.REFERENCIA_PECA
, op.ORDEM_PRODUCAO

)
SELECT
  n.SEMANA_NECESSIDADE
, sum(n.QTD_PRODUTO) QTD_PRODUTO
, sum(n.QTD_INSUMO) QTD_INSUMO
FROM neces n
GROUP BY
  n.SEMANA_NECESSIDADE
;

SELECT
  ia.*
FROM BASI_050 ia
LEFT JOIN BASI_040 cot -- combinação tamanho
  ON ia.SUB_COMP = '000'
 AND cot.GRUPO_ITEM = ia.GRUPO_ITEM
 AND cot.ALTERNATIVA_ITEM = ia.ALTERNATIVA_ITEM
 AND cot.SEQUENCIA = ia.SEQUENCIA
 AND cot.SUB_ITEM = 'P'
WHERE ia.NIVEL_COMP = 9
  AND ia.GRUPO_COMP = 'FI002'
  AND ia.NIVEL_ITEM = 1
  AND ia.GRUPO_ITEM = 'M0156'
  AND ia.ALTERNATIVA_ITEM = 4
;

SELECT
  oi.*
FROM PCPC_021 oi
WHERE oi.ORDEM_PRODUCAO = 4627
;

SELECT
  lote.*
FROM PCPC_040 lote
WHERE lote.ORDEM_PRODUCAO = 4627
;

SELECT
  lote.PROCONF_SUBGRUPO
, oi.TAMANHO
, lote.PROCONF_ITEM
, oi.SORTIMENTO

SELECT
  sum(lote.QTDE_PERDAS ) PERDA
FROM PCPC_021 oi
JOIN PCPC_040 lote
  ON lote.ORDEM_PRODUCAO = oi.ORDEM_PRODUCAO
 AND lote.PROCONF_SUBGRUPO = oi.TAMANHO
 AND lote.PROCONF_ITEM = oi.SORTIMENTO
WHERE oi.ORDEM_PRODUCAO = 4627

SELECT
  oi.TAMANHO TAMANHO
, oi.SORTIMENTO SORTIMENTO
, sum(lote.QTDE_PERDAS ) QUANTIDADE
FROM PCPC_021 oi
JOIN PCPC_040 lote
  ON lote.ORDEM_PRODUCAO = oi.ORDEM_PRODUCAO
 AND lote.PROCONF_SUBGRUPO = oi.TAMANHO
 AND lote.PROCONF_ITEM = oi.SORTIMENTO
WHERE oi.ORDEM_PRODUCAO = 4627
GROUP BY
  oi.SEQUENCIA_TAMANHO
, oi.TAMANHO
, oi.SORTIMENTO
ORDER BY
  oi.SEQUENCIA_TAMANHO
, oi.SORTIMENTO
;

SELECT
  lote.*
FROM PCPC_040 lote
WHERE lote.ORDEM_PRODUCAO = 3476
;

-- ME  G  /(2)28938 GG /(2)28945 M  /(2)28921 P  /(2)28914

UPDATE BASI_010 SET CODIGO_BARRAS='7899618828914' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0104M' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618828921' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0104M' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618828938' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0104M' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618828945' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0104M' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000ME';

-- PR  G  /(2)29225 GG /(2)29232 M  /(2)29218 P  /(2)29201

UPDATE BASI_010 SET CODIGO_BARRAS='7899618829201' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0104M' AND SUBGRU_ESTRUTURA= 'P' AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618829218' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0104M' AND SUBGRU_ESTRUTURA= 'M' AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618829225' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0104M' AND SUBGRU_ESTRUTURA= 'G' AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618829232' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0104M' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000PR';

SELECT
  u.*
FROM HDOC_030 u
WHERE u.USUARIO = 'MASTER'
;

SELECT
  i.CODIGO_BARRAS
, i.*
FROM basi_010 i
WHERE i.NIVEL_ESTRUTURA = 1
  AND i.GRUPO_ESTRUTURA IN ('0261E')
  AND i.ITEM_ESTRUTURA IN ('0000BR')
ORDER BY
  i.ITEM_ESTRUTURA
, i.SUBGRU_ESTRUTURA
, i.GRUPO_ESTRUTURA
;

UPDATE BASI_010 SET CODIGO_BARRAS='7899618819523' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000AJ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618819530' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000AJ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618819547' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000AJ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618819554' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000AJ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618810698' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000AM';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618810704' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000AM';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618810711' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000AM';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618810728' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000AM';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618809081' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618809098' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618809104' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618809111' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896256750' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896256798' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896256804' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896256811' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618814689' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618814696' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618814702' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618814719' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896256828' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896256835' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896256842' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896256859' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896256866' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896256873' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896256910' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896256927' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618810773' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000VE';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618810780' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000VE';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618810797' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000VE';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618810803' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000VE';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618810735' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000VM';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618810742' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000VM';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618810759' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000VM';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618810766' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0156L' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000VM';

UPDATE BASI_010 SET CODIGO_BARRAS='7899618819684' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='5156L' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000BC';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618819691' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='5156L' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000BC';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618819707' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='5156L' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000BC';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618819714' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='5156L' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000BC';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618805328' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='5156L' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618805335' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='5156L' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618805342' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='5156L' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618805359' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='5156L' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618805366' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='5156L' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618805373' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='5156L' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618805380' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='5156L' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618805397' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='5156L' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618805403' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='5156L' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618805410' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='5156L' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618805427' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='5156L' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618805434' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='5156L' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000PR';

UPDATE BASI_010 SET CODIGO_BARRAS='7899618840190' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0001U' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840206' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0001U' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840213' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0001U' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840220' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0001U' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840534' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0003U' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840541' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0003U' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840558' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0003U' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840565' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='0003U' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000AZ';

SELECT
  ia.*
FROM BASI_050 ia
WHERE ia.GRUPO_COMP = 'PL002'
;

SELECT
  ia.*
FROM BASI_050 ia
WHERE ia.GRUPO_COMP IN ('PL002', 'CA027')
;

UPDATE BASI_050 ia
SET
  ia.NIVEL_COMP ='9'
, ia.GRUPO_COMP ='CA027'
, ia.SUB_COMP = '0UN'
, ia.ITEM_COMP = '0000UN'
WHERE ia.GRUPO_COMP = 'PL002'
;

SELECT
  coc.GRUPO_ITEM
, ia.GRUPO_ITEM
, ia.*
FROM BASI_050 ia
LEFT JOIN BASI_040 coc -- combinação cor
  ON coc.GRUPO_ITEM = ia.GRUPO_ITEM
 AND coc.ALTERNATIVA_ITEM = ia.ALTERNATIVA_ITEM
 AND coc.SEQUENCIA = ia.SEQUENCIA
WHERE ia.GRUPO_COMP = 'PL002'
;

SELECT
  i.*
FROM BASI_010 i
WHERE i.GRUPO_ESTRUTURA = '05156'
-- AND i.NIVEL_ESTRUTURA = prev.NIVEL_ESTRUTURA
-- AND i.SUBGRU_ESTRUTURA = prev.SUBGRU_ESTRUTURA
;

SELECT
  i.*
FROM BASI_020 i
WHERE i.BASI030_NIVEL030 = 1
  AND i.BASI030_REFERENC = '05156'
  AND i.TAMANHO_REF = 'P'
;

SELECT
  lote.*
FROM PCPC_040 lote
WHERE lote.QTDE_PECAS_2A > 0
;

SELECT
  lote.PERIODO_PRODUCAO
, lote.ORDEM_CONFECCAO
, count(*) count
FROM PCPC_040 lote
WHERE lote.QTDE_PECAS_2A > 0
GROUP BY
  lote.PERIODO_PRODUCAO
, lote.ORDEM_CONFECCAO
ORDER BY
  3 DESC
;

SELECT
  lote.*
FROM PCPC_040 lote
WHERE lote.PERIODO_PRODUCAO = 1719 -- 171903268
  AND lote.ORDEM_CONFECCAO = 3268
;

SELECT
  lote.*
FROM PCPC_040 lote
WHERE lote.PERIODO_PRODUCAO = 1813
  AND lote.ORDEM_CONFECCAO = 1784
;


SELECT
  cr.*
FROM BASI_070 cr
WHERE cr.GRUPO = '5156J'
;

SELECT
  ca.*
FROM BASI_060 ca
--WHERE ca.GRUPO_ESTRUTURA = '5156J'
;

SELECT
  prev.NR_SOLICITACAO NR
--, prev.DESCRICAO DESCR
, prev.NIVEL_ESTRUTURA NIVEL
, prev.GRUPO_ESTRUTURA REF
--, prev.ITEM_ESTRUTURA COR_P
, ic.ITEM_ESTRUTURA COR
--, CASE WHEN prev.ITEM_ESTRUTURA = '000000'
--  THEN
--    ( SELECT
--        count(*)
--      FROM BASI_010 icc -- item cor contador
--      WHERE icc.NIVEL_ESTRUTURA = ic.NIVEL_ESTRUTURA
--        AND icc.GRUPO_ESTRUTURA = ic.GRUPO_ESTRUTURA
--        AND icc.SUBGRU_ESTRUTURA = ic.SUBGRU_ESTRUTURA
--    )
--  ELSE 1
--  END QTDE_C_I
--, prev.SUBGRU_ESTRUTURA TAM_P
--, prev.ORDEM_TAMANHO ORD_TAM_P
, it.TAMANHO_REF TAM
--, tam.ORDEM_TAMANHO ORD_TAM
--, CASE WHEN prev.SUBGRU_ESTRUTURA = '000'
--  THEN
--    ( SELECT
--        count(*)
--      FROM BASI_020 itc -- item tamanho contador
--      WHERE itc.BASI030_NIVEL030 = it.BASI030_NIVEL030
--        AND itc.BASI030_REFERENC = it.BASI030_REFERENC
--    )
--  ELSE 1
--  END QTDE_T_I
, prev.QTDE_NEC_BRUTAS
  /
  CASE WHEN prev.ITEM_ESTRUTURA = '000000'
  THEN
    ( SELECT
        count(*)
      FROM BASI_010 icc -- item cor contador
      WHERE icc.NIVEL_ESTRUTURA = ic.NIVEL_ESTRUTURA
        AND icc.GRUPO_ESTRUTURA = ic.GRUPO_ESTRUTURA
        AND icc.SUBGRU_ESTRUTURA = ic.SUBGRU_ESTRUTURA
    )
  ELSE 1
  END
  /
  CASE WHEN prev.SUBGRU_ESTRUTURA = '000'
  THEN
    ( SELECT
        count(*)
      FROM BASI_020 itc -- item tamanho contador
      WHERE itc.BASI030_NIVEL030 = it.BASI030_NIVEL030
        AND itc.BASI030_REFERENC = it.BASI030_REFERENC
    )
  ELSE 1
  END
  QTD
--, ic.NARRATIVA
--, ic.ALTERNATIVA_CUSTOS ALT_I
--, ic.ROTEIRO_CUSTOS ROT_I
--, ic.NUMERO_ALTERNATI ALT_IP
--, ic.NUMERO_ROTEIRO ROT_IP
--, prev.ALTERNATIVA ALT_O
--, prev.ROTEIRO ROT_O
, CASE WHEN prev.ALTERNATIVA = 0
  THEN ic.NUMERO_ALTERNATI
  ELSE prev.ALTERNATIVA
  END ALT
, CASE WHEN prev.ROTEIRO = 0
  THEN ic.NUMERO_ROTEIRO
  ELSE prev.ROTEIRO
  END ROT
--, prev.QTDE_NEC_BRUTAS QTD_BRUTA
--, prev.*
FROM RCNB_020 prev
LEFT JOIN BASI_020 it -- combinação tam
  ON ( prev.SUBGRU_ESTRUTURA = '000'
     OR it.TAMANHO_REF = prev.SUBGRU_ESTRUTURA
     )
 AND it.BASI030_NIVEL030 = prev.NIVEL_ESTRUTURA
 AND it.BASI030_REFERENC = prev.GRUPO_ESTRUTURA
LEFT JOIN BASI_220 tam
  ON tam.TAMANHO_REF = it.TAMANHO_REF
LEFT JOIN BASI_010 ic -- combinação cor
  ON ( prev.ITEM_ESTRUTURA = '000000'
     OR ic.ITEM_ESTRUTURA = prev.ITEM_ESTRUTURA
     )
 AND ic.NIVEL_ESTRUTURA = prev.NIVEL_ESTRUTURA
 AND ic.GRUPO_ESTRUTURA = prev.GRUPO_ESTRUTURA
 AND ic.SUBGRU_ESTRUTURA = it.TAMANHO_REF
WHERE prev.NR_SOLICITACAO = 9
ORDER BY
  prev.NIVEL_ESTRUTURA
, prev.GRUPO_ESTRUTURA
, ic.ITEM_ESTRUTURA
, tam.ORDEM_TAMANHO
;

WITH previsao AS (
SELECT
  1 NR
, 1 NIVEL
, '5156J' REF
, '0000ME' COR
, 'P' TAM
, 1000 QTD
, 4 ALT
, 4 ROT
FROM SYS.DUAL
)
SELECT
  ia.NIVEL_COMP C_NIVEL
, ia.GRUPO_COMP C_REF
, CASE WHEN ia.ITEM_COMP = '000000'
  THEN coc.ITEM_COMP
  ELSE ia.ITEM_COMP
  END C_COR
, CASE WHEN ia.SUB_COMP = '000'
  THEN cot.SUB_COMP
  ELSE ia.SUB_COMP
  END C_TAM
, ia.ALTERNATIVA_COMP C_ALT
, ia.CONSUMO * pre.QTD C_QTD
, pre.*
, ia.*
FROM previsao pre
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = pre.NIVEL
 AND ia.GRUPO_ITEM = pre.REF
 AND (ia.SUB_ITEM = pre.TAM OR ia.SUB_ITEM = '000')
 AND (ia.ITEM_ITEM = pre.COR OR ia.ITEM_ITEM = '000000')
 AND ia.ALTERNATIVA_ITEM = pre.ALT
LEFT JOIN BASI_040 coc -- combinação cor
  ON ia.ITEM_COMP = '000000'
 AND coc.GRUPO_ITEM = pre.REF
 AND coc.ALTERNATIVA_ITEM = pre.ALT
 AND coc.SEQUENCIA = ia.SEQUENCIA
 AND coc.ITEM_ITEM = pre.COR
LEFT JOIN BASI_040 cot -- combinação tamanho
  ON ia.SUB_COMP = '000'
 AND cot.GRUPO_ITEM = pre.REF
 AND cot.ALTERNATIVA_ITEM = pre.ALT
 AND cot.SEQUENCIA = ia.SEQUENCIA
 AND cot.SUB_ITEM = pre.TAM
;


WITH previsao AS (
SELECT
  prev.NR_SOLICITACAO NR
, prev.NIVEL_ESTRUTURA NIVEL
, prev.GRUPO_ESTRUTURA REF
, ic.ITEM_ESTRUTURA COR
, it.TAMANHO_REF TAM
, prev.QTDE_NEC_BRUTAS
  /
  CASE WHEN prev.ITEM_ESTRUTURA = '000000'
  THEN
    ( SELECT
        count(*)
      FROM BASI_010 icc -- item cor contador
      WHERE icc.NIVEL_ESTRUTURA = ic.NIVEL_ESTRUTURA
        AND icc.GRUPO_ESTRUTURA = ic.GRUPO_ESTRUTURA
        AND icc.SUBGRU_ESTRUTURA = ic.SUBGRU_ESTRUTURA
    )
  ELSE 1
  END
  /
  CASE WHEN prev.SUBGRU_ESTRUTURA = '000'
  THEN
    ( SELECT
        count(*)
      FROM BASI_020 itc -- item tamanho contador
      WHERE itc.BASI030_NIVEL030 = it.BASI030_NIVEL030
        AND itc.BASI030_REFERENC = it.BASI030_REFERENC
    )
  ELSE 1
  END
  QTD
, CASE WHEN prev.ALTERNATIVA = 0
  THEN ic.NUMERO_ALTERNATI
  ELSE prev.ALTERNATIVA
  END ALT
FROM RCNB_020 prev
LEFT JOIN BASI_020 it -- combinação tam
  ON ( prev.SUBGRU_ESTRUTURA = '000'
     OR it.TAMANHO_REF = prev.SUBGRU_ESTRUTURA
     )
 AND it.BASI030_NIVEL030 = prev.NIVEL_ESTRUTURA
 AND it.BASI030_REFERENC = prev.GRUPO_ESTRUTURA
LEFT JOIN BASI_220 tam
  ON tam.TAMANHO_REF = it.TAMANHO_REF
LEFT JOIN BASI_010 ic -- combinação cor
  ON ( prev.ITEM_ESTRUTURA = '000000'
     OR ic.ITEM_ESTRUTURA = prev.ITEM_ESTRUTURA
     )
 AND ic.NIVEL_ESTRUTURA = prev.NIVEL_ESTRUTURA
 AND ic.GRUPO_ESTRUTURA = prev.GRUPO_ESTRUTURA
 AND ic.SUBGRU_ESTRUTURA = it.TAMANHO_REF
WHERE prev.NR_SOLICITACAO = 9
ORDER BY
  prev.NIVEL_ESTRUTURA
, prev.GRUPO_ESTRUTURA
, ic.ITEM_ESTRUTURA
, tam.ORDEM_TAMANHO
)
SELECT
  ia.NIVEL_COMP C_NIVEL
, ia.GRUPO_COMP C_REF
, CASE WHEN ia.ITEM_COMP = '000000'
  THEN coc.ITEM_COMP
  ELSE ia.ITEM_COMP
  END C_COR
, CASE WHEN ia.SUB_COMP = '000'
  THEN cot.SUB_COMP
  ELSE ia.SUB_COMP
  END C_TAM
, ia.ALTERNATIVA_COMP C_ALT
, ia.CONSUMO * pre.QTD C_QTD
, pre.*
, ia.*
FROM previsao pre
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = pre.NIVEL
 AND ia.GRUPO_ITEM = pre.REF
 AND (ia.SUB_ITEM = pre.TAM OR ia.SUB_ITEM = '000')
 AND (ia.ITEM_ITEM = pre.COR OR ia.ITEM_ITEM = '000000')
 AND ia.ALTERNATIVA_ITEM = pre.ALT
LEFT JOIN BASI_040 coc -- combinação cor
  ON ia.ITEM_COMP = '000000'
 AND coc.GRUPO_ITEM = pre.REF
 AND coc.ALTERNATIVA_ITEM = pre.ALT
 AND coc.SEQUENCIA = ia.SEQUENCIA
 AND coc.ITEM_ITEM = pre.COR
LEFT JOIN BASI_040 cot -- combinação tamanho
  ON ia.SUB_COMP = '000'
 AND cot.GRUPO_ITEM = pre.REF
 AND cot.ALTERNATIVA_ITEM = pre.ALT
 AND cot.SEQUENCIA = ia.SEQUENCIA
 AND cot.SUB_ITEM = pre.TAM
;

-- teste de connect by
SELECT
  ia.NIVEL_ITEM
, ia.GRUPO_ITEM
, ia.ALTERNATIVA_ITEM
, ia.NIVEL_COMP
, CASE WHEN LEVEL = 1
  THEN ia.GRUPO_COMP
  ELSE ia.GRUPO_COMP || '!'
  END GRUPO_COMP
, ia.ALTERNATIVA_COMP
, LEVEL
FROM BASI_050 ia
START WITH ia.NIVEL_ITEM = 1 AND ia.GRUPO_ITEM = '05156' AND ia.ALTERNATIVA_ITEM = 4
CONNECT BY PRIOR ia.NIVEL_COMP = ia.NIVEL_ITEM AND PRIOR ia.GRUPO_COMP = ia.GRUPO_ITEM AND PRIOR ia.ALTERNATIVA_COMP = ia.ALTERNATIVA_ITEM
ORDER SIBLINGS BY ia.GRUPO_ITEM
;

-- teste de connect by sobre JOIN
SELECT
  ia.NIVEL_ITEM
, ia.GRUPO_ITEM
, re.DESCR_REFERENCIA
, ia.ALTERNATIVA_ITEM
, ia.NIVEL_COMP
, ia.GRUPO_COMP
, ia.ALTERNATIVA_COMP
, ia.ALTERNATIVA_COMP + PRIOR ia.ALTERNATIVA_COMP teste
FROM BASI_050 ia
JOIN BASI_030 re
  ON re.NIVEL_ESTRUTURA = ia.NIVEL_ITEM
 AND re.REFERENCIA = ia.GRUPO_ITEM
START WITH ia.NIVEL_ITEM = 1 AND ia.GRUPO_ITEM = '05156' AND ia.ALTERNATIVA_ITEM = 4
CONNECT BY PRIOR ia.NIVEL_COMP = ia.NIVEL_ITEM AND PRIOR ia.GRUPO_COMP = ia.GRUPO_ITEM AND PRIOR ia.ALTERNATIVA_COMP = ia.ALTERNATIVA_ITEM
;


-- tentativa de eliminar o with - não funcionou
SELECT
  CASE WHEN LEVEL = 1 THEN prev.NIVEL_ESTRUTURA
  ELSE ia.NIVEL_ITEM
  END NIVEL
, CASE WHEN LEVEL = 1 THEN prev.GRUPO_ESTRUTURA
  ELSE ia.GRUPO_ITEM
  END REF
, CASE WHEN LEVEL = 1 THEN ic.ITEM_ESTRUTURA
  ELSE ia.ITEM_ITEM
  END COR
, CASE WHEN LEVEL = 1 THEN it.TAMANHO_REF
  ELSE ia.SUB_ITEM
  END TAM
, CASE WHEN LEVEL = 1 THEN
    prev.QTDE_NEC_BRUTAS
    /
    CASE WHEN prev.ITEM_ESTRUTURA = '000000'
    THEN
      ( SELECT
          count(*)
        FROM BASI_010 icc -- item cor contador
        WHERE icc.NIVEL_ESTRUTURA = ic.NIVEL_ESTRUTURA
          AND icc.GRUPO_ESTRUTURA = ic.GRUPO_ESTRUTURA
          AND icc.SUBGRU_ESTRUTURA = ic.SUBGRU_ESTRUTURA
      )
    ELSE 1
    END
    /
    CASE WHEN prev.SUBGRU_ESTRUTURA = '000'
    THEN
      ( SELECT
          count(*)
        FROM BASI_020 itc -- item tamanho contador
        WHERE itc.BASI030_NIVEL030 = it.BASI030_NIVEL030
          AND itc.BASI030_REFERENC = it.BASI030_REFERENC
      )
    ELSE 1
    END
  ELSE ia.CONSUMO
  END QTD
, CASE WHEN LEVEL = 1 THEN
    CASE WHEN prev.ALTERNATIVA = 0
    THEN ic.NUMERO_ALTERNATI
    ELSE prev.ALTERNATIVA
    END
  ELSE ia.ALTERNATIVA_COMP
  END ALT
, ia.NIVEL_COMP C_NIVEL
, ia.GRUPO_COMP C_REF
--, CASE WHEN ia.ITEM_COMP = '000000'
--  THEN coc.ITEM_COMP
--  ELSE ia.ITEM_COMP
--  END C_COR
--, CASE WHEN ia.SUB_COMP = '000'
--  THEN cot.SUB_COMP
--  ELSE ia.SUB_COMP
--  END C_TAM
, ia.ALTERNATIVA_COMP C_ALT
--, ia.CONSUMO * pre.QTD C_QTD
FROM RCNB_020 prev
LEFT JOIN BASI_020 it -- combinação tam
  ON ( prev.SUBGRU_ESTRUTURA = '000'
     OR it.TAMANHO_REF = prev.SUBGRU_ESTRUTURA
     )
 AND it.BASI030_NIVEL030 = prev.NIVEL_ESTRUTURA
 AND it.BASI030_REFERENC = prev.GRUPO_ESTRUTURA
LEFT JOIN BASI_220 tam
  ON tam.TAMANHO_REF = it.TAMANHO_REF
LEFT JOIN BASI_010 ic -- combinação cor
  ON ( prev.ITEM_ESTRUTURA = '000000'
     OR ic.ITEM_ESTRUTURA = prev.ITEM_ESTRUTURA
     )
 AND ic.NIVEL_ESTRUTURA = prev.NIVEL_ESTRUTURA
 AND ic.GRUPO_ESTRUTURA = prev.GRUPO_ESTRUTURA
 AND ic.SUBGRU_ESTRUTURA = it.TAMANHO_REF
JOIN BASI_050 ia -- insumos de alternativa
  ON LEVEL > 1
START WITH prev.NR_SOLICITACAO = 9
CONNECT BY ia.NIVEL_ITEM = PRIOR ia.NIVEL_COMP
       AND ia.GRUPO_ITEM = PRIOR ia.GRUPO_COMP
--       AND (ia.SUB_ITEM = PRIOR TAM OR ia.SUB_ITEM = '000')
--       AND (ia.ITEM_ITEM = PRIOR COR OR ia.ITEM_ITEM = '000000')
       AND ia.ALTERNATIVA_ITEM = PRIOR ia.ALTERNATIVA_COMP
ORDER BY
  1
, 2
, 3
, 4
; -- deu errado

-- tentativa de connect by - não funcionou
WITH previsao AS (
SELECT
  prev.NR_SOLICITACAO NR
, prev.NIVEL_ESTRUTURA NIVEL
, prev.GRUPO_ESTRUTURA REF
, ic.ITEM_ESTRUTURA COR
, it.TAMANHO_REF TAM
, prev.QTDE_NEC_BRUTAS
  /
  CASE WHEN prev.ITEM_ESTRUTURA = '000000'
  THEN
    ( SELECT
        count(*)
      FROM BASI_010 icc -- item cor contador
      WHERE icc.NIVEL_ESTRUTURA = ic.NIVEL_ESTRUTURA
        AND icc.GRUPO_ESTRUTURA = ic.GRUPO_ESTRUTURA
        AND icc.SUBGRU_ESTRUTURA = ic.SUBGRU_ESTRUTURA
    )
  ELSE 1
  END
  /
  CASE WHEN prev.SUBGRU_ESTRUTURA = '000'
  THEN
    ( SELECT
        count(*)
      FROM BASI_020 itc -- item tamanho contador
      WHERE itc.BASI030_NIVEL030 = it.BASI030_NIVEL030
        AND itc.BASI030_REFERENC = it.BASI030_REFERENC
    )
  ELSE 1
  END
  QTD
, CASE WHEN prev.ALTERNATIVA = 0
  THEN ic.NUMERO_ALTERNATI
  ELSE prev.ALTERNATIVA
  END ALT
FROM RCNB_020 prev
LEFT JOIN BASI_020 it -- combinação tam
  ON ( prev.SUBGRU_ESTRUTURA = '000'
     OR it.TAMANHO_REF = prev.SUBGRU_ESTRUTURA
     )
 AND it.BASI030_NIVEL030 = prev.NIVEL_ESTRUTURA
 AND it.BASI030_REFERENC = prev.GRUPO_ESTRUTURA
LEFT JOIN BASI_220 tam
  ON tam.TAMANHO_REF = it.TAMANHO_REF
LEFT JOIN BASI_010 ic -- combinação cor
  ON ( prev.ITEM_ESTRUTURA = '000000'
     OR ic.ITEM_ESTRUTURA = prev.ITEM_ESTRUTURA
     )
 AND ic.NIVEL_ESTRUTURA = prev.NIVEL_ESTRUTURA
 AND ic.GRUPO_ESTRUTURA = prev.GRUPO_ESTRUTURA
 AND ic.SUBGRU_ESTRUTURA = it.TAMANHO_REF
ORDER BY
  prev.NIVEL_ESTRUTURA
, prev.GRUPO_ESTRUTURA
, ic.ITEM_ESTRUTURA
, tam.ORDEM_TAMANHO
)
SELECT
  LEVEL
, ia.NIVEL_COMP C_NIVEL
, ia.GRUPO_COMP C_REF
, CASE WHEN ia.ITEM_COMP = '000000'
  THEN coc.ITEM_COMP
  ELSE ia.ITEM_COMP
  END C_COR
, CASE WHEN ia.SUB_COMP = '000'
  THEN cot.SUB_COMP
  ELSE ia.SUB_COMP
  END C_TAM
, ia.ALTERNATIVA_COMP C_ALT
, ia.CONSUMO * pre.QTD C_QTD
, pre.*
FROM previsao pre
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = pre.NIVEL
 AND ia.GRUPO_ITEM = pre.REF
 AND (ia.SUB_ITEM = pre.TAM OR ia.SUB_ITEM = '000')
 AND (ia.ITEM_ITEM = pre.COR OR ia.ITEM_ITEM = '000000')
 AND ia.ALTERNATIVA_ITEM = pre.ALT
LEFT JOIN BASI_040 coc -- combinação cor
  ON ia.ITEM_COMP = '000000'
 AND coc.GRUPO_ITEM = pre.REF
 AND coc.ALTERNATIVA_ITEM = pre.ALT
 AND coc.SEQUENCIA = ia.SEQUENCIA
 AND coc.ITEM_ITEM = pre.COR
LEFT JOIN BASI_040 cot -- combinação tamanho
  ON ia.SUB_COMP = '000'
 AND cot.GRUPO_ITEM = pre.REF
 AND cot.ALTERNATIVA_ITEM = pre.ALT
 AND cot.SEQUENCIA = ia.SEQUENCIA
 AND cot.SUB_ITEM = pre.TAM
START WITH pre.NR = 9 AND pre.COR = '0000BC' AND pre.TAM = 'P'
CONNECT BY ia.NIVEL_COMP = 1
       AND ia.GRUPO_ITEM = PRIOR ia.GRUPO_COMP
--       AND (ia.SUB_ITEM = PRIOR TAM OR ia.SUB_ITEM = '000')
--       AND (ia.ITEM_ITEM = PRIOR COR OR ia.ITEM_ITEM = '000000')
--       AND ia.ALTERNATIVA_ITEM = PRIOR ia.ALTERNATIVA_COMP
; -- não funcionou

-- invertendo o join - não funcionou
SELECT
  prev.NR_SOLICITACAO NR
, prev.NIVEL_ESTRUTURA NIVEL
, prev.GRUPO_ESTRUTURA REF
, ic.ITEM_ESTRUTURA COR
, it.TAMANHO_REF TAM
, prev.QTDE_NEC_BRUTAS
  /
  CASE WHEN prev.ITEM_ESTRUTURA = '000000'
  THEN
    ( SELECT
        count(*)
      FROM BASI_010 icc -- item cor contador
      WHERE icc.NIVEL_ESTRUTURA = ic.NIVEL_ESTRUTURA
        AND icc.GRUPO_ESTRUTURA = ic.GRUPO_ESTRUTURA
        AND icc.SUBGRU_ESTRUTURA = ic.SUBGRU_ESTRUTURA
    )
  ELSE 1
  END
  /
  CASE WHEN prev.SUBGRU_ESTRUTURA = '000'
  THEN
    ( SELECT
        count(*)
      FROM BASI_020 itc -- item tamanho contador
      WHERE itc.BASI030_NIVEL030 = it.BASI030_NIVEL030
        AND itc.BASI030_REFERENC = it.BASI030_REFERENC
    )
  ELSE 1
  END
  QTD
, CASE WHEN prev.ALTERNATIVA = 0
  THEN ic.NUMERO_ALTERNATI
  ELSE prev.ALTERNATIVA
  END ALT
FROM BASI_010 ic -- item
LEFT JOIN RCNB_020 prev
  ON ( prev.ITEM_ESTRUTURA = '000000'
     OR ic.ITEM_ESTRUTURA = prev.ITEM_ESTRUTURA
     )
 AND ic.NIVEL_ESTRUTURA = prev.NIVEL_ESTRUTURA
 AND ic.GRUPO_ESTRUTURA = prev.GRUPO_ESTRUTURA
LEFT JOIN BASI_020 it -- combinação tam
  ON ( prev.SUBGRU_ESTRUTURA = '000'
     OR it.TAMANHO_REF = prev.SUBGRU_ESTRUTURA
     )
 AND it.BASI030_NIVEL030 = prev.NIVEL_ESTRUTURA
 AND it.BASI030_REFERENC = prev.GRUPO_ESTRUTURA
 AND ic.SUBGRU_ESTRUTURA = it.TAMANHO_REF
LEFT JOIN BASI_220 tam
  ON tam.TAMANHO_REF = it.TAMANHO_REF
WHERE prev.NR_SOLICITACAO = 9 -- AND pre.COR = '0000BC' AND pre.TAM = 'P'
ORDER BY
  prev.NIVEL_ESTRUTURA
, prev.GRUPO_ESTRUTURA
, ic.ITEM_ESTRUTURA
, tam.ORDEM_TAMANHO
; -- não funcionou

SELECT
  u.*
FROM HDOC_033 u
WHERE 1=1
  AND u.USU_PRG_CDUSU IN ('ROSANGELA_PCP', 'ALESSANDRA_PCP', 'ADRIANA_PCP')
  AND u.PROGRAMA= 'pcpc_e480'
ORDER BY
  u.PROGRAMA
, u.USU_PRG_CDUSU
;

DELETE FROM HDOC_033 u
WHERE u.USU_PRG_CDUSU NOT IN ('ROSANGELA_PCP', 'ALESSANDRA_PCP', 'ADRIANA_PCP')
  AND u.PROGRAMA = 'pcpc_e480'
;

SELECT
  ap.*
FROM basi_290 ap
WHERE ap.NIVEL_ESTRUTURA = 1
;


SELECT
  rownum NUM
, rr.NIVEL
, rr.REF
, rr.TIPO
, rr.DESCR
, rr.RESP
, rr.CPNJ9
, rr.CPNJ4
, rr.CPNJ2
, rr.CLIENTE
FROM (
SELECT
  r.NIVEL_ESTRUTURA NIVEL
, r.REFERENCIA REF
, CASE WHEN r.REFERENCIA <= '99999' THEN 'PA'
  WHEN r.REFERENCIA like 'A%' or r.REFERENCIA like 'B%' THEN 'PG'
  WHEN r.REFERENCIA like 'Z%' THEN 'MP'
  ELSE 'MD'
  END TIPO
, r.DESCR_REFERENCIA DESCR
, r.RESPONSAVEL RESP
, r.CGC_CLIENTE_9 CPNJ9
, r.CGC_CLIENTE_4 CPNJ4
, r.CGC_CLIENTE_2 CPNJ2
, COALESCE(c.FANTASIA_CLIENTE, c.NOME_CLIENTE) CLIENTE
FROM BASI_030 r
LEFT JOIN PEDI_010 c
  ON c.CGC_9 = r.CGC_CLIENTE_9
 AND c.CGC_4 = r.CGC_CLIENTE_4
 AND c.CGC_2 = r.CGC_CLIENTE_2
WHERE r.NIVEL_ESTRUTURA = 1
  AND r.RESPONSAVEL IS NOT NULL
  AND (
--  r.REFERENCIA LIKE '%0%'
--      OR r.DESCR_REFERENCIA LIKE '%0%'
--      OR r.RESPONSAVEL LIKE '%0%'
--      OR r.CGC_CLIENTE_9 LIKE '%0%'
--      OR
      COALESCE(c.FANTASIA_CLIENTE, c.NOME_CLIENTE) LIKE '%LASA%'
      )
ORDER BY
  NLSSORT(r.REFERENCIA,'NLS_SORT=BINARY_AI')
) rr
;

SELECT
  min(p.SEQUENCIA_ESTAGIO)
FROM PCPC_040 p
WHERE p.ORDEM_PRODUCAO > 3000
;


SELECT
  oi.TAMANHO TAMANHO
, oi.SORTIMENTO SORTIMENTO
, sum(lote.QTDE_PECAS_2A ) QUANTIDADE
FROM PCPC_021 oi
JOIN PCPC_040 lote
  ON lote.ORDEM_PRODUCAO = oi.ORDEM_PRODUCAO
 AND lote.PROCONF_SUBGRUPO = oi.TAMANHO
 AND lote.PROCONF_ITEM = oi.SORTIMENTO
WHERE oi.ORDEM_PRODUCAO = 5132
 AND lote.SEQUENCIA_ESTAGIO
     = COALESCE(
       (
          SELECT
           MAX(ulote.SEQUENCIA_ESTAGIO)
         FROM PCPC_040 ulote
         WHERE ulote.ORDEM_PRODUCAO = lote.ORDEM_PRODUCAO
           AND ulote.ORDEM_CONFECCAO = lote.ORDEM_CONFECCAO
           AND ulote.QTDE_PECAS_2A > 0
         GROUP BY
           ulote.ORDEM_PRODUCAO
         , ulote.ORDEM_CONFECCAO
       )
     , 1 )
GROUP BY
  oi.SEQUENCIA_TAMANHO
, oi.TAMANHO
, oi.SORTIMENTO
ORDER BY
  oi.SEQUENCIA_TAMANHO
, oi.SORTIMENTO
;

SELECT
--  ia.ESTAGIO
  ia.*
--  count(*)
FROM BASI_050 ia
WHERE ia.ALTERNATIVA_ITEM IN (01, 11, 21, 04, 14, 24)
  AND ia.NIVEL_COMP <> 1
  AND (  ia.GRUPO_COMP LIKE 'TG%'
      OR ia.GRUPO_COMP LIKE 'EB%'
      OR ia.GRUPO_COMP LIKE 'CA%'
      OR ia.GRUPO_COMP LIKE 'ET%'
      )
  AND ia.ESTAGIO <> 18
;

UPDATE BASI_050 ia
SET
  ia.ESTAGIO = 18
WHERE ia.ALTERNATIVA_ITEM IN (01, 11, 21, 04, 14, 24)
  AND ia.NIVEL_COMP <> 1
  AND (  ia.GRUPO_COMP LIKE 'TG%'
      OR ia.GRUPO_COMP LIKE 'EB%'
      OR ia.GRUPO_COMP LIKE 'CA%'
      OR ia.GRUPO_COMP LIKE 'ET%'
      )
  AND ia.ESTAGIO <> 18
;

SELECT
--  count(*)
  ia.*
FROM BASI_050 ia
WHERE ia.ALTERNATIVA_ITEM IN (01, 11, 21)
  AND ia.NIVEL_COMP <> 1
  AND ia.ESTAGIO in (45, 12, 60, 66)
;

UPDATE BASI_050 ia
SET
  ia.ESTAGIO = 18
WHERE ia.ALTERNATIVA_ITEM IN (01, 11, 21)
  AND ia.NIVEL_COMP <> 1
  AND ia.ESTAGIO in (45, 12, 60, 66)
;

UPDATE BASI_010 SET CODIGO_BARRAS='7899618836704' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00465' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836711' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00465' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836728' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00465' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836735' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00465' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836742' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00465' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000CB';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836759' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00465' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000CB';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836766' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00465' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000CB';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836773' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00465' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000CB';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836780' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00465' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000VE';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836797' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00465' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000VE';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836803' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00465' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000VE';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836810' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00465' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000VE';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839767' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00466' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839774' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00466' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839781' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00466' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839798' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00466' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839804' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00466' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000CB';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839811' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00466' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000CB';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839828' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00466' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000CB';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839835' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00466' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000CB';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839842' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00466' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839859' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00466' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839866' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00466' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839873' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00466' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839880' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00466' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839897' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00466' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839903' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00466' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839910' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00466' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839927' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00466' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000VE';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839934' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00466' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000VE';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839941' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00466' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000VE';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839958' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00466' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000VE';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839590' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00493' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839606' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00493' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839613' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00493' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839620' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00493' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839637' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00493' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839644' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00493' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839651' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00493' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618839668' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00493' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896258389' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00271' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896258396' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00271' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896258440' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00271' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896258457' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00271' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836223' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00271' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000CZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836230' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00271' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000CZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836247' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00271' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000CZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836254' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00271' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000CZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836148' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00271' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836155' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00271' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836162' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00271' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618836179' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00271' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000MA';

UPDATE BASI_010 SET CODIGO_BARRAS='7899618840534' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00003' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840541' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00003' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840558' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00003' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840565' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00003' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840466' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00003' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840480' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00003' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840510' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00003' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840527' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00003' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840572' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00003' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840589' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00003' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840596' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00003' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840602' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00003' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840626' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00004' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840633' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00004' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840640' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00004' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840657' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00004' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840664' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00004' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840671' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00004' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840688' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00004' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840695' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00004' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840701' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00004' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000VI';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840718' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00004' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000VI';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840725' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00004' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000VI';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840732' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00004' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000VI';

SELECT
--  ia.ESTAGIO
  ia.*
--  count(*)
FROM BASI_050 ia
WHERE ia.ALTERNATIVA_ITEM IN (01, 11, 21, 04, 14, 24)
  AND ia.NIVEL_COMP <> 1
  AND ia.GRUPO_COMP IN ('LI001', 'FI001')
  AND ia.ESTAGIO <> 18
;

UPDATE BASI_050 ia
SET
  ia.ESTAGIO = 18
WHERE ia.ALTERNATIVA_ITEM IN (01, 11, 21, 04, 14, 24)
  AND ia.NIVEL_COMP <> 1
  AND ia.GRUPO_COMP IN ('LI001', 'FI001')
  AND ia.ESTAGIO <> 18
;

UPDATE BASI_010 SET CODIGO_BARRAS='7896896233898' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00809' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896233904' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00809' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896228795' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00809' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896228788' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00809' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000BR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618846543' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00809' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618846550' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00809' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618846536' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00809' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618846529' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00809' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000MA';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896233935' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00809' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896233942' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00809' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896233928' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00809' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7896896233911' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00809' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000ME';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618846505' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00809' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618846512' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00809' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618846499' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00809' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000PR';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618846482' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00809' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000PR';

SELECT
  l.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO EST
, l.QTDE_PROGRAMADA Q_PROG
, l.QTDE_PECAS_PROG Q_P
, l.QTDE_A_PRODUZIR_PACOTE Q_AP
, l.QTDE_EM_PRODUCAO_PACOTE Q_EP
, l.QTDE_PECAS_PROD Q_PROD
, l.QTDE_PECAS_2A Q_2A
, l.QTDE_PERDAS Q_PERDA
, l.QTDE_CONSERTO Q_CONCERTO
, l.CODIGO_FAMILIA FAMI
, l.NUMERO_ORDEM OS
, coalesce(d.USUARIO_SYSTEXTIL, ' ') USU
, TO_CHAR(d.DATA_INSERCAO, 'DD/MM/YYYY HH24:MI') DT
, d.DATA_PRODUCAO
, coalesce(d.PROCESSO_SYSTEXTIL || ' - ' || p.DESCRICAO, ' ') PRG
, d.QTDE_PRODUZIDA
, d.QTDE_PECAS_2A
, d.QTDE_PERDAS
, d.QTDE_CONSERTO
FROM PCPC_040 l -- lote
JOIN MQOP_005 e -- estagio
  ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
LEFT JOIN PCPC_045 d -- movimentações de lote
  ON d.PCPC040_PERCONF = l.PERIODO_PRODUCAO
 AND d.PCPC040_ORDCONF = l.ORDEM_CONFECCAO
 AND d.PCPC040_ESTCONF = l.CODIGO_ESTAGIO
LEFT JOIN HDOC_036 p -- programa
  ON p.CODIGO_PROGRAMA = d.PROCESSO_SYSTEXTIL
 AND p.LOCALE = 'pt_BR'
WHERE l.PERIODO_PRODUCAO = 1814
  AND l.ORDEM_CONFECCAO = 00507
ORDER BY
  l.SEQ_OPERACAO
, d.SEQUENCIA
;

SELECT
  el.CODIGO_ESTAGIO
, el.DESCRICAO DESCRICAO_ESTAGIO
FROM (
SELECT
  l.CODIGO_ESTAGIO
, e.DESCRICAO
FROM PCPC_040 l
JOIN MQOP_005 e
  ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
WHERE l.PERIODO_PRODUCAO = 1814
  AND l.ORDEM_CONFECCAO = 531
  AND l.QTDE_EM_PRODUCAO_PACOTE <> 0
UNION
SELECT
  0
, 'FINALIZADO'
from dual
ORDER BY
  1 DESC
) el
WHERE rownum = 1
;

SELECT
  l.QTDE_PECAS_PROG
, l.QTDE_PROGRAMADA
, l.QTDE_PECAS_PROD
, l.QTDE_PECAS_2A
, l.QTDE_PERDAS
, l.QTDE_CONSERTO
, l.QTDE_EM_PRODUCAO_PACOTE
, l.QTDE_A_PRODUZIR_PACOTE
--
, l.*
FROM PCPC_040 l
JOIN MQOP_005 e
  ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
WHERE l.PERIODO_PRODUCAO = 1814
  AND l.ORDEM_CONFECCAO = 531
;

WITH lotes AS (
SELECT DISTINCT
  l.PERIODO_PRODUCAO
, l.ORDEM_CONFECCAO
FROM PCPC_040 l
WHERE l.PERIODO_PRODUCAO = 1814
  AND l.ORDEM_CONFECCAO = 631
)
...


WITH lotes AS (
SELECT
  1814 PERIODO_PRODUCAO
, 507 ORDEM_CONFECCAO
FROM SYS.DUAL
)
(
SELECT
  0 + l.SEQUENCIA_ESTAGIO SEQUENCIA
, l.QTDE_PECAS_PROD QTD
, 'FINALIZADO 1A.' TIPO
, l.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO ESTAGIO
FROM lotes sel
JOIN PCPC_040 l
  ON l.PERIODO_PRODUCAO = sel.PERIODO_PRODUCAO
 AND l.ORDEM_CONFECCAO = sel.ORDEM_CONFECCAO
JOIN MQOP_005 e
  ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
WHERE l.QTDE_PECAS_PROD <> 0
  AND l.SEQUENCIA_ESTAGIO
      = (
        SELECT
          max(ms.SEQUENCIA_ESTAGIO)
        FROM PCPC_040 ms
        WHERE ms.PERIODO_PRODUCAO = sel.PERIODO_PRODUCAO
          AND ms.ORDEM_CONFECCAO = sel.ORDEM_CONFECCAO
      )
--
UNION
--
SELECT
  1000 + l.SEQUENCIA_ESTAGIO SEQUENCIA
, l.QTDE_PECAS_2A QTD
, 'FINALIZADO 2A.' TIPO
, l.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO ESTAGIO
FROM lotes sel
JOIN PCPC_040 l
  ON l.PERIODO_PRODUCAO = sel.PERIODO_PRODUCAO
 AND l.ORDEM_CONFECCAO = sel.ORDEM_CONFECCAO
JOIN MQOP_005 e
  ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
WHERE l.QTDE_PECAS_2A <> 0
  AND l.SEQUENCIA_ESTAGIO
      = (
        SELECT
          max(ms.SEQUENCIA_ESTAGIO)
        FROM PCPC_040 ms
        WHERE ms.PERIODO_PRODUCAO = sel.PERIODO_PRODUCAO
          AND ms.ORDEM_CONFECCAO = sel.ORDEM_CONFECCAO
      )
--
UNION
--
SELECT
  2000 + l.SEQUENCIA_ESTAGIO SEQUENCIA
, l.QTDE_EM_PRODUCAO_PACOTE - l.QTDE_CONSERTO QTD
, 'A PRODUZIR' TIPO
, l.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO ESTAGIO
FROM lotes sel
JOIN PCPC_040 l
  ON l.PERIODO_PRODUCAO = sel.PERIODO_PRODUCAO
 AND l.ORDEM_CONFECCAO = sel.ORDEM_CONFECCAO
JOIN MQOP_005 e
  ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
WHERE l.QTDE_EM_PRODUCAO_PACOTE - l.QTDE_CONSERTO <> 0
--
UNION
--
SELECT
  3000 + l.SEQUENCIA_ESTAGIO SEQUENCIA
, l.QTDE_CONSERTO QTD
, 'EM CONSERTO' TIPO
, l.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO ESTAGIO
FROM lotes sel
JOIN PCPC_040 l
  ON l.PERIODO_PRODUCAO = sel.PERIODO_PRODUCAO
 AND l.ORDEM_CONFECCAO = sel.ORDEM_CONFECCAO
JOIN MQOP_005 e
  ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
WHERE l.QTDE_CONSERTO <> 0
--
UNION
--
SELECT
  4000 + l.SEQUENCIA_ESTAGIO SEQUENCIA
, l.QTDE_PERDAS QTD
, 'PERDAS' TIPO
, l.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO ESTAGIO
FROM lotes sel
JOIN PCPC_040 l
  ON l.PERIODO_PRODUCAO = sel.PERIODO_PRODUCAO
 AND l.ORDEM_CONFECCAO = sel.ORDEM_CONFECCAO
JOIN MQOP_005 e
  ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
WHERE l.QTDE_PERDAS <> 0
)
;


SELECT DISTINCT
  l.PERIODO_PRODUCAO
, l.ORDEM_CONFECCAO
, l.SITUACAO_ORDEM
FROM PCPC_040 l
WHERE l.PERIODO_PRODUCAO = 1814
  AND l.ORDEM_CONFECCAO = 631
;


SELECT DISTINCT
  l.SITUACAO_ORDEM
FROM PCPC_040 l
;

SELECT DISTINCT
  l.PERIODO_PRODUCAO
, l.ORDEM_CONFECCAO
FROM PCPC_040 l
WHERE l.QTDE_PROGRAMADA <> l.QTDE_PECAS_PROG
ORDER BY
  l.PERIODO_PRODUCAO DESC
, l.ORDEM_CONFECCAO DESC
;

SELECT
  l.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO EST
, l.QTDE_PROGRAMADA Q_PROG
, l.QTDE_PECAS_PROG Q_P
, l.QTDE_A_PRODUZIR_PACOTE Q_AP
, l.QTDE_EM_PRODUCAO_PACOTE Q_EP
, l.QTDE_PECAS_PROD Q_PROD
, l.QTDE_PECAS_2A Q_2A
, l.QTDE_PERDAS Q_PERDA
, l.QTDE_CONSERTO Q_CONSERTO
, l.CODIGO_FAMILIA FAMI
, l.NUMERO_ORDEM OS
FROM PCPC_040 l
JOIN MQOP_005 e
  ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
WHERE l.PERIODO_PRODUCAO = 1814 --181407892
  AND l.ORDEM_CONFECCAO = 7892
ORDER BY
  l.SEQ_OPERACAO
;

SELECT
  TO_CHAR(h.DATA_INSERCAO, 'DD/MM/YYYY HH24:MI:SS') DT
, h.PCPC040_ESTCONF EST
, h.TURNO_PRODUCAO TURNO
, h.CODIGO_FAMILIA FAMILIA
, h.QTDE_PRODUZIDA Q_P1
, h.QTDE_PECAS_2A Q_P2
, h.QTDE_CONSERTO Q_C
, h.QTDE_PERDAS Q_P
, coalesce(h.USUARIO_SYSTEXTIL, ' ') USU
, coalesce(h.PROCESSO_SYSTEXTIL, ' ') PRG
, coalesce(p.DESCRICAO, ' ') PRG_DESCR
FROM PCPC_045 h
LEFT JOIN HDOC_036 p
  ON p.CODIGO_PROGRAMA = h.PROCESSO_SYSTEXTIL
 AND p.LOCALE = 'pt_BR'
WHERE h.PCPC040_PERCONF = 1814
  AND h.PCPC040_ORDCONF = 507
ORDER BY
  h.DATA_INSERCAO
, h.PCPC040_ESTCONF
, h.SEQUENCIA
;

SELECT
  prev.NR_SOLICITACAO NR
, prev.DESCRICAO PREV_DESCR
, prev.NIVEL_ESTRUTURA NIVEL
, prev.GRUPO_ESTRUTURA REF
, ic.ITEM_ESTRUTURA COR
, it.TAMANHO_REF TAM
, sum(
  prev.QTDE_NEC_BRUTAS
  /
  CASE WHEN prev.ITEM_ESTRUTURA = '000000'
  THEN
    ( SELECT
        count(*)
      FROM BASI_010 icc -- item cor contador
      WHERE icc.NIVEL_ESTRUTURA = ic.NIVEL_ESTRUTURA
        AND icc.GRUPO_ESTRUTURA = ic.GRUPO_ESTRUTURA
        AND icc.SUBGRU_ESTRUTURA = ic.SUBGRU_ESTRUTURA
    )
  ELSE 1
  END
  /
  CASE WHEN prev.SUBGRU_ESTRUTURA = '000'
  THEN
    ( SELECT
        count(*)
      FROM BASI_020 itc -- item tamanho contador
      WHERE itc.BASI030_NIVEL030 = it.BASI030_NIVEL030
        AND itc.BASI030_REFERENC = it.BASI030_REFERENC
    )
  ELSE 1
  END
  ) QTD
, CASE WHEN prev.ALTERNATIVA = 0
  THEN ic.NUMERO_ALTERNATI
  ELSE prev.ALTERNATIVA
  END ALT
FROM RCNB_020 prev
LEFT JOIN BASI_020 it -- combinação tam
  ON ( prev.SUBGRU_ESTRUTURA = '000'
     OR it.TAMANHO_REF = prev.SUBGRU_ESTRUTURA
     )
 AND it.BASI030_NIVEL030 = prev.NIVEL_ESTRUTURA
 AND it.BASI030_REFERENC = prev.GRUPO_ESTRUTURA
LEFT JOIN BASI_220 tam
  ON tam.TAMANHO_REF = it.TAMANHO_REF
LEFT JOIN BASI_010 ic -- combinação cor
  ON ( prev.ITEM_ESTRUTURA = '000000'
     OR ic.ITEM_ESTRUTURA = prev.ITEM_ESTRUTURA
     )
 AND ic.NIVEL_ESTRUTURA = prev.NIVEL_ESTRUTURA
 AND ic.GRUPO_ESTRUTURA = prev.GRUPO_ESTRUTURA
 AND ic.SUBGRU_ESTRUTURA = it.TAMANHO_REF
WHERE prev.NR_SOLICITACAO = 9
GROUP BY
  prev.NR_SOLICITACAO
, prev.DESCRICAO
, prev.NIVEL_ESTRUTURA
, prev.GRUPO_ESTRUTURA
, ic.ITEM_ESTRUTURA
, tam.ORDEM_TAMANHO
, it.TAMANHO_REF
, CASE WHEN prev.ALTERNATIVA = 0
  THEN ic.NUMERO_ALTERNATI
  ELSE prev.ALTERNATIVA
  END
ORDER BY
  prev.NIVEL_ESTRUTURA
, prev.GRUPO_ESTRUTURA
, ic.ITEM_ESTRUTURA
, tam.ORDEM_TAMANHO
;

SELECT
  9 NR
, 1 NIVEL
, '05156' REF
, '0000BC' COR
, 'P' TAM
, 625 QTD
, 4 ALT
FROM SYS.DUAL
UNION
SELECT
  9 NR
, 1 NIVEL
, '05156' REF
, '0000BC' COR
, 'M' TAM
, 1625 QTD
, 4 ALT
FROM SYS.DUAL
;


WITH previsao AS (
SELECT
  9 NR
, 1 NIVEL
, '05156' REF
, '0000BC' COR
, 'P' TAM
, 625 QTD
, 4 ALT
FROM SYS.DUAL
UNION
SELECT
  9 NR
, 1 NIVEL
, '05156' REF
, '0000BC' COR
, 'M' TAM
, 1625 QTD
, 4 ALT
FROM SYS.DUAL
)
SELECT
  ia.NIVEL_COMP C_NIVEL
, ia.GRUPO_COMP C_REF
, CASE WHEN ia.ITEM_COMP = '000000'
  THEN coc.ITEM_COMP
  ELSE ia.ITEM_COMP
  END C_COR
, CASE WHEN ia.SUB_COMP = '000'
  THEN cot.SUB_COMP
  ELSE ia.SUB_COMP
  END C_TAM
, tam.ORDEM_TAMANHO ORD_TAM
, ia.ALTERNATIVA_COMP C_ALT
, ia.CONSUMO * pre.QTD C_QTD
, pre.*
, ia.*
FROM previsao pre
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = pre.NIVEL
 AND ia.GRUPO_ITEM = pre.REF
 AND (ia.SUB_ITEM = pre.TAM OR ia.SUB_ITEM = '000')
 AND (ia.ITEM_ITEM = pre.COR OR ia.ITEM_ITEM = '000000')
 AND ia.ALTERNATIVA_ITEM = pre.ALT
LEFT JOIN BASI_040 coc -- combinação cor
  ON ia.ITEM_COMP = '000000'
 AND coc.GRUPO_ITEM = pre.REF
 AND coc.ALTERNATIVA_ITEM = pre.ALT
 AND coc.SEQUENCIA = ia.SEQUENCIA
 AND coc.ITEM_ITEM = pre.COR
LEFT JOIN BASI_040 cot -- combinação tamanho
  ON ia.SUB_COMP = '000'
 AND cot.GRUPO_ITEM = pre.REF
 AND cot.ALTERNATIVA_ITEM = pre.ALT
 AND cot.SEQUENCIA = ia.SEQUENCIA
 AND cot.SUB_ITEM = pre.TAM
LEFT JOIN BASI_220 tam
  ON tam.TAMANHO_REF =
    CASE WHEN ia.SUB_COMP = '000'
    THEN cot.SUB_COMP
    ELSE ia.SUB_COMP
    END
ORDER BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, CASE WHEN ia.ITEM_COMP = '000000'
  THEN coc.ITEM_COMP
  ELSE ia.ITEM_COMP
  END
, tam.ORDEM_TAMANHO
, ia.ALTERNATIVA_COMP
;

SELECT distinct
--  i.NUMERO_MOLDE
--,
  i.descricao_tag1
, i.descricao_tag2
--, i.*
FROM basi_030 i
--WHERE i.ARTIGO = 8014
--ORDER BY
--  1
;

SELECT distinct
  i.descricao_tag1
, i.descricao_tag2
, i.*
FROM basi_030 i
WHERE i.DESCRICAO_TAG1 IS NOT NULL
   OR i.DESCRICAO_TAG2 IS NOT NULL
;

SELECT
  prev.NR_SOLICITACAO
, prev.DESCRICAO PREV_DESCR
, p.PERIODO_PRODUCAO
, p.DATA_INI_PERIODO INI_PERIODO
, p.DATA_INI_PERIODO - 7 DT_NECESSIDADE
, prev.NIVEL_ESTRUTURA NIVEL
, prev.GRUPO_ESTRUTURA REF
, ic.ITEM_ESTRUTURA COR
, it.TAMANHO_REF TAM
, SUM(
  prev.QTDE_NEC_BRUTAS
  /
  CASE WHEN prev.ITEM_ESTRUTURA = '000000'
  THEN
    ( SELECT
        count(*)
      FROM BASI_010 icc -- item cor contador
      WHERE icc.NIVEL_ESTRUTURA = ic.NIVEL_ESTRUTURA
        AND icc.GRUPO_ESTRUTURA = ic.GRUPO_ESTRUTURA
        AND icc.SUBGRU_ESTRUTURA = ic.SUBGRU_ESTRUTURA
    )
  ELSE 1
  END
  /
  CASE WHEN prev.SUBGRU_ESTRUTURA = '000'
  THEN
    ( SELECT
        count(*)
      FROM BASI_020 itc -- item tamanho contador
      WHERE itc.BASI030_NIVEL030 = it.BASI030_NIVEL030
        AND itc.BASI030_REFERENC = it.BASI030_REFERENC
    )
  ELSE 1
  END
  ) QTD
, CASE WHEN prev.ALTERNATIVA = 0
  THEN ic.NUMERO_ALTERNATI
  ELSE prev.ALTERNATIVA
  END ALT
FROM RCNB_020 prev
LEFT JOIN BASI_020 it -- combinação tam
  ON ( prev.SUBGRU_ESTRUTURA = '000'
     OR it.TAMANHO_REF = prev.SUBGRU_ESTRUTURA
     )
 AND it.BASI030_NIVEL030 = prev.NIVEL_ESTRUTURA
 AND it.BASI030_REFERENC = prev.GRUPO_ESTRUTURA
LEFT JOIN BASI_220 tam
  ON tam.TAMANHO_REF = it.TAMANHO_REF
LEFT JOIN BASI_010 ic -- combinação cor
  ON ( prev.ITEM_ESTRUTURA = '000000'
     OR ic.ITEM_ESTRUTURA = prev.ITEM_ESTRUTURA
     )
 AND ic.NIVEL_ESTRUTURA = prev.NIVEL_ESTRUTURA
 AND ic.GRUPO_ESTRUTURA = prev.GRUPO_ESTRUTURA
 AND ic.SUBGRU_ESTRUTURA = it.TAMANHO_REF
JOIN PCPC_010 p
  ON p.PERIODO_PRODUCAO = SUBSTR(prev.DESCRICAO, 1, 4)
 AND p.DATA_INI_PERIODO > (CURRENT_DATE + 37)
WHERE TRANSLATE(SUBSTR(prev.DESCRICAO, 1, 4), '0123456789', '9999999999') = '9999'
--  AND prev.DESCRICAO LIKE '1801 %'
GROUP BY
  prev.NR_SOLICITACAO
, prev.DESCRICAO
, p.PERIODO_PRODUCAO
, p.DATA_INI_PERIODO
, p.DATA_INI_PERIODO - 7
, prev.NIVEL_ESTRUTURA
, prev.GRUPO_ESTRUTURA
, ic.ITEM_ESTRUTURA
, tam.ORDEM_TAMANHO
, it.TAMANHO_REF
, CASE WHEN prev.ALTERNATIVA = 0
  THEN ic.NUMERO_ALTERNATI
  ELSE prev.ALTERNATIVA
  END
ORDER BY
  prev.NIVEL_ESTRUTURA
, prev.GRUPO_ESTRUTURA
, ic.ITEM_ESTRUTURA
, tam.ORDEM_TAMANHO
;

SELECT
  *
FROM HDOC_030
ORDER BY
  CODIGO_USUARIO DESC
;

SELECT
  i.CODIGO_BARRAS
, i.GRUPO_ESTRUTURA
, i.SUBGRU_ESTRUTURA
, i.ITEM_ESTRUTURA
FROM BASI_010 i
WHERE i.NIVEL_ESTRUTURA='1'
  AND i.GRUPO_ESTRUTURA='263DU'
;

UPDATE BASI_010 i
SET i.CODIGO_BARRAS =
  ( SELECT ii.CODIGO_BARRAS
    FROM BASI_010 ii
    WHERE ii.NIVEL_ESTRUTURA=i.NIVEL_ESTRUTURA
      AND ii.GRUPO_ESTRUTURA='00263'
      AND ii.SUBGRU_ESTRUTURA=i.SUBGRU_ESTRUTURA
      AND ii.ITEM_ESTRUTURA=i.ITEM_ESTRUTURA
  )
WHERE i.NIVEL_ESTRUTURA='1'
  AND i.GRUPO_ESTRUTURA='263DU'
;

SELECT
  d.*
FROM hdoc_033 d
WHERE d.PROGRAMA = 'pcpc_f230'
;

SELECT
  u.*
FROM HDOC_030 u
WHERE u.USUARIO like '%LUIZ%'
;

SELECT
  u.*
FROM HDOC_030 u
WHERE u.USUARIO IN
(
'ALESSANDRA_PCP',
'ROSANGELA_PCP',
'VANESSA_LOG',
'DIOGO_LOG',
'MARIANA_IND',
'VALDEIR_EST',
'CAIO_EST',
'LUIZ_IND'
)
;

SELECT
  d.*
FROM hdoc_033 d
WHERE d.PROGRAMA = 'pcpc_f230'
  AND d.USU_PRG_CDUSU IN
(
  'ALESSANDRA_PCP',
  'ROSANGELA_PCP',
  'VANESSA_LOG',
  'DIOGO_LOG',
  'MARIANA_IND',
  'VALDEIR_EST',
  'CAIO_EST',
  'LUIZ_IND',
  'ANSELMO_SIS'
)
;

DELETE FROM hdoc_033 d
WHERE d.PROGRAMA = 'pcpc_f230'
  AND d.USU_PRG_CDUSU NOT IN
(
  'ALESSANDRA_PCP',
  'ROSANGELA_PCP',
  'VANESSA_LOG',
  'DIOGO_LOG',
  'MARIANA_IND',
  'VALDEIR_EST',
  'CAIO_EST',
  'LUIZ_IND',
  'ANSELMO_SIS'
)
;

SELECT
  'SILVIO_TEC' USU_PRG_CDUSU
, d.USU_PRG_EMPR_USU
, d.PROGRAMA
, d.NOME_MENU
, d.ITEM_MENU
, d.ORDEM_MENU
, d.INCLUIR
, d.MODIFICAR
, d.EXCLUIR
, d.PROCURAR
, d.COORDENADA_X
, d.COORDENADA_Y
, d.MARGEM_ESQ_RELATORIOS
, d.SUPERVISOR
FROM hdoc_033 d
WHERE d.PROGRAMA = 'pcpc_f230'
  AND d.NOME_MENU = 'm0801_04'
  AND d.USU_PRG_CDUSU = 'ALESSANDRA_PCP'
;

INSERT INTO SYSTEXTIL.HDOC_033
(USU_PRG_CDUSU, USU_PRG_EMPR_USU, PROGRAMA, NOME_MENU, ITEM_MENU, ORDEM_MENU, INCLUIR, MODIFICAR, EXCLUIR, PROCURAR, COORDENADA_X, COORDENADA_Y, MARGEM_ESQ_RELATORIOS, SUPERVISOR)
VALUES('ALESSANDRA_PCP', 1, 'pcpc_f230', 'm0801_04', 1, 45, 'S', 'S', 'S', 'S', 0, 0, 0, NULL)
;

INSERT INTO SYSTEXTIL.HDOC_033
(USU_PRG_CDUSU, USU_PRG_EMPR_USU, PROGRAMA, NOME_MENU, ITEM_MENU, ORDEM_MENU, INCLUIR, MODIFICAR, EXCLUIR, PROCURAR, COORDENADA_X, COORDENADA_Y, MARGEM_ESQ_RELATORIOS, SUPERVISOR)
SELECT
  'SILVIO_TEC' USU_PRG_CDUSU
, d.USU_PRG_EMPR_USU
, d.PROGRAMA
, d.NOME_MENU
, d.ITEM_MENU
, d.ORDEM_MENU
, d.INCLUIR
, d.MODIFICAR
, d.EXCLUIR
, d.PROCURAR
, d.COORDENADA_X
, d.COORDENADA_Y
, d.MARGEM_ESQ_RELATORIOS
, d.SUPERVISOR
FROM hdoc_033 d
WHERE d.PROGRAMA = 'pcpc_f230'
  AND d.NOME_MENU = 'm0801_04'
  AND d.USU_PRG_CDUSU = 'ALESSANDRA_PCP'
;

SELECT DISTINCT
  d.USU_PRG_CDUSU
FROM hdoc_033 d
WHERE d.PROGRAMA = 'pcpc_f230'
ORDER BY 1
;

SELECT
  ii.CODIGO_BARRAS
, ii.*
FROM BASI_010 ii
WHERE ii.NIVEL_ESTRUTURA=1
  AND ii.GRUPO_ESTRUTURA = '0251H'
  AND ii.CODIGO_BARRAS IS NOT NULL
ORDER BY
  ii.GRUPO_ESTRUTURA
, ii.SUBGRU_ESTRUTURA
, ii.ITEM_ESTRUTURA
;

UPDATE BASI_010 i
SET i.CODIGO_BARRAS =
  ( SELECT ii.CODIGO_BARRAS
    FROM BASI_010 ii
    WHERE ii.NIVEL_ESTRUTURA=i.NIVEL_ESTRUTURA
      AND ii.GRUPO_ESTRUTURA='00251'
      AND ii.SUBGRU_ESTRUTURA=i.SUBGRU_ESTRUTURA
      AND ii.ITEM_ESTRUTURA=i.ITEM_ESTRUTURA
  )
WHERE i.NIVEL_ESTRUTURA='1'
  AND i.GRUPO_ESTRUTURA='0251H'
;

UPDATE BASI_010 SET CODIGO_BARRAS='7899618840190' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00001' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840206' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00001' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840213' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00001' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840220' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00001' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000AZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840237' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00001' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000CZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840244' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00001' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000CZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840251' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00001' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000CZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840268' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00001' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000CZ';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840275' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00001' AND SUBGRU_ESTRUTURA='P'  AND ITEM_ESTRUTURA='0000VI';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840282' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00001' AND SUBGRU_ESTRUTURA='M'  AND ITEM_ESTRUTURA='0000VI';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840299' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00001' AND SUBGRU_ESTRUTURA='G'  AND ITEM_ESTRUTURA='0000VI';
UPDATE BASI_010 SET CODIGO_BARRAS='7899618840305' WHERE NIVEL_ESTRUTURA='1' AND GRUPO_ESTRUTURA='00001' AND SUBGRU_ESTRUTURA='GG' AND ITEM_ESTRUTURA='0000VI';

WITH lotes AS
(
  SELECT DISTINCT
    le.ORDEM_PRODUCAO
  , le.ORDEM_CONFECCAO
  , le.QTDE_PECAS_PROG
  FROM PCPC_040 le -- lote estágio
  JOIN PCPC_020 op -- OP capa
    ON op.ordem_producao = le.ORDEM_PRODUCAO
  WHERE op.COD_CANCELAMENTO = 0
    AND op.ORDEM_PRODUCAO < 20
  ORDER BY
    le.ORDEM_PRODUCAO
  , le.ORDEM_CONFECCAO
)
SELECT
  FLOOR(le.ORDEM_PRODUCAO/10) OP
, sum(le.QTDE_PECAS_PROG) prog
FROM lotes le
GROUP BY
  FLOOR(le.ORDEM_PRODUCAO/10)
ORDER BY
  1
;

WITH lotes AS
(
  SELECT DISTINCT
    le.ORDEM_PRODUCAO
  , le.ORDEM_CONFECCAO
  , le.QTDE_PECAS_PROG
  FROM PCPC_040 le -- lote estágio
  JOIN PCPC_020 op -- OP capa
    ON op.ordem_producao = le.ORDEM_PRODUCAO
  WHERE op.COD_CANCELAMENTO = 0
    AND op.ORDEM_PRODUCAO < 20
  ORDER BY
    le.ORDEM_PRODUCAO
  , le.ORDEM_CONFECCAO
)
SELECT
  lo.ORDEM_PRODUCAO OP
--, lo.ORDEM_CONFECCAO
--, mod(lo.ORDEM_CONFECCAO, 10)
--, (1+lo.ORDEM_CONFECCAO)
--, sum(lo.QTDE_PECAS_PROG) prog
, sum(lo.QTDE_PECAS_PROG*(1+mod(lo.ORDEM_CONFECCAO, 10))) prog2
FROM lotes lo
GROUP BY
  lo.ORDEM_PRODUCAO
ORDER BY
  1
;

SELECT DISTINCT
  le.ORDEM_PRODUCAO OP
, le.PERIODO_PRODUCAO PERIODO
, le.ORDEM_CONFECCAO OC
, le.PROCONF_GRUPO REF
, le.PROCONF_SUBGRUPO TAM
, t.ORDEM_TAMANHO ORD_TAM
, le.PROCONF_ITEM COR
, le.QTDE_PECAS_PROG QUANT
FROM PCPC_040 le -- lote estágio
LEFT JOIN BASI_220 t
  ON t.TAMANHO_REF = le.PROCONF_SUBGRUPO
WHERE le.ORDEM_PRODUCAO = 13
ORDER BY
  le.ORDEM_PRODUCAO
, le.ORDEM_CONFECCAO
;

SELECT
  oi.ORDEM_PRODUCAO
, oi.TAMANHO TAMANHO
, oi.SORTIMENTO SORTIMENTO
, sum(lote.QTDE_CONSERTO ) QUANTIDADE
FROM PCPC_021 oi
JOIN PCPC_040 lote
  ON lote.ORDEM_PRODUCAO = oi.ORDEM_PRODUCAO
 AND lote.PROCONF_SUBGRUPO = oi.TAMANHO
 AND lote.PROCONF_ITEM = oi.SORTIMENTO
WHERE oi.ORDEM_PRODUCAO > 5132
  AND lote.QTDE_CONSERTO > 0
GROUP BY
  oi.ORDEM_PRODUCAO
, oi.SEQUENCIA_TAMANHO
, oi.TAMANHO
, oi.SORTIMENTO
ORDER BY
  oi.SEQUENCIA_TAMANHO
, oi.SORTIMENTO
;

SELECT
--  ia.ESTAGIO
  ia.*
--  count(*)
FROM BASI_050 ia
WHERE ia.ALTERNATIVA_ITEM IN (01, 11, 21, 04, 14, 24)
  AND ia.NIVEL_COMP <> 1
  AND ia.GRUPO_COMP LIKE 'TR%'
  AND ia.ESTAGIO <> 18
;

UPDATE BASI_050 ia
SET
  ia.ESTAGIO = 18
WHERE ia.ALTERNATIVA_ITEM IN (01, 11, 21, 04, 14, 24)
  AND ia.NIVEL_COMP <> 1
  AND ia.GRUPO_COMP LIKE 'TR%'
  AND ia.ESTAGIO <> 18
;


SELECT
  nf.DATA_EMISSAO
, nf.NUM_NOTA_FISCAL
, osi.NUMERO_ORDEM
, op.REFERENCIA_PECA
, osi.PRODSAI_GRUPO
, osr.PRODORD_GRUPO
, osr.PRODBASE_GRUPO
, osi.NUMERO_ORDEM
, osi.SEQUENCIA
, nf.*
, osi.*
FROM FATU_050 nf -- nota fiscal da Tussor - capa
JOIN OBRF_082 osi -- OS - item de nota
  ON osi.NUM_NF_SAI = nf.NUM_NOTA_FISCAL
JOIN OBRF_081 osr -- OS - item de retorno
  ON osr.NUMERO_ORDEM = osi.NUMERO_ORDEM
JOIN PCPC_040 l -- lote
  ON l.NUMERO_ORDEM = osr.NUMERO_ORDEM
JOIN OBRF_080 os -- OS - capa
  ON os.NUMERO_ORDEM = osr.NUMERO_ORDEM
JOIN PCPC_020 op -- OP - capa
  ON op.ordem_producao = l.ORDEM_PRODUCAO
-- AND op.REFERENCIA_PECA = osi.PRODSAI_GRUPO
WHERE nf.NUM_NOTA_FISCAL = 62996
;

SELECT
  l.*
FROM PCPC_040 l -- lote
WHERE l.ORDEM_PRODUCAO = 4817
;

SELECT
  osr.*
FROM OBRF_081 osr -- OS - item de retorno
where osr.NUMERO_ORDEM = 2000
;

SELECT
  nf.DATA_EMISSAO DT
, nf.NUM_NOTA_FISCAL NF
, op.ORDEM_PRODUCAO OP
, osr.NUMERO_ORDEM OS
, op.REFERENCIA_PECA REF
, osr.e
, osr.PRODBASE_GRUPO
--, osi.NUMERO_ORDEM
--, osi.SEQUENCIA
FROM FATU_050 nf -- nota fiscal da Tussor - capa
JOIN OBRF_081 osr -- OS - item de retorno
  ON osr.NOTA_SAIDA = nf.NUM_NOTA_FISCAL
JOIN PCPC_040 l -- lote
  ON l.NUMERO_ORDEM = osr.NUMERO_ORDEM
JOIN OBRF_080 os -- OS - capa
  ON os.NUMERO_ORDEM = osr.NUMERO_ORDEM
JOIN PCPC_020 op -- OP - capa
  ON op.ordem_producao = l.ORDEM_PRODUCAO
-- AND op.REFERENCIA_PECA = osi.PRODSAI_GRUPO
WHERE nf.NUM_NOTA_FISCAL = 62996
;

SELECT
  c.*
FROM PEDI_010 c;
;

SELECT
  nf.*
FROM FATU_050 nf -- nota fiscal da Tussor - capa
WHERE nf.CGC_9 = 0
;

WITH op_os AS
( SELECT DISTINCT
    l.ORDEM_PRODUCAO
  , l.PROCONF_GRUPO
  , l.PROCONF_SUBGRUPO
  , l.PROCONF_ITEM
  , l.NUMERO_ORDEM
  FROM PCPC_040 l -- lote
)
SELECT
  oo.ORDEM_PRODUCAO OP
, oo.PROCONF_GRUPO REF
, oo.PROCONF_ITEM COR
, oo.PROCONF_SUBGRUPO TAM
, os.NUMERO_ORDEM OS
, SUM(osi.QTDE_ENVIADA) QTD
, nf.DATA_EMISSAO DT
, nf.NUM_NOTA_FISCAL NF
, cind.NOME_CLIENTE
  || ' (' || lpad(cind.CGC_9, 8, '0')
  || '/' || lpad(cind.CGC_4, 4, '0')
  || '-' || lpad(cind.CGC_2, 2, '0')
  || ')' FACCAO
, nfec.DATA_EMISSAO DT_RET
, nfec.DOCUMENTO NF_RET
, sum(nfei.QUANTIDADE) QTD_RET
, op.PEDIDO_VENDA PED
, ped.COD_PED_CLIENTE PED_CLI
, c.NOME_CLIENTE
  || ' (' || lpad(c.CGC_9, 8, '0')
  || '/' || lpad(c.CGC_4, 4, '0')
  || '-' || lpad(c.CGC_2, 2, '0')
  || ')' CLI
FROM OBRF_080 os -- OS - capa
JOIN op_os oo -- relação de OP com OS
  ON oo.NUMERO_ORDEM = os.NUMERO_ORDEM
JOIN PCPC_020 op -- OP - capa
  ON op.ordem_producao = oo.ORDEM_PRODUCAO
LEFT JOIN PEDI_100 ped -- pedido de venda
  ON ped.PEDIDO_VENDA = op.PEDIDO_VENDA
LEFT JOIN PEDI_010 c -- cliente - do pedido de venda
  ON c.CGC_9 = ped.CLI_PED_CGC_CLI9
 AND c.CGC_4 = ped.CLI_PED_CGC_CLI4
JOIN OBRF_082 osi -- OS - item de nota
  ON osi.NUMERO_ORDEM = os.NUMERO_ORDEM
 AND osi.PRODSAI_GRUPO = oo.PROCONF_GRUPO
JOIN FATU_050 nf -- nota fiscal da Tussor - capa
  ON nf.NUM_NOTA_FISCAL = osi.NUM_NF_SAI
LEFT JOIN PEDI_010 cind -- cliente - industrializador
  ON cind.CGC_9 = nf.CGC_9
 AND cind.CGC_4 = nf.CGC_4
LEFT JOIN OBRF_015 nfei -- nota fiscal de entrada - item
  ON osi.NUM_NF_SAI <> 0
 AND nfei.NUM_NOTA_ORIG = osi.NUM_NF_SAI
 AND nfei.CODITEM_NIVEL99 = osi.PRODSAI_NIVEL99
 AND nfei.CODITEM_GRUPO = osi.PRODSAI_GRUPO
 AND nfei.CODITEM_SUBGRUPO = osi.PRODSAI_SUBGRUPO
 AND nfei.CODITEM_ITEM = osi.PRODSAI_ITEM
LEFT JOIN OBRF_010 nfec -- nota fiscal de entrada - capa
  ON nfec.DOCUMENTO = nfei.CAPA_ENT_NRDOC
 AND nfec.CGC_CLI_FOR_9 = nfei.CAPA_ENT_FORCLI9
 AND nfec.CGC_CLI_FOR_4 = nfei.CAPA_ENT_FORCLI4
LEFT JOIN BASI_220 t -- tamanhos
  ON t.TAMANHO_REF = oo.PROCONF_SUBGRUPO
WHERE 1=1
--  AND op.ordem_producao = 3480 -- op
--  AND os.NUMERO_ORDEM = 2170 -- os
--  AND nf.DATA_EMISSAO = TO_DATE('19/03/2018','DD/MM/YYYY') -- dt_saida
            AND nf.DATA_EMISSAO >= TO_DATE('19/03/2018','DD/MM/YYYY')
            AND nf.DATA_EMISSAO <= TO_DATE('19/03/2018','DD/MM/YYYY')
--  AND nf.NUM_NOTA_FISCAL = 63422 -- nf_saida
--  AND nfec.DATA_EMISSAO = TO_DATE('26/03/2018','DD/MM/YYYY') -- dt_entrada
--  AND nfec.DOCUMENTO = 54603 -- nf_entrada
--  AND cind.NOME_CLIENTE
--      || ' (' || lpad(cind.CGC_9, 8, '0')
--      || '/' || lpad(cind.CGC_4, 4, '0')
--      || '-' || lpad(cind.CGC_2, 2, '0')
--      || ')' LIKE '%LAU%'  -- faccao
--  AND op.PEDIDO_VENDA = 3472 -- pedido
--  AND ped.COD_PED_CLIENTE like '2341494' -- pedido_cliente
--  AND c.NOME_CLIENTE
--      || ' (' || lpad(c.CGC_9, 8, '0')
--      || '/' || lpad(c.CGC_4, 4, '0')
--      || '-' || lpad(c.CGC_2, 2, '0')
--      || ')' LIKE '%RENN%'  -- cliente
GROUP BY
  oo.ORDEM_PRODUCAO
, oo.PROCONF_GRUPO
, oo.PROCONF_ITEM
, t.ORDEM_TAMANHO
, oo.PROCONF_SUBGRUPO
, os.NUMERO_ORDEM
, nf.DATA_EMISSAO
, nf.NUM_NOTA_FISCAL
, cind.NOME_CLIENTE
, cind.CGC_9
, cind.CGC_4
, cind.CGC_2
, nfec.DATA_EMISSAO
, nfec.DOCUMENTO
, op.PEDIDO_VENDA
, ped.COD_PED_CLIENTE
, c.NOME_CLIENTE
, c.CGC_9
, c.CGC_4
, c.CGC_2
ORDER BY
  oo.ORDEM_PRODUCAO
, os.NUMERO_ORDEM
, oo.PROCONF_GRUPO
, oo.PROCONF_ITEM
, t.ORDEM_TAMANHO
, nf.DATA_EMISSAO
, nf.NUM_NOTA_FISCAL
, nfec.DATA_EMISSAO
, nfec.DOCUMENTO
;

SELECT
  i.CODIGO_BARRAS
, i.GRUPO_ESTRUTURA
, i.SUBGRU_ESTRUTURA
, i.ITEM_ESTRUTURA
FROM BASI_010 i
WHERE i.NIVEL_ESTRUTURA='1'
  AND i.GRUPO_ESTRUTURA='613DU'
--  AND i.GRUPO_ESTRUTURA='00613'
;

UPDATE BASI_010 i
SET i.CODIGO_BARRAS =
  ( SELECT ii.CODIGO_BARRAS
    FROM BASI_010 ii
    WHERE ii.NIVEL_ESTRUTURA=i.NIVEL_ESTRUTURA
      AND ii.GRUPO_ESTRUTURA='00613'
      AND ii.SUBGRU_ESTRUTURA=i.SUBGRU_ESTRUTURA
      AND ii.ITEM_ESTRUTURA=i.ITEM_ESTRUTURA
  )
WHERE i.NIVEL_ESTRUTURA='1'
  AND i.GRUPO_ESTRUTURA='613DU'
;

WITH prod AS
(
  SELECT DISTINCT
    ia.GRUPO_ITEM ITEM
  , ia.GRUPO_COMP COMP
  FROM BASI_050 ia
  WHERE 1=1
    AND ia.NIVEL_COMP = 1
    AND ia.NIVEL_ITEM = 1
    AND ia.GRUPO_ITEM IN
      (
      '00001',
      '00002',
      '00003',
      '00004',
      '0001A'
      )
)
SELECT DISTINCT
  r.REFERENCIA
FROM BASI_030 r
JOIN prod p
  ON p.ITEM = r.REFERENCIA
  OR p.COMP = r.REFERENCIA
WHERE r.NIVEL_ESTRUTURA = 1
ORDER BY
  1
;

SELECT DISTINCT
  r.REFERENCIA
FROM (
  SELECT DISTINCT
    ia.GRUPO_ITEM ITEM
  , ia.GRUPO_COMP COMP
  FROM BASI_050 ia
  WHERE 1=1
    AND ia.NIVEL_COMP = 1
    AND ia.NIVEL_ITEM = 1
    AND ia.GRUPO_ITEM IN
      (
      '00001',
      '00002',
      '00003',
      '00004',
      '0001A'
      )
) p
JOIN BASI_030 r
  ON r.REFERENCIA = p.ITEM
  OR r.REFERENCIA = p.COMP
WHERE r.NIVEL_ESTRUTURA = 1
ORDER BY
  1
;

SELECT DISTINCT
--  ia.GRUPO_ITEM
--, ia2.GRUPO_ITEM
--, ia3.GRUPO_ITEM
--, ia4.GRUPO_ITEM
--, ia5.GRUPO_ITEM
--,
  COALESCE(
    ia5.GRUPO_ITEM
  , COALESCE(
      ia4.GRUPO_ITEM
    , COALESCE(
        ia3.GRUPO_ITEM
      , COALESCE(
          ia2.GRUPO_ITEM
        , ia.GRUPO_ITEM
        )
      )
    )
  ) ITEM
FROM BASI_050 ia
LEFT JOIN BASI_050 ia2
  ON ia2.NIVEL_ITEM = ia.NIVEL_COMP
 AND ia2.GRUPO_ITEM = ia.GRUPO_COMP
LEFT JOIN BASI_050 ia3
  ON ia3.NIVEL_ITEM = ia2.NIVEL_COMP
 AND ia3.GRUPO_ITEM = ia2.GRUPO_COMP
LEFT JOIN BASI_050 ia4
  ON ia4.NIVEL_ITEM = ia3.NIVEL_COMP
 AND ia4.GRUPO_ITEM = ia3.GRUPO_COMP
LEFT JOIN BASI_050 ia5
  ON ia5.NIVEL_ITEM = ia4.NIVEL_COMP
 AND ia5.GRUPO_ITEM = ia4.GRUPO_COMP
WHERE 1=1
  AND ia.NIVEL_ITEM = 1
  AND (ia2.NIVEL_ITEM IS NULL OR ia2.NIVEL_ITEM = 1)
  AND (ia3.NIVEL_ITEM IS NULL OR ia3.NIVEL_ITEM = 1)
  AND (ia4.NIVEL_ITEM IS NULL OR ia4.NIVEL_ITEM = 1)
  AND (ia5.NIVEL_ITEM IS NULL OR ia5.NIVEL_ITEM = 1)
  AND ia.GRUPO_ITEM IN
      (
      '00001',
      '00002',
      '00003',
      '00004',
      '0001A',
      '0002A',
      '617VO',
      '619VO',
      '620VO'
      )
 ORDER BY
   1
;

WITH itens AS
(
SELECT DISTINCT
--  ia.GRUPO_ITEM
--, ia2.GRUPO_ITEM
--, ia3.GRUPO_ITEM
--, ia4.GRUPO_ITEM
--, ia5.GRUPO_ITEM
--,
  COALESCE(
    ia5.GRUPO_ITEM
  , COALESCE(
      ia4.GRUPO_ITEM
    , COALESCE(
        ia3.GRUPO_ITEM
      , COALESCE(
          ia2.GRUPO_ITEM
        , ia.GRUPO_ITEM
        )
      )
    )
  ) ITEM
FROM BASI_050 ia
LEFT JOIN BASI_050 ia2
  ON ia2.NIVEL_ITEM = ia.NIVEL_COMP
 AND ia2.GRUPO_ITEM = ia.GRUPO_COMP
LEFT JOIN BASI_050 ia3
  ON ia3.NIVEL_ITEM = ia2.NIVEL_COMP
 AND ia3.GRUPO_ITEM = ia2.GRUPO_COMP
LEFT JOIN BASI_050 ia4
  ON ia4.NIVEL_ITEM = ia3.NIVEL_COMP
 AND ia4.GRUPO_ITEM = ia3.GRUPO_COMP
LEFT JOIN BASI_050 ia5
  ON ia5.NIVEL_ITEM = ia4.NIVEL_COMP
 AND ia5.GRUPO_ITEM = ia4.GRUPO_COMP
WHERE 1=1
  AND ia.NIVEL_ITEM = 1
  AND (ia2.NIVEL_ITEM IS NULL OR ia2.NIVEL_ITEM = 1)
  AND (ia3.NIVEL_ITEM IS NULL OR ia3.NIVEL_ITEM = 1)
  AND (ia4.NIVEL_ITEM IS NULL OR ia4.NIVEL_ITEM = 1)
  AND (ia5.NIVEL_ITEM IS NULL OR ia5.NIVEL_ITEM = 1)
  AND ia.GRUPO_ITEM IN
      (
      '00001',
      '00002',
      '00003',
      '00004',
      '0001A',
      '0002A',
      '0003A',
      '0004A',
      '00103',
      '00104',
      '00156',
      '00204',
      '00223',
      '00254',
      '00256',
      '00257',
      '00258',
      '00259',
      '00260',
      '00261',
      '00262',
      '00263',
      '00266',
      '00268',
      '00269',
      '00270',
      '00271',
      '00272',
      '00304',
      '00455',
      '00456',
      '00458',
      '00460',
      '00466',
      '00467',
      '00493',
      '00613',
      '00617',
      '00618',
      '00619',
      '00620',
      '00706',
      '00707',
      '00708',
      '00717',
      '00809',
      '0103A',
      '0104A',
      '0156A',
      '0204A',
      '02156',
      '0223A',
      '0254A',
      '0256A',
      '0257A',
      '0258A',
      '0258U',
      '0259A',
      '0260A',
      '0261A',
      '0262A',
      '0262E',
      '0262U',
      '0263A',
      '0266A',
      '0268A',
      '0269A',
      '0270A',
      '0271A',
      '0272A',
      '0304A',
      '0455A',
      '0456A',
      '0458A',
      '0460A',
      '0466A',
      '0467A',
      '0493A',
      '05156',
      '06025',
      '06027',
      '0706A',
      '0707A',
      '0708A',
      '0717A',
      '103VO',
      '156VO',
      '2156O',
      '254VO',
      '256VO',
      '257VO',
      '258VO',
      '259VO',
      '260VO',
      '262VO',
      '263VO',
      '269VO',
      '455VO',
      '456VO',
      '458VO',
      '5321V',
      '617VO',
      '619VO',
      '620VO'
      )
 ORDER BY
   1
)
SELECT
  i.ITEM
FROM itens i
JOIN BASI_030 r
  ON r.NIVEL_ESTRUTURA = 1
 AND r.REFERENCIA = i.ITEM
WHERE r.RESPONSAVEL IS NULL
;

UPDATE BASI_030 r
SET
  r.RESPONSAVEL = 'AUTO'
WHERE r.RESPONSAVEL IS NULL
  AND r.NIVEL_ESTRUTURA = 1
  AND r.REFERENCIA IN
(
'M256A',
'0156A',
'M257A',
'0258A',
'0717A',
'0266A',
'156VO',
'M455A',
'0263A',
'0104A',
'0455A',
'M321V',
'260VO',
'M254A',
'263VO',
'0268A',
'256VO',
'0256A',
'0706A',
'0103A',
'0458A',
'0460A',
'0204A',
'M103A',
'M456A',
'0260A',
'M104A',
'M458A',
'458VO',
'0262A',
'257VO',
'0456A',
'262VO',
'R0304',
'0261A',
'0259A',
'269VO',
'456VO',
'0304A',
'5321V',
'455VO',
'M259A',
'M263A',
'M460A',
'259VO',
'103VO',
'0257A',
'0467A',
'0269A',
'258VO',
'M304A',
'254VO',
'0466A',
'M156A',
'0262U'
)
;

SELECT
  rop.*
FROM MQOP_050 rop
WHERE rop.NIVEL_ESTRUTURA = '1'
  AND rop.GRUPO_ESTRUTURA = 'Z01PA'
  AND rop.NUMERO_ROTEIRO = 1 -- IN (1, 11, 21, 2, 12, 22, 3, 13, 23)
;

SELECT
  i.CODIGO_BARRAS
, i.GRUPO_ESTRUTURA
, i.SUBGRU_ESTRUTURA
, i.ITEM_ESTRUTURA
FROM BASI_010 i
WHERE i.NIVEL_ESTRUTURA='1'
--  AND i.GRUPO_ESTRUTURA='0613L'
  AND i.GRUPO_ESTRUTURA LIKE '%613%'
;

UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846420' WHERE GRUPO_ESTRUTURA='0613L' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000PT';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846437' WHERE GRUPO_ESTRUTURA='0613L' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000PT';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846413' WHERE GRUPO_ESTRUTURA='0613L' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000PT';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846406' WHERE GRUPO_ESTRUTURA='0613L' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000PT';



SELECT
  nf.*
FROM fatu_050 nf
where nf.codigo_empresa  = 1
  and nf.num_nota_fiscal = 55288
  and nf.serie_nota_fisc = '1'
;

SELECT
  o.num_nota_orig
, o.serie_nota_orig
, o.motivo_devolucao
, o.*
FROM obrf_015 o
where o.capa_ent_nrdoc = 64107
  and   o.capa_ent_serie = '1'
;

update obrf_015 o
set o.num_nota_orig    = 55288,  --<<<<< nota devolvida
    o.serie_nota_orig  = '1',
    o.motivo_devolucao = 1
where o.capa_ent_nrdoc = 64107  --<<<<< nota de entrada nova
  and o.capa_ent_serie = '1'
;

select sum(o.rateio_despesas), sum(o.rateio_descontos_ipi), sum(o.desconto_item)
from obrf_015 o
where o.capa_ent_nrdoc = 64107
and   o.capa_ent_serie = '1'
;

update obrf_015 o
set o.rateio_descontos_ipi = abs(o.rateio_despesas)
where o.capa_ent_nrdoc = 64107
and   o.capa_ent_serie = '1'
;

SELECT
  COALESCE(
  ( SELECT
      MIN( le.CODIGO_ESTAGIO ) CODIGO_ESTAGIO
    FROM PCPC_040 le
    JOIN MQOP_005 ed
      ON ed.CODIGO_ESTAGIO = le.CODIGO_ESTAGIO
    WHERE le.PERIODO_PRODUCAO = l.PERIODO_PRODUCAO
      AND le.ORDEM_CONFECCAO = l.ORDEM_CONFECCAO
      AND le.QTDE_EM_PRODUCAO_PACOTE <> 0
  )
  , 9999
  ) EST_NUM
, l.ORDEM_PRODUCAO OP
, op.SITUACAO OP_SITUACAO
, CASE WHEN dos.NUMERO_ORDEM IS NULL
  THEN '0'
  ELSE l.NUMERO_ORDEM || ' (' || eos.DESCRICAO || ')'
  END OS
, l.PROCONF_GRUPO REF
, l.PROCONF_SUBGRUPO TAM
, t.ORDEM_TAMANHO
, l.PROCONF_ITEM COR
, COALESCE(
  ( SELECT
      LISTAGG(le.CODIGO_ESTAGIO || ' - ' || ed.DESCRICAO, ' & ')
      WITHIN GROUP (ORDER BY le.CODIGO_ESTAGIO)
    FROM PCPC_040 le
    JOIN MQOP_005 ed
      ON ed.CODIGO_ESTAGIO = le.CODIGO_ESTAGIO
    WHERE le.PERIODO_PRODUCAO = l.PERIODO_PRODUCAO
      AND le.ORDEM_CONFECCAO = l.ORDEM_CONFECCAO
      AND le.QTDE_EM_PRODUCAO_PACOTE <> 0
  )
  , 'FINALIZADO'
  ) EST
, l.PERIODO_PRODUCAO PERIODO
, l.ORDEM_CONFECCAO OC
, l.QTDE_PECAS_PROG QTD
, l.QTDE_PECAS_PROD PROD1Q
, l.QTDE_CONSERTO CONSERTO
, l.QTDE_PECAS_2A PROD2Q
, l.QTDE_PERDAS PERDA
, r.NARRATIVA
, ref.DESCR_REFERENCIA
, tam.DESCR_TAM_REFER DESCR_TAMANHO
, r.DESCRICAO_15 DESCR_COR
, ref.COLECAO
, CASE WHEN l.DIVISAO = 0 THEN dp.DIVISAO_PRODUCAO
  ELSE l.DIVISAO END DIVISAO
, CASE WHEN l.DIVISAO = 0 THEN dp.DESCRICAO
  ELSE di.DESCRICAO END DESCRICAO_DIVISAO
, op.DATA_ENTRADA_CORTE
, ( SELECT
    MIN( l1.ORDEM_CONFECCAO )
  FROM PCPC_040 l1
  WHERE l1.ORDEM_PRODUCAO   = l.ORDEM_PRODUCAO
    AND l1.PERIODO_PRODUCAO = l.PERIODO_PRODUCAO
    AND l1.PROCONF_GRUPO    = l.PROCONF_GRUPO
    AND l1.PROCONF_SUBGRUPO = l.PROCONF_SUBGRUPO
    AND l1.PROCONF_ITEM     = l.PROCONF_ITEM
) OC1
FROM (
  SELECT
    os.PERIODO_PRODUCAO
  , os.ORDEM_CONFECCAO
  , os.PROCONF_GRUPO
  , os.PROCONF_SUBGRUPO
  , os.PROCONF_ITEM
  , os.ORDEM_PRODUCAO
  , max( os.NUMERO_ORDEM ) NUMERO_ORDEM
  , max( os.QTDE_PECAS_PROG ) QTDE_PECAS_PROG
  , max( os.QTDE_PECAS_PROD ) QTDE_PECAS_PROD
  , max( os.QTDE_CONSERTO ) QTDE_CONSERTO
  , max( os.QTDE_PECAS_2A ) QTDE_PECAS_2A
  , max( os.QTDE_PERDAS ) QTDE_PERDAS
  , max( CASE WHEN os.CODIGO_FAMILIA < 1000
         THEN os.CODIGO_FAMILIA
         ELSE 0 END ) DIVISAO
  FROM PCPC_040 os
  WHERE os.ORDEM_PRODUCAO = 5614
  GROUP BY
    os.PERIODO_PRODUCAO
  , os.ORDEM_CONFECCAO
  , os.PROCONF_GRUPO
  , os.PROCONF_SUBGRUPO
  , os.PROCONF_ITEM
  , os.ORDEM_PRODUCAO
) l
LEFT JOIN PCPC_040 dos
  ON l.NUMERO_ORDEM <> 0
 AND dos.PERIODO_PRODUCAO = l.PERIODO_PRODUCAO
 AND dos.ORDEM_CONFECCAO = l.ORDEM_CONFECCAO
 AND dos.NUMERO_ORDEM = l.NUMERO_ORDEM
LEFT JOIN MQOP_005 eos
  ON eos.CODIGO_ESTAGIO = dos.CODIGO_ESTAGIO
LEFT JOIN BASI_220 t
  ON t.TAMANHO_REF = l.PROCONF_SUBGRUPO
JOIN BASI_030 ref
  ON ref.NIVEL_ESTRUTURA = 1
 AND ref.REFERENCIA = l.PROCONF_GRUPO
JOIN BASI_020 tam
  ON tam.BASI030_NIVEL030 = 1
 AND tam.BASI030tussor  Systêxtil geral EAN_REFERENC = l.PROCONF_GRUPO
 AND tam.TAMANHO_REF = l.PROCONF_SUBGRUPO
JOIN BASI_010 r
  ON r.NIVEL_ESTRUTURA = 1
 AND r.GRUPO_ESTRUTURA = l.PROCONF_GRUPO
 AND r.SUBGRU_ESTRUTURA = l.PROCONF_SUBGRUPO
 AND r.ITEM_ESTRUTURA = l.PROCONF_ITEM
LEFT JOIN BASI_180 di -- divisao de producao - unidade
  ON di.DIVISAO_PRODUCAO = l.DIVISAO
LEFT JOIN OBRF_080 osc -- OS capa
  ON l.NUMERO_ORDEM <> 0
 AND osc.NUMERO_ORDEM = l.NUMERO_ORDEM
LEFT JOIN BASI_180 dp -- divisao de producao - unidade
  ON dp.FACCIONISTA9 = osc.CGCTERC_FORNE9
 AND dp.FACCIONISTA4 = osc.CGCTERC_FORNE4
 AND dp.FACCIONISTA2 = osc.CGCTERC_FORNE2
JOIN PCPC_020 op -- OP capa
  ON op.ordem_producao = l.ORDEM_PRODUCAO
ORDER BY
  1
, l.ORDEM_PRODUCAO
, l.NUMERO_ORDEM
, l.PROCONF_GRUPO
, l.PROCONF_ITEM
, t.ORDEM_TAMANHO
, l.PERIODO_PRODUCAO
, l.ORDEM_CONFECCAO
;

SELECT
  i.CODIGO_BARRAS
, i.GRUPO_ESTRUTURA
, i.SUBGRU_ESTRUTURA
, i.ITEM_ESTRUTURA
FROM BASI_010 i
WHERE i.NIVEL_ESTRUTURA='1'
  AND i.GRUPO_ESTRUTURA='05331'
--  AND i.GRUPO_ESTRUTURA LIKE '%613%'
;

SELECT
  ii.CODIGO_BARRAS
, ii.*
FROM BASI_010 ii
WHERE ii.NIVEL_ESTRUTURA=1
  AND ii.GRUPO_ESTRUTURA = '5331G'
--  AND ii.GRUPO_ESTRUTURA = '05331'
--  AND ii.CODIGO_BARRAS IS NOT NULL
ORDER BY
  ii.GRUPO_ESTRUTURA
, ii.SUBGRU_ESTRUTURA
, ii.ITEM_ESTRUTURA
;

UPDATE BASI_010 i
SET i.CODIGO_BARRAS =
  ( SELECT ii.CODIGO_BARRAS
    FROM BASI_010 ii
    WHERE ii.NIVEL_ESTRUTURA=i.NIVEL_ESTRUTURA
      AND ii.GRUPO_ESTRUTURA='05331'
      AND ii.SUBGRU_ESTRUTURA=i.SUBGRU_ESTRUTURA
      AND ii.ITEM_ESTRUTURA=i.ITEM_ESTRUTURA
  )
WHERE i.NIVEL_ESTRUTURA='1'
  AND i.GRUPO_ESTRUTURA='5331G'
  AND i.ITEM_ESTRUTURA='0000CB'
;

SELECT
--  ia.ESTAGIO
  ia.*
--  count(*)
FROM BASI_050 ia
WHERE ia.ALTERNATIVA_ITEM IN (01, 11, 21, 04, 14, 24)
  AND ia.NIVEL_COMP <> 1
  AND (  ia.GRUPO_COMP LIKE 'EL%'
      OR ia.GRUPO_COMP LIKE 'EP%'
      )
  AND ia.ESTAGIO <> 18
;

UPDATE BASI_050 ia
SET
  ia.ESTAGIO = 18
WHERE ia.ALTERNATIVA_ITEM IN (01, 11, 21, 04, 14, 24)
  AND ia.NIVEL_COMP <> 1
  AND (  ia.GRUPO_COMP LIKE 'EL%'
      OR ia.GRUPO_COMP LIKE 'EP%'
      )
  AND ia.ESTAGIO <> 18
;

SELECT
  ii.CODIGO_BARRAS
, ii.*
FROM BASI_010 ii
WHERE ii.NIVEL_ESTRUTURA=1
  AND ii.GRUPO_ESTRUTURA = '0002A'
  AND ii.SUBGRU_ESTRUTURA = 'P'
  AND ii.ITEM_ESTRUTURA = '0000VI'
--  AND ii.GRUPO_ESTRUTURA = '05331'
--  AND ii.CODIGO_BARRAS IS NOT NULL
ORDER BY
  ii.GRUPO_ESTRUTURA
, ii.SUBGRU_ESTRUTURA
, ii.ITEM_ESTRUTURA
;

SELECT
  le.ORDEM_PRODUCAO OP
, le.PERIODO_PRODUCAO PERIODO
, le.SEQUENCIA_ESTAGIO SEQ
, le.CODIGO_ESTAGIO EST
, le.ORDEM_CONFECCAO OC
, le.QTDE_EM_PRODUCAO_PACOTE QTD
FROM PCPC_040 le -- lote estágio atual
WHERE le.QTDE_EM_PRODUCAO_PACOTE <> 0
  AND le.ORDEM_PRODUCAO = 3596
  AND le.ORDEM_CONFECCAO IN (3173, 3229, 3104)
ORDER BY
  le.ORDEM_PRODUCAO
, le.SEQUENCIA_ESTAGIO
, le.CODIGO_ESTAGIO
, le.ORDEM_CONFECCAO
;

SELECT
  CASE WHEN i.SEQ = 0 THEN 99
  ELSE i.SEQ END SEQ
, i.REF
, i.TAM
, i.COR
, i.OC
, i.OP
, i.PERIODO
, i.EST
, i.QTD
FROM (
  SELECT
    e.OC
  , e.OP
  , e.PERIODO
  , e.REF
  , e.TAM
  , e.COR
  , MAX(e.SEQ) SEQ
  , MAX(e.EST) EST
  , MAX(e.QTD) QTD
  FROM (
    SELECT
      le.SEQUENCIA_ESTAGIO SEQ
    , le.ORDEM_CONFECCAO OC
    , le.ORDEM_PRODUCAO OP
    , le.PERIODO_PRODUCAO PERIODO
    , le.PROCONF_GRUPO REF
    , le.PROCONF_SUBGRUPO TAM
    , le.PROCONF_ITEM COR
    , le.CODIGO_ESTAGIO EST
    , le.QTDE_EM_PRODUCAO_PACOTE QTD
    FROM PCPC_040 le -- lote estágio atual
    WHERE le.QTDE_EM_PRODUCAO_PACOTE <> 0
      AND le.ORDEM_PRODUCAO = 524
      AND le.ORDEM_CONFECCAO IN (
      3408, 3481
      )
    UNION
    SELECT DISTINCT
      0 SEQ
    , le.ORDEM_CONFECCAO OC
    , le.ORDEM_PRODUCAO OP
    , le.PERIODO_PRODUCAO PERIODO
    , le.PROCONF_GRUPO REF
    , le.PROCONF_SUBGRUPO TAM
    , le.PROCONF_ITEM COR
    , 0 EST
    , le.QTDE_PECAS_PROD QTD
    FROM PCPC_040 le -- lote estágio atual
    WHERE le.QTDE_EM_PRODUCAO_PACOTE = 0
      AND le.ORDEM_PRODUCAO = 524
      AND le.ORDEM_CONFECCAO IN (
      3408, 3481
      )
  ) e
  GROUP BY
    e.OC
  , e.OP
  , e.PERIODO
  , e.REF
  , e.TAM
  , e.COR
) i
WHERE i.EST <> 63
ORDER BY
  1
, i.REF
, i.TAM
, i.COR
, i.OC
;

UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846758' WHERE GRUPO_ESTRUTURA='0613U' and SUBGRU_ESTRUTURA='EG' and ITEM_ESTRUTURA='0000MC';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846734' WHERE GRUPO_ESTRUTURA='0613U' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000MC';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846741' WHERE GRUPO_ESTRUTURA='0613U' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000MC';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846727' WHERE GRUPO_ESTRUTURA='0613U' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000MC';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846710' WHERE GRUPO_ESTRUTURA='0613U' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000MC';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846703' WHERE GRUPO_ESTRUTURA='0613U' and SUBGRU_ESTRUTURA='EG' and ITEM_ESTRUTURA='0000PT';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846680' WHERE GRUPO_ESTRUTURA='0613U' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000PT';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846697' WHERE GRUPO_ESTRUTURA='0613U' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000PT';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846673' WHERE GRUPO_ESTRUTURA='0613U' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000PT';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846666' WHERE GRUPO_ESTRUTURA='0613U' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000PT';

UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847502' WHERE GRUPO_ESTRUTURA='0270A' and SUBGRU_ESTRUTURA='EG' and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847489' WHERE GRUPO_ESTRUTURA='0270A' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847496' WHERE GRUPO_ESTRUTURA='0270A' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847472' WHERE GRUPO_ESTRUTURA='0270A' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847465' WHERE GRUPO_ESTRUTURA='0270A' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847557' WHERE GRUPO_ESTRUTURA='0270A' and SUBGRU_ESTRUTURA='EG' and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847533' WHERE GRUPO_ESTRUTURA='0270A' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847540' WHERE GRUPO_ESTRUTURA='0270A' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847526' WHERE GRUPO_ESTRUTURA='0270A' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847519' WHERE GRUPO_ESTRUTURA='0270A' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846819' WHERE GRUPO_ESTRUTURA='0001A' and SUBGRU_ESTRUTURA='EG' and ITEM_ESTRUTURA='0000AZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846796' WHERE GRUPO_ESTRUTURA='0001A' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000AZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846802' WHERE GRUPO_ESTRUTURA='0001A' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000AZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846789' WHERE GRUPO_ESTRUTURA='0001A' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000AZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846772' WHERE GRUPO_ESTRUTURA='0001A' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000AZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846864' WHERE GRUPO_ESTRUTURA='0001A' and SUBGRU_ESTRUTURA='EG' and ITEM_ESTRUTURA='0000CZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846840' WHERE GRUPO_ESTRUTURA='0001A' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000CZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846857' WHERE GRUPO_ESTRUTURA='0001A' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000CZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846833' WHERE GRUPO_ESTRUTURA='0001A' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000CZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846826' WHERE GRUPO_ESTRUTURA='0001A' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000CZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846918' WHERE GRUPO_ESTRUTURA='0001A' and SUBGRU_ESTRUTURA='EG' and ITEM_ESTRUTURA='0000VI';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846895' WHERE GRUPO_ESTRUTURA='0001A' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000VI';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846901' WHERE GRUPO_ESTRUTURA='0001A' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000VI';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846888' WHERE GRUPO_ESTRUTURA='0001A' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000VI';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846871' WHERE GRUPO_ESTRUTURA='0001A' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000VI';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847021' WHERE GRUPO_ESTRUTURA='0002A' and SUBGRU_ESTRUTURA='EG' and ITEM_ESTRUTURA='0000AZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847007' WHERE GRUPO_ESTRUTURA='0002A' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000AZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847014' WHERE GRUPO_ESTRUTURA='0002A' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000AZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846994' WHERE GRUPO_ESTRUTURA='0002A' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000AZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846987' WHERE GRUPO_ESTRUTURA='0002A' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000AZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846970' WHERE GRUPO_ESTRUTURA='0002A' and SUBGRU_ESTRUTURA='EG' and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846956' WHERE GRUPO_ESTRUTURA='0002A' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846963' WHERE GRUPO_ESTRUTURA='0002A' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846949' WHERE GRUPO_ESTRUTURA='0002A' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846932' WHERE GRUPO_ESTRUTURA='0002A' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847076' WHERE GRUPO_ESTRUTURA='0002A' and SUBGRU_ESTRUTURA='EG' and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847052' WHERE GRUPO_ESTRUTURA='0002A' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847069' WHERE GRUPO_ESTRUTURA='0002A' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847045' WHERE GRUPO_ESTRUTURA='0002A' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847038' WHERE GRUPO_ESTRUTURA='0002A' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847120' WHERE GRUPO_ESTRUTURA='0002A' and SUBGRU_ESTRUTURA='EG' and ITEM_ESTRUTURA='0000VI';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847106' WHERE GRUPO_ESTRUTURA='0002A' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000VI';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847113' WHERE GRUPO_ESTRUTURA='0002A' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000VI';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847090' WHERE GRUPO_ESTRUTURA='0002A' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000VI';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847083' WHERE GRUPO_ESTRUTURA='0002A' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000VI';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847236' WHERE GRUPO_ESTRUTURA='0003A' and SUBGRU_ESTRUTURA='EG' and ITEM_ESTRUTURA='0000AZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847212' WHERE GRUPO_ESTRUTURA='0003A' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000AZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847229' WHERE GRUPO_ESTRUTURA='0003A' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000AZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847205' WHERE GRUPO_ESTRUTURA='0003A' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000AZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847199' WHERE GRUPO_ESTRUTURA='0003A' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000AZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847182' WHERE GRUPO_ESTRUTURA='0003A' and SUBGRU_ESTRUTURA='EG' and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847168' WHERE GRUPO_ESTRUTURA='0003A' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847175' WHERE GRUPO_ESTRUTURA='0003A' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847151' WHERE GRUPO_ESTRUTURA='0003A' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847144' WHERE GRUPO_ESTRUTURA='0003A' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847281' WHERE GRUPO_ESTRUTURA='0003A' and SUBGRU_ESTRUTURA='EG' and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847267' WHERE GRUPO_ESTRUTURA='0003A' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847274' WHERE GRUPO_ESTRUTURA='0003A' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847250' WHERE GRUPO_ESTRUTURA='0003A' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847243' WHERE GRUPO_ESTRUTURA='0003A' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847342' WHERE GRUPO_ESTRUTURA='0004A' and SUBGRU_ESTRUTURA='EG' and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847328' WHERE GRUPO_ESTRUTURA='0004A' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847335' WHERE GRUPO_ESTRUTURA='0004A' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847311' WHERE GRUPO_ESTRUTURA='0004A' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847304' WHERE GRUPO_ESTRUTURA='0004A' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847397' WHERE GRUPO_ESTRUTURA='0004A' and SUBGRU_ESTRUTURA='EG' and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847373' WHERE GRUPO_ESTRUTURA='0004A' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847380' WHERE GRUPO_ESTRUTURA='0004A' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847366' WHERE GRUPO_ESTRUTURA='0004A' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847359' WHERE GRUPO_ESTRUTURA='0004A' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847441' WHERE GRUPO_ESTRUTURA='0004A' and SUBGRU_ESTRUTURA='EG' and ITEM_ESTRUTURA='0000VI';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847427' WHERE GRUPO_ESTRUTURA='0004A' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000VI';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847434' WHERE GRUPO_ESTRUTURA='0004A' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000VI';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847410' WHERE GRUPO_ESTRUTURA='0004A' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000VI';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847403' WHERE GRUPO_ESTRUTURA='0004A' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000VI';



UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847601' WHERE GRUPO_ESTRUTURA='0270A' and SUBGRU_ESTRUTURA='EG' and ITEM_ESTRUTURA='0000MA';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847588' WHERE GRUPO_ESTRUTURA='0270A' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000MA';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847595' WHERE GRUPO_ESTRUTURA='0270A' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000MA';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847571' WHERE GRUPO_ESTRUTURA='0270A' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000MA';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847564' WHERE GRUPO_ESTRUTURA='0270A' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000MA';

SELECT
  ed.CDITEM_GRUPO
, ed.CDITEM_SUBGRUPO
, ed.CDITEM_ITEM
, ed.QTDE_ESTOQUE_ATU
, ed.*
FROM ESTQ_040 ed
WHERE ed.DEPOSITO = 0
;

SELECT
  i.CODIGO_BARRAS
, i.GRUPO_ESTRUTURA
, i.SUBGRU_ESTRUTURA
, i.ITEM_ESTRUTURA
FROM BASI_010 i
WHERE i.NIVEL_ESTRUTURA='1'
--  AND i.GRUPO_ESTRUTURA='0613L'
  AND i.GRUPO_ESTRUTURA LIKE '%605%'
;

UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7896896242135' WHERE GRUPO_ESTRUTURA='0606O' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7896896242142' WHERE GRUPO_ESTRUTURA='0606O' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7896896242128' WHERE GRUPO_ESTRUTURA='0606O' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7896896242111' WHERE GRUPO_ESTRUTURA='0606O' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000BR';

UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846611' WHERE GRUPO_ESTRUTURA='0605O' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000MA';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846628' WHERE GRUPO_ESTRUTURA='0605O' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000MA';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846635' WHERE GRUPO_ESTRUTURA='0605O' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000MA';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618846642' WHERE GRUPO_ESTRUTURA='0605O' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000MA';

SELECT
--  e.*
  count(*)
FROM ESTQ_040 e -- estoque atual
;

WITH lotes AS
(
  SELECT DISTINCT
    le.ORDEM_PRODUCAO
  , le.ORDEM_CONFECCAO
  , le.QTDE_PECAS_PROG
  FROM PCPC_040 le -- lote estágio
  JOIN PCPC_020 op -- OP capa
    ON op.ordem_producao = le.ORDEM_PRODUCAO
  WHERE op.COD_CANCELAMENTO = 0
    AND le.QTDE_PECAS_PROG IS NOT NULL
    AND le.QTDE_PECAS_PROG <> 0
AND op.ORDEM_PRODUCAO = 5990
  ORDER BY
    le.ORDEM_PRODUCAO
  , le.ORDEM_CONFECCAO
)
--SELECT
--  max(op)
--, max(prog)
--FROM (
  SELECT
    lo.ORDEM_PRODUCAO op
  , sum(lo.QTDE_PECAS_PROG*(1+mod(lo.ORDEM_CONFECCAO, 10))) prog
  FROM lotes lo
  GROUP BY
    lo.ORDEM_PRODUCAO
  ORDER BY
    1
--)
;

SELECT DISTINCT
  le.ORDEM_PRODUCAO
, le.QTDE_PECAS_PROG
, le.*
FROM PCPC_040 le -- lote estágio
WHERE 1=1
--  AND le.PERIODO_PRODUCAO = 1810
--  AND le.ORDEM_CONFECCAO = 21
--  AND le.QTDE_EM_PRODUCAO_PACOTE <> 0
  AND le.QTDE_PERDAS <> 0
ORDER BY
  le.ORDEM_PRODUCAO DESC
;



SELECT
  lote.ORDEM_CONFECCAO OP
, lote.QTDE_PECAS_PROG PROG
, CASE WHEN l.ORDEM_CONFECCAO IS NULL THEN 999
  ELSE l.CODIGO_ESTAGIO END EST
, CASE WHEN l.ORDEM_CONFECCAO IS NULL THEN lf.QTDE_PECAS_PROD
  ELSE l.QTDE_EM_PRODUCAO_PACOTE END QTD
FROM
(
  SELECT
    le.ORDEM_PRODUCAO
  , le.ORDEM_CONFECCAO
  , le.QTDE_PECAS_PROG
  , max(le.SEQUENCIA_ESTAGIO) ULTIMO_ESTAGIO
  FROM PCPC_040 le -- lote estágio
  JOIN PCPC_020 op -- OP capa
    ON op.ordem_producao = le.ORDEM_PRODUCAO
  WHERE op.COD_CANCELAMENTO = 0
    AND le.QTDE_PECAS_PROG IS NOT NULL
    AND le.QTDE_PECAS_PROG <> 0
    AND op.ORDEM_PRODUCAO = 5990
  GROUP BY
    le.ORDEM_PRODUCAO
  , le.ORDEM_CONFECCAO
  , le.QTDE_PECAS_PROG
) lote
LEFT JOIN PCPC_040 l -- lote estágio
  ON l.ORDEM_PRODUCAO = lote.ORDEM_PRODUCAO
 AND l.ORDEM_CONFECCAO = lote.ORDEM_CONFECCAO
 AND l.QTDE_EM_PRODUCAO_PACOTE <> 0
LEFT JOIN PCPC_040 lf -- lote estágio
  ON l.ORDEM_CONFECCAO IS NULL
 AND lf.ORDEM_PRODUCAO = lote.ORDEM_PRODUCAO
 AND lf.ORDEM_CONFECCAO = lote.ORDEM_CONFECCAO
 AND lf.SEQUENCIA_ESTAGIO = lote.ULTIMO_ESTAGIO
ORDER BY
  lote.ORDEM_CONFECCAO
;


SELECT
--  max(op)
--, max(oc)
--, max(trail)
  *
FROM (
SELECT
  lo.ORDEM_PRODUCAO op
, lo.ORDEM_CONFECCAO oc
, sum(
    ( 1
    + lo.QTDE_PECAS_PROG
    + lo.QTDE_EM_PRODUCAO_PACOTE
    + lo.QTDE_PECAS_PROD
    )
  * (1 + lo.CODIGO_ESTAGIO)
  * (1 + mod(lo.ORDEM_CONFECCAO, 111))
  ) trail
FROM PCPC_040 lo -- lote estágio
JOIN PCPC_020 op -- OP capa
  ON op.ordem_producao = lo.ORDEM_PRODUCAO
WHERE op.COD_CANCELAMENTO = 0
GROUP BY
  lo.ORDEM_PRODUCAO
, lo.ORDEM_CONFECCAO
ORDER BY
  lo.ORDEM_PRODUCAO
, lo.ORDEM_CONFECCAO
)
--WHERE trail = 9370620
;

SELECT
  lote.OP
, lote.PERIODO
, lote.OC
, lote.REF
, lote.TAM
, lote.ORD_TAM
, lote.COR
, lote.QTD_PRODUZIR
--, lote.ULTIMO_ESTAGIO
, lote.TRAIL
, CASE WHEN l.ORDEM_CONFECCAO IS NULL THEN 999
  ELSE l.CODIGO_ESTAGIO END ESTAGIO
, CASE WHEN l.ORDEM_CONFECCAO IS NULL THEN lf.QTDE_PECAS_PROD
  ELSE l.QTDE_EM_PRODUCAO_PACOTE END QTD
FROM
(
  SELECT
    le.ORDEM_PRODUCAO OP
  , le.PERIODO_PRODUCAO PERIODO
  , le.ORDEM_CONFECCAO OC
  , le.PROCONF_GRUPO REF
  , le.PROCONF_SUBGRUPO TAM
  , t.ORDEM_TAMANHO ORD_TAM
  , le.PROCONF_ITEM COR
  , le.QTDE_PECAS_PROG QTD_PRODUZIR
  , max(le.CODIGO_ESTAGIO) ULTIMO_ESTAGIO
  , max(le.SEQUENCIA_ESTAGIO) ULTIMA_SEQ_ESTAGIO
  , sum(
      ( 1
      + le.QTDE_PECAS_PROG
      + le.QTDE_EM_PRODUCAO_PACOTE
      + le.QTDE_PECAS_PROD
      )
    * (1 + le.CODIGO_ESTAGIO)
    * (1 + mod(le.ORDEM_CONFECCAO, 111))
    ) trail
  FROM PCPC_040 le -- lote estágio
  LEFT JOIN BASI_220 t
    ON t.TAMANHO_REF = le.PROCONF_SUBGRUPO
  WHERE le.ORDEM_PRODUCAO = 1637 -- 5990 -- 5315 -- 13
--    AND le.ORDEM_CONFECCAO = 2746
--    AND le.QTDE_PECAS_PROG IS NOT NULL
--    AND le.QTDE_PECAS_PROG <> 0
  GROUP BY
    le.ORDEM_PRODUCAO
  , le.PERIODO_PRODUCAO
  , le.ORDEM_CONFECCAO
  , le.PROCONF_GRUPO
  , le.PROCONF_SUBGRUPO
  , t.ORDEM_TAMANHO
  , le.PROCONF_ITEM
  , le.QTDE_PECAS_PROG
  ORDER BY
    le.ORDEM_PRODUCAO
  , le.ORDEM_CONFECCAO
  ) lote
LEFT JOIN PCPC_040 l -- lote estágio
  ON l.ORDEM_PRODUCAO = lote.OP
 AND l.ORDEM_CONFECCAO = lote.OC
 AND l.QTDE_EM_PRODUCAO_PACOTE <> 0
LEFT JOIN PCPC_040 lf -- lote está5990gio
  ON l.ORDEM_CONFECCAO IS NULL
 AND lf.ORDEM_PRODUCAO = lote.OP
 AND lf.ORDEM_CONFECCAO = lote.OC
 AND (  (lote.ULTIMA_SEQ_ESTAGIO = 0 AND lf.CODIGO_ESTAGIO = lote.ULTIMO_ESTAGIO)
     OR (lote.ULTIMA_SEQ_ESTAGIO <> 0 AND lf.SEQUENCIA_ESTAGIO = lote.ULTIMA_SEQ_ESTAGIO)
     )
;

SELECT
  le.*
FROM PCPC_040 le -- lote estágio
WHERE le.PERIODO_PRODUCAO = 1737
  AND le.ORDEM_CONFECCAO = 2746
;

WITH lotes AS
(
  SELECT DISTINCT
    le.ORDEM_PRODUCAO
  , le.ORDEM_CONFECCAO
  , COALESCE(le.QTDE_PECAS_PROG, 0) QTDE_PECAS_PROG
  FROM PCPC_040 le -- lote estágio
  JOIN PCPC_020 op -- OP capa
    ON op.ordem_producao = le.ORDEM_PRODUCAO
  WHERE op.COD_CANCELAMENTO = 0
    AND op.ORDEM_PRODUCAO = 4535
  ORDER BY
    le.ORDEM_PRODUCAO
  , le.ORDEM_CONFECCAO
)
SELECT
  lo.ORDEM_PRODUCAO op
, sum(lo.QTDE_PECAS_PROG*(1+mod(lo.ORDEM_CONFECCAO, 10))) prog
FROM lotes lo
GROUP BY
  lo.ORDEM_PRODUCAO
ORDER BY
  1
;

WITH lotes AS
(
  SELECT DISTINCT
    le.ORDEM_PRODUCAO
  , le.ORDEM_CONFECCAO
  , le.QTDE_PECAS_PROG
  FROM PCPC_040 le -- lote estágio
  JOIN PCPC_020 op -- OP capa
    ON op.ordem_producao = le.ORDEM_PRODUCAO
  WHERE op.COD_CANCELAMENTO = 0
    AND op.ORDEM_PRODUCAO = 5829
  ORDER BY
    le.ORDEM_PRODUCAO
  , le.ORDEM_CONFECCAO
)
SELECT
  lo.*
FROM lotes lo
;

SELECT DISTINCT
  le.*
FROM PCPC_040 le -- lote estágio
WHERE le.ORDEM_PRODUCAO = 4535
ORDER BY
  le.ORDEM_CONFECCAO
;

SELECT
  le.*
FROM PCPC_040 le -- lote estágio
WHERE le.QTDE_PECAS_PROG IS NULL
;

SELECT DISTINCT
  le.ORDEM_PRODUCAO OP
, le.PERIODO_PRODUCAO PERIODO
, le.ORDEM_CONFECCAO OC
, le.PROCONF_GRUPO REF
, le.PROCONF_SUBGRUPO TAM
, t.ORDEM_TAMANHO ORD_TAM
, le.PROCONF_ITEM COR
, le.QTDE_PECAS_PROG QUANT
FROM PCPC_040 le -- lote estágio
LEFT JOIN BASI_220 t
  ON t.TAMANHO_REF = le.PROCONF_SUBGRUPO
WHERE le.ORDEM_PRODUCAO = 5829
--  AND le.QTDE_PECAS_PROG IS NOT NULL
--  AND le.QTDE_PECAS_PROG <> 0
ORDER BY
  le.ORDEM_PRODUCAO
, le.ORDEM_CONFECCAO
;

SELECT
  le.*
FROM PCPC_040 le -- lote estágio atual
JOIN PCPC_020 op -- OP capa
  ON op.ordem_producao = le.ORDEM_PRODUCAO
WHERE op.COD_CANCELAMENTO = 0
  AND le.ORDEM_PRODUCAO = 5120
  AND le.ORDEM_CONFECCAO in (3349, 3350, 3238)
  AND le.QTDE_EM_PRODUCAO_PACOTE <> 0
ORDER BY
  le.ORDEM_CONFECCAO
;

SELECT
  op.ORDEM_PRODUCAO OP
, le.SEQUENCIA_ESTAGIO SEQ
, le.CODIGO_ESTAGIO EST
, le63.SEQUENCIA_ESTAGIO SEQ63
, sum(le.QTDE_EM_PRODUCAO_PACOTE) QTD
FROM PCPC_040 le -- lote estágio atual
JOIN PCPC_020 op -- OP capa
  ON op.ordem_producao = le.ORDEM_PRODUCAO
LEFT JOIN PCPC_040 le63 -- lote estágio 63
  ON le63.PERIODO_PRODUCAO = le.PERIODO_PRODUCAO
 AND le63.ORDEM_CONFECCAO = le.ORDEM_CONFECCAO
 AND le63.CODIGO_ESTAGIO = 63
WHERE op.COD_CANCELAMENTO = 0
  AND
    (  ( op.ORDEM_PRODUCAO = 5166 AND le.ORDEM_CONFECCAO in (980, 981, 919, 937) )
    OR ( op.ORDEM_PRODUCAO = 5120 AND le.ORDEM_CONFECCAO in (3349, 3350, 3238) )
    )
  AND le.QTDE_EM_PRODUCAO_PACOTE <> 0
GROUP BY
  op.ORDEM_PRODUCAO
, le.SEQUENCIA_ESTAGIO
, le.CODIGO_ESTAGIO
, le63.SEQUENCIA_ESTAGIO
ORDER BY
  op.ORDEM_PRODUCAO
, le.SEQUENCIA_ESTAGIO
;


SELECT
  le.ORDEM_PRODUCAO OP
, le.ORDEM_CONFECCAO OC
, le.SEQUENCIA_ESTAGIO SEQ
, le.CODIGO_ESTAGIO EST
, le.QTDE_A_PRODUZIR_PACOTE
, le.QTDE_CONSERTO
, le.QTDE_CONSERTO_RECALC
, le.QTDE_DISPONIVEL_BAIXA
, le.QTDE_EM_PRODUCAO_PACOTE
, le.QTDE_PECAS_2A
, le.QTDE_PECAS_2A_RECALC
, le.QTDE_PECAS_PROD
, le.QTDE_PECAS_PROD_RECALC
, le.QTDE_PECAS_PROG
, le.QTDE_PERDAS
FROM PCPC_040 le -- lote estágio atual
WHERE (( le.ORDEM_PRODUCAO = 21 AND le.ORDEM_CONFECCAO in (1299,1301) ) OR ( le.ORDEM_PRODUCAO = 38 AND le.ORDEM_CONFECCAO in (1804,1805,1806) ))
ORDER BY
  le.ORDEM_PRODUCAO
, le.ORDEM_CONFECCAO
, le.SEQUENCIA_ESTAGIO
;

SELECT
  op.ORDEM_PRODUCAO OP
, le.SEQUENCIA_ESTAGIO SEQ
, le.CODIGO_ESTAGIO EST
, le63.SEQUENCIA_ESTAGIO SEQ63
, sum(le.QTDE_EM_PRODUCAO_PACOTE) QTD
FROM PCPC_020 op -- OP capa
LEFT JOIN PCPC_040 le63 -- lote estágio 63
  ON le63.ordem_producao = op.ORDEM_PRODUCAO
 AND le63.CODIGO_ESTAGIO = 63
LEFT JOIN PCPC_040 le -- lote estágio atual
  ON le.ordem_producao = op.ORDEM_PRODUCAO
 AND le.PERIODO_PRODUCAO = le63.PERIODO_PRODUCAO
 AND le.ORDEM_CONFECCAO = le63.ORDEM_CONFECCAO
 AND le.QTDE_EM_PRODUCAO_PACOTE <> 0
WHERE op.COD_CANCELAMENTO = 0
  AND
    (  ( op.ORDEM_PRODUCAO = 5166 AND le63.ORDEM_CONFECCAO in (980, 981, 919, 937) )
    OR ( op.ORDEM_PRODUCAO = 5120 AND le63.ORDEM_CONFECCAO in (3349, 3350, 3238) )
    )
--  AND (( op.ORDEM_PRODUCAO = 21 AND le63.ORDEM_CONFECCAO in (1299,1301) ) OR ( op.ORDEM_PRODUCAO = 38 AND le63.ORDEM_CONFECCAO in (1804,1805,1806) ))
GROUP BY
  op.ORDEM_PRODUCAO
, le.SEQUENCIA_ESTAGIO
, le.CODIGO_ESTAGIO
, le63.SEQUENCIA_ESTAGIO
ORDER BY
  op.ORDEM_PRODUCAO
, le.SEQUENCIA_ESTAGIO
;

SELECT
  e.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO ESTAGIO
, CASE WHEN u.USUARIO IS NULL
  THEN '--SEM RESPONSAVEL--'
  ELSE u.USUARIO || ' ( ' || u.CODIGO_USUARIO || ' )'
  END USUARIO
, CASE WHEN rbel.TIPO_MOVIMENTO IS NOT NULL OR rbl.TIPO_MOVIMENTO IS NOT NULL THEN 'X'
  ELSE ' ' END BL
, CASE WHEN rbel.TIPO_MOVIMENTO IS NOT NULL OR rel.TIPO_MOVIMENTO IS NOT NULL THEN 'X'
  ELSE ' ' END EL
, CASE WHEN rco.TIPO_MOVIMENTO IS NOT NULL THEN 'X'
  ELSE ' ' END CO
FROM MQOP_005 e
LEFT JOIN MQOP_006 rbel
  ON rbel.CODIGO_ESTAGIO = e.CODIGO_ESTAGIO
 AND rbel.TIPO_MOVIMENTO = 0
LEFT JOIN MQOP_006 rbl
  ON rbl.CODIGO_ESTAGIO = e.CODIGO_ESTAGIO
 AND rbl.TIPO_MOVIMENTO = 1
LEFT JOIN MQOP_006 rel
  ON rel.CODIGO_ESTAGIO = e.CODIGO_ESTAGIO
 AND rel.TIPO_MOVIMENTO = 2
LEFT JOIN MQOP_006 rco
  ON rco.CODIGO_ESTAGIO = e.CODIGO_ESTAGIO
 AND rco.TIPO_MOVIMENTO = 3
LEFT JOIN HDOC_030 ubel
  ON ubel.CODIGO_USUARIO = rbel.CODIGO_USUARIO
LEFT JOIN HDOC_030 ubl
  ON ubl.CODIGO_USUARIO = rbl.CODIGO_USUARIO
LEFT JOIN HDOC_030 uel
  ON uel.CODIGO_USUARIO = rel.CODIGO_USUARIO
LEFT JOIN HDOC_030 uco
  ON uco.CODIGO_USUARIO = rco.CODIGO_USUARIO
LEFT JOIN HDOC_030 u
  ON u.CODIGO_USUARIO IN (ubel.CODIGO_USUARIO, ubl.CODIGO_USUARIO, uel.CODIGO_USUARIO, uco.CODIGO_USUARIO)
WHERE e.CODIGO_ESTAGIO <> 0
  AND u.USUARIO = 'FELIPE_IND'
; -- não funciona


SELECT
  s.CODIGO_ESTAGIO
, s.USUARIO
, s.CODIGO_USUARIO
, CASE WHEN rbel.TIPO_MOVIMENTO IS NOT NULL THEN 'X'
  ELSE ' ' END BL
FROM (
  SELECT
    e.CODIGO_ESTAGIO
  , u.USUARIO
  , u.CODIGO_USUARIO
  FROM MQOP_005 e, HDOC_030 u
  WHERE e.CODIGO_ESTAGIO <> 0
    AND u.USUARIO = 'FELIPE_IND'
) s
LEFT JOIN MQOP_006 rbel
  ON rbel.CODIGO_ESTAGIO = s.CODIGO_ESTAGIO
 AND rbel.CODIGO_USUARIO = s.CODIGO_USUARIO
 AND rbel.TIPO_MOVIMENTO = 0
; -- não funciona

SELECT
  e.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO ESTAGIO
, CASE WHEN u.USUARIO IS NULL
  THEN '--SEM RESPONSAVEL--'
  ELSE u.USUARIO || ' ( ' || u.CODIGO_USUARIO || ' )'
  END USUARIO
, CASE WHEN EXISTS (
    SELECT
      rbl.TIPO_MOVIMENTO
    FROM MQOP_006 rbl
    WHERE rbl.TIPO_MOVIMENTO IN (0, 1)
  )
  THEN 'X'
  ELSE ' ' END BL
, CASE WHEN r.TIPO_MOVIMENTO IN (0, 2)
  THEN 'X'
  ELSE ' ' END EL
FROM MQOP_005 e
LEFT JOIN MQOP_006 r
  ON r.CODIGO_ESTAGIO = e.CODIGO_ESTAGIO
 AND r.TIPO_MOVIMENTO = 0
LEFT JOIN HDOC_030 u
  ON u.CODIGO_USUARIO = r.CODIGO_USUARIO
WHERE e.CODIGO_ESTAGIO <> 0
  AND u.USUARIO = 'FELIPE_IND'
; -- não funciona

SELECT DISTINCT
  e.CODIGO_ESTAGIO
, u.USUARIO
, u.CODIGO_USUARIO
FROM MQOP_005 e
LEFT JOIN MQOP_006 r
  ON r.CODIGO_ESTAGIO = e.CODIGO_ESTAGIO
LEFT JOIN HDOC_030 u
  ON u.CODIGO_USUARIO = r.CODIGO_USUARIO
WHERE e.CODIGO_ESTAGIO <> 0
  AND u.USUARIO = 'FELIPE_IND'
;

SELECT
  s.CODIGO_ESTAGIO || ' - ' || s.DESCRICAO ESTAGIO
, CASE WHEN s.USUARIO IS NULL
  THEN '--SEM RESPONSAVEL--'
  ELSE s.USUARIO || ' ( ' || s.CODIGO_USUARIO || ' )'
  END USUARIO
, CASE WHEN EXISTS (
    SELECT
      r.TIPO_MOVIMENTO
    FROM MQOP_006 r
    WHERE r.CODIGO_ESTAGIO = s.CODIGO_ESTAGIO
      AND r.CODIGO_USUARIO = s.CODIGO_USUARIO
      AND r.TIPO_MOVIMENTO IN (0, 1)
  )
  THEN 'X'
  ELSE ' ' END BL
, CASE WHEN EXISTS (
    SELECT
      r.TIPO_MOVIMENTO
    FROM MQOP_006 r
    WHERE r.CODIGO_ESTAGIO = s.CODIGO_ESTAGIO
      AND r.CODIGO_USUARIO = s.CODIGO_USUARIO
      AND r.TIPO_MOVIMENTO IN (0, 2)
  )
  THEN 'X'
  ELSE ' ' END EL
, CASE WHEN EXISTS (
    SELECT
      r.TIPO_MOVIMENTO
    FROM MQOP_006 r
    WHERE r.CODIGO_ESTAGIO = s.CODIGO_ESTAGIO
      AND r.CODIGO_USUARIO = s.CODIGO_USUARIO
      AND r.TIPO_MOVIMENTO = 3
  )
  THEN 'X'
  ELSE ' ' END CO
, CASE WHEN EXISTS (
    SELECT
      r.TIPO_MOVIMENTO
    FROM MQOP_006 r
    WHERE r.CODIGO_ESTAGIO = s.CODIGO_ESTAGIO
      AND r.CODIGO_USUARIO = s.CODIGO_USUARIO
      AND r.TIPO_MOVIMENTO = 4
  )
  THEN 'X'
  ELSE ' ' END AO
FROM (
  SELECT DISTINCT
    e.CODIGO_ESTAGIO
  , e.DESCRICAO
  , u.USUARIO
  , u.CODIGO_USUARIO
  FROM MQOP_005 e
  LEFT JOIN MQOP_006 r
    ON r.CODIGO_ESTAGIO = e.CODIGO_ESTAGIO
  LEFT JOIN HDOC_030 u
    ON u.CODIGO_USUARIO = r.CODIGO_USUARIO
  WHERE e.CODIGO_ESTAGIO <> 0
--    AND u.USUARIO = 'FELIPE_IND'
  ORDER BY
    e.CODIGO_ESTAGIO
  , u.USUARIO
) s
;

SELECT
  *
FROM MQOP_006 r
WHERE r.TIPO_MOVIMENTO = 0
;

UPDATE MQOP_006 r
SET
  r.TIPO_MOVIMENTO = 1
WHERE r.TIPO_MOVIMENTO = 0
;

SELECT
  *
FROM MQOP_006 r
LEFT JOIN HDOC_030 u
  ON u.CODIGO_USUARIO = r.CODIGO_USUARIO
WHERE r.TIPO_MOVIMENTO = 1
  AND u.USUARIO IN (
  'ROSANGELA_PCP'
, 'ALESSANDRA_PCP'
, 'ADRIANA_PCP'
, 'LUIZ_IND'
, 'LILIANE_IND'
)
;

SELECT DISTINCT
  u.USUARIO
, u.CODIGO_USUARIO
FROM MQOP_006 r
LEFT JOIN HDOC_030 u
  ON u.CODIGO_USUARIO = r.CODIGO_USUARIO
WHERE r.TIPO_MOVIMENTO = 1
  AND u.USUARIO IN (
  'ROSANGELA_PCP'
, 'ALESSANDRA_PCP'
, 'ADRIANA_PCP'
, 'LUIZ_IND'
, 'LILIANE_IND'
)
;

SELECT
  r.*
FROM MQOP_006 r -- direitos sobre estágios
WHERE r.TIPO_MOVIMENTO = 1
  AND r.CODIGO_USUARIO IN (
  '8'
, '898'
, '2372'
, '2253'
, '1468'
)
;

UPDATE MQOP_006 r
SET
  r.TIPO_MOVIMENTO = 0
WHERE r.TIPO_MOVIMENTO = 1
  AND r.CODIGO_USUARIO IN (
  '8'
, '898'
, '2372'
, '2253'
, '1468'
, '99001'
)
;

SELECT
  ud.USU_PRG_CDUSU
, count(*)
FROM HDOC_033 ud -- direitos de usuários
WHERE ud.USU_PRG_CDUSU LIKE '%_PCP'
GROUP BY
  ud.USU_PRG_CDUSU
;

SELECT
  u.*
FROM HDOC_030 u
WHERE u.USUARIO = 'ALESSANDRO_LOG'
;

UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847700' WHERE GRUPO_ESTRUTURA='0467L' and SUBGRU_ESTRUTURA='EG' and ITEM_ESTRUTURA='0000CB';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847687' WHERE GRUPO_ESTRUTURA='0467L' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000CB';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847694' WHERE GRUPO_ESTRUTURA='0467L' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000CB';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847670' WHERE GRUPO_ESTRUTURA='0467L' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000CB';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618847663' WHERE GRUPO_ESTRUTURA='0467L' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000CB';

SELECT
  d.*
FROM HDOC_033 d
WHERE d.PROGRAMA = 'pcpc_f230'
;

SELECT
  dold.*
--  count(*)
FROM HDOC_033 dold
LEFT JOIN HDOC_033 dnew
  ON dnew.USU_PRG_CDUSU = 'MARISE_PRO'
 AND dnew.PROGRAMA = dold.PROGRAMA
WHERE 1=1
--  AND d.PROGRAMA = 'pcpc_f230'
  AND dold.USU_PRG_CDUSU = 'GISELLE_PRO'
  AND dnew.USU_PRG_CDUSU IS NULL
--  AND d.USU_PRG_CDUSU = 'MARISE_PRO'
;

-- Completa direitos para novos funcionários
INSERT INTO SYSTEXTIL.HDOC_033
(USU_PRG_CDUSU, USU_PRG_EMPR_USU, PROGRAMA, NOME_MENU, ITEM_MENU, ORDEM_MENU, INCLUIR, MODIFICAR, EXCLUIR, PROCURAR, COORDENADA_X, COORDENADA_Y, MARGEM_ESQ_RELATORIOS, SUPERVISOR)
--VALUES('ALESSANDRA_PCP', 1, 'pcpc_f230', 'favoritos', 1, 18, 'S', 'S', 'S', 'S', 0, 0, 0, NULL)
SELECT
--  dold.*
--  count(*)
  'MARISE_PRO', dold.USU_PRG_EMPR_USU, dold.PROGRAMA, dold.NOME_MENU, dold.ITEM_MENU, dold.ORDEM_MENU, dold.INCLUIR, dold.MODIFICAR, dold.EXCLUIR, dold.PROCURAR, dold.COORDENADA_X, dold.COORDENADA_Y, dold.MARGEM_ESQ_RELATORIOS, dold.SUPERVISOR
FROM HDOC_033 dold
LEFT JOIN HDOC_033 dnew
  ON dnew.USU_PRG_CDUSU = 'MARISE_PRO'
 AND dnew.PROGRAMA = dold.PROGRAMA
WHERE 1=1
--  AND d.PROGRAMA = 'pcpc_f230'
  AND dold.USU_PRG_CDUSU = 'GISELLE_PRO'
  AND dnew.USU_PRG_CDUSU IS NULL
--  AND d.USU_PRG_CDUSU = 'MARISE_PRO'
;

SELECT
  count(*)
--  le.*
FROM pcpc_040 le
WHERE le.SEQUENCIA_ESTAGIO = 0
;

SELECT
  le.*
FROM pcpc_040 le
WHERE le.PERIODO_PRODUCAO = 1750
  AND le.ORDEM_CONFECCAO = 6693
ORDER BY
  le.ROWID
;

SELECT
  x.rnum
FROM (
SELECT
  ROW_NUMBER() OVER (PARTITION BY le.ORDEM_CONFECCAO ORDER BY le.ROWID) RNUM
, le.ROWID RID
, le.*
FROM pcpc_040 le
WHERE le.PERIODO_PRODUCAO = 1750
  AND le.ORDEM_CONFECCAO = 6692
--  AND le.SEQUENCIA_ESTAGIO = 0
) x
WHERE x.RID = 'AAAOSRAAFAADSZEAA2'
--ORDER BY
--  le.ROWID
;

SELECT
  *
FROM (
  SELECT DISTINCT
    le.PERIODO_PRODUCAO
  , le.ORDEM_CONFECCAO
  , count(*)
  FROM pcpc_040 le
  WHERE le.SEQUENCIA_ESTAGIO = 0
  GROUP BY
    le.PERIODO_PRODUCAO
  , le.ORDEM_CONFECCAO
  HAVING
    count(*) > 1
  ORDER BY
    le.PERIODO_PRODUCAO
  , le.ORDEM_CONFECCAO
)
WHERE rownum <= 10
;

SELECT
  ROW_NUMBER() OVER (PARTITION BY le.ORDEM_CONFECCAO ORDER BY le.ROWID) RNUM
, le.ROWID RID
, le.SEQUENCIA_ESTAGIO
--, le.*
FROM pcpc_040 le
WHERE le.PERIODO_PRODUCAO = 1720
  AND le.ORDEM_CONFECCAO = 23699
ORDER BY
  le.ROWID
;

UPDATE pcpc_040 le
SET
  le.SEQUENCIA_ESTAGIO = 6
WHERE le.ROWID = 'AAAOSRAAFAAAZQ/AAM'
;

SELECT
    r.PERIODO_PRODUCAO PERIODO
  , r.ORDEM_CONFECCAO OC
FROM (
  SELECT DISTINCT
    le.PERIODO_PRODUCAO
  , le.ORDEM_CONFECCAO
  FROM pcpc_040 le
  WHERE le.SEQUENCIA_ESTAGIO = 0
  ORDER BY
    le.PERIODO_PRODUCAO
  , le.ORDEM_CONFECCAO
) r
WHERE rownum <= 100
;

-- sequencias de um lote
SELECT
  le.ROWID
, le.*
FROM pcpc_040 le
WHERE le.PERIODO_PRODUCAO = 1822
  AND le.ORDEM_CONFECCAO = 7428
ORDER BY
  le.ROWID
;

-- sequencias de um lote
SELECT
  le.ROWID
, le.*
FROM pcpc_040 le
WHERE le.PERIODO_PRODUCAO = 1818
  AND le.ORDEM_CONFECCAO = 3808
ORDER BY
  le.SEQ_OPERACAO
;

-- variações de sequencias de uma OP
SELECT DISTINCT
  le.SEQUENCIA_ESTAGIO
, le.CODIGO_ESTAGIO
, le.SEQ_OPERACAO
FROM pcpc_040 le
WHERE le.ORDEM_PRODUCAO = 1617 -- 7 -- 5947
ORDER BY
  1
, 2
;

-- variações de sequencias de um lote
SELECT DISTINCT
  le.SEQUENCIA_ESTAGIO
, le.CODIGO_ESTAGIO
, le.*
FROM pcpc_040 le
WHERE le.ORDEM_PRODUCAO = 5947
  AND le.SEQUENCIA_ESTAGIO = 1
ORDER BY
  1
, 2
;


-- lista OPS com mais de uma sequenca diferente de estágios
SELECT
  oo.*
FROM (
  SELECT
    oe.OP
  , count(*)
  FROM (
    SELECT DISTINCT
      le.ORDEM_PRODUCAO OP
    , le.SEQUENCIA_ESTAGIO SEQEST
    , le.CODIGO_ESTAGIO
    FROM pcpc_040 le
    WHERE le.SEQUENCIA_ESTAGIO = 1
  ) oe
  GROUP BY
    oe.OP
  , oe.SEQEST
  HAVING
    count(*) > 1
  ORDER BY
    2 DESC
  , 1
) oo
--WHERE rownum = 1
;

SELECT DISTINCT
  le.SEQUENCIA_ESTAGIO
, le.CODIGO_ESTAGIO
, le.SEQ_OPERACAO
, min(le.ORDEM_CONFECCAO)
FROM pcpc_040 le
WHERE le.ORDEM_PRODUCAO = 3812 -- 7 -- 5947
GROUP BY
  le.SEQUENCIA_ESTAGIO
, le.CODIGO_ESTAGIO
, le.SEQ_OPERACAO
ORDER BY
  1
, 2
;

-- nova sequencia de estagios baseada na sequencia de operações
SELECT
  ROW_NUMBER() OVER (
    PARTITION BY le.ORDEM_CONFECCAO ORDER BY le.SEQ_OPERACAO, le.ROWID
  ) SEQ
, le.SEQUENCIA_ESTAGIO
, le.SEQ_OPERACAO
, le.ROWID RID
FROM pcpc_040 le
WHERE le.PERIODO_PRODUCAO = 1748
  AND le.ORDEM_CONFECCAO = 7850
ORDER BY
  le.SEQ_OPERACAO
, le.ROWID
;


-- nova sequencia de estagios baseada na sequencia de operações, apenas se estiver errada
SELECT
  s.*
FROM (
  SELECT
    ROW_NUMBER() OVER (
      PARTITION BY le.ORDEM_CONFECCAO
      ORDER BY le.SEQ_OPERACAO, le.ROWID
    ) SEQ
  , le.SEQUENCIA_ESTAGIO
  , le.SEQ_OPERACAO
  , le.ROWID RID
  FROM pcpc_040 le
  WHERE le.PERIODO_PRODUCAO = 1737
    AND le.ORDEM_CONFECCAO = 820
  ORDER BY
    le.SEQ_OPERACAO
  , le.ROWID
) s
WHERE s.SEQ <> s.SEQUENCIA_ESTAGIO
;

SELECT
  u.*
FROM HDOC_030 u
--WHERE u.USUARIO = 'ALESSANDRO_LOG'
--WHERE u.USUARIO = 'DALVES_LOG'
WHERE u.USUARIO like '%_LOG'
;

SELECT
  u.USU_PRG_CDUSU
, COUNT(*)
FROM HDOC_033 u
WHERE u.USU_PRG_CDUSU LIKE '%_PCP'
GROUP BY
  u.USU_PRG_CDUSU
;

SELECT
  pu.*
FROM HDOC_033 pu -- programas de usuários
WHERE pu.USU_PRG_CDUSU = 'RAFAELA_PCP'
;

SELECT DISTINCT
  u.USUARIO
FROM HDOC_030 u
WHERE 1=1
  AND u.ATIVO_INATIVO = 2 -- u.ATIVO_INATIVO = 2 => inativo
;

SELECT
  pu.*
FROM HDOC_033 pu -- programas de usuários
JOIN HDOC_030 u -- usuários
  ON pu.USU_PRG_CDUSU = u.USUARIO
WHERE pu.USU_PRG_CDUSU = 'RAFAELA_PCP'
  AND u.ATIVO_INATIVO = 2 -- u.ATIVO_INATIVO = 2 => inativo
;

SELECT
  pu.*
FROM HDOC_033 pu -- programas de usuários
WHERE pu.USU_PRG_CDUSU in
(
  SELECT DISTINCT
    u.USUARIO
  FROM HDOC_030 u
  WHERE 1=1
--    AND u.USUARIO = 'RAFAELA_PCP'
    AND u.ATIVO_INATIVO = 2 -- u.ATIVO_INATIVO = 2 => inativo
)
;

DELETE
FROM HDOC_033 pu -- programas de usuários
WHERE pu.USU_PRG_CDUSU IN
(
  SELECT DISTINCT
    u.USUARIO
  FROM HDOC_030 u
  WHERE 1=1
--    AND u.USUARIO = 'RAFAELA_PCP'
    AND u.ATIVO_INATIVO = 2 -- u.ATIVO_INATIVO = 2 => inativo
)
;

SELECT
  u.*
FROM HDOC_030 u
WHERE u.USUARIO = 'RAFAELA_PCP'
;

SELECT
  u.*
FROM HDOC_033 u
WHERE u.USU_PRG_CDUSU LIKE 'DALVES_LOG'
;

SELECT
  h.USUARIO
, h.PROGRAMA
, count(*)
--, h.*
FROM HIST_100 h
WHERE 1=1
--  AND h.DATA_OCORR > TO_DATE('01/01/2018','DD/MM/YYYY')
  AND h.USUARIO = 'GABRIEL_PCP'
GROUP BY
  h.USUARIO
, h.PROGRAMA
;

SELECT
  count(*)
FROM HIST_100 h
;

SELECT
  h.*
FROM HIST_100 h
WHERE 1=1
  AND h.USUARIO LIKE '%_PCP'
;

SELECT
  u.*
FROM HIST_999 u
;

SELECT
  u.*
FROM HIST_999 u
WHERE u.USUARIO = 'GABRIEL_PCP'
;

UPDATE MQOP_006 r
SET
  r.TIPO_MOVIMENTO = 0
WHERE r.TIPO_MOVIMENTO = 1
  AND r.CODIGO_USUARIO IN (
  '1440'
)
;

SELECT
  op.ORDEM_PRODUCAO OP
, le.SEQUENCIA_ESTAGIO SEQ
, le.CODIGO_ESTAGIO EST
, le63.SEQUENCIA_ESTAGIO SEQ63
, sum(le.QTDE_EM_PRODUCAO_PACOTE) QTD
FROM PCPC_020 op -- OP capa
LEFT JOIN PCPC_040 le63 -- lote estágio 63
  ON le63.ordem_producao = op.ORDEM_PRODUCAO
 AND le63.CODIGO_ESTAGIO = 63
LEFT JOIN PCPC_040 le -- lote estágio atual
  ON le.ordem_producao = op.ORDEM_PRODUCAO
 AND le.PERIODO_PRODUCAO = le63.PERIODO_PRODUCAO
 AND le.ORDEM_CONFECCAO = le63.ORDEM_CONFECCAO
 AND le.QTDE_EM_PRODUCAO_PACOTE <> 0
WHERE op.COD_CANCELAMENTO = 0
  AND (( op.ORDEM_PRODUCAO = 21 AND le63.ORDEM_CONFECCAO in (1299,1301) )
    OR ( op.ORDEM_PRODUCAO = 38 AND le63.ORDEM_CONFECCAO in (1804,1805,1806) )
    OR ( op.ORDEM_PRODUCAO = 76 AND le63.ORDEM_CONFECCAO in (123,1231) )
    OR ( op.ORDEM_PRODUCAO = 320 AND le63.ORDEM_CONFECCAO in (1514) )
    OR ( op.ORDEM_PRODUCAO = 524 AND le63.ORDEM_CONFECCAO in (3408,3481) )
    OR ( op.ORDEM_PRODUCAO = 1013 AND le63.ORDEM_CONFECCAO in (3268,3269) ))
GROUP BY
  op.ORDEM_PRODUCAO
, le.SEQUENCIA_ESTAGIO
, le.CODIGO_ESTAGIO
, le63.SEQUENCIA_ESTAGIO
ORDER BY
  op.ORDEM_PRODUCAO
, le.SEQUENCIA_ESTAGIO
;



SELECT
  f.NUM_NOTA_FISCAL NF
, f.BASE_ICMS VALOR
, f.QTDE_EMBALAGENS VOLUMES
, f.DATA_AUTORIZACAO_NFE FATURAMENTO
, CAST( COALESCE( '0' || f.COD_STATUS, '0' ) AS INT )
  COD_STATUS
, COALESCE( f.MSG_STATUS, ' ' ) MSG_STATUS
, f.SITUACAO_NFISC SITUACAO
, f.NATOP_NF_NAT_OPER NAT
, f.NATOP_NF_EST_OPER UF
, n.DESCR_NAT_OPER NATUREZA
, n.COD_NATUREZA COD_NAT
, n.DIVISAO_NATUR DIV_NAT
, f.CGC_9 CNPJ9
, f.CGC_4 CNPJ4
, f.CGC_2 CNPJ2
, c.NOME_CLIENTE CLIENTE
, COALESCE(
    CASE WHEN f.TRANSPOR_FORNE9
            + f.TRANSPOR_FORNE4
            + f.TRANSPOR_FORNE2 = 0
    THEN 'O PROPRIO'
    ELSE COALESCE( t.NOME_FANTASIA
                 , '(' || f.TRANSPOR_FORNE9 || '/' ||
                   f.TRANSPOR_FORNE4 || '-' ||
                   f.TRANSPOR_FORNE2 || ')' )
    END
  , '-') TRANSP
, f.PEDIDO_VENDA PEDIDO
, p.COD_PED_CLIENTE PED_CLIENTE
FROM FATU_050 f
LEFT JOIN PEDI_100 p
  ON p.PEDIDO_VENDA = f.PEDIDO_VENDA
JOIN PEDI_010 c
  ON c.CGC_9 = f.CGC_9
 AND c.CGC_4 = f.CGC_4
 AND c.CGC_2 = f.CGC_2
JOIN PEDI_080 n
  ON n.NATUR_OPERACAO = f.NATOP_NF_NAT_OPER
 AND n.ESTADO_NATOPER = f.NATOP_NF_EST_OPER
LEFT JOIN SUPR_010 t
  ON t.TIPO_FORNECEDOR = 31 -- transportadora
 AND t.FORNECEDOR9 = f.TRANSPOR_FORNE9
 AND t.FORNECEDOR4 = f.TRANSPOR_FORNE4
 AND t.FORNECEDOR2 = f.TRANSPOR_FORNE2
WHERE rownum = 1
--  AND f.NATOP_NF_NAT_OPER = 18
  AND n.COD_NATUREZA = '5.11'
  AND n.DIVISAO_NATUR = '8'
ORDER BY
  f.NUM_NOTA_FISCAL DESC
;


SELECT
  e.*
FROM EMPR_005 e
;

SELECT
--  count(*)
  l.*
FROM OBRF_081_LOG l
;

SELECT
  x.*
FROM PCPC_700 x
;

CREATE TABLE PCPC_700_TEMP AS SELECT * FROM PCPC_700;

INSERT INTO PCPC_700 SELECT * FROM PCPC_700_TEMP;

SELECT DISTINCT
  i.TAMANHO
, i.SEQUENCIA_TAMANHO
FROM PCPC_021 i
WHERE i.ORDEM_PRODUCAO = 6000
ORDER BY
  i.SEQUENCIA_TAMANHO
;

SELECT
  t.TAMANHO_REF
, t.ORDEM_TAMANHO
FROM BASI_220 t
;


SELECT
  TO_CHAR(h.DATA_INSERCAO, 'DD/MM/YYYY HH24:MI:SS') DT
, h.PCPC040_ESTCONF EST
, h.TURNO_PRODUCAO TURNO
, h.CODIGO_FAMILIA FAMILIA
, h.QTDE_PRODUZIDA Q_P1
, h.QTDE_PECAS_2A Q_P2
, h.QTDE_CONSERTO Q_C
, h.QTDE_PERDAS Q_P
, coalesce(h.USUARIO_SYSTEXTIL, ' ') USU
, coalesce(h.PROCESSO_SYSTEXTIL, ' ') PRG
, coalesce(p.DESCRICAO, ' ') PRG_DESCR
FROM PCPC_045 h
LEFT JOIN HDOC_036 p
  ON p.CODIGO_PROGRAMA = h.PROCESSO_SYSTEXTIL
 AND p.LOCALE = 'pt_BR'
WHERE h.PCPC040_PERCONF = 1820
  AND h.PCPC040_ORDCONF = 1802
ORDER BY
  h.DATA_INSERCAO
, h.PCPC040_ESTCONF
, h.SEQUENCIA

SELECT
  le.*
FROM PCPC_040 le -- lote estágio
WHERE le.CODIGO_ESTAGIO = 22
  AND ORDEM_PRODUCAO > 6000
;

SELECT
  h.*
FROM PCPC_045 h
WHERE 1=1
;

SELECT
  TO_DATE(h.DATA_INSERCAO) DT
, h.CODIGO_FAMILIA FAMILIA
, count(*) LOTES
, sum(h.QTDE_PRODUZIDA) PECAS
FROM PCPC_045 h
WHERE 1=1
--  AND h.PCPC040_PERCONF = 1820
--  AND h.PCPC040_ORDCONF = 1802
  AND TO_DATE(h.DATA_INSERCAO) = TO_DATE('24/05/2018','DD/MM/YYYY')
  AND h.PCPC040_ESTCONF = 22
GROUP BY
  TO_DATE(h.DATA_INSERCAO)
, h.CODIGO_FAMILIA
ORDER BY
  1s
, h.CODIGO_FAMILIA
;


SELECT
  TO_CHAR(h.DATA_INSERCAO, 'YYYY/MM/DD') DATA_SORT
, TO_CHAR(h.DATA_INSERCAO, 'DD/MM/YYYY') DATA
, h.CODIGO_FAMILIA FAMILIA
, count(DISTINCT h.ORDEM_PRODUCAO) OPS
, count(*) LOTES
, sum(h.QTDE_PRODUZIDA) PECAS
FROM PCPC_045 h
WHERE h.PCPC040_ESTCONF = 22
  AND TO_DATE(h.DATA_INSERCAO) >= TO_DATE('24/05/2018','DD/MM/YYYY')
  AND TO_DATE(h.DATA_INSERCAO) <= TO_DATE('24/05/2018','DD/MM/YYYY')
GROUP BY
  TO_CHAR(h.DATA_INSERCAO, 'YYYY/MM/DD')
, TO_CHAR(h.DATA_INSERCAO, 'DD/MM/YYYY')
, h.CODIGO_FAMILIA
ORDER BY
  1
, h.CODIGO_FAMILIA
;

UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618819547' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000AJ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618819554' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000AJ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618819530' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000AJ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618819523' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000AJ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618810711' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000AM';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618810728' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000AM';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618810704' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000AM';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618810698' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000AM';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618809104' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000AZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618809111' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000AZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618809098' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000AZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618809081' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000AZ';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7896896256804' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7896896256811' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7896896256798' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7896896256750' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618814702' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000MA';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618814719' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000MA';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618814696' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000MA';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618814689' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000MA';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7896896256842' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000ME';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7896896256859' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000ME';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7896896256835' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000ME';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7896896256828' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000ME';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7896896256910' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7896896256927' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7896896256873' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7896896256866' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618810797' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000VE';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618810803' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000VE';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618810780' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000VE';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618810773' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000VE';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618810759' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000VM';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618810766' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000VM';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618810742' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000VM';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618810735' WHERE GRUPO_ESTRUTURA='0156M' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000VM';


UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7896896291447' WHERE GRUPO_ESTRUTURA='0262M' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7896896291454' WHERE GRUPO_ESTRUTURA='0262M' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7896896291430' WHERE GRUPO_ESTRUTURA='0262M' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7896896291423' WHERE GRUPO_ESTRUTURA='0262M' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618830948' WHERE GRUPO_ESTRUTURA='0262M' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000CB';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618830962' WHERE GRUPO_ESTRUTURA='0262M' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000CB';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618830924' WHERE GRUPO_ESTRUTURA='0262M' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000CB';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618830900' WHERE GRUPO_ESTRUTURA='0262M' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000CB';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618831013' WHERE GRUPO_ESTRUTURA='0262M' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618831020' WHERE GRUPO_ESTRUTURA='0262M' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618830993' WHERE GRUPO_ESTRUTURA='0262M' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618830979' WHERE GRUPO_ESTRUTURA='0262M' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000PR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618831051' WHERE GRUPO_ESTRUTURA='0262M' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000RO';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618831068' WHERE GRUPO_ESTRUTURA='0262M' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000RO';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618831044' WHERE GRUPO_ESTRUTURA='0262M' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000RO';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618831037' WHERE GRUPO_ESTRUTURA='0262M' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000RO';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618831099' WHERE GRUPO_ESTRUTURA='0262M' and SUBGRU_ESTRUTURA='G'  and ITEM_ESTRUTURA='0000VM';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618831105' WHERE GRUPO_ESTRUTURA='0262M' and SUBGRU_ESTRUTURA='GG' and ITEM_ESTRUTURA='0000VM';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618831082' WHERE GRUPO_ESTRUTURA='0262M' and SUBGRU_ESTRUTURA='M'  and ITEM_ESTRUTURA='0000VM';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618831075' WHERE GRUPO_ESTRUTURA='0262M' and SUBGRU_ESTRUTURA='P'  and ITEM_ESTRUTURA='0000VM';

SELECT
  lote.OP
, lote.PERIODO
, lote.OC
, lote.REF
, lote.TAM
, lote.ORD_TAM
, lote.COR
, lote.QTD_PRODUZIR
--, lote.ULTIMO_ESTAGIO
, lote.TRAIL
, CASE WHEN l.ORDEM_CONFECCAO IS NULL THEN 999
  ELSE l.CODIGO_ESTAGIO END ESTAGIO
, CASE WHEN l.ORDEM_CONFECCAO IS NULL THEN lf.QTDE_PECAS_PROD
  ELSE l.QTDE_EM_PRODUCAO_PACOTE END QTD
, lote.ULTIMA_SEQ_ESTAGIO lote_ult_seq
, lf.SEQUENCIA_ESTAGIO lf_seq
, l.SEQUENCIA_ESTAGIO l_seq
FROM
(
  SELECT
    le.ORDEM_PRODUCAO OP
  , le.PERIODO_PRODUCAO PERIODO
  , le.ORDEM_CONFECCAO OC
  , le.PROCONF_GRUPO REF
  , le.PROCONF_SUBGRUPO TAM
  , t.ORDEM_TAMANHO ORD_TAM
  , le.PROCONF_ITEM COR
  , le.QTDE_PECAS_PROG QTD_PRODUZIR
  , max(le.CODIGO_ESTAGIO) ULTIMO_ESTAGIO
  , max(le.SEQUENCIA_ESTAGIO) ULTIMA_SEQ_ESTAGIO
  , sum(
      ( 1
      + le.QTDE_PECAS_PROG
      + le.QTDE_EM_PRODUCAO_PACOTE
      + le.QTDE_PECAS_PROD
      )
    * (1 + le.CODIGO_ESTAGIO)
    * (1 + mod(le.ORDEM_CONFECCAO, 111))
    ) trail
  FROM PCPC_040 le -- lote estágio
  LEFT JOIN BASI_220 t
    ON t.TAMANHO_REF = le.PROCONF_SUBGRUPO
  WHERE le.ORDEM_PRODUCAO = 4217
--    AND le.ORDEM_CONFECCAO = 22
    AND le.QTDE_PECAS_PROG IS NOT NULL
    AND le.QTDE_PECAS_PROG <> 0
    AND le.ORDEM_CONFECCAO = 4057
  GROUP BY
    le.ORDEM_PRODUCAO
  , le.PERIODO_PRODUCAO
  , le.ORDEM_CONFECCAO
  , le.PROCONF_GRUPO
  , le.PROCONF_SUBGRUPO
  , t.ORDEM_TAMANHO
  , le.PROCONF_ITEM
  , le.QTDE_PECAS_PROG
  ORDER BY
    le.ORDEM_PRODUCAO
  , le.ORDEM_CONFECCAO
) lote
LEFT JOIN PCPC_040 l -- lote estágio
  ON l.ORDEM_PRODUCAO = lote.OP
 AND l.ORDEM_CONFECCAO = lote.OC
 AND l.QTDE_EM_PRODUCAO_PACOTE <> 0
 AND (  (   lote.ULTIMA_SEQ_ESTAGIO = 0
        AND l.CODIGO_ESTAGIO = lote.ULTIMO_ESTAGIO)
     OR (   lote.ULTIMA_SEQ_ESTAGIO <> 0
        AND l.SEQUENCIA_ESTAGIO = lote.ULTIMA_SEQ_ESTAGIO)
     )
LEFT JOIN PCPC_040 lf -- lote estágio
  ON l.ORDEM_CONFECCAO IS NULL
 AND lf.ORDEM_PRODUCAO = lote.OP
 AND lf.ORDEM_CONFECCAO = lote.OC
 AND (  (   lote.ULTIMA_SEQ_ESTAGIO = 0
        AND lf.CODIGO_ESTAGIO = lote.ULTIMO_ESTAGIO)
     OR (   lote.ULTIMA_SEQ_ESTAGIO <> 0
        AND lf.SEQUENCIA_ESTAGIO = lote.ULTIMA_SEQ_ESTAGIO)
     )
;

SELECT
  le.*
FROM PCPC_040 le -- lote estágio
WHERE le.PERIODO_PRODUCAO = 1804
  AND le.ORDEM_CONFECCAO = 4057
;


SELECT
  ped.PEDIDO_VENDA
, ped.DATA_EMIS_VENDA DT_EMISSAO
, ped.DATA_PREV_RECEB DT_RECEBIMENTO
, ped.DATA_ENTR_VENDA DT_EMBARQUE
, ped.OBSERVACAO
, c.NOME_CLIENTE
  || ' (' || lpad(c.CGC_9, 8, '0')
  || '/' || lpad(c.CGC_4, 4, '0')
  || '-' || lpad(c.CGC_2, 2, '0')
  || ')' CLIENTE
, COALESCE(ped.COD_PED_CLIENTE, ' ') PEDIDO_CLIENTE
, CASE ped.STATUS_PEDIDO
  WHEN 0 THEN '0-Digitado'
  WHEN 1 THEN '1-Financeiro'
  WHEN 2 THEN '2-Liberado Financeiro'
  WHEN 3 THEN '3-Faturamento'
  WHEN 4 THEN '4-A cancelar'
  WHEN 5 THEN '5-Cancelado'
  WHEN 9 THEN '9-Aberto na web'
  END STATUS_PEDIDO
, CASE ped.SITUACAO_VENDA
  WHEN 0  THEN '0-Pedido liberado'
  WHEN 5  THEN '5-Pedido suspenso'
  WHEN 10 THEN '10-Faturado total'
  WHEN 15 THEN '15-Pedido com NF cancelada'
  END SITUACAO_VENDA
FROM PEDI_100 ped -- pedido de venda
LEFT JOIN PEDI_010 c
  ON c.CGC_9 = ped.CLI_PED_CGC_CLI9
 AND c.CGC_4 = ped.CLI_PED_CGC_CLI4
WHERE ped.PEDIDO_VENDA = 3001
;


SELECT
  ll.EST
, ll.COD_EST
, (SELECT
      cast( SUM( lp.QTDE_PECAS_PROD ) / SUM( lp.QTDE_PECAS_PROG ) * 100
            AS NUMERIC(10,2) )
    FROM pcpc_040 lp
    WHERE lp.ORDEM_PRODUCAO = ll.ORDEM_PRODUCAO
      AND lp.SEQ_OPERACAO = ll.SEQ_OPERACAO
  ) PERC
, (SELECT
      SUM( lp.QTDE_PECAS_PROD )
    FROM pcpc_040 lp
    WHERE lp.ORDEM_PRODUCAO = ll.ORDEM_PRODUCAO
      AND lp.SEQ_OPERACAO = ll.SEQ_OPERACAO
  ) PROD
, (SELECT
      SUM( lp.QTDE_PECAS_2A )
    FROM pcpc_040 lp
    WHERE lp.ORDEM_PRODUCAO = ll.ORDEM_PRODUCAO
      AND lp.SEQ_OPERACAO = ll.SEQ_OPERACAO
  ) Q2
, (SELECT
      SUM( lp.QTDE_PERDAS )
    FROM pcpc_040 lp
    WHERE lp.ORDEM_PRODUCAO = ll.ORDEM_PRODUCAO
      AND lp.SEQ_OPERACAO = ll.SEQ_OPERACAO
  ) PERDA
, (SELECT
      SUM( lp.QTDE_CONSERTO )
    FROM pcpc_040 lp
    WHERE lp.ORDEM_PRODUCAO = ll.ORDEM_PRODUCAO
      AND lp.SEQ_OPERACAO = ll.SEQ_OPERACAO
  ) CONSERTO
, (SELECT
      count(*)
    FROM pcpc_040 lp
    WHERE lp.ORDEM_PRODUCAO = ll.ORDEM_PRODUCAO
      AND lp.SEQ_OPERACAO = ll.SEQ_OPERACAO
      AND lp.QTDE_EM_PRODUCAO_PACOTE <> 0
  ) LOTES
FROM
(
SELECT DISTINCT
  l.ORDEM_PRODUCAO
, l.SEQ_OPERACAO
, l.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO EST
, l.CODIGO_ESTAGIO COD_EST
FROM pcpc_040 l
JOIN MQOP_005 e
  ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
WHERE l.ORDEM_PRODUCAO = 5155
ORDER BY
  l.SEQ_OPERACAO
) ll
;


SELECT
  ll.EST
, ll.COD_EST
, cast( SUM( lp.QTDE_PECAS_PROD ) / SUM( lp.QTDE_PECAS_PROG ) * 100
        AS NUMERIC(10,2) ) PERC
, SUM( lp.QTDE_PECAS_PROD ) PROD
, SUM( lp.QTDE_PECAS_2A ) Q2
, SUM( lp.QTDE_PERDAS ) PERDA
, SUM( lp.QTDE_CONSERTO ) CONSERTO
, SUM(
  CASE WHEN lp.QTDE_EM_PRODUCAO_PACOTE <> 0 THEN 1 ELSE 0 END
  ) LOTES
FROM
(
SELECT DISTINCT
  l.ORDEM_PRODUCAO
, l.SEQ_OPERACAO
, l.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO EST
, l.CODIGO_ESTAGIO COD_EST
FROM pcpc_040 l
JOIN MQOP_005 e
  ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
WHERE l.ORDEM_PRODUCAO = 5155
) ll
LEFT JOIN pcpc_040 lp
  ON lp.ORDEM_PRODUCAO = ll.ORDEM_PRODUCAO
 AND lp.SEQ_OPERACAO = ll.SEQ_OPERACAO
GROUP BY
  ll.SEQ_OPERACAO
, ll.EST
, ll.COD_EST
ORDER BY
  ll.SEQ_OPERACAO
;


SELECT
  l.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO EST
, l.CODIGO_ESTAGIO COD_EST
, cast( SUM( l.QTDE_PECAS_PROD ) / SUM( l.QTDE_PECAS_PROG ) * 100
        AS NUMERIC(10,2) ) PERC
, SUM( l.QTDE_PECAS_PROD ) PROD
, SUM( l.QTDE_PECAS_2A ) Q2
, SUM( l.QTDE_PERDAS ) PERDA
, SUM( l.QTDE_CONSERTO ) CONSERTO
, SUM(
  CASE WHEN l.QTDE_EM_PRODUCAO_PACOTE <> 0 THEN 1 ELSE 0 END
  ) LOTES
FROM pcpc_040 l
JOIN MQOP_005 e
  ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
WHERE l.ORDEM_PRODUCAO = 5155
GROUP BY
  l.SEQ_OPERACAO
, l.CODIGO_ESTAGIO
, e.DESCRICAO
, l.ORDEM_PRODUCAO
ORDER BY
  l.SEQ_OPERACAO
;



SELECT
  ll.EST
, ll.COD_EST
, ll.PERC
, ll.PROD
, ll.Q2
, ll.PERDA
, ll.CONSERTO
, ll.LOTES
, ROUND(TO_DATE('01/01/2001','DD/MM/YYYY') + AVG(u.DATA_PRODUCAO - TO_DATE('01/01/2001','DD/MM/YYYY')) - MIN(u.DATA_PRODUCAO)) DT_MIN
, TO_DATE('01/01/2001','DD/MM/YYYY') + AVG(u.DATA_PRODUCAO - TO_DATE('01/01/2001','DD/MM/YYYY')) DIA_AVG
, ROUND(MAX(u.DATA_PRODUCAO) - (TO_DATE('01/01/2001','DD/MM/YYYY') + AVG(u.DATA_PRODUCAO - TO_DATE('01/01/2001','DD/MM/YYYY')))) DT_MAX
FROM (
SELECT
  l.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO EST
, l.CODIGO_ESTAGIO COD_EST
, l.SEQ_OPERACAO
, l.ORDEM_PRODUCAO
, cast( SUM( l.QTDE_PECAS_PROD ) / SUM( l.QTDE_PECAS_PROG ) * 100
        AS NUMERIC(10,2) ) PERC
, SUM( l.QTDE_PECAS_PROD ) PROD
, SUM( l.QTDE_PECAS_2A ) Q2
, SUM( l.QTDE_PERDAS ) PERDA
, SUM( l.QTDE_CONSERTO ) CONSERTO
, SUM(
  CASE WHEN l.QTDE_EM_PRODUCAO_PACOTE <> 0 THEN 1 ELSE 0 END
  ) LOTES
FROM pcpc_040 l
JOIN MQOP_005 e
  ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
WHERE l.ORDEM_PRODUCAO = 5155
GROUP BY
  l.SEQ_OPERACAO
, l.CODIGO_ESTAGIO
, e.DESCRICAO
, l.ORDEM_PRODUCAO
) ll
LEFT JOIN pcpc_045 u
  ON u.ORDEM_PRODUCAO = ll.ORDEM_PRODUCAO
 AND u.PCPC040_ESTCONF = ll.COD_EST
 AND u.QTDE_PRODUZIDA + u.QTDE_PECAS_2A + u.QTDE_PERDAS + u.QTDE_CONSERTO > 0
GROUP BY
  ll.SEQ_OPERACAO
, ll.EST
, ll.COD_EST
, ll.PERC
, ll.PROD
, ll.Q2
, ll.PERDA
, ll.CONSERTO
, ll.LOTES
ORDER BY
  ll.SEQ_OPERACAO
;


SELECT
  u.PCPC040_ESTCONF
, ROUND(TO_DATE('01/01/2001','DD/MM/YYYY') + AVG(u.DATA_PRODUCAO - TO_DATE('01/01/2001','DD/MM/YYYY')) - MIN(u.DATA_PRODUCAO)) DT_MIN
, TO_DATE('01/01/2001','DD/MM/YYYY') + AVG(u.DATA_PRODUCAO - TO_DATE('01/01/2001','DD/MM/YYYY')) DIA_AVG
, ROUND(MAX(u.DATA_PRODUCAO) - (TO_DATE('01/01/2001','DD/MM/YYYY') + AVG(u.DATA_PRODUCAO - TO_DATE('01/01/2001','DD/MM/YYYY')))) DT_MAX
FROM pcpc_045 u
WHERE u.ORDEM_PRODUCAO = 5155
 AND u.QTDE_PRODUZIDA + u.QTDE_PECAS_2A + u.QTDE_PERDAS + u.QTDE_CONSERTO > 0
GROUP BY
  u.PCPC040_ESTCONF
;

SELECT
  u.PCPC040_ESTCONF
, count(*)
, u.USUARIO_SYSTEXTIL
, ROUND(TO_DATE('01/01/2001','DD/MM/YYYY') + AVG(u.DATA_PRODUCAO - TO_DATE('01/01/2001','DD/MM/YYYY')) - MIN(u.DATA_PRODUCAO)) DT_MIN
, TO_DATE('01/01/2001','DD/MM/YYYY') + AVG(u.DATA_PRODUCAO - TO_DATE('01/01/2001','DD/MM/YYYY')) DIA_AVG
, ROUND(MAX(u.DATA_PRODUCAO) - (TO_DATE('01/01/2001','DD/MM/YYYY') + AVG(u.DATA_PRODUCAO - TO_DATE('01/01/2001','DD/MM/YYYY')))) DT_MAX
FROM pcpc_045 u
WHERE u.ORDEM_PRODUCAO = 5155
 AND u.QTDE_PRODUZIDA + u.QTDE_PECAS_2A + u.QTDE_PERDAS + u.QTDE_CONSERTO > 0
GROUP BY
  u.PCPC040_ESTCONF
, u.USUARIO_SYSTEXTIL
ORDER BY
  1
, 2 DESC
, 3
;

SELECT DISTINCT
  l.SEQ_OPERACAO
, l.CODIGO_ESTAGIO
FROM pcpc_040 l
WHERE l.ORDEM_PRODUCAO = 5155
;

SELECT
  ll.EST
, u.USUARIO_SYSTEXTIL
, count(*) LOTES
, MIN(u.DATA_PRODUCAO) DT_MIN
, ROUND(TO_DATE('01/01/2001','DD/MM/YYYY') + AVG(u.DATA_PRODUCAO - TO_DATE('01/01/2001','DD/MM/YYYY')) - MIN(u.DATA_PRODUCAO)) DIA_INI
, TO_DATE('01/01/2001','DD/MM/YYYY') + AVG(u.DATA_PRODUCAO - TO_DATE('01/01/2001','DD/MM/YYYY')) DT_AVG
, ROUND(MAX(u.DATA_PRODUCAO) - (TO_DATE('01/01/2001','DD/MM/YYYY') + AVG(u.DATA_PRODUCAO - TO_DATE('01/01/2001','DD/MM/YYYY')))) DIA_FIM
, MAX(u.DATA_PRODUCAO) DT_MAX
FROM (
  SELECT DISTINCT
    l.SEQ_OPERACAO
  , l.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO EST
  , l.CODIGO_ESTAGIO
  , l.ORDEM_PRODUCAO
  FROM pcpc_040 l
  JOIN MQOP_005 e
    ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
  WHERE l.ORDEM_PRODUCAO = 5155
) ll
JOIN pcpc_045 u
  ON u.ORDEM_PRODUCAO = ll.ORDEM_PRODUCAO
 AND u.PCPC040_ESTCONF = ll.CODIGO_ESTAGIO
 AND u.QTDE_PRODUZIDA + u.QTDE_PECAS_2A + u.QTDE_PERDAS + u.QTDE_CONSERTO > 0
GROUP BY
  ll.SEQ_OPERACAO
, ll.EST
, u.PCPC040_ESTCONF
, u.USUARIO_SYSTEXTIL
ORDER BY
  ll.SEQ_OPERACAO
, 4 -- DT_MIN
, 3 DESC -- LOTES
, u.USUARIO_SYSTEXTIL
;

SELECT
  i.CODIGO_BARRAS
--, i.GRUPO_ESTRUTURA
--, i.SUBGRU_ESTRUTURA
--, i.ITEM_ESTRUTURA
, i.*
FROM BASI_010 i
WHERE i.NIVEL_ESTRUTURA='1'
--  AND i.GRUPO_ESTRUTURA='603ME'
  AND i.GRUPO_ESTRUTURA LIKE '%00417%'
  AND i.ITEM_ESTRUTURA = '0000PR'
ORDER BY
--  i.GRUPO_ESTRUTURA
--,
i.ITEM_ESTRUTURA
, i.SUBGRU_ESTRUTURA
;

UPDATE BASI_010 i
SET i.CODIGO_BARRAS =
  ( SELECT ii.CODIGO_BARRAS
    FROM BASI_010 ii
    WHERE ii.NIVEL_ESTRUTURA=i.NIVEL_ESTRUTURA
      AND ii.GRUPO_ESTRUTURA='0002A'
      AND ii.SUBGRU_ESTRUTURA=i.SUBGRU_ESTRUTURA
      AND ii.ITEM_ESTRUTURA=i.ITEM_ESTRUTURA
  )
WHERE i.NIVEL_ESTRUTURA='1'
  AND i.GRUPO_ESTRUTURA='00002'
  AND i.ITEM_ESTRUTURA='0000AZ'
  AND (i.CODIGO_BARRAS = '' OR i.CODIGO_BARRAS = ' ' OR i.CODIGO_BARRAS IS NULL)
;


SELECT
  r.CODIGO_BARRAS
, r.*
FROM BASI_010 r
WHERE r.GRUPO_ESTRUTURA IN (
  '0002A'
, '0003A'
, '0004A'
, '0256A'
, '0257A'
, '0259A'
, '0263A'
, '0266A'
, '0270A'
, '0271A'
, '0272A'
)
--  and r.SUBGRU_ESTRUTURA='P'
--  and r.ITEM_ESTRUTURA='0000BR'
ORDER BY
  r.GRUPO_ESTRUTURA
, r.ITEM_ESTRUTURA
, r.SUBGRU_ESTRUTURA
;

SELECT DISTINCT
  r.GRUPO_ESTRUTURA
, r.ITEM_ESTRUTURA
FROM BASI_010 r
WHERE r.GRUPO_ESTRUTURA IN (
  '0002A'
, '0003A'
, '0004A'
, '0256A'
, '0257A'
, '0259A'
, '0263A'
, '0266A'
, '0270A'
, '0271A'
, '0272A'
)
ORDER BY
  r.GRUPO_ESTRUTURA
, r.ITEM_ESTRUTURA
;

SELECT
  op.ORDEM_PRODUCAO OPP
, op.PEDIDO_VENDA PEDIDO
, CASE WHEN op.OBSERVACAO2 LIKE '%(VAREJO)%' THEN 1 ELSE 0 END VAREJO
, op.COD_CANCELAMENTO CANCELADA
FROM PCPC_020 op -- OP capa
ORDER BY
  op.ORDEM_PRODUCAO
;

SELECT
  o.PEDIDO_VENDA
, o.*
FROM PCPC_020 o -- OP capa
WHERE 1=1
  AND o.REFERENCIA_PECA = '0619R'
  AND o.PEDIDO_VENDA <> 0
ORDER BY
  o.ORDEM_PRODUCAO DESC
;


SELECT
  lote.OP
, lote.PERIODO
, lote.OC
, lote.REF
, lote.TAM
, lote.ORD_TAM
, lote.COR
, lote.QTD_PRODUZIR
--, lote.ULTIMO_ESTAGIO
, lote.TRAIL
, CASE WHEN l.ORDEM_CONFECCAO IS NULL THEN 999
  ELSE l.CODIGO_ESTAGIO END ESTAGIO
, CASE WHEN l.ORDEM_CONFECCAO IS NULL THEN lf.QTDE_PECAS_PROD
  ELSE l.QTDE_EM_PRODUCAO_PACOTE END QTD
FROM
(
  SELECT
    le.ORDEM_PRODUCAO OP
  , le.PERIODO_PRODUCAO PERIODO
  , le.ORDEM_CONFECCAO OC
  , le.PROCONF_GRUPO REF
  , le.PROCONF_SUBGRUPO TAM
  , t.ORDEM_TAMANHO ORD_TAM
  , le.PROCONF_ITEM COR
  , le.QTDE_PECAS_PROG QTD_PRODUZIR
  , max(le.CODIGO_ESTAGIO) ULTIMO_ESTAGIO
  , max(le.SEQUENCIA_ESTAGIO) ULTIMA_SEQ_ESTAGIO
  , sum(
      ( 1
      + le.QTDE_PECAS_PROG
      + le.QTDE_EM_PRODUCAO_PACOTE
      + le.QTDE_PECAS_PROD
      )
    * (1 + le.CODIGO_ESTAGIO)
    * (1 + mod(le.ORDEM_CONFECCAO, 111))
    ) trail
  FROM PCPC_040 le -- lote estágio
  LEFT JOIN BASI_220 t
    ON t.TAMANHO_REF = le.PROCONF_SUBGRUPO
  WHERE le.ORDEM_PRODUCAO = 6468
--    AND le.ORDEM_CONFECCAO = 22
    AND le.QTDE_PECAS_PROG IS NOT NULL
    AND le.QTDE_PECAS_PROG <> 0
  GROUP BY
    le.ORDEM_PRODUCAO
  , le.PERIODO_PRODUCAO
  , le.ORDEM_CONFECCAO
  , le.PROCONF_GRUPO
  , le.PROCONF_SUBGRUPO
  , t.ORDEM_TAMANHO
  , le.PROCONF_ITEM
  , le.QTDE_PECAS_PROG
  ORDER BY
    le.ORDEM_PRODUCAO
  , le.ORDEM_CONFECCAO
) lote
LEFT JOIN PCPC_040 l -- lote estágio
  ON l.ORDEM_PRODUCAO = lote.OP
 AND l.ORDEM_CONFECCAO = lote.OC
 AND l.QTDE_EM_PRODUCAO_PACOTE <> 0
-- AND (  (   lote.ULTIMA_SEQ_ESTAGIO = 0
--        AND l.CODIGO_ESTAGIO = lote.ULTIMO_ESTAGIO)
--     OR (   lote.ULTIMA_SEQ_ESTAGIO <> 0
--        AND l.SEQUENCIA_ESTAGIO = lote.ULTIMA_SEQ_ESTAGIO)
--     )
LEFT JOIN PCPC_040 lf -- lote estágio
  ON l.ORDEM_CONFECCAO IS NULL
 AND lf.ORDEM_PRODUCAO = lote.OP
 AND lf.ORDEM_CONFECCAO = lote.OC
 AND (  (   lote.ULTIMA_SEQ_ESTAGIO = 0
        AND lf.CODIGO_ESTAGIO = lote.ULTIMO_ESTAGIO)
     OR (   lote.ULTIMA_SEQ_ESTAGIO <> 0
        AND lf.SEQUENCIA_ESTAGIO = lote.ULTIMA_SEQ_ESTAGIO)
     )
;



SELECT DISTINCT
  le.SEQUENCIA_ESTAGIO
, le.CODIGO_ESTAGIO
, le.SEQ_OPERACAO
, min(le.ORDEM_CONFECCAO)
FROM pcpc_040 le
WHERE le.ORDEM_PRODUCAO = 3812 -- 7 -- 5947
GROUP BY
  le.SEQUENCIA_ESTAGIO
, le.CODIGO_ESTAGIO
, le.SEQ_OPERACAO
ORDER BY
  1
, 2
;


UPDATE pcpc_040 le
SET
  SEQUENCIA_ESTAGIO = 0
WHERE le.ORDEM_PRODUCAO = 4158
;


WITH lotes AS (
SELECT
  1748 PERIODO_PRODUCAO
, 1713 ORDEM_CONFECCAO
FROM SYS.DUAL
)
(
SELECT
  0 + l.SEQUENCIA_ESTAGIO SEQUENCIA
, l.QTDE_PECAS_PROD QTD
, 'FINALIZADO 1A.' TIPO
, l.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO || ' (ULTIMO)' ESTAGIO
FROM lotes sel
JOIN PCPC_040 l
  ON l.PERIODO_PRODUCAO = sel.PERIODO_PRODUCAO
 AND l.ORDEM_CONFECCAO = sel.ORDEM_CONFECCAO
JOIN MQOP_005 e
  ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
WHERE l.QTDE_PECAS_PROD <> 0
  AND l.SEQUENCIA_ESTAGIO
      = (
        SELECT
          max(ms.SEQUENCIA_ESTAGIO)
        FROM PCPC_040 ms
        WHERE ms.PERIODO_PRODUCAO = sel.PERIODO_PRODUCAO
          AND ms.ORDEM_CONFECCAO = sel.ORDEM_CONFECCAO
      )
--
UNION
--
SELECT
  1000 + l.SEQUENCIA_ESTAGIO SEQUENCIA
, l.QTDE_PECAS_2A QTD
, 'FINALIZADO 2A.' TIPO
, l.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO || ' (ULTIMO)' ESTAGIO
FROM lotes sel
JOIN PCPC_040 l
  ON l.PERIODO_PRODUCAO = sel.PERIODO_PRODUCAO
 AND l.ORDEM_CONFECCAO = sel.ORDEM_CONFECCAO
JOIN MQOP_005 e
  ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
WHERE l.QTDE_PECAS_2A <> 0
  AND l.SEQUENCIA_ESTAGIO
      = (
        SELECT
          max(ms.SEQUENCIA_ESTAGIO)
        FROM PCPC_040 ms
        WHERE ms.PERIODO_PRODUCAO = sel.PERIODO_PRODUCAO
          AND ms.ORDEM_CONFECCAO = sel.ORDEM_CONFECCAO
      )
--
UNION
--
SELECT
  2000 + l.SEQUENCIA_ESTAGIO SEQUENCIA
, l.QTDE_EM_PRODUCAO_PACOTE - l.QTDE_CONSERTO QTD
, 'A PRODUZIR' TIPO
, l.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO ESTAGIO
FROM lotes sel
JOIN PCPC_040 l
  ON l.PERIODO_PRODUCAO = sel.PERIODO_PRODUCAO
 AND l.ORDEM_CONFECCAO = sel.ORDEM_CONFECCAO
JOIN MQOP_005 e
  ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
WHERE l.QTDE_EM_PRODUCAO_PACOTE - l.QTDE_CONSERTO > 0
--
UNION
--
SELECT
  3000 + l.SEQUENCIA_ESTAGIO SEQUENCIA
, l.QTDE_CONSERTO QTD
, 'EM CONSERTO' TIPO
, l.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO ESTAGIO
FROM lotes sel
JOIN PCPC_040 l
  ON l.PERIODO_PRODUCAO = sel.PERIODO_PRODUCAO
 AND l.ORDEM_CONFECCAO = sel.ORDEM_CONFECCAO
JOIN MQOP_005 e
  ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
WHERE l.QTDE_CONSERTO <> 0
--
UNION
--
SELECT
  4000 + l.SEQUENCIA_ESTAGIO SEQUENCIA
, l.QTDE_PERDAS QTD
, 'PERDAS' TIPO
, l.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO ESTAGIO
FROM lotes sel
JOIN PCPC_040 l
  ON l.PERIODO_PRODUCAO = sel.PERIODO_PRODUCAO
 AND l.ORDEM_CONFECCAO = sel.ORDEM_CONFECCAO
JOIN MQOP_005 e
  ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
WHERE l.QTDE_PERDAS <> 0
)
;

SELECT
  lote.OP
, lote.PERIODO
, lote.OC
, lote.REF
, lote.TAM
, lote.ORD_TAM
, lote.COR
, lote.QTD_PRODUZIR
--, lote.ULTIMO_ESTAGIO
, lote.TRAIL
, CASE WHEN l.ORDEM_CONFECCAO IS NULL THEN 999
  ELSE l.CODIGO_ESTAGIO END ESTAGIO
, CASE WHEN l.ORDEM_CONFECCAO IS NULL THEN lf.QTDE_PECAS_PROD
  ELSE l.QTDE_EM_PRODUCAO_PACOTE END QTD
FROM
(
  SELECT
    le.ORDEM_PRODUCAO OP
  , le.PERIODO_PRODUCAO PERIODO
  , le.ORDEM_CONFECCAO OC
  , le.PROCONF_GRUPO REF
  , le.PROCONF_SUBGRUPO TAM
  , t.ORDEM_TAMANHO ORD_TAM
  , le.PROCONF_ITEM COR
  , le.QTDE_PECAS_PROG QTD_PRODUZIR
  , max(le.CODIGO_ESTAGIO) ULTIMO_ESTAGIO
  , max(le.SEQUENCIA_ESTAGIO) ULTIMA_SEQ_ESTAGIO
  , sum(
      ( 1
      + le.QTDE_PECAS_PROG
      + le.QTDE_EM_PRODUCAO_PACOTE
      + le.QTDE_PECAS_PROD
      )
    * (1 + le.CODIGO_ESTAGIO)
    * (1 + mod(le.ORDEM_CONFECCAO, 111))
    ) trail
  FROM PCPC_040 le -- lote estágio
  LEFT JOIN BASI_220 t
    ON t.TAMANHO_REF = le.PROCONF_SUBGRUPO
  WHERE le.ORDEM_PRODUCAO = 2623
    AND le.ORDEM_CONFECCAO = 13183
    AND le.QTDE_PECAS_PROG IS NOT NULL
    AND le.QTDE_PECAS_PROG <> 0
  GROUP BY
    le.ORDEM_PRODUCAO
  , le.PERIODO_PRODUCAO
  , le.ORDEM_CONFECCAO
  , le.PROCONF_GRUPO
  , le.PROCONF_SUBGRUPO
  , t.ORDEM_TAMANHO
  , le.PROCONF_ITEM
  , le.QTDE_PECAS_PROG
  ORDER BY
    le.ORDEM_PRODUCAO
  , le.ORDEM_CONFECCAO
) lote
LEFT JOIN PCPC_040 l -- lote estágio
  ON l.ORDEM_PRODUCAO = lote.OP
 AND l.ORDEM_CONFECCAO = lote.OC
 AND l.QTDE_EM_PRODUCAO_PACOTE <> 0
LEFT JOIN PCPC_040 lf -- lote estágio
  ON l.ORDEM_CONFECCAO IS NULL
 AND lf.ORDEM_PRODUCAO = lote.OP
 AND lf.ORDEM_CONFECCAO = lote.OC
 AND (  (   lote.ULTIMA_SEQ_ESTAGIO = 0
        AND lf.CODIGO_ESTAGIO = lote.ULTIMO_ESTAGIO)
     OR (   lote.ULTIMA_SEQ_ESTAGIO <> 0
        AND lf.SEQUENCIA_ESTAGIO = lote.ULTIMA_SEQ_ESTAGIO)
     )
;

SELECT
  x.CODIGO_ROLO
, x.ORDEM_PRODUCAO
, x.ROLO_ESTOQUE
, x.TRANSACAO_CARDEX
, x.DATA_CARDEX
, x.*
FROM PCPT_020 x -- cadastro de rolos
WHERE 1=1
--  AND x.ROLO_ESTOQUE = 3
--  AND x.CODIGO_ROLO = 1009 -- 11443
--  AND x.CODIGO_ROLO = 11019
--  AND x.ORDEM_PRODUCAO <> 0
ORDER BY
  x.CODIGO_ROLO DESC
;


SELECT
  x.*
FROM PCPT_020 x -- cadastro de rolos
WHERE x.CODIGO_ROLO IN (13633, 13638, 13636, 13631)
;

SELECT
  x.*
FROM TMRP_141 x -- reserva de rolo para OP
WHERE x.CODIGO_ROLO IN (13633, 13638, 13636, 13631)
--WHERE x.NUMERO_LOTE = 158713
;

SELECT
  x.*
FROM PCPT_025 x -- confirmação de rolo para OP
WHERE x.CODIGO_ROLO IN (13633, 13638, 13636, 13631)
;

SELECT
  x.*
FROM EFIC_100 x -- rejeição de rolo
WHERE x.CODIGO_ROLO IN (13633, 13638, 13636, 13631)
;

SELECT
  x.*
FROM ESTQ_073 x -- romaneio/inventário rolo
WHERE x.CODIGO_ROLO IN (13633, 13638, 13636, 13631)
;

SELECT
  x.*
FROM TMRP_615 x -- ? rolo
WHERE x.CODIGO_ROLO IN (13633, 13638, 13636, 13631)
;

SELECT
  r.DISTRIBUICAO_COR
, r.GRADE_DISTRIBUICAO
, r.PRIORIDADE_DISTRIBUICAO
, r.*
FROM basi_010 r
WHERE r.GRUPO_ESTRUTURA = 'A0613'
  AND r.SUBGRU_ESTRUTURA IN ('P', 'M')
  AND r.ITEM_ESTRUTURA = '0000BR'
;

SELECT
  x.*
FROM BASI_632 x -- Grade do Agrupador - distribuição_cor
--WHERE x.CODIGO_ROLO = 15054
;


SELECT
  x.*
FROM PCPC_010 x -- período
WHERE x.PERIODO_PRODUCAO = 1826
;


SELECT
  prev.NR_SOLICITACAO NR
, prev.DESCRICAO PREV_DESCR
, p.PERIODO_PRODUCAO
, p.DATA_INI_PERIODO INI_PERIODO
, p.DATA_INI_PERIODO - 7 DT_NECESSIDADE
, prev.NIVEL_ESTRUTURA NIVEL
, prev.GRUPO_ESTRUTURA REF
, ir.DESCR_REFERENCIA REF_DESCR
, ic.ITEM_ESTRUTURA COR
, it.TAMANHO_REF TAM
, SUM(
  prev.QTDE_NEC_BRUTAS
  /
  CASE WHEN prev.ITEM_ESTRUTURA = '000000'
  THEN
    ( SELECT
        count(*)
      FROM BASI_010 icc -- item cor contador
      WHERE icc.NIVEL_ESTRUTURA = ic.NIVEL_ESTRUTURA
        AND icc.GRUPO_ESTRUTURA = ic.GRUPO_ESTRUTURA
        AND icc.SUBGRU_ESTRUTURA = ic.SUBGRU_ESTRUTURA
    )
  ELSE 1
  END
  /
  CASE WHEN prev.SUBGRU_ESTRUTURA = '000'
  THEN
    ( SELECT
        count(*)
      FROM BASI_020 itc -- item tamanho contador
      WHERE itc.BASI030_NIVEL030 = it.BASI030_NIVEL030
        AND itc.BASI030_REFERENC = it.BASI030_REFERENC
    )
  ELSE 1
  END
  ) QTD
, CASE WHEN prev.ALTERNATIVA = 0
  THEN ic.NUMERO_ALTERNATI
  ELSE prev.ALTERNATIVA
  END ALT
FROM RCNB_020 prev
LEFT JOIN BASI_030 ir -- combinação referencia
   ON ir.NIVEL_ESTRUTURA = prev.NIVEL_ESTRUTURA
  AND ir.REFERENCIA = prev.GRUPO_ESTRUTURA
LEFT JOIN BASI_020 it -- combinação tam
  ON ( prev.SUBGRU_ESTRUTURA = '000'
     OR it.TAMANHO_REF = prev.SUBGRU_ESTRUTURA
     )
 AND it.BASI030_NIVEL030 = prev.NIVEL_ESTRUTURA
 AND it.BASI030_REFERENC = prev.GRUPO_ESTRUTURA
LEFT JOIN BASI_220 tam
  ON tam.TAMANHO_REF = it.TAMANHO_REF
LEFT JOIN BASI_010 ic -- combinação cor
  ON ( prev.ITEM_ESTRUTURA = '000000'
     OR ic.ITEM_ESTRUTURA = prev.ITEM_ESTRUTURA
     )
 AND ic.NIVEL_ESTRUTURA = prev.NIVEL_ESTRUTURA
 AND ic.GRUPO_ESTRUTURA = prev.GRUPO_ESTRUTURA
 AND ic.SUBGRU_ESTRUTURA = it.TAMANHO_REF
JOIN PCPC_010 p
  ON p.PERIODO_PRODUCAO = SUBSTR(prev.DESCRICAO, 1, 4)
 AND p.AREA_PERIODO = 1
   -- filtro_date
WHERE 1=1
  AND prev.DESCRICAO LIKE '1826 %' -- filtro_periodo
GROUP BY
  prev.NR_SOLICITACAO
, prev.DESCRICAO
, p.PERIODO_PRODUCAO
, p.DATA_INI_PERIODO
, p.DATA_INI_PERIODO - 7
, prev.NIVEL_ESTRUTURA
, prev.GRUPO_ESTRUTURA
, ic.ITEM_ESTRUTURA
, tam.ORDEM_TAMANHO
, it.TAMANHO_REF
, CASE WHEN prev.ALTERNATIVA = 0
  THEN ic.NUMERO_ALTERNATI
  ELSE prev.ALTERNATIVA
  END
ORDER BY
  prev.NIVEL_ESTRUTURA
, prev.GRUPO_ESTRUTURA
, ic.ITEM_ESTRUTURA
, tam.ORDEM_TAMANHO
;

SELECT
  itc.*
FROM BASI_020 itc -- item tamanho
;

WITH previsao AS (
SELECT
  prev.NR_SOLICITACAO NR
, prev.DESCRICAO PREV_DESCR
, p.PERIODO_PRODUCAO
, p.DATA_INI_PERIODO INI_PERIODO
, p.DATA_INI_PERIODO - 7 DT_NECESSIDADE
, prev.NIVEL_ESTRUTURA NIVEL
, prev.GRUPO_ESTRUTURA REF
, ir.DESCR_REFERENCIA REF_DESCR
, ic.ITEM_ESTRUTURA COR
, ic.DESCRICAO_15 COR_DESCR
, it.TAMANHO_REF TAM
, it.DESCR_TAM_REFER TAM_DESCR
, tam.ORDEM_TAMANHO ORD_TAM
, SUM(prev.QTDE_NEC_BRUTAS) QTDE_NEC_BRUTAS
, MAX(
  CASE WHEN prev.ITEM_ESTRUTURA = '000000'
  THEN
    ( SELECT
        MIN(icc.ITEM_ESTRUTURA)
      FROM BASI_010 icc -- item cor contador
      WHERE icc.NIVEL_ESTRUTURA = ic.NIVEL_ESTRUTURA
        AND icc.GRUPO_ESTRUTURA = ic.GRUPO_ESTRUTURA
        AND icc.SUBGRU_ESTRUTURA = ic.SUBGRU_ESTRUTURA
    )
  ELSE prev.ITEM_ESTRUTURA
  END
  ) MIN_COR
, MAX(
  CASE WHEN prev.ITEM_ESTRUTURA = '000000'
  THEN
    ( SELECT
        count(*)
      FROM BASI_010 icc -- item cor contador
      WHERE icc.NIVEL_ESTRUTURA = ic.NIVEL_ESTRUTURA
        AND icc.GRUPO_ESTRUTURA = ic.GRUPO_ESTRUTURA
        AND icc.SUBGRU_ESTRUTURA = ic.SUBGRU_ESTRUTURA
    )
  ELSE 1
  END
  ) COUNT_COR
, MAX(
  CASE WHEN prev.SUBGRU_ESTRUTURA = '000'
  THEN
    ( SELECT
        MIN(tamc.ORDEM_TAMANHO)
      FROM BASI_020 itc -- item tamanho contador
      LEFT JOIN BASI_220 tamc
        ON tamc.TAMANHO_REF = itc.TAMANHO_REF
      WHERE itc.BASI030_NIVEL030 = it.BASI030_NIVEL030
        AND itc.BASI030_REFERENC = it.BASI030_REFERENC
    )
  ELSE 0
  END
  ) MIN_ORD_TAM
, MAX(
  CASE WHEN prev.SUBGRU_ESTRUTURA = '000'
  THEN
    ( SELECT
        count(*)
      FROM BASI_020 itc -- item tamanho contador
      WHERE itc.BASI030_NIVEL030 = it.BASI030_NIVEL030
        AND itc.BASI030_REFERENC = it.BASI030_REFERENC
    )
  ELSE 1
  END
  ) COUNT_TAM
, CASE WHEN prev.ALTERNATIVA = 0
  THEN ic.NUMERO_ALTERNATI
  ELSE prev.ALTERNATIVA
  END ALT
FROM RCNB_020 prev
LEFT JOIN BASI_030 ir -- combinação referencia
   ON ir.NIVEL_ESTRUTURA = prev.NIVEL_ESTRUTURA
  AND ir.REFERENCIA = prev.GRUPO_ESTRUTURA
LEFT JOIN BASI_020 it -- combinação tam
  ON ( prev.SUBGRU_ESTRUTURA = '000'
     OR it.TAMANHO_REF = prev.SUBGRU_ESTRUTURA
     )
 AND it.BASI030_NIVEL030 = prev.NIVEL_ESTRUTURA
 AND it.BASI030_REFERENC = prev.GRUPO_ESTRUTURA
LEFT JOIN BASI_220 tam
  ON tam.TAMANHO_REF = it.TAMANHO_REF
LEFT JOIN BASI_010 ic -- combinação cor
  ON ( prev.ITEM_ESTRUTURA = '000000'
     OR ic.ITEM_ESTRUTURA = prev.ITEM_ESTRUTURA
     )
 AND ic.NIVEL_ESTRUTURA = prev.NIVEL_ESTRUTURA
 AND ic.GRUPO_ESTRUTURA = prev.GRUPO_ESTRUTURA
 AND ic.SUBGRU_ESTRUTURA = it.TAMANHO_REF
JOIN PCPC_010 p
  ON p.PERIODO_PRODUCAO = SUBSTR(prev.DESCRICAO, 1, 4)
 AND p.AREA_PERIODO = 1
   -- filtro_date
WHERE 1=1
  AND prev.DESCRICAO LIKE '1826 %' -- filtro_periodo
GROUP BY
  prev.NR_SOLICITACAO
, prev.DESCRICAO
, p.PERIODO_PRODUCAO
, p.DATA_INI_PERIODO
, p.DATA_INI_PERIODO - 7
, prev.NIVEL_ESTRUTURA
, prev.GRUPO_ESTRUTURA
, ir.DESCR_REFERENCIA
, ic.ITEM_ESTRUTURA
, ic.DESCRICAO_15
, tam.ORDEM_TAMANHO
, it.TAMANHO_REF
, it.DESCR_TAM_REFER
, CASE WHEN prev.ALTERNATIVA = 0
  THEN ic.NUMERO_ALTERNATI
  ELSE prev.ALTERNATIVA
  END
ORDER BY
  prev.NIVEL_ESTRUTURA
, prev.GRUPO_ESTRUTURA
, ic.ITEM_ESTRUTURA
, tam.ORDEM_TAMANHO
)
SELECT
  pp.NR
, pp.PREV_DESCR
, pp.PERIODO_PRODUCAO
, pp.INI_PERIODO
, pp.DT_NECESSIDADE
, pp.NIVEL
, pp.REF
, pp.REF_DESCR
, pp.COR
, pp.COR_DESCR
, pp.MIN_COR
, pp.TAM
, pp.TAM_DESCR
, pp.ORD_TAM
, pp.MIN_ORD_TAM
, pp.ALT
, CASE WHEN pp.COR = pp.MIN_COR AND pp.ORD_TAM = pp.MIN_ORD_TAM
  THEN
    pp.QTDE_NEC_BRUTAS -
    (
      TRUNC(
        pp.QTDE_NEC_BRUTAS
        / pp.COUNT_COR
        / pp.COUNT_TAM
      )
    * ((pp.COUNT_COR * pp.COUNT_TAM) - 1)
    )
  ELSE
    TRUNC(
      pp.QTDE_NEC_BRUTAS
      / pp.COUNT_COR
      / pp.COUNT_TAM
    )
  END QTD
--, pp.*
FROM previsao pp
;

SELECT
  iac.NIVEL_ITEM
, ia.*
FROM basi_030 r -- referencia
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = r.NIVEL_ESTRUTURA
 AND ia.GRUPO_ITEM = r.REFERENCIA
LEFT JOIN BASI_040 iac -- insumos de alternativa combinação (cor/tam)
  ON iac.NIVEL_ITEM = ia.NIVEL_ITEM
 AND iac.GRUPO_ITEM = ia.GRUPO_ITEM
 AND iac.SEQUENCIA = ia.SEQUENCIA
WHERE r.NIVEL_ESTRUTURA = 1
  AND r.REFERENCIA < '99999'
  AND r.CGC_CLIENTE_9 = 92754738 -- Renner
  AND ia.NIVEL_COMP = 9
  AND ia.GRUPO_COMP in ('-EB001', 'CX001', '-CA029')
;

SELECT
  r.REFERENCIA
, ia.SUB_ITEM
, ia.ITEM_ITEM
, ia.ALTERNATIVA_ITEM
, count(*) CONTA
FROM basi_030 r -- referencia
LEFT JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = r.NIVEL_ESTRUTURA
 AND ia.GRUPO_ITEM = r.REFERENCIA
 AND ia.NIVEL_COMP = 9
 AND ia.GRUPO_COMP in ('EB001', '-CX001', '-CA029')
WHERE r.NIVEL_ESTRUTURA = 1
  AND r.REFERENCIA < '99999'
  AND r.CGC_CLIENTE_9 = 92754738 -- Renner
GROUP BY
  r.REFERENCIA
, ia.SUB_ITEM
, ia.ITEM_ITEM
, ia.ALTERNATIVA_ITEM
--HAVING
--  count(ia.GRUPO_COMP) = 0
;

-- falta EB001
SELECT DISTINCT
  r.REFERENCIA
FROM basi_030 r -- referencia
LEFT JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = r.NIVEL_ESTRUTURA
 AND ia.GRUPO_ITEM = r.REFERENCIA
 AND ia.NIVEL_COMP = 9
 AND ia.GRUPO_COMP in 'EB001'
WHERE r.NIVEL_ESTRUTURA = 1
  AND r.REFERENCIA < '99999'
  AND r.CGC_CLIENTE_9 = 92754738 -- Renner
  AND ia.GRUPO_ITEM IS NULL
;

-- falta qq insumo
SELECT DISTINCT
  r.REFERENCIA
FROM basi_030 r -- referencia
LEFT JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = r.NIVEL_ESTRUTURA
 AND ia.GRUPO_ITEM = r.REFERENCIA
WHERE r.NIVEL_ESTRUTURA = 1
  AND r.REFERENCIA < '99999'
  AND r.CGC_CLIENTE_9 = 92754738 -- Renner
  AND ia.GRUPO_ITEM IS NULL
;

-- não tem EB001, mas não é vazio
SELECT
  r.REFERENCIA
FROM basi_030 r -- referencia
WHERE r.REFERENCIA IN (
    SELECT DISTINCT
      r.REFERENCIA
    FROM basi_030 r -- referencia
    LEFT JOIN BASI_050 ia -- insumos de alternativa
      ON ia.NIVEL_ITEM = r.NIVEL_ESTRUTURA
     AND ia.GRUPO_ITEM = r.REFERENCIA
     AND ia.NIVEL_COMP = 9
     AND ia.GRUPO_COMP in 'EB001'
    WHERE r.NIVEL_ESTRUTURA = 1
      AND r.REFERENCIA < '99999'
      AND r.CGC_CLIENTE_9 = 92754738 -- Renner
      AND ia.GRUPO_ITEM IS NULL
  )
  AND r.REFERENCIA NOT IN (
    SELECT DISTINCT
      r.REFERENCIA
    FROM basi_030 r -- referencia
    LEFT JOIN BASI_050 ia -- insumos de alternativa
      ON ia.NIVEL_ITEM = r.NIVEL_ESTRUTURA
     AND ia.GRUPO_ITEM = r.REFERENCIA
    WHERE r.NIVEL_ESTRUTURA = 1
      AND r.REFERENCIA < '99999'
      AND r.CGC_CLIENTE_9 = 92754738 -- Renner
      AND ia.GRUPO_ITEM IS NULL
  )
;

SELECT
  ia.*
FROM BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_ITEM = 1
  AND ia.GRUPO_ITEM < '99999'
  AND ( SELECT max(r.CGC_CLIENTE_9)
        FROM basi_030 r
        WHERE r.NIVEL_ESTRUTURA = ia.NIVEL_ITEM
          AND r.REFERENCIA = ia.GRUPO_ITEM
      ) = 92754738 -- Renner
  AND ia.NIVEL_COMP = 9
  AND ia.GRUPO_COMP in ('EB001', '-CX001', '-CA029')
;

SELECT
  ia.*
FROM BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_ITEM = 1
  AND ia.GRUPO_ITEM = '0619R'
  AND ia.ALTERNATIVA_ITEM = 1
  AND ia.NIVEL_COMP = 9
  AND ia.GRUPO_COMP in 'EB001'
;

INSERT INTO SYSTEXTIL.BASI_050
(NIVEL_ITEM, GRUPO_ITEM, SUB_ITEM, ITEM_ITEM, ALTERNATIVA_ITEM, SEQUENCIA, NIVEL_COMP, GRUPO_COMP, SUB_COMP, ITEM_COMP, ALTERNATIVA_COMP, CONSUMO, ESTAGIO, TIPO_CALCULO, LETRA_GRAFICO, QTDE_CAMADAS, PERCENT_PERDAS, NUMERO_GRAFICO, QTDE_INICIAL, QTDE_FINAL, TENSAO, LFA, LOTE, FORNECEDOR, CONS_UN_REC, SEQ_PRINCIPAL, GRUPO_SIMILARES, CENTRO_CUSTO, CONS_UNID_MED_GENERICA, PERC_CONS_CALC, CALCULA_COMPOSICAO, RELACAO_BANHO, QTDE_PECAS_ESTAMPADAS, TIPO_TELA, AREA_COBERTURA, TIPO_APLICACAO, TIPO_MEDIDA, CODIGO_PROJETO, SEQUENCIA_PROJETO, TECIDO_PRINCIPAL, VALOR_ML_L, FATOR_CONVERSOR, QTDE_CABOS, VARIACAO, AGRUP_TINGIMENTO, QTDE_PECAS)
-- gera o select a ser incluido dos componentes faltantes
WITH falta AS
(
  SELECT
    r.REFERENCIA REFERENCIA_FALTANTE
  , max(ia.SEQUENCIA) MAX_SEQUENCIA
  FROM basi_030 r -- referencia
  LEFT JOIN BASI_050 ia -- insumos de alternativa
    ON ia.NIVEL_ITEM = r.NIVEL_ESTRUTURA
   AND ia.GRUPO_ITEM = r.REFERENCIA
  WHERE r.REFERENCIA IN (
      SELECT DISTINCT
        r.REFERENCIA
      FROM basi_030 r -- referencia
      LEFT JOIN BASI_050 ia -- insumos de alternativa
        ON ia.NIVEL_ITEM = r.NIVEL_ESTRUTURA
       AND ia.GRUPO_ITEM = r.REFERENCIA
       AND ia.NIVEL_COMP = 9
       AND ia.GRUPO_COMP in 'EB001'
      WHERE r.NIVEL_ESTRUTURA = 1
        AND r.REFERENCIA < '99999'
        AND r.CGC_CLIENTE_9 = 92754738 -- Renner
        AND ia.GRUPO_ITEM IS NULL
    )
    AND r.REFERENCIA NOT IN (
      SELECT DISTINCT
        r.REFERENCIA
      FROM basi_030 r -- referencia
      LEFT JOIN BASI_050 ia -- insumos de alternativa
        ON ia.NIVEL_ITEM = r.NIVEL_ESTRUTURA
       AND ia.GRUPO_ITEM = r.REFERENCIA
      WHERE r.NIVEL_ESTRUTURA = 1
        AND r.REFERENCIA < '99999'
        AND r.CGC_CLIENTE_9 = 92754738 -- Renner
        AND ia.GRUPO_ITEM IS NULL
    )
  GROUP BY
    r.REFERENCIA
)
SELECT
  NIVEL_ITEM
, f.REFERENCIA_FALTANTE GRUPO_ITEM
, SUB_ITEM, ITEM_ITEM, ALTERNATIVA_ITEM
, f.MAX_SEQUENCIA + 10 SEQUENCIA
, NIVEL_COMP, GRUPO_COMP, SUB_COMP, ITEM_COMP, ALTERNATIVA_COMP, CONSUMO, ESTAGIO, TIPO_CALCULO, LETRA_GRAFICO, QTDE_CAMADAS, PERCENT_PERDAS, NUMERO_GRAFICO, QTDE_INICIAL, QTDE_FINAL, TENSAO, LFA, LOTE, FORNECEDOR, CONS_UN_REC, SEQ_PRINCIPAL, GRUPO_SIMILARES, CENTRO_CUSTO, CONS_UNID_MED_GENERICA, PERC_CONS_CALC, CALCULA_COMPOSICAO, RELACAO_BANHO, QTDE_PECAS_ESTAMPADAS, TIPO_TELA, AREA_COBERTURA, TIPO_APLICACAO, TIPO_MEDIDA, CODIGO_PROJETO, SEQUENCIA_PROJETO, TECIDO_PRINCIPAL, VALOR_ML_L, FATOR_CONVERSOR, QTDE_CABOS, VARIACAO, AGRUP_TINGIMENTO, QTDE_PECAS
FROM falta f, BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_ITEM = 1
  AND ia.GRUPO_ITEM = '0619R'
  AND ia.ALTERNATIVA_ITEM = 1
  AND ia.NIVEL_COMP = 9
  AND ia.GRUPO_COMP in 'EB001'
;

SELECT
  ia.*
FROM BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_ITEM = 1
  AND ia.GRUPO_ITEM = '0617R'
;

-- não tem CX001, mas não é vazio
SELECT DISTINCT
  r.REFERENCIA REFERENCIA_FALTANTE
, ia.ALTERNATIVA_ITEM ALTERNATIVA_ITEM_FALTANTE
FROM basi_030 r -- referencia
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = r.NIVEL_ESTRUTURA
 AND ia.GRUPO_ITEM = r.REFERENCIA
WHERE r.REFERENCIA IN (
    SELECT DISTINCT
      r.REFERENCIA
    FROM basi_030 r -- referencia
    LEFT JOIN BASI_050 ia -- insumos de alternativa
      ON ia.NIVEL_ITEM = r.NIVEL_ESTRUTURA
     AND ia.GRUPO_ITEM = r.REFERENCIA
     AND ia.NIVEL_COMP = 9
     AND ia.GRUPO_COMP in 'CX001'
    WHERE r.NIVEL_ESTRUTURA = 1
      AND r.REFERENCIA < '99999'
      AND r.CGC_CLIENTE_9 = 92754738 -- Renner
      AND ia.GRUPO_ITEM IS NULL
  )
  AND r.REFERENCIA NOT IN (
    SELECT DISTINCT
      r.REFERENCIA
    FROM basi_030 r -- referencia
    LEFT JOIN BASI_050 ia -- insumos de alternativa
      ON ia.NIVEL_ITEM = r.NIVEL_ESTRUTURA
     AND ia.GRUPO_ITEM = r.REFERENCIA
    WHERE r.NIVEL_ESTRUTURA = 1
      AND r.REFERENCIA < '99999'
      AND r.CGC_CLIENTE_9 = 92754738 -- Renner
      AND ia.GRUPO_ITEM IS NULL
  )
;

SELECT
  ia.*
FROM BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_ITEM = 1
  AND ia.GRUPO_ITEM = '06996'
  AND ia.ALTERNATIVA_ITEM = 5
  AND ia.NIVEL_COMP = 9
  AND ia.GRUPO_COMP in 'CX001'
;

INSERT INTO SYSTEXTIL.BASI_050
(NIVEL_ITEM, GRUPO_ITEM, SUB_ITEM, ITEM_ITEM, ALTERNATIVA_ITEM, SEQUENCIA, NIVEL_COMP, GRUPO_COMP, SUB_COMP, ITEM_COMP, ALTERNATIVA_COMP, CONSUMO, ESTAGIO, TIPO_CALCULO, LETRA_GRAFICO, QTDE_CAMADAS, PERCENT_PERDAS, NUMERO_GRAFICO, QTDE_INICIAL, QTDE_FINAL, TENSAO, LFA, LOTE, FORNECEDOR, CONS_UN_REC, SEQ_PRINCIPAL, GRUPO_SIMILARES, CENTRO_CUSTO, CONS_UNID_MED_GENERICA, PERC_CONS_CALC, CALCULA_COMPOSICAO, RELACAO_BANHO, QTDE_PECAS_ESTAMPADAS, TIPO_TELA, AREA_COBERTURA, TIPO_APLICACAO, TIPO_MEDIDA, CODIGO_PROJETO, SEQUENCIA_PROJETO, TECIDO_PRINCIPAL, VALOR_ML_L, FATOR_CONVERSOR, QTDE_CABOS, VARIACAO, AGRUP_TINGIMENTO, QTDE_PECAS)
-- errado!!!!!!!!!!!!!!
-- gera o select a ser incluido dos componentes faltantes
WITH falta AS
(
  SELECT DISTINCT
    r.REFERENCIA REFERENCIA_FALTANTE
  , ia.ALTERNATIVA_ITEM ALTERNATIVA_ITEM_FALTANTE
  , max(ia.SEQUENCIA) MAX_SEQUENCIA
  FROM basi_030 r -- referencia
  JOIN BASI_050 ia -- insumos de alternativa
    ON ia.NIVEL_ITEM = r.NIVEL_ESTRUTURA
   AND ia.GRUPO_ITEM = r.REFERENCIA
  WHERE r.REFERENCIA IN (
      SELECT DISTINCT
        ir.REFERENCIA
      FROM basi_030 ir -- referencia
      LEFT JOIN BASI_050 iia -- insumos de alternativa
        ON iia.NIVEL_ITEM = ir.NIVEL_ESTRUTURA
       AND iia.GRUPO_ITEM = ir.REFERENCIA
       AND iia.NIVEL_COMP = 9
       AND ia.GRUPO_COMP in 'CX001'
      WHERE ir.NIVEL_ESTRUTURA = 1
        AND ir.REFERENCIA < '99999'
        AND ir.CGC_CLIENTE_9 = 92754738 -- Renner
        AND iia.GRUPO_ITEM IS NULL
    )
    AND r.REFERENCIA NOT IN (
      SELECT DISTINCT
        r.REFERENCIA
      FROM basi_030 r -- referencia
      LEFT JOIN BASI_050 ia -- insumos de alternativa
        ON ia.NIVEL_ITEM = r.NIVEL_ESTRUTURA
       AND ia.GRUPO_ITEM = r.REFERENCIA
      WHERE r.NIVEL_ESTRUTURA = 1
        AND r.REFERENCIA < '99999'
        AND r.CGC_CLIENTE_9 = 92754738 -- Renner
        AND ia.GRUPO_ITEM IS NULL
    )
  GROUP BY
    r.REFERENCIA
  , ia.ALTERNATIVA_ITEM
)
SELECT
  NIVEL_ITEM
, f.REFERENCIA_FALTANTE GRUPO_ITEM
, SUB_ITEM, ITEM_ITEM
, f.ALTERNATIVA_ITEM_FALTANTE ALTERNATIVA_ITEM
, f.MAX_SEQUENCIA + 10 SEQUENCIA
, NIVEL_COMP, GRUPO_COMP, SUB_COMP, ITEM_COMP, ALTERNATIVA_COMP, CONSUMO, ESTAGIO, TIPO_CALCULO, LETRA_GRAFICO, QTDE_CAMADAS, PERCENT_PERDAS, NUMERO_GRAFICO, QTDE_INICIAL, QTDE_FINAL, TENSAO, LFA, LOTE, FORNECEDOR, CONS_UN_REC, SEQ_PRINCIPAL, GRUPO_SIMILARES, CENTRO_CUSTO, CONS_UNID_MED_GENERICA, PERC_CONS_CALC, CALCULA_COMPOSICAO, RELACAO_BANHO, QTDE_PECAS_ESTAMPADAS, TIPO_TELA, AREA_COBERTURA, TIPO_APLICACAO, TIPO_MEDIDA, CODIGO_PROJETO, SEQUENCIA_PROJETO, TECIDO_PRINCIPAL, VALOR_ML_L, FATOR_CONVERSOR, QTDE_CABOS, VARIACAO, AGRUP_TINGIMENTO, QTDE_PECAS
FROM falta f, BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_ITEM = 1
  AND ia.GRUPO_ITEM = '06996'
  AND ia.ALTERNATIVA_ITEM = 5
  AND ia.NIVEL_COMP = 9
  AND ia.GRUPO_COMP in 'CX001'
;

-- Renner PA sem CX001
-- COM estrutura porém SEM insumo buscado
SELECT DISTINCT
  iae.GRUPO_ITEM GRUPO_ITEM_FALTANTE
, iae.ALTERNATIVA_ITEM ALTERNATIVA_ITEM_FALTANTE
, max(iae.SEQUENCIA) MAX_SEQUENCIA
FROM BASI_050 iae -- insumos de alternativa existente
JOIN BASI_030 re -- referencia
  ON re.NIVEL_ESTRUTURA = iae.NIVEL_ITEM
 AND re.REFERENCIA = iae.GRUPO_ITEM
LEFT JOIN BASI_050 iab -- insumos de alternativa com insumo buscado
  ON iab.NIVEL_ITEM = iae.NIVEL_ITEM
 AND iab.GRUPO_ITEM = iae.GRUPO_ITEM
 AND iab.NIVEL_COMP = 9
 AND iab.GRUPO_COMP in 'CX001'
WHERE re.NIVEL_ESTRUTURA = 1
  AND re.REFERENCIA < '99999'
  AND re.CGC_CLIENTE_9 = 92754738 -- Renner
  AND iab.GRUPO_ITEM IS NULL
GROUP BY
  iae.GRUPO_ITEM
, iae.ALTERNATIVA_ITEM
ORDER BY
  iae.GRUPO_ITEM
, iae.ALTERNATIVA_ITEM
;

-- insere componentes faltantes em estruturas existentes
INSERT INTO SYSTEXTIL.BASI_050
(NIVEL_ITEM, GRUPO_ITEM, SUB_ITEM, ITEM_ITEM, ALTERNATIVA_ITEM, SEQUENCIA, NIVEL_COMP, GRUPO_COMP, SUB_COMP, ITEM_COMP, ALTERNATIVA_COMP, CONSUMO, ESTAGIO, TIPO_CALCULO, LETRA_GRAFICO, QTDE_CAMADAS, PERCENT_PERDAS, NUMERO_GRAFICO, QTDE_INICIAL, QTDE_FINAL, TENSAO, LFA, LOTE, FORNECEDOR, CONS_UN_REC, SEQ_PRINCIPAL, GRUPO_SIMILARES, CENTRO_CUSTO, CONS_UNID_MED_GENERICA, PERC_CONS_CALC, CALCULA_COMPOSICAO, RELACAO_BANHO, QTDE_PECAS_ESTAMPADAS, TIPO_TELA, AREA_COBERTURA, TIPO_APLICACAO, TIPO_MEDIDA, CODIGO_PROJETO, SEQUENCIA_PROJETO, TECIDO_PRINCIPAL, VALOR_ML_L, FATOR_CONVERSOR, QTDE_CABOS, VARIACAO, AGRUP_TINGIMENTO, QTDE_PECAS)
-- gera o select a ser incluido dos componentes faltantes
WITH falta AS
(
  -- Renner PA sem CX001
  SELECT DISTINCT
    iae.GRUPO_ITEM GRUPO_ITEM_FALTANTE
  , iae.ALTERNATIVA_ITEM ALTERNATIVA_ITEM_FALTANTE
  , max(iae.SEQUENCIA) MAX_SEQUENCIA
  FROM BASI_050 iae -- insumos de alternativa existente
  JOIN BASI_030 re -- referencia
    ON re.NIVEL_ESTRUTURA = iae.NIVEL_ITEM
   AND re.REFERENCIA = iae.GRUPO_ITEM
  LEFT JOIN BASI_050 iab -- insumos de alternativa com insumo buscado
    ON iab.NIVEL_ITEM = iae.NIVEL_ITEM
   AND iab.GRUPO_ITEM = iae.GRUPO_ITEM
   AND iab.NIVEL_COMP = 9
   AND iab.GRUPO_COMP in 'CX001'
  WHERE re.NIVEL_ESTRUTURA = 1
    AND re.REFERENCIA < '99999'
    AND re.CGC_CLIENTE_9 = 92754738 -- Renner
    AND iab.GRUPO_ITEM IS NULL
  GROUP BY
    iae.GRUPO_ITEM
  , iae.ALTERNATIVA_ITEM
  ORDER BY
    iae.GRUPO_ITEM
  , iae.ALTERNATIVA_ITEM
)
SELECT
  NIVEL_ITEM
, f.GRUPO_ITEM_FALTANTE GRUPO_ITEM
, SUB_ITEM, ITEM_ITEM
, f.ALTERNATIVA_ITEM_FALTANTE ALTERNATIVA_ITEM
, f.MAX_SEQUENCIA + 10 SEQUENCIA
, NIVEL_COMP, GRUPO_COMP, SUB_COMP, ITEM_COMP, ALTERNATIVA_COMP, CONSUMO, ESTAGIO, TIPO_CALCULO, LETRA_GRAFICO, QTDE_CAMADAS, PERCENT_PERDAS, NUMERO_GRAFICO, QTDE_INICIAL, QTDE_FINAL, TENSAO, LFA, LOTE, FORNECEDOR, CONS_UN_REC, SEQ_PRINCIPAL, GRUPO_SIMILARES, CENTRO_CUSTO, CONS_UNID_MED_GENERICA, PERC_CONS_CALC, CALCULA_COMPOSICAO, RELACAO_BANHO, QTDE_PECAS_ESTAMPADAS, TIPO_TELA, AREA_COBERTURA, TIPO_APLICACAO, TIPO_MEDIDA, CODIGO_PROJETO, SEQUENCIA_PROJETO, TECIDO_PRINCIPAL, VALOR_ML_L, FATOR_CONVERSOR, QTDE_CABOS, VARIACAO, AGRUP_TINGIMENTO, QTDE_PECAS
FROM falta f, BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_ITEM = 1
  AND ia.GRUPO_ITEM = '06996'
  AND ia.ALTERNATIVA_ITEM = 5
  AND ia.NIVEL_COMP = 9
  AND ia.GRUPO_COMP in 'CX001'
;

-- Renner PA NÃO KIT sem CA029
SELECT DISTINCT
  iae.GRUPO_ITEM GRUPO_ITEM_FALTANTE
, iae.ALTERNATIVA_ITEM ALTERNATIVA_ITEM_FALTANTE
, max(iae.SEQUENCIA) MAX_SEQUENCIA
FROM BASI_050 iae -- insumos de alternativa existente
JOIN BASI_030 re -- referencia
  ON re.NIVEL_ESTRUTURA = iae.NIVEL_ITEM
 AND re.REFERENCIA = iae.GRUPO_ITEM
LEFT JOIN BASI_050 iab -- insumos de alternativa com insumo buscado
  ON iab.NIVEL_ITEM = iae.NIVEL_ITEM
 AND iab.GRUPO_ITEM = iae.GRUPO_ITEM
 AND iab.NIVEL_COMP = 9
 AND iab.GRUPO_COMP in 'CA029'
WHERE re.NIVEL_ESTRUTURA = 1
  AND re.REFERENCIA < '99999'
  AND re.CGC_CLIENTE_9 = 92754738 -- Renner
  AND re.ARTIGO = 1001
  AND iab.GRUPO_ITEM IS NULL
GROUP BY
  iae.GRUPO_ITEM
, iae.ALTERNATIVA_ITEM
ORDER BY
  iae.GRUPO_ITEM
, iae.ALTERNATIVA_ITEM
;

SELECT
  ia.*
FROM BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_ITEM = 1
  AND ia.GRUPO_ITEM = '06996'
  AND ia.ALTERNATIVA_ITEM = 5
  AND ia.NIVEL_COMP = 9
  AND ia.GRUPO_COMP = 'CX001'
;

-- insere componentes faltantes em estruturas existentes
INSERT INTO SYSTEXTIL.BASI_050
(NIVEL_ITEM, GRUPO_ITEM, SUB_ITEM, ITEM_ITEM, ALTERNATIVA_ITEM, SEQUENCIA, NIVEL_COMP, GRUPO_COMP, SUB_COMP, ITEM_COMP, ALTERNATIVA_COMP, CONSUMO, ESTAGIO, TIPO_CALCULO, LETRA_GRAFICO, QTDE_CAMADAS, PERCENT_PERDAS, NUMERO_GRAFICO, QTDE_INICIAL, QTDE_FINAL, TENSAO, LFA, LOTE, FORNECEDOR, CONS_UN_REC, SEQ_PRINCIPAL, GRUPO_SIMILARES, CENTRO_CUSTO, CONS_UNID_MED_GENERICA, PERC_CONS_CALC, CALCULA_COMPOSICAO, RELACAO_BANHO, QTDE_PECAS_ESTAMPADAS, TIPO_TELA, AREA_COBERTURA, TIPO_APLICACAO, TIPO_MEDIDA, CODIGO_PROJETO, SEQUENCIA_PROJETO, TECIDO_PRINCIPAL, VALOR_ML_L, FATOR_CONVERSOR, QTDE_CABOS, VARIACAO, AGRUP_TINGIMENTO, QTDE_PECAS)
-- gera o select a ser incluido dos componentes faltantes
WITH falta AS
(
  -- Renner PA NÃO KIT sem CA029
  SELECT DISTINCT
    iae.GRUPO_ITEM GRUPO_ITEM_FALTANTE
  , iae.ALTERNATIVA_ITEM ALTERNATIVA_ITEM_FALTANTE
  , max(iae.SEQUENCIA) MAX_SEQUENCIA
  FROM BASI_050 iae -- insumos de alternativa existente
  JOIN BASI_030 re -- referencia
    ON re.NIVEL_ESTRUTURA = iae.NIVEL_ITEM
   AND re.REFERENCIA = iae.GRUPO_ITEM
  LEFT JOIN BASI_050 iab -- insumos de alternativa com insumo buscado
    ON iab.NIVEL_ITEM = iae.NIVEL_ITEM
   AND iab.GRUPO_ITEM = iae.GRUPO_ITEM
   AND iab.NIVEL_COMP = 9
   AND iab.GRUPO_COMP in 'CA029'
  WHERE re.NIVEL_ESTRUTURA = 1
    AND re.REFERENCIA < '99999'
    AND re.CGC_CLIENTE_9 = 92754738 -- Renner
    AND re.ARTIGO = 1001
    AND iab.GRUPO_ITEM IS NULL
  GROUP BY
    iae.GRUPO_ITEM
  , iae.ALTERNATIVA_ITEM
  ORDER BY
    iae.GRUPO_ITEM
  , iae.ALTERNATIVA_ITEM
)
SELECT
  NIVEL_ITEM
, f.GRUPO_ITEM_FALTANTE GRUPO_ITEM
, SUB_ITEM, ITEM_ITEM
, f.ALTERNATIVA_ITEM_FALTANTE ALTERNATIVA_ITEM
, f.MAX_SEQUENCIA + 10 SEQUENCIA
, 9 NIVEL_COMP
, 'CA029' GRUPO_COMP
, 'UNI' SUB_COMP
, '0000UN' ITEM_COMP, ALTERNATIVA_COMP
, 0.5 CONSUMO
, 18 ESTAGIO, TIPO_CALCULO, LETRA_GRAFICO, QTDE_CAMADAS, PERCENT_PERDAS, NUMERO_GRAFICO, QTDE_INICIAL, QTDE_FINAL, TENSAO, LFA, LOTE, FORNECEDOR, CONS_UN_REC, SEQ_PRINCIPAL, GRUPO_SIMILARES, CENTRO_CUSTO, CONS_UNID_MED_GENERICA, PERC_CONS_CALC, CALCULA_COMPOSICAO, RELACAO_BANHO, QTDE_PECAS_ESTAMPADAS, TIPO_TELA, AREA_COBERTURA, TIPO_APLICACAO, TIPO_MEDIDA, CODIGO_PROJETO, SEQUENCIA_PROJETO, TECIDO_PRINCIPAL, VALOR_ML_L, FATOR_CONVERSOR, QTDE_CABOS, VARIACAO, AGRUP_TINGIMENTO, QTDE_PECAS
FROM falta f, BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_ITEM = 1
  AND ia.GRUPO_ITEM = '06996'
  AND ia.ALTERNATIVA_ITEM = 5
  AND ia.NIVEL_COMP = 9
  AND ia.GRUPO_COMP in 'CX001'
;

-- Renner PA caixa CX001
-- seleciona a corrigir
SELECT DISTINCT
  ia.*
FROM BASI_050 ia -- insumos de alternativa
JOIN BASI_030 r -- referencia
  ON r.NIVEL_ESTRUTURA = ia.NIVEL_ITEM
 AND r.REFERENCIA = ia.GRUPO_ITEM
WHERE r.NIVEL_ESTRUTURA = 1
  AND r.REFERENCIA < '99999'
  AND r.CGC_CLIENTE_9 = 92754738 -- Renner
  AND ia.GRUPO_COMP = 'CX001'
ORDER BY
  ia.GRUPO_ITEM
, ia.ALTERNATIVA_ITEM
;

-- Renner PA caixa CX001
-- seleciona a corrigir
SELECT DISTINCT
  ia.*
FROM BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_ITEM = 1
  AND ia.GRUPO_ITEM < '99999'
  AND ( SELECT max(r.CGC_CLIENTE_9)
        FROM basi_030 r
        WHERE r.NIVEL_ESTRUTURA = ia.NIVEL_ITEM
          AND r.REFERENCIA = ia.GRUPO_ITEM
      ) = 92754738 -- Renner
  AND ia.GRUPO_COMP = 'CX001'
ORDER BY
  ia.GRUPO_ITEM
, ia.ALTERNATIVA_ITEM
;

-- Renner PA caixa CX001
-- corrige
UPDATE BASI_050 ia -- insumos de alternativa
SET
  ia.SUB_COMP = 'G'
, ia.ESTAGIO = 18
, ia.CONSUMO = 0.02
WHERE ia.NIVEL_ITEM = 1
  AND ia.GRUPO_ITEM < '99999'
  AND ( SELECT max(r.CGC_CLIENTE_9)
        FROM basi_030 r
        WHERE r.NIVEL_ESTRUTURA = ia.NIVEL_ITEM
          AND r.REFERENCIA = ia.GRUPO_ITEM
      ) = 92754738 -- Renner
  AND ia.GRUPO_COMP = 'CX001'
;

-- Renner PA caixa EB001
-- seleciona a corrigir
SELECT DISTINCT
  ia.*
FROM BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_ITEM = 1
  AND ia.GRUPO_ITEM < '99999'
  AND ( SELECT max(r.CGC_CLIENTE_9)
        FROM basi_030 r
        WHERE r.NIVEL_ESTRUTURA = ia.NIVEL_ITEM
          AND r.REFERENCIA = ia.GRUPO_ITEM
      ) = 92754738 -- Renner
  AND ia.GRUPO_COMP = 'EB001'
ORDER BY
  ia.GRUPO_ITEM
, ia.ALTERNATIVA_ITEM
;

-- Renner PA caixa EB001
-- corrige
UPDATE BASI_050 ia -- insumos de alternativa
SET
  ia.SUB_COMP = '3'
, ia.ESTAGIO = 18
, ia.CONSUMO = 0.5
WHERE ia.NIVEL_ITEM = 1
  AND ia.GRUPO_ITEM < '99999'
  AND ( SELECT max(r.CGC_CLIENTE_9)
        FROM basi_030 r
        WHERE r.NIVEL_ESTRUTURA = ia.NIVEL_ITEM
          AND r.REFERENCIA = ia.GRUPO_ITEM
      ) = 92754738 -- Renner
  AND ia.GRUPO_COMP = 'EB001'
;

SELECT
  p.*
FROM PCPC_010 p
WHERE p.PERIODO_PRODUCAO = 1835
  AND p.AREA_PERIODO = 1 -- produção
;

SELECT
  i.CODIGO_BARRAS
, i.*
FROM BASI_010 i
WHERE i.NIVEL_ESTRUTURA='1'
  AND i.GRUPO_ESTRUTURA='05314'
--  AND i.ITEM_ESTRUTURA='0000AZ'
--  AND (i.CODIGO_BARRAS = '' OR i.CODIGO_BARRAS = ' ' OR i.CODIGO_BARRAS IS NULL)
;

WITH previsao AS (
             SELECT
                  1 NIVEL
                , 'M0001' REF
                , '0000AZ' COR
                , 'P' TAM
                , 937 QTD
                , 4 ALT
                FROM SYS.DUAL
             UNION
                SELECT
                  1 NIVEL
                , 'M0001' REF
                , '0000AZ' COR
                , 'P' TAM
                , 945 QTD
                , 4 ALT
                FROM SYS.DUAL
             UNION
                SELECT
                  1 NIVEL
                , 'M0001' REF
                , '0000AZ' COR
                , 'M' TAM
                , 937 QTD
                , 4 ALT
                FROM SYS.DUAL
             -- UNION ...
)
SELECT
  ia.NIVEL_COMP NIVEL
, ia.GRUPO_COMP REF
, ir.DESCR_REFERENCIA REF_DESCR
, CASE WHEN ia.ITEM_COMP = '000000'
  THEN coc.ITEM_COMP
  ELSE ia.ITEM_COMP
  END COR
, ic.DESCRICAO_15 COR_DESCR
, CASE WHEN ia.SUB_COMP = '000'
  THEN cot.SUB_COMP
  ELSE ia.SUB_COMP
  END TAM
, it.DESCR_TAM_REFER TAM_DESCR
, tam.ORDEM_TAMANHO ORD_TAM
, ia.ALTERNATIVA_COMP ALT
, ia.CONSUMO * pre.QTD QTD
FROM previsao pre
JOIN BASI_050 ia -- insumos de alternativa
  ON ia.NIVEL_ITEM = pre.NIVEL
 AND ia.GRUPO_ITEM = pre.REF
 AND (ia.SUB_ITEM = pre.TAM OR ia.SUB_ITEM = '000')
 AND (ia.ITEM_ITEM = pre.COR OR ia.ITEM_ITEM = '000000')
 AND ia.ALTERNATIVA_ITEM = pre.ALT
LEFT JOIN BASI_040 coc -- combinação cor
  ON ia.ITEM_COMP = '000000'
 AND coc.GRUPO_ITEM = pre.REF
 AND coc.ALTERNATIVA_ITEM = pre.ALT
 AND coc.SEQUENCIA = ia.SEQUENCIA
 AND coc.ITEM_ITEM = pre.COR
LEFT JOIN BASI_040 cot -- combinação tamanho
  ON ia.SUB_COMP = '000'
 AND cot.GRUPO_ITEM = pre.REF
 AND cot.ALTERNATIVA_ITEM = pre.ALT
 AND cot.SEQUENCIA = ia.SEQUENCIA
 AND cot.SUB_ITEM = pre.TAM
LEFT JOIN BASI_220 tam
  ON tam.TAMANHO_REF =
    CASE WHEN ia.SUB_COMP = '000'
    THEN cot.SUB_COMP
    ELSE ia.SUB_COMP
    END
LEFT JOIN BASI_030 ir -- item referencia
  ON ir.NIVEL_ESTRUTURA = ia.NIVEL_COMP
 AND ir.REFERENCIA = ia.GRUPO_COMP
LEFT JOIN BASI_020 it -- item tamanho
  ON it.BASI030_NIVEL030 = ia.NIVEL_COMP
 AND it.BASI030_REFERENC = ia.GRUPO_COMP
 AND it.TAMANHO_REF =
  CASE WHEN ia.SUB_COMP = '000'
  THEN cot.SUB_COMP
  ELSE ia.SUB_COMP
  END
LEFT JOIN BASI_010 ic -- item cor
  ON ic.NIVEL_ESTRUTURA = ia.NIVEL_COMP
 AND ic.GRUPO_ESTRUTURA = ia.GRUPO_COMP
 AND ic.SUBGRU_ESTRUTURA =
  CASE WHEN ia.SUB_COMP = '000'
  THEN cot.SUB_COMP
  ELSE ia.SUB_COMP
  END
 AND ic.ITEM_ESTRUTURA =
  CASE WHEN ia.ITEM_COMP = '000000'
  THEN coc.ITEM_COMP
  ELSE ia.ITEM_COMP
  END
ORDER BY
  ia.NIVEL_COMP
, ia.GRUPO_COMP
, CASE WHEN ia.ITEM_COMP = '000000'
  THEN coc.ITEM_COMP
  ELSE ia.ITEM_COMP
  END
, tam.ORDEM_TAMANHO
, ia.ALTERNATIVA_COMP
;

--SELECT
--  count(*)
--  h.*
DELETE
FROM HIST_999 h
WHERE h.APLICACAO = 'python3@duomoanselmo'
;

SELECT
prev.*
FROM RCNB_020 prev
WHERE prev.DESCRICAO LIKE '1831 %'
;

INSERT INTO SYSTEXTIL.RCNB_020
(NIVEL_ESTRUTURA, GRUPO_ESTRUTURA, SUBGRU_ESTRUTURA, ITEM_ESTRUTURA, NR_SOLICITACAO, QTDE_NEC_BRUTAS, DESCRICAO, NR_MOLDE, CONSIDERA_PLANO, QTDE_LATERAL, ORDEM_TAMANHO, CODIGO_EMBALAGEM, ALTERNATIVA, CODIGO_RISCO, ROTEIRO, GRUPO_MAQUINA, SUBGRUPO_MAQUINA, NUMERO_MAQUINA)
SELECT
NIVEL_ESTRUTURA, GRUPO_ESTRUTURA, SUBGRU_ESTRUTURA, ITEM_ESTRUTURA
, 831 -- NR_SOLICITACAO
, QTDE_NEC_BRUTAS
, '1831 COPIA DE 1826' -- DESCRICAO
, NR_MOLDE, CONSIDERA_PLANO, QTDE_LATERAL, ORDEM_TAMANHO, CODIGO_EMBALAGEM, ALTERNATIVA, CODIGO_RISCO, ROTEIRO, GRUPO_MAQUINA, SUBGRUPO_MAQUINA, NUMERO_MAQUINA
FROM SYSTEXTIL.RCNB_020
WHERE DESCRICAO LIKE '1826 %'
;

SELECT
o.*
FROM OPER_004 o
;

SELECT
c.VERSAO_LAYOUT_NFE
, c.*
FROM OBRF_158 c
;

-------- NF-e 3.10

UPDATE SYSTEXTIL.OBRF_158
SET
VERSAO_LAYOUT_NFE='3.10'
WHERE ID=1 AND COD_EMPRESA=1;

UPDATE SYSTEXTIL.OPER_004
SET
URL_RECEPCAO='https://www.scan.fazenda.gov.br/NfeRecepcao2/NfeRecepcao2.asmx'
, URL_RETRECEPCAO='https://www.scan.fazenda.gov.br/NfeRetRecepcao2/NfeRetRecepcao2.asmx'
, URL_CONSULTA='https://www.scan.fazenda.gov.br/NfeConsulta2/NfeConsulta2.asmx'
, URL_CANCELAMENTO='https://www.scan.fazenda.gov.br/NfeCancelamento2/NfeCancelamento2.asmx'
, URL_RECEPCAO_SERVICO_CCE=' '
, URL_INUTILIZACAO='https://www.scan.fazenda.gov.br/NfeInutilizacao2/NfeInutilizacao2.asmx'
, URL_STATUS_SERVICO='https://www.scan.fazenda.gov.br/NfeStatusServico2/NfeStatusServico2.asmx'
WHERE UF_URL='AN'
;

UPDATE SYSTEXTIL.OPER_004
SET
URL_RECEPCAO='https://nfe.svrs.rs.gov.br/ws/NfeAutorizacao/NFeAutorizacao.asmx'
, URL_RETRECEPCAO='https://nfe.svrs.rs.gov.br/ws/NfeRetAutorizacao/NFeRetAutorizacao.asmx'
, URL_CONSULTA='https://nfe.svrs.rs.gov.br/ws/NfeConsulta/NfeConsulta2.asmx'
, URL_CANCELAMENTO=' '
, URL_RECEPCAO_SERVICO_CCE='https://nfe.svrs.rs.gov.br/ws/recepcaoevento/recepcaoevento.asmx'
, URL_INUTILIZACAO='https://nfe.svrs.rs.gov.br/ws/nfeinutilizacao/nfeinutilizacao2.asmx'
, URL_STATUS_SERVICO='https://nfe.svrs.rs.gov.br/ws/NfeStatusServico/NfeStatusServico2.asmx'
WHERE UF_URL='RJ'
;

-------- NF-e 4.00

UPDATE SYSTEXTIL.OBRF_158
SET
VERSAO_LAYOUT_NFE='4.00'
WHERE ID=1 AND COD_EMPRESA=1;


UPDATE SYSTEXTIL.OPER_004
SET
URL_RECEPCAO='https://www.svc.fazenda.gov.br/NFeAutorizacao4/NFeAutorizacao4.asmx'
, URL_RETRECEPCAO='https://www.svc.fazenda.gov.br/NFeRetAutorizacao4/NFeRetAutorizacao4.asmx'
, URL_CONSULTA='https://www.svc.fazenda.gov.br/NFeConsultaProtocolo4/NFeConsultaProtocolo4.asmx'
, URL_CANCELAMENTO=''
, URL_RECEPCAO_SERVICO_CCE='https://www.svc.fazenda.gov.br/NFeRecepcaoEvento4/NFeRecepcaoEvento4.asmx'
, URL_INUTILIZACAO=''
, URL_STATUS_SERVICO='https://www.svc.fazenda.gov.br/NFeStatusServico4/NFeStatusServico4.asmx'
WHERE UF_URL='AN'
;

UPDATE SYSTEXTIL.OPER_004
SET
URL_RECEPCAO='https://nfe.svrs.rs.gov.br/ws/NfeAutorizacao/NFeAutorizacao4.asmx'
, URL_RETRECEPCAO='https://nfe.svrs.rs.gov.br/ws/NfeRetAutorizacao/NFeRetAutorizacao4.asmx'
, URL_CONSULTA='https://nfe.svrs.rs.gov.br/ws/NfeConsulta/NfeConsulta4.asmx'
, URL_CANCELAMENTO=''
, URL_RECEPCAO_SERVICO_CCE='https://nfe.svrs.rs.gov.br/ws/recepcaoevento/recepcaoevento4.asmx'
, URL_INUTILIZACAO='https://nfe.svrs.rs.gov.br/ws/nfeinutilizacao/nfeinutilizacao4.asmx'
, URL_STATUS_SERVICO='https://nfe.svrs.rs.gov.br/ws/NfeStatusServico/NfeStatusServico4.asmx'
WHERE UF_URL='RJ'
;
-- NfeConsultaCadastro  4.00  https://cad.svrs.rs.gov.br/ws/cadconsultacadastro/cadconsultacadastro4.asmx

SELECT
le.SEQUENCIA_ESTAGIO
, le.SEQ_OPERACAO
, le.SEQUENCIA_ENFESTO
, le.SEQ_ORDEM_SERV
, le.SEQ_QUEBRA
, le.*
FROM PCPC_040 le
WHERE le.PERIODO_PRODUCAO = 1801
AND le.ORDEM_CONFECCAO = 10654
;


--   06002
--   M6002

SELECT
cor.*
FROM BASI_010 cor
WHERE cor.NIVEL_ESTRUTURA = 1
AND cor.GRUPO_ESTRUTURA = 'M6002'
;

SELECT
count(*)
FROM ESTQ_040_HIST -- foi trucado
;

SELECT
*
FROM ESTQ_040_HIST -- foi trucado
;

SELECT
count(*)
, NIVEL, GRUPO, SUB, ITEM, LOTE, DEPOSITO, QTDE_ESTQ_OLD, QTDE_ESTQ_ATU, DATA_OCORR, TIPO_OCORR, NOME_PROGRAMA, QTDE_ESTQ_ANT_OLD, QTDE_ESTQ_ANT_ATU, QTDE_ESTQ_MES_OLD, QTDE_ESTQ_MES_ATU, DATA_ENTRADA_OLD, DATA_ENTRADA_ATU, DATA_SAIDA_OLD, DATA_SAIDA_ATU, QTDE_ESTQ_EMP_OLD, QTDE_ESTQ_EMP_ATU, QTDE_SUGERIDA_OLD, QTDE_SUGERIDA_ATU, USUARIO_REDE, MAQUINA_REDE, APLICACAO
FROM SYSTEXTIL.ESTQ_040_HIST
GROUP BY
NIVEL, GRUPO, SUB, ITEM, LOTE, DEPOSITO, QTDE_ESTQ_OLD, QTDE_ESTQ_ATU, DATA_OCORR, TIPO_OCORR, NOME_PROGRAMA, QTDE_ESTQ_ANT_OLD, QTDE_ESTQ_ANT_ATU, QTDE_ESTQ_MES_OLD, QTDE_ESTQ_MES_ATU, DATA_ENTRADA_OLD, DATA_ENTRADA_ATU, DATA_SAIDA_OLD, DATA_SAIDA_ATU, QTDE_ESTQ_EMP_OLD, QTDE_ESTQ_EMP_ATU, QTDE_SUGERIDA_OLD, QTDE_SUGERIDA_ATU, USUARIO_REDE, MAQUINA_REDE, APLICACAO
ORDER BY 1 DESC
;


SELECT
x.*
FROM ESTQ_040_HIST x
;

SELECT
count(*)
FROM ESTQ_301_HIST -- foi trucado
;

SELECT
*
FROM PEDI_100_HIST
;

SELECT
count(*)
FROM PEDI_100_HIST -- foi trucado
;

SELECT
count(*)
, PEDIDO, SITUACAO_VENDA_OLD, SITUACAO_VENDA_ATU, TIPO_OCORR, DATA_OCORR, USUARIO_REDE, MAQUINA_REDE, APLICACAO, DESCONTO1, DESCONTO2, DESCONTO3, DESCONTO_ITEM1, DESCONTO_ITEM2, DESCONTO_ITEM3, COD_CANCELAMENTO_OLD, COD_CANCELAMENTO_NEW, DATA_CANC_VENDA_OLD, DATA_CANC_VENDA_NEW, OBSERVACAO_ATU, OBSERVACAO_OLD, SEQ_END_ENTREGA_OLD, SEQ_END_ENTREGA_ATU, SEQ_END_COBRANCA_OLD, SEQ_END_COBRANCA_ATU, QTDE_SALDO_PEDI_OLD, QTDE_SALDO_PEDI_NEW, VALOR_SALDO_PEDI_OLD, VALOR_SALDO_PEDI_NEW
FROM SYSTEXTIL.PEDI_100_HIST h
GROUP BY
PEDIDO, SITUACAO_VENDA_OLD, SITUACAO_VENDA_ATU, TIPO_OCORR, DATA_OCORR, USUARIO_REDE, MAQUINA_REDE, APLICACAO, DESCONTO1, DESCONTO2, DESCONTO3, DESCONTO_ITEM1, DESCONTO_ITEM2, DESCONTO_ITEM3, COD_CANCELAMENTO_OLD, COD_CANCELAMENTO_NEW, DATA_CANC_VENDA_OLD, DATA_CANC_VENDA_NEW, OBSERVACAO_ATU, OBSERVACAO_OLD, SEQ_END_ENTREGA_OLD, SEQ_END_ENTREGA_ATU, SEQ_END_COBRANCA_OLD, SEQ_END_COBRANCA_ATU, QTDE_SALDO_PEDI_OLD, QTDE_SALDO_PEDI_NEW, VALOR_SALDO_PEDI_OLD, VALOR_SALDO_PEDI_NEW
--HAVING
--  count(*) = 1
ORDER BY 1 DESC
;

SELECT
min( h.rowid )
FROM SYSTEXTIL.PEDI_100_HIST h
GROUP BY
PEDIDO, SITUACAO_VENDA_OLD, SITUACAO_VENDA_ATU, TIPO_OCORR, DATA_OCORR, USUARIO_REDE, MAQUINA_REDE, APLICACAO, DESCONTO1, DESCONTO2, DESCONTO3, DESCONTO_ITEM1, DESCONTO_ITEM2, DESCONTO_ITEM3, COD_CANCELAMENTO_OLD, COD_CANCELAMENTO_NEW, DATA_CANC_VENDA_OLD, DATA_CANC_VENDA_NEW, OBSERVACAO_ATU, OBSERVACAO_OLD, SEQ_END_ENTREGA_OLD, SEQ_END_ENTREGA_ATU, SEQ_END_COBRANCA_OLD, SEQ_END_COBRANCA_ATU, QTDE_SALDO_PEDI_OLD, QTDE_SALDO_PEDI_NEW, VALOR_SALDO_PEDI_OLD, VALOR_SALDO_PEDI_NEW
;

DELETE FROM SYSTEXTIL.PEDI_100_HIST
WHERE rowid NOT IN
( SELECT
min( h.rowid )
FROM SYSTEXTIL.PEDI_100_HIST h
GROUP BY
PEDIDO, SITUACAO_VENDA_OLD, SITUACAO_VENDA_ATU, TIPO_OCORR, DATA_OCORR, USUARIO_REDE, MAQUINA_REDE, APLICACAO, DESCONTO1, DESCONTO2, DESCONTO3, DESCONTO_ITEM1, DESCONTO_ITEM2, DESCONTO_ITEM3, COD_CANCELAMENTO_OLD, COD_CANCELAMENTO_NEW, DATA_CANC_VENDA_OLD, DATA_CANC_VENDA_NEW, OBSERVACAO_ATU, OBSERVACAO_OLD, SEQ_END_ENTREGA_OLD, SEQ_END_ENTREGA_ATU, SEQ_END_COBRANCA_OLD, SEQ_END_COBRANCA_ATU, QTDE_SALDO_PEDI_OLD, QTDE_SALDO_PEDI_NEW, VALOR_SALDO_PEDI_OLD, VALOR_SALDO_PEDI_NEW
)
;

SELECT
count(*)
FROM PEDI_110_HIST -- foi trucado
;

SELECT
*
FROM PEDI_110_HIST
;

SELECT
count(*)
, NUMERO_PEDIDO, SEQ_ITEM_PEDIDO, PERCENTUAL_DESC, TIPO_OCORR, DATA_OCORR, USUARIO_REDE, MAQUINA_REDE, APLICACAO, QTDE_SUGERIDA_OLD, QTDE_SUGERIDA_NEW, QTDE_FATURADA_OLD, QTDE_FATURADA_NEW, QTDE_AFATURAR_OLD, QTDE_AFATURAR_NEW, QTDE_PEDIDA_OLD, QTDE_PEDIDA_NEW, SEQ_PRINCIPAL_OLD, SEQ_PRINCIPAL_NEW, SITUACAO_FATU_IT_OLD, SITUACAO_FATU_IT_NEW, LOTE_EMPENHADO_OLD, LOTE_EMPENHADO_NEW, CODIGO_ACOMP_OLD, CODIGO_ACOMP_NEW, CD_IT_PE_NIVEL99, CD_IT_PE_GRUPO, CD_IT_PE_SUBGRUPO, CD_IT_PE_ITEM, DEPOSITO_OLD, DEPOSITO_NEW, NOME_PROGRAMA
FROM SYSTEXTIL.PEDI_110_HIST
GROUP BY
NUMERO_PEDIDO, SEQ_ITEM_PEDIDO, PERCENTUAL_DESC, TIPO_OCORR, DATA_OCORR, USUARIO_REDE, MAQUINA_REDE, APLICACAO, QTDE_SUGERIDA_OLD, QTDE_SUGERIDA_NEW, QTDE_FATURADA_OLD, QTDE_FATURADA_NEW, QTDE_AFATURAR_OLD, QTDE_AFATURAR_NEW, QTDE_PEDIDA_OLD, QTDE_PEDIDA_NEW, SEQ_PRINCIPAL_OLD, SEQ_PRINCIPAL_NEW, SITUACAO_FATU_IT_OLD, SITUACAO_FATU_IT_NEW, LOTE_EMPENHADO_OLD, LOTE_EMPENHADO_NEW, CODIGO_ACOMP_OLD, CODIGO_ACOMP_NEW, CD_IT_PE_NIVEL99, CD_IT_PE_GRUPO, CD_IT_PE_SUBGRUPO, CD_IT_PE_ITEM, DEPOSITO_OLD, DEPOSITO_NEW, NOME_PROGRAMA
ORDER BY 1 DESC
;

SELECT
count(*)
FROM HIST_010
;

SELECT
*
FROM HIST_010
;

UPDATE HIST_010
SET USUARIO_REDE = NULL
WHERE USUARIO_REDE = USUARIO_SISTEMA
;

UPDATE HIST_010
SET APLICACAO = NULL
WHERE APLICACAO = NOME_PROGRAMA
;

-- RENNER  a faturar no dia 02/07/2018
SELECT
i.CODIGO_BARRAS
--, i.GRUPO_ESTRUTURA
--, i.SUBGRU_ESTRUTURA
--, i.ITEM_ESTRUTURA
, i.*
FROM BASI_010 i
WHERE i.NIVEL_ESTRUTURA='1'
--  AND i.GRUPO_ESTRUTURA='603ME'
--  AND i.GRUPO_ESTRUTURA LIKE '%00417%'
AND i.GRUPO_ESTRUTURA IN (
'0156R'
, '04337'
, '02556'
, '0619R'
, '0717R'
, '0156R'
, '0417R'
, '5156R'
, '06983'
, '06981'
, '0266R'
, '02764'
, '0263R'
)
--  AND i.ITEM_ESTRUTURA = '0000PR'
ORDER BY
--  i.GRUPO_ESTRUTURA
--,
i.ITEM_ESTRUTURA
, i.SUBGRU_ESTRUTURA
;

UPDATE BASI_010 i
SET
i.CODIGO_BARRAS = 'SEM GTIN'
WHERE i.NIVEL_ESTRUTURA='1'
AND i.GRUPO_ESTRUTURA IN (
'0156R'
, '04337'
, '02556'
, '0619R'
, '0717R'
, '0156R'
, '0417R'
, '5156R'
, '06983'
, '06981'
, '0266R'
, '02764'
, '0263R'
)
AND (  i.CODIGO_BARRAS = ''
OR i.CODIGO_BARRAS = ' '
OR i.CODIGO_BARRAS IS NULL
)
;

SELECT
count(*)
FROM OBRF_015_HIST
;

SELECT
count(*)
FROM obrf_015
;

SELECT
h.*
FROM obrf_015_hist h
;

SELECT
count(*)
FROM HIST_100
;

SELECT
*
FROM HIST_100
;

SELECT
count(*)
FROM FATU_060_HIST
;

SELECT
count(*)
FROM FATU_060
;

SELECT
h.*
FROM FATU_060_HIST h
;

SELECT
count(*)
FROM ESTQ_301_HIST
;

SELECT
count(*)
FROM ESTQ_301
;

SELECT
h.*
FROM ESTQ_301 h
--WHERE USUARIO_REDE <> 'ANSELMO_SIS'
;
SELECT
h.*
FROM ESTQ_301_HIST h
--WHERE USUARIO_REDE <> 'ANSELMO_SIS'
;

SELECT
count(*)
FROM ESTQ_040_LOG
;

SELECT
count(*)
FROM ESTQ_040
;

SELECT
h.*
FROM ESTQ_040 h
;

SELECT
h.*
FROM ESTQ_040_LOG h
ORDER BY
h.DATA_OPERACAO
;

SELECT
count(*)
FROM ESTQ_310 h
;

SELECT
h.*
FROM ESTQ_310 h
;

SELECT
h.*
FROM ESTQ_310 h
WHERE h.DATA_MOVIMENTO < TO_DATE('01/01/2018','DD/MM/YYYY')
;

DELETE FROM ESTQ_310 h
WHERE h.DATA_MOVIMENTO < TO_DATE('01/01/2018','DD/MM/YYYY')
;

SELECT
count(*)
FROM ESTQ_040_LOG h
;

SELECT
h.*
FROM ESTQ_040_LOG h
ORDER BY h.DATA_OPERACAO
;

SELECT
count(*)
FROM PCPC_040 h
;

SELECT
h.*
FROM PCPC_040 h
;

SELECT
i.CODIGO_BARRAS
, i.GRUPO_ESTRUTURA
, i.SUBGRU_ESTRUTURA
, i.ITEM_ESTRUTURA
, i.*
FROM BASI_010 i
WHERE i.NIVEL_ESTRUTURA='1'
AND i.GRUPO_ESTRUTURA LIKE '%809E%'
--  AND i.GRUPO_ESTRUTURA LIKE '%00417%'
--  AND i.GRUPO_ESTRUTURA IN (
--    '0156R'
--  , '04337'
--  )
AND i.ITEM_ESTRUTURA = '0000BR'
ORDER BY
i.GRUPO_ESTRUTURA
, i.ITEM_ESTRUTURA
, i.SUBGRU_ESTRUTURA
;

UPDATE BASI_010 i
SET i.CODIGO_BARRAS =
( SELECT ii.CODIGO_BARRAS
FROM BASI_010 ii
WHERE ii.NIVEL_ESTRUTURA=i.NIVEL_ESTRUTURA
AND ii.GRUPO_ESTRUTURA='00809'
AND ii.SUBGRU_ESTRUTURA=i.SUBGRU_ESTRUTURA
AND ii.ITEM_ESTRUTURA=i.ITEM_ESTRUTURA
)
WHERE i.NIVEL_ESTRUTURA='1'
AND i.GRUPO_ESTRUTURA='0809E'
AND i.ITEM_ESTRUTURA='0000BR'
AND (i.CODIGO_BARRAS = '' OR i.CODIGO_BARRAS = ' ' OR i.CODIGO_BARRAS IS NULL)
;

SELECT
i.CODIGO_BARRAS
, i.GRUPO_ESTRUTURA
, i.SUBGRU_ESTRUTURA
, i.ITEM_ESTRUTURA
, i.*
FROM BASI_010 i
WHERE i.NIVEL_ESTRUTURA='1'
AND i.GRUPO_ESTRUTURA LIKE '%00002%'
--  AND i.GRUPO_ESTRUTURA LIKE '%00417%'
--  AND i.GRUPO_ESTRUTURA IN (
--    '0156R'
--  , '04337'
--  )
AND i.ITEM_ESTRUTURA = '0000AZ'
ORDER BY
i.GRUPO_ESTRUTURA
, i.ITEM_ESTRUTURA
, i.SUBGRU_ESTRUTURA
;

UPDATE BASI_010 i
SET i.CODIGO_BARRAS =
( SELECT ii.CODIGO_BARRAS
FROM BASI_010 ii
WHERE ii.NIVEL_ESTRUTURA=i.NIVEL_ESTRUTURA
AND ii.GRUPO_ESTRUTURA='00467'
AND ii.SUBGRU_ESTRUTURA=i.SUBGRU_ESTRUTURA
AND ii.ITEM_ESTRUTURA=i.ITEM_ESTRUTURA
)
WHERE i.NIVEL_ESTRUTURA='1'
AND i.GRUPO_ESTRUTURA='0467E'
AND i.ITEM_ESTRUTURA='0000PR'
AND (i.CODIGO_BARRAS = '' OR i.CODIGO_BARRAS = ' ' OR i.CODIGO_BARRAS IS NULL)
;

SELECT
prev.*
FROM RCNB_020 prev
WHERE prev.DESCRICAO LIKE '1835 %'
;

INSERT INTO SYSTEXTIL.RCNB_020
(NIVEL_ESTRUTURA, GRUPO_ESTRUTURA, SUBGRU_ESTRUTURA, ITEM_ESTRUTURA, NR_SOLICITACAO, QTDE_NEC_BRUTAS, DESCRICAO, NR_MOLDE, CONSIDERA_PLANO, QTDE_LATERAL, ORDEM_TAMANHO, CODIGO_EMBALAGEM, ALTERNATIVA, CODIGO_RISCO, ROTEIRO, GRUPO_MAQUINA, SUBGRUPO_MAQUINA, NUMERO_MAQUINA)
SELECT
NIVEL_ESTRUTURA, GRUPO_ESTRUTURA, SUBGRU_ESTRUTURA, ITEM_ESTRUTURA
, 835 -- NR_SOLICITACAO
, QTDE_NEC_BRUTAS
, '1835 AGO/18 - COPIA DE 1826' -- DESCRICAO
, NR_MOLDE, CONSIDERA_PLANO, QTDE_LATERAL, ORDEM_TAMANHO, CODIGO_EMBALAGEM, ALTERNATIVA, CODIGO_RISCO, ROTEIRO, GRUPO_MAQUINA, SUBGRUPO_MAQUINA, NUMERO_MAQUINA
FROM SYSTEXTIL.RCNB_020
WHERE DESCRICAO LIKE '1826 %'
;

UPDATE RCNB_020 prev
SET
prev.DESCRICAO = '1835 SET/18 - COPIA DE 1826'
WHERE prev.DESCRICAO LIKE '1835 %'
;

SELECT
--  ia.NIVEL_COMP
--, ia.ALTERNATIVA_COMP
--,
ia.*
FROM BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_COMP <> 1
AND ia.ALTERNATIVA_COMP <> 1
;

UPDATE BASI_050 ia -- insumos de alternativa
SET
ia.ALTERNATIVA_COMP = 1
WHERE ia.NIVEL_COMP <> 1
AND ia.ALTERNATIVA_COMP <> 1
;

SELECT
--  ia.NIVEL_COMP
--, ia.ALTERNATIVA_COMP
--,
ia.*
FROM BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_COMP = 1
AND ia.GRUPO_COMP LIKE 'F%'
--  AND ia.ALTERNATIVA_COMP <> 8
;

UPDATE BASI_050 ia -- insumos de alternativa
SET
ia.ALTERNATIVA_COMP = 8
WHERE ia.NIVEL_COMP = 1
AND ia.GRUPO_COMP LIKE 'F%'
AND ia.ALTERNATIVA_COMP <> 8
;

SELECT
coct.*
FROM BASI_040 coct -- combinação cor e tamanho
WHERE coct.GRUPO_ITEM = 'F0856'
;

SELECT
--  ia.*
ia.GRUPO_ITEM
FROM BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_ITEM = 1
AND ia.GRUPO_ITEM LIKE 'F%'
AND ia.ALTERNATIVA_ITEM = 8
;

INSERT INTO SYSTEXTIL.BASI_050
(NIVEL_ITEM, GRUPO_ITEM, SUB_ITEM, ITEM_ITEM, ALTERNATIVA_ITEM, SEQUENCIA, NIVEL_COMP, GRUPO_COMP, SUB_COMP, ITEM_COMP, ALTERNATIVA_COMP, CONSUMO, ESTAGIO, TIPO_CALCULO, LETRA_GRAFICO, QTDE_CAMADAS, PERCENT_PERDAS, NUMERO_GRAFICO, QTDE_INICIAL, QTDE_FINAL, TENSAO, LFA, LOTE, FORNECEDOR, CONS_UN_REC, SEQ_PRINCIPAL, GRUPO_SIMILARES, CENTRO_CUSTO, CONS_UNID_MED_GENERICA, PERC_CONS_CALC, CALCULA_COMPOSICAO, RELACAO_BANHO, QTDE_PECAS_ESTAMPADAS, TIPO_TELA, AREA_COBERTURA, TIPO_APLICACAO, TIPO_MEDIDA, CODIGO_PROJETO, SEQUENCIA_PROJETO, TECIDO_PRINCIPAL, VALOR_ML_L, FATOR_CONVERSOR, QTDE_CABOS, VARIACAO, AGRUP_TINGIMENTO, QTDE_PECAS)
--VALUES('1', 'F0642', '000', '000000', 8, 20, '2', 'MA005', 'UNI', '0000BR', 1, 0.04, 15, 0, NULL, 1, 0, 0, 0, 0, 0, 0, 0, NULL, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, '000000', 0, 0, 0, 0, 0, 0, 0, 0);
SELECT
NIVEL_ITEM, GRUPO_ITEM, SUB_ITEM, ITEM_ITEM
, 8 -- ALTERNATIVA_ITEM
, SEQUENCIA, NIVEL_COMP, GRUPO_COMP, SUB_COMP, ITEM_COMP, ALTERNATIVA_COMP, CONSUMO, ESTAGIO, TIPO_CALCULO, LETRA_GRAFICO, QTDE_CAMADAS, PERCENT_PERDAS, NUMERO_GRAFICO, QTDE_INICIAL, QTDE_FINAL, TENSAO, LFA, LOTE, FORNECEDOR, CONS_UN_REC, SEQ_PRINCIPAL, GRUPO_SIMILARES, CENTRO_CUSTO, CONS_UNID_MED_GENERICA, PERC_CONS_CALC, CALCULA_COMPOSICAO, RELACAO_BANHO, QTDE_PECAS_ESTAMPADAS, TIPO_TELA, AREA_COBERTURA, TIPO_APLICACAO, TIPO_MEDIDA, CODIGO_PROJETO, SEQUENCIA_PROJETO, TECIDO_PRINCIPAL, VALOR_ML_L, FATOR_CONVERSOR, QTDE_CABOS, VARIACAO, AGRUP_TINGIMENTO, QTDE_PECAS
FROM SYSTEXTIL.BASI_050 ia
WHERE ia.NIVEL_ITEM = 1
AND ia.GRUPO_ITEM LIKE 'F%'
AND ia.GRUPO_ITEM NOT IN
(
SELECT
ia8.GRUPO_ITEM
FROM BASI_050 ia8 -- insumos de alternativa
WHERE ia8.NIVEL_ITEM = 1
AND ia8.GRUPO_ITEM LIKE 'F%'
AND ia8.ALTERNATIVA_ITEM = 8
)
AND ia.ALTERNATIVA_ITEM = 1
;

SELECT
--  ia.GRUPO_ITEM
ia.*
FROM BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_ITEM = 1
AND ia.GRUPO_ITEM LIKE 'M156%'
AND ia.ITEM_ITEM = '0000ME'
--  AND ia.GRUPO_COMP = 'TR004'
AND ia.SEQUENCIA = 92
;

INSERT INTO SYSTEXTIL.BASI_050
(NIVEL_ITEM, GRUPO_ITEM, SUB_ITEM, ITEM_ITEM, ALTERNATIVA_ITEM, SEQUENCIA, NIVEL_COMP, GRUPO_COMP, SUB_COMP, ITEM_COMP, ALTERNATIVA_COMP, CONSUMO, ESTAGIO, TIPO_CALCULO, LETRA_GRAFICO, QTDE_CAMADAS, PERCENT_PERDAS, NUMERO_GRAFICO, QTDE_INICIAL, QTDE_FINAL, TENSAO, LFA, LOTE, FORNECEDOR, CONS_UN_REC, SEQ_PRINCIPAL, GRUPO_SIMILARES, CENTRO_CUSTO, CONS_UNID_MED_GENERICA, PERC_CONS_CALC, CALCULA_COMPOSICAO, RELACAO_BANHO, QTDE_PECAS_ESTAMPADAS, TIPO_TELA, AREA_COBERTURA, TIPO_APLICACAO, TIPO_MEDIDA, CODIGO_PROJETO, SEQUENCIA_PROJETO, TECIDO_PRINCIPAL, VALOR_ML_L, FATOR_CONVERSOR, QTDE_CABOS, VARIACAO, AGRUP_TINGIMENTO, QTDE_PECAS)
--VALUES('1', 'F0642', '000', '000000', 8, 20, '2', 'MA005', 'UNI', '0000BR', 1, 0.04, 15, 0, NULL, 1, 0, 0, 0, 0, 0, 0, 0, NULL, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, '000000', 0, 0, 0, 0, 0, 0, 0, 0);
SELECT
NIVEL_ITEM, GRUPO_ITEM, SUB_ITEM, ITEM_ITEM, ALTERNATIVA_ITEM
, 92 --SEQUENCIA
, NIVEL_COMP
, 'TR005' -- GRUPO_COMP
, SUB_COMP, ITEM_COMP, ALTERNATIVA_COMP, CONSUMO, ESTAGIO, TIPO_CALCULO, LETRA_GRAFICO, QTDE_CAMADAS, PERCENT_PERDAS, NUMERO_GRAFICO, QTDE_INICIAL, QTDE_FINAL, TENSAO, LFA, LOTE, FORNECEDOR, CONS_UN_REC, SEQ_PRINCIPAL, GRUPO_SIMILARES, CENTRO_CUSTO, CONS_UNID_MED_GENERICA, PERC_CONS_CALC, CALCULA_COMPOSICAO, RELACAO_BANHO, QTDE_PECAS_ESTAMPADAS, TIPO_TELA, AREA_COBERTURA, TIPO_APLICACAO, TIPO_MEDIDA, CODIGO_PROJETO, SEQUENCIA_PROJETO, TECIDO_PRINCIPAL, VALOR_ML_L, FATOR_CONVERSOR, QTDE_CABOS, VARIACAO, AGRUP_TINGIMENTO, QTDE_PECAS
FROM SYSTEXTIL.BASI_050 ia
WHERE ia.NIVEL_ITEM = 1
AND ia.GRUPO_ITEM LIKE 'M156%'
AND ia.ITEM_ITEM = '0000ME'
AND ia.GRUPO_COMP = 'TR004'
;

UPDATE BASI_040 iac -- insumos de alternativa combinação (cor/tam)
SET
iac.SEQUENCIA = 92
WHERE iac.NIVEL_ITEM = 1
AND iac.GRUPO_ITEM IN
( SELECT DISTINCT
ia.GRUPO_ITEM
FROM BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_ITEM = 1
AND ia.GRUPO_ITEM LIKE 'M156%'
AND ia.ITEM_ITEM = '0000ME'
AND ia.GRUPO_COMP = 'TR004'
)
AND iac.SEQUENCIA = 90
AND iac.ITEM_ITEM = '0000ME'
;

DELETE FROM BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_ITEM = 1
AND ia.GRUPO_ITEM LIKE 'M156%'
AND ia.ITEM_ITEM = '0000ME'
AND ia.GRUPO_COMP = 'TR004'
--  AND ia.SEQUENCIA = 92
;

SELECT
i.TAMANHO
, i.SORTIMENTO
, i.QUANTIDADE
FROM PCPC_021 i
WHERE i.ORDEM_PRODUCAO = 6180
ORDER BY
i.SEQUENCIA_TAMANHO
, i.SORTIMENTO
;

SELECT
lote.PROCONF_SUBGRUPO TAMANHO
, lote.PROCONF_ITEM SORTIMENTO
, sum(lote.QTDE_CONSERTO ) QUANTIDADE
FROM PCPC_040 lote
LEFT JOIN BASI_220 tam
ON tam.TAMANHO_REF = lote.PROCONF_SUBGRUPO
WHERE lote.ORDEM_PRODUCAO = 6180
GROUP BY
tam.ORDEM_TAMANHO
, lote.PROCONF_SUBGRUPO
, lote.PROCONF_ITEM
ORDER BY
tam.ORDEM_TAMANHO
, lote.PROCONF_ITEM
;

SELECT
lote.PROCONF_SUBGRUPO TAMANHO
, lote.PROCONF_ITEM SORTIMENTO
, sum(lote.QTDE_PECAS_2A ) QUANTIDADE
FROM PCPC_040 lote
LEFT JOIN BASI_220 tam
ON tam.TAMANHO_REF = lote.PROCONF_SUBGRUPO
WHERE lote.ORDEM_PRODUCAO = 6180
AND lote.SEQUENCIA_ESTAGIO
= COALESCE(
  (
    SELECT
      MAX(ulote.SEQUENCIA_ESTAGIO)
    FROM PCPC_040 ulote
    WHERE ulote.ORDEM_PRODUCAO = lote.ORDEM_PRODUCAO
      AND ulote.ORDEM_CONFECCAO = lote.ORDEM_CONFECCAO
      AND ulote.QTDE_PECAS_2A > 0
    GROUP BY
      ulote.ORDEM_PRODUCAO
    , ulote.ORDEM_CONFECCAO
  )
, 0)
GROUP BY
tam.ORDEM_TAMANHO
, lote.PROCONF_SUBGRUPO
, lote.PROCONF_ITEM
ORDER BY
tam.ORDEM_TAMANHO
, lote.PROCONF_ITEM
;

SELECT
oi.TAMANHO TAMANHO
, oi.SORTIMENTO SORTIMENTO
, sum(lote.QTDE_CONSERTO ) QUANTIDADE
FROM PCPC_021 oi
JOIN PCPC_040 lote
ON lote.ORDEM_PRODUCAO = oi.ORDEM_PRODUCAO
AND lote.PROCONF_SUBGRUPO = oi.TAMANHO
AND lote.PROCONF_ITEM = oi.SORTIMENTO
WHERE oi.ORDEM_PRODUCAO = 6180
GROUP BY
oi.SEQUENCIA_TAMANHO
, oi.TAMANHO
, oi.SORTIMENTO
ORDER BY
oi.SEQUENCIA_TAMANHO
, oi.SORTIMENTO
;

SELECT
lote.PROCONF_SUBGRUPO TAMANHO
, lote.PROCONF_ITEM SORTIMENTO
, sum(lote.QTDE_PECAS_PROG ) QUANTIDADE
FROM PCPC_040 lote
LEFT JOIN BASI_220 tam
ON tam.TAMANHO_REF = lote.PROCONF_SUBGRUPO
WHERE lote.ORDEM_PRODUCAO = 6180
AND lote.SEQUENCIA_ESTAGIO
= COALESCE(
  (
    SELECT
      MIN(ulote.SEQUENCIA_ESTAGIO)
    FROM PCPC_040 ulote
    WHERE ulote.ORDEM_PRODUCAO = lote.ORDEM_PRODUCAO
      AND ulote.ORDEM_CONFECCAO = lote.ORDEM_CONFECCAO
    GROUP BY
      ulote.ORDEM_PRODUCAO
    , ulote.ORDEM_CONFECCAO
  )
, 0)
GROUP BY
tam.ORDEM_TAMANHO
, lote.PROCONF_SUBGRUPO
, lote.PROCONF_ITEM
ORDER BY
tam.ORDEM_TAMANHO
, lote.PROCONF_ITEM
;

-- Tamanho do banco
-- http://www.webmundi.com/banco-de-dados/oracle/como-saber-o-tamanho-banco-de-dados-oracle/

select sum(bytes) / 1024 / 1024 / 1024 tamanho_GB from dba_segments;

select tablespace_name, sum(bytes) / 1024 / 1024 / 1024 tamanho_GB from dba_segments group by tablespace_name;

-- SHRINK
-- https://www.devmedia.com.br/compactando-tabelas-com-o-shrink-em-bancos-de-dados-oracle/25928


-- BASI_050 - combinação de cor / tamanho

-- Habilitando ROW MOVEMENT (obrigatório antes)

ALTER TABLE SYSTEXTIL.BASI_050 ENABLE ROW MOVEMENT;

-- Executando SHRINK sem ajustar a HWM

ALTER TABLE SYSTEXTIL.BASI_050 SHRINK SPACE COMPACT;

-- Executando SHRINK e ajustando a marca d’água

ALTER TABLE SYSTEXTIL.BASI_050 SHRINK SPACE;

-- Tamanho do banco
-- 9.42864990234375

-- BASI_040 - insumos de alternativa

ALTER TABLE SYSTEXTIL.BASI_040 ENABLE ROW MOVEMENT;
ALTER TABLE SYSTEXTIL.BASI_040 SHRINK SPACE COMPACT;
ALTER TABLE SYSTEXTIL.BASI_040 SHRINK SPACE;

-- Tamanho do banco
-- 9.4342041015625

-- BASI_070 - roteiro - nome

ALTER TABLE SYSTEXTIL.BASI_070 ENABLE ROW MOVEMENT;
ALTER TABLE SYSTEXTIL.BASI_070 SHRINK SPACE COMPACT;
ALTER TABLE SYSTEXTIL.BASI_070 SHRINK SPACE;

-- Tamanho do banco
-- 9.4351806640625

-- MQOP_050 - roteiro - operações

ALTER TABLE SYSTEXTIL.MQOP_050 ENABLE ROW MOVEMENT;
ALTER TABLE SYSTEXTIL.MQOP_050 SHRINK SPACE COMPACT;
ALTER TABLE SYSTEXTIL.MQOP_050 SHRINK SPACE;

-- Tamanho do banco
-- 9.438720703125

SELECT
i.ITEM_ATIVO
, i.*
FROM BASI_010 i
WHERE i.GRUPO_ESTRUTURA like '%5746'
;

SELECT
r.DESCR_REFERENCIA
, r.*
FROM BASI_030 r
WHERE r.REFERENCIA = '00103'
;


WITH NECES AS (
SELECT
ness.SEMANA_NECESSIDADE
, ness.ORDEM_PRODUCAO
, ness.QTD_INSUMO
, oss.NUMERO_ORDEM
, sum( nfs.QTDE_ESTRUTURA ) QTD_OS
FROM (
SELECT
TRUNC(coalesce(op.DATA_ENTRADA_CORTE, SYSDATE) - 7, 'iw')
SEMANA_NECESSIDADE
, op.ORDEM_PRODUCAO
, sum( ia.CONSUMO *
   (
( lote.QTDE_PECAS_PROG - lote.QTDE_PECAS_PROD - lote.QTDE_PECAS_2A
- lote.QTDE_PERDAS - lote.QTDE_CONSERTO )
   )
 ) QTD_INSUMO
FROM BASI_030 ref -- referencia
JOIN PCPC_020 op -- OP
ON op.REFERENCIA_PECA = ref.REFERENCIA
JOIN PCPC_040 lote -- lote
ON lote.ORDEM_PRODUCAO = op.ORDEM_PRODUCAO
JOIN BASI_050 ia -- insumos de alternativa
ON ia.NIVEL_ITEM = 1
AND ia.NIVEL_COMP <> 1
AND ia.GRUPO_ITEM = op.REFERENCIA_PECA
AND (ia.SUB_ITEM = lote.PROCONF_SUBGRUPO OR ia.SUB_ITEM = '000')
AND (ia.ITEM_ITEM = lote.PROCONF_ITEM OR ia.ITEM_ITEM = '000000')
AND ia.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
AND ia.ESTAGIO = lote.CODIGO_ESTAGIO
LEFT JOIN BASI_040 coc -- combinação cor
ON ia.ITEM_COMP = '000000'
AND coc.GRUPO_ITEM = ia.GRUPO_ITEM
AND coc.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
AND coc.SEQUENCIA = ia.SEQUENCIA
AND coc.ITEM_ITEM = lote.PROCONF_ITEM
LEFT JOIN BASI_040 cot -- combinação tamanho
ON ia.SUB_COMP = '000'
AND cot.GRUPO_ITEM = ia.GRUPO_ITEM
AND cot.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
AND cot.SEQUENCIA = ia.SEQUENCIA
AND cot.SUB_ITEM = lote.PROCONF_SUBGRUPO
WHERE op.SITUACAO IN (2, 4) -- não cancelada
AND ia.NIVEL_COMP = 9
AND ia.GRUPO_COMP = 'CA001'
AND CASE WHEN ia.ITEM_COMP = '000000'
  THEN coc.ITEM_COMP
  ELSE ia.ITEM_COMP
  END = '0000PR'
AND CASE WHEN ia.SUB_COMP = '000'
  THEN cot.SUB_COMP
  ELSE ia.SUB_COMP
  END = 'UNI'
GROUP BY
TRUNC(coalesce(op.DATA_ENTRADA_CORTE, SYSDATE) - 7, 'iw')
, op.ORDEM_PRODUCAO
HAVING
sum( ia.CONSUMO *
   (
( lote.QTDE_PECAS_PROG - lote.QTDE_PECAS_PROD - lote.QTDE_PECAS_2A
- lote.QTDE_PERDAS - lote.QTDE_CONSERTO )
   )
 ) > 0
ORDER BY
1, 2
) ness
LEFT JOIN (
SELECT UNIQUE
os.NUMERO_ORDEM
, l.ORDEM_PRODUCAO
FROM OBRF_080 os
JOIN pcpc_040 l
ON l.NUMERO_ORDEM = os.NUMERO_ORDEM
WHERE l.NUMERO_ORDEM <> 0
) oss
ON oss.ORDEM_PRODUCAO = ness.ORDEM_PRODUCAO
LEFT JOIN OBRF_082 nfs
ON nfs.NUMERO_ORDEM = oss.NUMERO_ORDEM
AND nfs.PRODSAI_NIVEL99 = 9
AND nfs.PRODSAI_GRUPO = 'CA001'
AND nfs.PRODSAI_ITEM = '0000PR'
AND nfs.PRODSAI_SUBGRUPO = 'UNI'
GROUP BY
ness.SEMANA_NECESSIDADE
, ness.ORDEM_PRODUCAO
, ness.QTD_INSUMO
, oss.NUMERO_ORDEM
--  ORDER BY
--    1, 2, 3, 4
)
SELECT
n.SEMANA_NECESSIDADE
, sum(n.QTD_INSUMO) - coalesce(sum(n.QTD_OS), 0) QTD_INSUMO
FROM NECES n
GROUP BY
n.SEMANA_NECESSIDADE
HAVING
sum(n.QTD_INSUMO) - coalesce(sum(n.QTD_OS), 0) > 0
ORDER BY
n.SEMANA_NECESSIDADE
;

SELECT
1 NIVEL
, 'B0493' REF
, '0000PR' COR
, 'GG' TAM
, 625 QTD
, 11 ALT
, '2018-08-26 00:00:00' DT_NECESSIDADE
FROM SYS.DUAL
;

INSERT INTO SYSTEXTIL.RCNB_020
(NIVEL_ESTRUTURA, GRUPO_ESTRUTURA, SUBGRU_ESTRUTURA, ITEM_ESTRUTURA, NR_SOLICITACAO, QTDE_NEC_BRUTAS, DESCRICAO, NR_MOLDE, CONSIDERA_PLANO, QTDE_LATERAL, ORDEM_TAMANHO, CODIGO_EMBALAGEM, ALTERNATIVA, CODIGO_RISCO, ROTEIRO, GRUPO_MAQUINA, SUBGRUPO_MAQUINA, NUMERO_MAQUINA)
SELECT
NIVEL_ESTRUTURA, GRUPO_ESTRUTURA, SUBGRU_ESTRUTURA, ITEM_ESTRUTURA
, 840 -- NR_SOLICITACAO
, QTDE_NEC_BRUTAS
, '1840 OUTUBRO/2018' -- DESCRICAO
, NR_MOLDE, CONSIDERA_PLANO, QTDE_LATERAL, ORDEM_TAMANHO, CODIGO_EMBALAGEM, ALTERNATIVA, CODIGO_RISCO, ROTEIRO, GRUPO_MAQUINA, SUBGRUPO_MAQUINA, NUMERO_MAQUINA
FROM SYSTEXTIL.RCNB_020
WHERE DESCRICAO LIKE '1835 %'
;

SELECT
ll.EST
, u.USUARIO_SYSTEXTIL
, count(*) LOTES
, MIN(u.DATA_PRODUCAO) DT_MIN
, ROUND( TO_DATE('01/01/2001','DD/MM/YYYY')
+ AVG(u.DATA_PRODUCAO - TO_DATE('01/01/2001','DD/MM/YYYY'))
- MIN(u.DATA_PRODUCAO)
) DIA_INI
, TO_DATE('01/01/2001','DD/MM/YYYY')
+ AVG(u.DATA_PRODUCAO - TO_DATE('01/01/2001','DD/MM/YYYY')) DT_AVG
, ROUND( MAX(u.DATA_PRODUCAO)
- ( TO_DATE('01/01/2001','DD/MM/YYYY')
 + AVG(u.DATA_PRODUCAO - TO_DATE('01/01/2001','DD/MM/YYYY'))
 )
) DIA_FIM
, MAX(u.DATA_PRODUCAO) DT_MAX
FROM (
SELECT DISTINCT
l.SEQ_OPERACAO
, l.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO EST
, l.CODIGO_ESTAGIO
, l.ORDEM_PRODUCAO
FROM pcpc_040 l
JOIN MQOP_005 e
ON e.CODIGO_ESTAGIO = l.CODIGO_ESTAGIO
WHERE l.ORDEM_PRODUCAO = 6276
) ll
JOIN pcpc_045 u
ON u.ORDEM_PRODUCAO = ll.ORDEM_PRODUCAO
AND u.PCPC040_ESTCONF = ll.CODIGO_ESTAGIO
AND u.QTDE_PRODUZIDA + u.QTDE_PECAS_2A +
u.QTDE_PERDAS + u.QTDE_CONSERTO > 0
GROUP BY
ll.SEQ_OPERACAO
, ll.EST
, u.PCPC040_ESTCONF
, u.USUARIO_SYSTEXTIL
ORDER BY
ll.SEQ_OPERACAO
, 4 -- DT_MIN
, 3 DESC -- LOTES
, u.USUARIO_SYSTEXTIL
;

SELECT
le.*
FROM pcpc_040 le
WHERE le.ORDEM_PRODUCAO = 6066
AND ORDEM_CONFECCAO = 20483
;

SELECT
le.*
FROM pcpc_040 le
WHERE le.EXPORTADO_PMS IS NOT NULL
;

SELECT
le.*
FROM pcpc_040 le
WHERE le.CODIGO_ESTAGIO = 15
AND le.QTDE_PERDAS <> 0
;

SELECT
le.*
FROM pcpc_040 le
WHERE le.PERIODO_PRODUCAO = 1817
AND le.ORDEM_CONFECCAO = 20370
ORDER BY
le.SEQUENCIA_ESTAGIO
;

SELECT
le.*
FROM pcpc_045 le
WHERE le.PCPC040_PERCONF = 1817
AND le.PCPC040_ORDCONF = 20370
;


620,617,619,5735


SELECT
rot.*
FROM MQOP_050 rot
WHERE rot.NUMERO_ALTERNATI = 1
AND (  rot.GRUPO_ESTRUTURA like '%5735%'
OR rot.GRUPO_ESTRUTURA like '%617%'
OR rot.GRUPO_ESTRUTURA like '%619%'
OR rot.GRUPO_ESTRUTURA like '%620%'
)
AND rot.GRUPO_ESTRUTURA > 'B9999'
--  AND rot.CODIGO_ESTAGIO = 51
--  AND rot.SEQUENCIA_ESTAGIO = 10
ORDER BY
rot.GRUPO_ESTRUTURA
, rot.SEQUENCIA_ESTAGIO
;

SELECT
r.DESCR_REFERENCIA
FROM BASI_030 r
WHERE r.NIVEL_ESTRUTURA = 1
AND r.REFERENCIA = '00620'
;

WITH insumos AS
(
SELECT DISTINCT
r.NIVEL_ESTRUTURA NIVEL
, r.REFERENCIA REF
, r.DESCR_REFERENCIA DESCR
, t.TAMANHO_REF TAM
, t.DESCR_TAM_REFER DESCR_TAM
, tam.ORDEM_TAMANHO ORDEM_TAM
, c.ITEM_ESTRUTURA COR
, c.DESCRICAO_15 DESCR_COR
--, count(ia.ROWID)
FROM BASI_030 r -- referencia
JOIN BASI_020 t -- tamanho
ON t.BASI030_NIVEL030 = r.NIVEL_ESTRUTURA
AND t.BASI030_REFERENC = r.REFERENCIA
LEFT JOIN BASI_220 tam -- cadastro de tamanhos
ON tam.TAMANHO_REF = t.TAMANHO_REF
JOIN BASI_010 c -- cor
ON c.NIVEL_ESTRUTURA = r.NIVEL_ESTRUTURA
AND c.GRUPO_ESTRUTURA = r.REFERENCIA
AND c.SUBGRU_ESTRUTURA = t.TAMANHO_REF
JOIN BASI_050 ia -- insumos de alternativa
ON ia.NIVEL_COMP = r.NIVEL_ESTRUTURA
AND ia.GRUPO_COMP = r.REFERENCIA
AND (ia.SUB_COMP = t.TAMANHO_REF OR ia.SUB_COMP = '000')
AND (ia.ITEM_COMP = c.ITEM_ESTRUTURA OR ia.ITEM_COMP = '000000')
WHERE r.NIVEL_ESTRUTURA IN (2, 9)
AND r.DESCR_REFERENCIA NOT LIKE '-%'
AND t.DESCR_TAM_REFER  NOT LIKE '-%'
AND c.DESCRICAO_15  NOT LIKE '-%'
AND c.ITEM_ATIVO = 0 -- ativo
--GROUP BY
--  r.NIVEL_ESTRUTURA
--, r.REFERENCIA
--, r.DESCR_REFERENCIA
--, t.TAMANHO_REF
--, t.DESCR_TAM_REFER
--, c.ITEM_ESTRUTURA
--, c.DESCRICAO_15
ORDER BY
r.NIVEL_ESTRUTURA
, r.REFERENCIA
, c.ITEM_ESTRUTURA
, tam.ORDEM_TAMANHO
, t.TAMANHO_REF
)
SELECT
i.*
FROM insumos i
WHERE rownum < 10
;


SELECT
i.NIVEL_ESTRUTURA NIVEL
, i.REFERENCIA REF
, i.DESCR_REFERENCIA DESCR
, ic.ITEM_ESTRUTURA COR
, ic.DESCRICAO_15 DESCR_COR
, it.TAMANHO_REF TAM
, it.DESCR_TAM_REFER DESCR_TAM
, coalesce(parm.ESTOQUE_MINIMO, 0) STQ_MIN
, coalesce(parm.TEMPO_REPOSICAO, 0) REPOSICAO
, coalesce(parm.LOTE_MULTIPLO, 0) LOTE_MULTIPLO
, i.UNIDADE_MEDIDA UNID
, COALESCE(e.QTDE_ESTOQUE_ATU, 0) QUANT
, e.DATA_ULT_ENTRADA ULT_ENTRADA
, e.DATA_ULT_SAIDA ULT_SAIDA
, e.DT_INVENTARIO
FROM BASI_010 ic -- insumo cor
JOIN BASI_020 it -- insumo tamanho
ON it.BASI030_NIVEL030 = ic.NIVEL_ESTRUTURA
AND it.BASI030_REFERENC = ic.GRUPO_ESTRUTURA
AND it.TAMANHO_REF = ic.SUBGRU_ESTRUTURA
JOIN BASI_030 i -- insumo
ON i.NIVEL_ESTRUTURA = ic.NIVEL_ESTRUTURA
AND i.REFERENCIA = ic.GRUPO_ESTRUTURA
LEFT JOIN BASI_015 parm -- parâmetros de item
ON parm.NIVEL_ESTRUTURA = ic.NIVEL_ESTRUTURA
AND parm.GRUPO_ESTRUTURA = ic.GRUPO_ESTRUTURA
AND parm.SUBGRU_ESTRUTURA = ic.SUBGRU_ESTRUTURA
AND parm.ITEM_ESTRUTURA = ic.ITEM_ESTRUTURA
LEFT JOIN ESTQ_040 e -- estoque por depósito
ON e.CDITEM_NIVEL99 = ic.NIVEL_ESTRUTURA
AND e.CDITEM_GRUPO = ic.GRUPO_ESTRUTURA
AND e.CDITEM_SUBGRUPO = ic.SUBGRU_ESTRUTURA
AND e.CDITEM_ITEM = ic.ITEM_ESTRUTURA
-- vvv não tenho certeza disso, mas evita aparecer mais de um registro
AND e.LOTE_ACOMP = 0
AND e.DEPOSITO =
CASE WHEN i.NIVEL_ESTRUTURA = 2 THEN 202
ELSE -- i.NIVEL_ESTRUTURA = 9
CASE WHEN i.CONTA_ESTOQUE = 22 THEN 212
ELSE 231
END
END
WHERE ic.NIVEL_ESTRUTURA = 2
AND ic.GRUPO_ESTRUTURA = 'MA002'
AND ic.ITEM_ESTRUTURA = '0000BR'
AND ic.SUBGRU_ESTRUTURA = 'UNI'
;

SELECT
i.NIVEL_ESTRUTURA NIVEL
, i.REFERENCIA REF
, i.DESCR_REFERENCIA DESCR
, ic.ITEM_ESTRUTURA COR
, ic.DESCRICAO_15 DESCR_COR
, it.TAMANHO_REF TAM
, it.DESCR_TAM_REFER DESCR_TAM
, coalesce(parm.ESTOQUE_MINIMO, 0) STQ_MIN
, coalesce(parm.TEMPO_REPOSICAO, 0) REPOSICAO
, coalesce(parm.LOTE_MULTIPLO, 0) LOTE_MULTIPLO
, i.UNIDADE_MEDIDA UNID
, COALESCE(e.QTDE_ESTOQUE_ATU, 0) QUANT
, e.DATA_ULT_ENTRADA ULT_ENTRADA
, e.DATA_ULT_SAIDA ULT_SAIDA
, e.DT_INVENTARIO
FROM BASI_030 i -- insumo
JOIN BASI_020 it -- insumo tamanho
ON it.BASI030_NIVEL030 = i.NIVEL_ESTRUTURA
AND it.BASI030_REFERENC = i.REFERENCIA
AND it.TAMANHO_REF = 'UNI'
JOIN BASI_010 ic -- insumo cor
ON ic.NIVEL_ESTRUTURA = i.NIVEL_ESTRUTURA
AND ic.GRUPO_ESTRUTURA = i.REFERENCIA
AND ic.SUBGRU_ESTRUTURA = it.TAMANHO_REF
AND ic.ITEM_ESTRUTURA = '0000BR'
LEFT JOIN BASI_015 parm -- parâmetros de item
ON parm.NIVEL_ESTRUTURA = i.NIVEL_ESTRUTURA
AND parm.GRUPO_ESTRUTURA = i.REFERENCIA
AND parm.SUBGRU_ESTRUTURA = it.TAMANHO_REF
AND parm.ITEM_ESTRUTURA = ic.ITEM_ESTRUTURA
LEFT JOIN ESTQ_040 e -- estoque por depósito
ON e.CDITEM_NIVEL99 = i.NIVEL_ESTRUTURA
AND e.CDITEM_GRUPO = i.REFERENCIA
AND e.CDITEM_SUBGRUPO = it.TAMANHO_REF
AND e.CDITEM_ITEM = ic.ITEM_ESTRUTURA
-- vvv não tenho certeza disso, mas evita aparecer mais de um registro
AND e.LOTE_ACOMP = 0
AND e.DEPOSITO =
CASE WHEN i.NIVEL_ESTRUTURA = 2 THEN 202
ELSE -- i.NIVEL_ESTRUTURA = 9
CASE WHEN i.CONTA_ESTOQUE = 22 THEN 212
ELSE 231
END
END
WHERE i.NIVEL_ESTRUTURA = 2
AND i.REFERENCIA = 'MA002'
;




SELECT
r.NIVEL_ESTRUTURA NIVEL
, r.REFERENCIA REF
, r.DESCR_REFERENCIA DESCR
, t.TAMANHO_REF TAM
, t.DESCR_TAM_REFER DESCR_TAM
, tam.ORDEM_TAMANHO ORDEM_TAM
, c.ITEM_ESTRUTURA COR
, c.DESCRICAO_15 DESCR_COR
FROM BASI_030 r -- referencia
JOIN BASI_020 t -- tamanho
ON t.BASI030_NIVEL030 = r.NIVEL_ESTRUTURA
AND t.BASI030_REFERENC = r.REFERENCIA
LEFT JOIN BASI_220 tam -- cadastro de tamanhos
ON tam.TAMANHO_REF = t.TAMANHO_REF
JOIN BASI_010 c -- cor
ON c.NIVEL_ESTRUTURA = r.NIVEL_ESTRUTURA
AND c.GRUPO_ESTRUTURA = r.REFERENCIA
AND c.SUBGRU_ESTRUTURA = t.TAMANHO_REF
WHERE r.NIVEL_ESTRUTURA = 2
AND r.REFERENCIA = 'MA002'
AND c.ITEM_ESTRUTURA = '0000BR'
AND t.TAMANHO_REF = 'UNI'
;

SELECT
case
when o.REFERENCIA_PECA <= '99999' then 'PA'
when o.REFERENCIA_PECA <= 'B9999' then 'PG'
else 'MD'
end TIPO_REF
, CASE
WHEN o.ORDEM_PRINCIPAL <> 0
OR ofi.ORDEM_PRODUCAO IS NOT NULL
OR ome.ORDEM_PRODUCAO IS NOT NULL
OR ose.ORDEM_PRODUCAO IS NOT NULL
THEN 'Relacionada'
ELSE 'Avulsa'
END TIPO_OP
--, coalesce( ofi.ORDEM_PRODUCAO,
--    coalesce( ome.ORDEM_PRODUCAO,
--      coalesce( ose.ORDEM_PRODUCAO, o.ORDEM_PRINCIPAL )
--    )
--  ) OP_REL
, o.SITUACAO ||
CASE
WHEN o.SITUACAO = 2 THEN '-Ordem conf. gerada'
WHEN o.SITUACAO = 4 THEN '-Ordens em produção'
WHEN o.SITUACAO = 9 THEN '-Ordem cancelada'
ELSE ' '
END SITUACAO
, o.COD_CANCELAMENTO ||
CASE
WHEN o.COD_CANCELAMENTO = 0 THEN ''
ELSE '-' || COALESCE(c.DESCRICAO, '')
END CANCELAMENTO
, o.ALTERNATIVA_PECA ALTERNATIVA
, o.ROTEIRO_PECA ROTEIRO
, o.REFERENCIA_PECA REF
, COALESCE(
CASE WHEN o.REFERENCIA_PECA < 'C0000' THEN
CAST( CAST( regexp_replace(o.REFERENCIA_PECA, '[^0-9]', '')
        AS INTEGER ) AS VARCHAR2(5) )
ELSE
( SELECT
CAST( MAX(
  CASE WHEN ec.GRUPO_ITEM IS NULL THEN 0
  ELSE CAST( regexp_replace(ec.GRUPO_ITEM, '[^0-9]', '')
             AS INTEGER )
  END
) AS VARCHAR2(5) )
FROM BASI_050 ec
JOIN BASI_030 rr
  ON rr.NIVEL_ESTRUTURA = ec.NIVEL_ITEM
 AND rr.REFERENCIA = ec.GRUPO_ITEM
 AND rr.RESPONSAVEL IS NOT NULL
WHERE ec.NIVEL_COMP = 1
  AND ec.GRUPO_COMP = o.REFERENCIA_PECA
)
END
, ' ' ) MODELO
, ( SELECT
COUNT( DISTINCT l.ORDEM_CONFECCAO )
FROM pcpc_040 l
WHERE l.ORDEM_PRODUCAO = o.ORDEM_PRODUCAO
) LOTES
, ( SELECT
SUM( l.QTDE_PECAS_PROG )
FROM pcpc_040 l
WHERE l.ORDEM_PRODUCAO = o.ORDEM_PRODUCAO
AND l.SEQ_OPERACAO = (
SELECT
  MAX( ls.SEQ_OPERACAO )
FROM pcpc_040 ls
WHERE ls.ORDEM_PRODUCAO = l.ORDEM_PRODUCAO
)
) QTD
, o.DATA_PROGRAMACAO DT_DIGITACAO
, o.DATA_ENTRADA_CORTE DT_CORTE
, o.PERIODO_PRODUCAO PERIODO
, p.DATA_INI_PERIODO PERIODO_INI
, p.DATA_FIM_PERIODO PERIODO_FIM
, o.DEPOSITO_ENTRADA || ' - ' || d.DESCRICAO DEPOSITO
, o.PEDIDO_VENDA PEDIDO
, COALESCE(ped.COD_PED_CLIENTE, ' ') PED_CLIENTE
, r.NUMERO_MOLDE MOLDE
, r.DESCR_REFERENCIA DESCR_REF
, o.OBSERVACAO
, o.OBSERVACAO2
, ( SELECT
coalesce( max( l.CODIGO_FAMILIA || '-' || div.DESCRICAO ), ' ' )
FROM pcpc_040 l
LEFT JOIN BASI_180 div
ON div.DIVISAO_PRODUCAO = l.CODIGO_FAMILIA
WHERE l.ORDEM_PRODUCAO = o.ORDEM_PRODUCAO
AND l.CODIGO_FAMILIA > 1
AND l.CODIGO_FAMILIA < 1000
) UNIDADE
FROM PCPC_020 o
JOIN PCPC_010 p
ON p.AREA_PERIODO = 1
AND p.PERIODO_PRODUCAO = o.PERIODO_PRODUCAO
LEFT JOIN pcpt_050 c
ON c.COD_CANCELAMENTO = o.COD_CANCELAMENTO
LEFT JOIN PCPC_020 ofi
ON ofi.ORDEM_PRINCIPAL = o.ORDEM_PRODUCAO
LEFT JOIN PCPC_020 ome
ON ome.ORDEM_PRODUCAO = o.ORDEM_MESTRE
AND o.ORDEM_MESTRE <> 0
AND o.ORDEM_MESTRE IS NOT NULL
LEFT JOIN PCPC_020 ose
ON ose.ORDEM_MESTRE = o.ORDEM_PRODUCAO
JOIN BASI_205 d
ON d.CODIGO_DEPOSITO = o.DEPOSITO_ENTRADA
LEFT JOIN PEDI_100 ped -- pedido de venda
ON ped.PEDIDO_VENDA = o.PEDIDO_VENDA
JOIN basi_030 r
ON r.NIVEL_ESTRUTURA = 1
AND r.REFERENCIA = o.REFERENCIA_PECA
WHERE o.ORDEM_PRODUCAO = 6703
AND rownum = 1
;

-- relacionamentos entre OPs
WITH ordemp AS
(
SELECT
o.ORDEM_PRODUCAO OP
, o.ORDEM_PRINCIPAL
, o.ORDEM_MESTRE
FROM PCPC_020 o
WHERE o.ORDEM_PRODUCAO = 7731
)
SELECT
o.OP
, 10
, CAST('é Mãe de' AS varchar2(50)) REL
, coalesce(ofi.ORDEM_PRODUCAO, 0) OP_REL
FROM ordemp o
JOIN PCPC_020 ofi
ON ofi.ORDEM_PRINCIPAL = o.OP
--
UNION
--
SELECT
o.OP
, 15
, CAST('é Avó de' AS varchar2(50)) REL
, coalesce(one.ORDEM_PRODUCAO, 0) OP_REL
FROM ordemp o
JOIN PCPC_020 ofi
ON ofi.ORDEM_PRINCIPAL = o.OP
JOIN PCPC_020 one
ON one.ORDEM_PRINCIPAL = ofi.ORDEM_PRODUCAO
--
UNION
--
SELECT
o.OP
, 20
, CAST('é Filha de' AS varchar2(50)) REL
, o.ORDEM_PRINCIPAL OP_REL
FROM ordemp o
WHERE o.ORDEM_PRINCIPAL <> 0
--
UNION
--
SELECT
o.OP
, 25
, CAST('é Neta de' AS varchar2(50)) REL
, one.ORDEM_PRINCIPAL OP_REL
FROM ordemp o
JOIN PCPC_020 one
ON one.ORDEM_PRODUCAO = o.ORDEM_PRINCIPAL
WHERE o.ORDEM_PRINCIPAL <> 0
AND one.ORDEM_PRINCIPAL <> 0
--
UNION
--
SELECT
o.OP
, 30
, CAST('é Mestra de' AS varchar2(50)) REL
, ose.ORDEM_PRODUCAO OP_REL
FROM ordemp o
JOIN PCPC_020 ose
ON ose.ORDEM_MESTRE = o.OP
--
UNION
--
SELECT
o.OP
, 40
, CAST('é Seguidora de' AS varchar2(50)) REL
, o.ORDEM_MESTRE OP_REL
FROM ordemp o
WHERE o.ORDEM_MESTRE <> 0
--
ORDER BY
1
, 2
;

SELECT DISTINCT
o.ORDEM_ASSOCIADA
FROM PCPC_020 o
;

SELECT
x.CODIGO_ROLO
, x.ROLO_ESTOQUE
, x.ORDEM_PRODUCAO
, x.CODIGO_DEPOSITO
--, sum(x.QTDE_QUILOS_ACAB) tot
, x.*
FROM PCPT_020 x -- cadastro de rolos
WHERE 1=1
--  AND x.PANOACAB_GRUPO = 'TC004'
AND x.ORDEM_PRODUCAO <> 0
--  AND x.CODIGO_ROLO = 370
--WHERE x.NUMERO_ROLO = 8080
--   OR x.NUMERO_LOTE = 8080
--   OR x.NR_VOLUME = 8080
--   OR x.NR_SOLIC_VOLUME = 8080
--   OR x.NUMERO_PROGRAMA = 8080
--   OR x.NR_ROLO_ORIGEM = 8080
--   OR x.NUMERO_TUBETE = 8080
--  AND x.ROLO_ESTOQUE = 2
--ORDER BY
--  x.CODIGO_ROLO
--GROUP BY
--  x.ROLO_ESTOQUE
--, x.ORDEM_PRODUCAO
--, x.CODIGO_DEPOSITO
;

SELECT
ro.CODIGO_ROLO
, ro.PANOACAB_NIVEL99
, ro.PANOACAB_GRUPO
, ro.PANOACAB_SUBGRUPO
, ro.PANOACAB_ITEM
, ro.ROLO_ESTOQUE
, COALESCElesce(re.ORDEM_PRODUCAO, 0) ORDEM_PRODUCAO
FROM PCPT_020 ro -- cadastro de rolos
LEFT JOIN TMRP_141 re -- reserva de rolo para OP
ON re.CODIGO_ROLO = ro.CODIGO_ROLO
--WHERE re.ORDEM_PRODUCAO <> 0
WHERE ro.CODIGO_ROLO = 11019
ORDER BY
ro.CODIGO_ROLO DESC
;

SELECT
x.GRUPO_PRODUTO
, x.ORDEM_PRODUCAO
, x.*
FROM TMRP_141 x -- reserva de rolo para OP
WHERE 1=1
--  AND x.GRUPO_PRODUTO = 'MA005'
--  AND x.CODIGO_ROLO = 3648
--  AND x.ORDEM_PRODUCAO <> 0
;

WITH NECES AS (
SELECT
ness.SEMANA_NECESSIDADE
, ness.ORDEM_PRODUCAO
, ness.QTD_INSUMO
, oss.NUMERO_ORDEM
, sum( nfs.QTDE_ESTRUTURA ) QTD_OS
FROM (
SELECT
TRUNC(coalesce(op.DATA_ENTRADA_CORTE, SYSDATE) - 7, 'iw')
SEMANA_NECESSIDADE
, op.ORDEM_PRODUCAO
, sum( ia.CONSUMO *
   (
( lote.QTDE_PECAS_PROG - lote.QTDE_PECAS_PROD
- lote.-QTDE_PECAS_2A - lote.QTDE_PERDAS - lote.QTDE_CONSERTO )
   )
 ) QTD_INSUMO
FROM BASI_030 ref -- referencia
JOIN PCPC_020 op -- OP
ON op.REFERENCIA_PECA = ref.REFERENCIA
JOIN PCPC_040 lote -- lote
ON lote.ORDEM_PRODUCAO = op.ORDEM_PRODUCAO
JOIN BASI_050 ia -- insumos de alternativa
ON ia.NIVEL_ITEM = 1
AND ia.NIVEL_COMP <> 1
AND ia.GRUPO_ITEM = op.REFERENCIA_PECA
AND (ia.SUB_ITEM = lote.PROCONF_SUBGRUPO OR ia.SUB_ITEM = '000')
AND (ia.ITEM_ITEM = lote.PROCONF_ITEM OR ia.ITEM_ITEM = '000000')
AND ia.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
AND ia.ESTAGIO = lote.CODIGO_ESTAGIO
LEFT JOIN BASI_040 coc -- combinação cor
ON ia.ITEM_COMP = '000000'
AND coc.GRUPO_ITEM = ia.GRUPO_ITEM
AND coc.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
AND coc.SEQUENCIA = ia.SEQUENCIA
AND coc.ITEM_ITEM = lote.PROCONF_ITEM
LEFT JOIN BASI_040 cot -- combinação tamanho
ON ia.SUB_COMP = '000'
AND cot.GRUPO_ITEM = ia.GRUPO_ITEM
AND cot.ALTERNATIVA_ITEM = op.ALTERNATIVA_PECA
AND cot.SEQUENCIA = ia.SEQUENCIA
AND cot.SUB_ITEM = lote.PROCONF_SUBGRUPO
WHERE op.SITUACAO IN (2, 4) -- não cancelada
AND ia.NIVEL_COMP = 2
AND ia.GRUPO_COMP = 'MA002'
AND CASE WHEN ia.ITEM_COMP = '000000'
  THEN coc.ITEM_COMP
  ELSE ia.ITEM_COMP
  END = '0000BR'
AND CASE WHEN ia.SUB_COMP = '000'
  THEN cot.SUB_COMP
  ELSE ia.SUB_COMP
  END = 'UNI'
AND op.DATA_ENTRADA_CORTE <= (TO_DATE('20180723','YYYYMMDD')+6+7*35+7) -- filtra_DATA_ENTRADA_CORTE
GROUP BY
TRUNC(coalesce(op.DATA_ENTRADA_CORTE, SYSDATE) - 7, 'iw')
, op.ORDEM_PRODUCAO
HAVING
sum( ia.CONSUMO *
   (
( lote.QTDE_PECAS_PROG - lote.QTDE_PECAS_PROD
- lote.QTDE_PECAS_2A - lote.QTDE_PERDAS - lote.QTDE_CONSERTO )
   )
 ) > 0
ORDER BY
1, 2
) ness
LEFT JOIN (
SELECT UNIQUE
os.NUMERO_ORDEM
, l.ORDEM_PRODUCAO
FROM OBRF_080 os
JOIN pcpc_040 l
ON l.NUMERO_ORDEM = os.NUMERO_ORDEM
WHERE l.NUMERO_ORDEM <> 0
) oss
ON oss.ORDEM_PRODUCAO = ness.ORDEM_PRODUCAO
LEFT JOIN OBRF_082 nfs
ON nfs.NUMERO_ORDEM = oss.NUMERO_ORDEM
AND nfs.PRODSAI_NIVEL99 = 2
AND nfs.PRODSAI_GRUPO = 'MA002'
AND nfs.PRODSAI_ITEM = '0000BR'
AND nfs.PRODSAI_SUBGRUPO = 'UNI'
GROUP BY
ness.SEMANA_NECESSIDADE
, ness.ORDEM_PRODUCAO
, ness.QTD_INSUMO
, oss.NUMERO_ORDEM
--  ORDER BY
--    1, 2, 3, 4
)
SELECT
n.SEMANA_NECESSIDADE
, sum(n.QTD_INSUMO) - coalesce(sum(n.QTD_OS), 0) QTD_INSUMO
FROM NECES n
GROUP BY
n.SEMANA_NECESSIDADE
HAVING
sum(n.QTD_INSUMO) - coalesce(sum(n.QTD_OS), 0) > 0
ORDER BY
n.SEMANA_NECESSIDADE
;

SELECT
u.*
FROM HDOC_030 u -- cadastro de usuários
WHERE u.USUARIO = 'DOUGLAS_LOG'
;

SELECT
*
FROM oper_276
;

SELECT
--DISTINCT
--  r.*
r.ROLO_ESTOQUE
, count(*)
FROM PCPT_020 r -- cadastro de rolos
GROUP BY
r.ROLO_ESTOQUE
;

SELECT distinct
rr.*
--  rr.TIPO_RESERVA
FROM TMRP_141 rr -- rolos reservados
;

SELECT
r.*
FROM PCPT_020 r -- cadastro de rolos
WHERE r.ROLO_ESTOQUE = 3
;

UPDATE PCPT_020 r -- cadastro de rolos
SET
r.ROLO_ESTOQUE = 1
WHERE r.ROLO_ESTOQUE = 3
;

SELECT
ip.LOTE_MULTIPLO
, ip.*
FROM BASI_015 ip
WHERE ip.GRUPO_ESTRUTURA = 'ET004'
ORDER BY
ip.LOTE_MULTIPLO DESC
;

SELECT
ia.*
FROM BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_COMP = 9
AND ia.GRUPO_COMP = 'FT001'
AND ia.ESTAGIO <> 18
;

UPDATE BASI_050 ia -- insumos de alternativa
SET
ia.ESTAGIO = 18
WHERE ia.NIVEL_COMP = 9
AND ia.GRUPO_COMP = 'FT001'
AND ia.ESTAGIO <> 18
;

SELECT
u.*
FROM HDOC_030 u -- cadastro de usuários
WHERE u.USUARIO = 'GABRIEL_PCP'
;

SELECT DISTINCT
ia.ALTERNATIVA_ITEM ALTERNATIVA
, COALESCE( al.DESCRICAO, '' ) DESCR
, COALESCE(
( SELECT
ec.GRUPO_COMP
FROM BASI_050 ec
WHERE ec.NIVEL_ITEM = ia.NIVEL_ITEM
AND ec.GRUPO_ITEM = ia.GRUPO_ITEM
AND ec.ALTERNATIVA_ITEM = ia.ALTERNATIVA_ITEM
AND ec.NIVEL_COMP = 1
AND rownum = 1
), ' ') REF
FROM BASI_050 ia -- insumos de alternativa
LEFT JOIN BASI_070 al
ON al.ALTERNATIVA = ia.ALTERNATIVA_ITEM
AND al.ROTEIRO = 0
WHERE ia.NIVEL_ITEM = 1
AND ia.GRUPO_ITEM = '00680'
ORDER BY
ia.ALTERNATIVA_ITEM
;

SELECT
al.*
FROM BASI_070 al
WHERE al.ROTEIRO = 0
;

SELECT DISTINCT
ia.ALTERNATIVA_ITEM ALTERNATIVA
, COALESCE( al.DESCRICAO, '' ) DESCR
, ia.GRUPO_COMP REF
FROM BASI_050 ia -- insumos de alternativa
LEFT JOIN BASI_070 al -- cadastro de alternativas de estrutura e de roteiro
ON al.ROTEIRO = 0 -- seleciona cadastro de alternativas de estrutura
AND al.ALTERNATIVA = ia.ALTERNATIVA_ITEM
WHERE ia.NIVEL_ITEM = 1
AND ia.NIVEL_COMP = 1
AND ia.GRUPO_ITEM = '00680'
ORDER BY
ia.ALTERNATIVA_ITEM
;

SELECT DISTINCT
ia.ALTERNATIVA_ITEM ALTERNATIVA
, COALESCE( al.DESCRICAO, '' ) DESCR
, LISTAGG(COALESCE(ia.GRUPO_COMP, ''), ', ')
WITHIN GROUP (ORDER BY ia.ALTERNATIVA_ITEM) REF
FROM BASI_050 ia -- insumos de alternativa
LEFT JOIN BASI_070 al -- cadastro de alternativas de estrutura e de roteiro
ON al.ROTEIRO = 0 -- seleciona cadastro de alternativas de estrutura
AND al.ALTERNATIVA = ia.ALTERNATIVA_ITEM
WHERE ia.NIVEL_ITEM = 1
--  AND ia.NIVEL_COMP = 1
AND ia.GRUPO_ITEM = 'R0417'
GROUP BY
ia.ALTERNATIVA_ITEM
, al.DESCRICAO
ORDER BY
ia.ALTERNATIVA_ITEM
;

SELECT
ia.*
FROM BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_COMP = 9
AND ia.GRUPO_COMP = 'ET003'
AND ia.ESTAGIO <> 18
;

UPDATE BASI_050 ia -- insumos de alternativa
SET
ia.ESTAGIO = 18
WHERE ia.NIVEL_COMP = 9
AND ia.GRUPO_COMP = 'ET003'
AND ia.ESTAGIO <> 18
;

SELECT
ia.*
FROM BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_COMP = 9
AND ia.GRUPO_COMP = 'EB001'
AND ia.ESTAGIO <> 18
;

UPDATE BASI_050 ia -- insumos de alternativa
SET
ia.ESTAGIO = 18
WHERE ia.NIVEL_COMP = 9
AND ia.GRUPO_COMP = 'EB001'
AND ia.ESTAGIO <> 18
;

SELECT DISTINCT
ia.ALTERNATIVA_ITEM ALTERNATIVA
, COALESCE( al.DESCRICAO, '' ) DESCR
, COALESCE(
( SELECT
LISTAGG(COALESCE(ec.GRUPO_COMP, ''), ', ')
WITHIN GROUP (ORDER BY ec.ALTERNATIVA_ITEM) REF
FROM BASI_050 ec
WHERE ec.NIVEL_ITEM = ia.NIVEL_ITEM
AND ec.GRUPO_ITEM = ia.GRUPO_ITEM
AND ec.ALTERNATIVA_ITEM = ia.ALTERNATIVA_ITEM
AND ec.NIVEL_COMP = 1
), ' ') REF
FROM BASI_050 ia -- insumos de alternativa
LEFT JOIN BASI_070 al -- cadastro de alternativas de estrutura e de roteiro
ON al.ROTEIRO = 0 -- seleciona cadastro de alternativas de estrutura
AND al.ALTERNATIVA = ia.ALTERNATIVA_ITEM
WHERE ia.NIVEL_ITEM = 1
AND ia.GRUPO_ITEM = 'R0417'
ORDER BY
ia.ALTERNATIVA_ITEM
;

SELECT
ia.*
FROM BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_COMP = 9
AND ia.GRUPO_COMP LIKE 'AL0%'
AND ia.ESTAGIO <> 18
;

UPDATE BASI_050 ia -- insumos de alternativa
SET
ia.ESTAGIO = 18
WHERE ia.NIVEL_COMP = 9
AND ia.GRUPO_COMP LIKE 'AL0%'
AND ia.ESTAGIO <> 18
;

SELECT
i.SORTIMENTO
, i.SORTIMENTO || ' - ' || max( p.DESCRICAO_15 ) DESCR
FROM PCPC_021 i
JOIN pcpc_020 op
ON op.ORDEM_PRODUCAO = i.ORDEM_PRODUCAO
LEFT JOIN basi_010 p
ON p.NIVEL_ESTRUTURA = 1
AND p.GRUPO_ESTRUTURA = op.REFERENCIA_PECA
AND p.ITEM_ESTRUTURA = i.SORTIMENTO
WHERE i.ORDEM_PRODUCAO = 7067
GROUP BY
i.SORTIMENTO
ORDER BY
2
;

SELECT DISTINCT
lote.PROCONF_SUBGRUPO TAMANHO
, lote.PROCONF_ITEM SORTIMENTO
, lote.*
FROM PCPC_040 lote
WHERE lote.ORDEM_PRODUCAO = 7067
;

SELECT
lote.PROCONF_ITEM SORTIMENTO
, lote.PROCONF_ITEM || ' - ' || max( p.DESCRICAO_15 ) DESCR
FROM PCPC_040 lote
LEFT JOIN basi_010 p
ON p.NIVEL_ESTRUTURA = 1
AND p.GRUPO_ESTRUTURA = lote.PROCONF_GRUPO
AND p.ITEM_ESTRUTURA = lote.PROCONF_ITEM
WHERE lote.ORDEM_PRODUCAO = 7067
GROUP BY
lote.PROCONF_ITEM
ORDER BY
2
;

SELECT DISTINCT
lote.PROCONF_SUBGRUPO TAMANHO
, tam.ORDEM_TAMANHO
FROM PCPC_040 lote
LEFT JOIN BASI_220 tam
ON tam.TAMANHO_REF = lote.PROCONF_SUBGRUPO
WHERE lote.ORDEM_PRODUCAO = 7067
ORDER BY
2
;

SELECT
lote.*
FROM PCPC_040 lote
;

SELECT
p.PEDIDO_VENDA PEDIDO
, c.NOME_CLIENTE
|| ' (' || lpad(c.CGC_9, 8, '0')
|| '/' || lpad(c.CGC_4, 4, '0')
|| '-' || lpad(c.CGC_2, 2, '0')
|| ')' CLIENTE
, i.CD_IT_PE_NIVEL99 NIVEL
, i.CD_IT_PE_GRUPO REF
, i.CD_IT_PE_ITEM COR
, i.CD_IT_PE_SUBGRUPO TAM
, i.QTDE_PEDIDA QTD
, coalesce( ip.REF_CLIENTE, '-') INFADPROD
, coalesce( ip.DESCR_REF_CLIENTE, '-') DESCRCLI
, coalesce( rtc.CODIGO_BARRAS, ' ') EAN
, rtc.NARRATIVA
FROM PEDI_100 p -- pedido de venda
LEFT JOIN PEDI_010 c
ON c.CGC_9 = p.CLI_PED_CGC_CLI9
AND c.CGC_4 = p.CLI_PED_CGC_CLI4
JOIN PEDI_110 i -- item de pedido de venda
ON i.PEDIDO_VENDA = p.PEDIDO_VENDA
JOIN BASI_010 rtc -- item (ref+tam+cor)
on rtc.NIVEL_ESTRUTURA = i.CD_IT_PE_NIVEL99
AND rtc.GRUPO_ESTRUTURA = i.CD_IT_PE_GRUPO
AND rtc.SUBGRU_ESTRUTURA = i.CD_IT_PE_SUBGRUPO
AND rtc.ITEM_ESTRUTURA = i.CD_IT_PE_ITEM
LEFT JOIN ESTQ_400 ip -- item - informações por cliente
ON ip.CLIENTE9 = CLI_PED_CGC_CLI9
AND ip.CLIENTE4 = CLI_PED_CGC_CLI4
AND ip.NIVEL_ESTRUTURA = i.CD_IT_PE_NIVEL99
AND ip.GRUPO_ESTRUTURA = i.CD_IT_PE_GRUPO
AND ip.SUBGRUPO_ESTRUTURA = i.CD_IT_PE_SUBGRUPO
AND ip.ITEM_ESTRUTURA = i.CD_IT_PE_ITEM
LEFT JOIN BASI_220 t -- tamanhos
ON t.TAMANHO_REF = i.CD_IT_PE_SUBGRUPO
WHERE p.PEDIDO_VENDA = 5814
ORDER BY
p.PEDIDO_VENDA
, p.CLI_PED_CGC_CLI9
, p.CLI_PED_CGC_CLI4
, i.CD_IT_PE_NIVEL99
, i.CD_IT_PE_GRUPO
, i.CD_IT_PE_ITEM
, t.ORDEM_TAMANHO
, i.CD_IT_PE_SUBGRUPO
;

SELECT
lote.PROCONF_SUBGRUPO TAMANHO
, lote.PROCONF_ITEM SORTIMENTO
, sum(lote.QTDE_PECAS_PROG ) QUANTIDADE
FROM PCPC_040 lote
LEFT JOIN BASI_220 tam
ON tam.TAMANHO_REF = lote.PROCONF_SUBGRUPO
WHERE lote.ORDEM_PRODUCAO = 7068
AND lote.SEQUENCIA_ESTAGIO
= COALESCE(
  (
    SELECT
      MIN(ulote.SEQUENCIA_ESTAGIO)
    FROM PCPC_040 ulote
    WHERE ulote.ORDEM_PRODUCAO = lote.ORDEM_PRODUCAO
      AND ulote.ORDEM_CONFECCAO = lote.ORDEM_CONFECCAO
    GROUP BY
      ulote.ORDEM_PRODUCAO
    , ulote.ORDEM_CONFECCAO
  )
, 0)
GROUP BY
tam.ORDEM_TAMANHO
, lote.PROCONF_SUBGRUPO
, lote.PROCONF_ITEM
ORDER BY
tam.ORDEM_TAMANHO
, lote.PROCONF_ITEM
;

SELECT
t.*
FROM BASI_220 t
;

SELECT
lote.PROCONF_GRUPO REF
, lote.PROCONF_ITEM COR
, lote.PROCONF_SUBGRUPO TAM
, sum(lote.QTDE_CONSERTO ) QTD
FROM PCPC_040 lote
LEFT JOIN BASI_220 tam
ON tam.TAMANHO_REF = lote.PROCONF_SUBGRUPO
--WHERE lote.ORDEM_PRODUCAO = %s
GROUP BY
lote.PROCONF_GRUPO
, lote.PROCONF_ITEM
, tam.ORDEM_TAMANHO
, lote.PROCONF_SUBGRUPO
HAVING
sum(lote.QTDE_CONSERTO ) > 0
ORDER BY
lote.PROCONF_GRUPO
, lote.PROCONF_ITEM
, tam.ORDEM_TAMANHO
, lote.PROCONF_SUBGRUPO
;

SELECT
op.ORDEM_PRODUCAO OP
, op.SITUACAO
, le.SEQUENCIA_ESTAGIO SEQ
, le.CODIGO_ESTAGIO EST
, le63.SEQUENCIA_ESTAGIO SEQ63
, sum(le.QTDE_EM_PRODUCAO_PACOTE) QTD
FROM PCPC_020 op -- OP capa
LEFT JOIN PCPC_040 le63 -- lote estágio 63
ON le63.ordem_producao = op.ORDEM_PRODUCAO
AND le63.CODIGO_ESTAGIO = 63
LEFT JOIN PCPC_040 le -- lote estágio atual
ON le.ordem_producao = op.ORDEM_PRODUCAO
AND le.PERIODO_PRODUCAO = le63.PERIODO_PRODUCAO
AND le.ORDEM_CONFECCAO = le63.ORDEM_CONFECCAO
AND le.QTDE_EM_PRODUCAO_PACOTE <> 0
--WHERE op.SITUACAO <> 9 -- op.COD_CANCELAMENTO = 0
--  AND ({filtro})
GROUP BY
op.ORDEM_PRODUCAO
, op.SITUACAO
, le.SEQUENCIA_ESTAGIO
, le.CODIGO_ESTAGIO
, le63.SEQUENCIA_ESTAGIO
ORDER BY
op.ORDEM_PRODUCAO
, le.SEQUENCIA_ESTAGIO
;

SELECT
ia.*
FROM BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_COMP = 9
AND ia.GRUPO_COMP = 'ET009'
AND ia.SUB_COMP <> 'UNI'
;

UPDATE BASI_050 ia -- insumos de alternativa
SET
ia.SUB_COMP = 'UNI'
WHERE ia.NIVEL_COMP = 9
AND ia.GRUPO_COMP = 'ET009'
AND ia.SUB_COMP <> 'UNI'
;

SELECT
ia.*
FROM BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_COMP = 9
AND ia.GRUPO_COMP = 'ET009'
AND ia.ITEM_COMP <> '0000BR'
;

UPDATE BASI_050 ia -- insumos de alternativa
SET
ia.ITEM_COMP = '0000BR'
WHERE ia.NIVEL_COMP = 9
AND ia.GRUPO_COMP = 'ET009'
AND ia.ITEM_COMP <> '0000BR'
;

UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618850144' WHERE GRUPO_ESTRUTURA='06000' and SUBGRU_ESTRUTURA='XXP'  and ITEM_ESTRUTURA='0000BR';
UPDATE SYSTEXTIL.BASI_010 SET CODIGO_BARRAS='7899618850304' WHERE GRUPO_ESTRUTURA='06002' and SUBGRU_ESTRUTURA='XPL'  and ITEM_ESTRUTURA='0000BR';

SELECT
ia.*
FROM BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_COMP = 9
AND ia.GRUPO_COMP = 'DV014'
AND ia.CONSUMO <> 0.007
;

UPDATE BASI_050 ia -- insumos de alternativa
SET
ia.CONSUMO = 0.007
WHERE ia.NIVEL_COMP = 9
AND ia.GRUPO_COMP = 'DV014'
AND ia.CONSUMO <> 0.007
;

SELECT
ia.*
FROM BASI_050 ia -- insumos de alternativa
WHERE ia.NIVEL_COMP = 9
AND ia.GRUPO_COMP = 'ET004'
AND ia.CONSUMO <> 0.007
;

UPDATE BASI_050 ia -- insumos de alternativa
SET
ia.CONSUMO = 0.007
WHERE ia.NIVEL_COMP = 9
AND ia.GRUPO_COMP = 'ET004'
AND ia.CONSUMO <> 0.007
;

SELECT
rownum NUM
, rr.NIVEL
, rr.REF
, rr.COR
, rr.COR_DESC
, rr.TIPO
, rr.DESCR
, rr.RESP
, rr.CNPJ9
, rr.CNPJ4
, rr.CNPJ2
, rr.CLIENTE
FROM (
SELECT DISTINCT
r.NIVEL_ESTRUTURA NIVEL
, r.REFERENCIA REF
, CASE WHEN r.REFERENCIA <= '99999' THEN 'PA'
WHEN r.REFERENCIA like 'A%' or r.REFERENCIA like 'B%' THEN 'PG'
WHEN r.REFERENCIA like 'Z%' THEN 'MP'
ELSE 'MD'
END TIPO
, r.DESCR_REFERENCIA DESCR
, r.RESPONSAVEL RESP
, r.CGC_CLIENTE_9 CNPJ9
, r.CGC_CLIENTE_4 CNPJ4
, r.CGC_CLIENTE_2 CNPJ2
, COALESCE(c.FANTASIA_CLIENTE, c.NOME_CLIENTE) CLIENTE
, cor.ITEM_ESTRUTURA COR
, cor.DESCRICAO_15 COR_DESC
FROM BASI_030 r
LEFT JOIN BASI_010 cor
ON cor.NIVEL_ESTRUTURA = r.NIVEL_ESTRUTURA
AND cor.GRUPO_ESTRUTURA = r.REFERENCIA
LEFT JOIN PEDI_010 c
ON c.CGC_9 = r.CGC_CLIENTE_9
AND c.CGC_4 = r.CGC_CLIENTE_4
AND c.CGC_2 = r.CGC_CLIENTE_2
WHERE r.NIVEL_ESTRUTURA = 1
AND r.RESPONSAVEL IS NOT NULL
AND (  r.REFERENCIA LIKE '%RENN%'
  OR r.DESCR_REFERENCIA LIKE '%RENN%'
  OR r.RESPONSAVEL LIKE '%RENN%'
  OR r.CGC_CLIENTE_9 LIKE '%RENN%'
  OR c.NOME_CLIENTE LIKE '%RENN%'
  OR c.FANTASIA_CLIENTE LIKE '%RENN%'
  )
-- filtro
AND (  cor.ITEM_ESTRUTURA LIKE '%CB%'
  OR cor.DESCRICAO_15 LIKE '%CB%'
  )
-- filtro_cor
ORDER BY
NLSSORT(r.REFERENCIA,'NLS_SORT=BINARY_AI')
) rr
;

SELECT
ia.*
FROM BASI_050 ia -- insumos de alternativa
WHERE 1=1
AND ia.GRUPO_ITEM = '05156'
AND ia.ALTERNATIVA_ITEM = 4
;

SELECT DISTINCT
e.SEQUENCIA
, (
SELECT
LISTAGG(ee.ITEM_ITEM, ', ')
WITHIN GROUP (ORDER BY ee.ITEM_ITEM)
FROM BASI_050 ee
WHERE ee.SEQUENCIA = e.SEQUENCIA
AND ee.NIVEL_ITEM = e.NIVEL_ITEM
AND ee.GRUPO_ITEM = e.GRUPO_ITEM
AND ee.ALTERNATIVA_ITEM = e.ALTERNATIVA_ITEM
AND ee.NIVEL_COMP = e.NIVEL_COMP
AND ee.GRUPO_COMP = e.GRUPO_COMP
AND ee.SUB_COMP = e.SUB_COMP
AND ee.ITEM_COMP = e.ITEM_COMP
AND ee.ALTERNATIVA_COMP = e.ALTERNATIVA_COMP
AND ee.CONSUMO = e.CONSUMO
AND ee.ESTAGIO = e.ESTAGIO
) COR_REF
, e.NIVEL_COMP NIVEL
, e.GRUPO_COMP REF
, r.DESCR_REFERENCIA DESCR
, e.SUB_COMP TAM
, CASE WHEN coc.SUB_ITEM IS NULL
THEN e.ITEM_COMP
ELSE coc.ITEM_ITEM || ' -> ' || coc.ITEM_COMP
END COR
, coc.ITEM_ITEM
, e.ALTERNATIVA_COMP ALTERN
, e.CONSUMO
, e.ESTAGIO || '-' || es.DESCRICAO ESTAGIO
FROM BASI_050 e
LEFT JOIN BASI_040 coc -- combinação cor
ON e.ITEM_COMP = '000000'
AND coc.SUB_ITEM = '000'
AND coc.GRUPO_ITEM = e.GRUPO_ITEM
AND coc.ALTERNATIVA_ITEM = e.ALTERNATIVA_ITEM
AND coc.SEQUENCIA = e.SEQUENCIA
LEFT JOIN basi_030 r
ON r.NIVEL_ESTRUTURA = e.NIVEL_COMP
AND r.REFERENCIA = e.GRUPO_COMP
LEFT JOIN MQOP_005 es
ON es.CODIGO_ESTAGIO = e.ESTAGIO
WHERE e.NIVEL_ITEM = 1
AND e.GRUPO_ITEM = '0156R'
AND e.ALTERNATIVA_ITEM = 4
ORDER BY
e.SEQUENCIA
, 2
, coc.ITEM_ITEM
;


SELECT
coc.*
FROM BASI_040 coc -- combinação cor
WHERE 1=1
--  AND e.ITEM_COMP = '000000'
AND coc.SUB_ITEM = '000'
AND coc.GRUPO_ITEM = '0156R'
AND coc.ALTERNATIVA_ITEM = 4
AND coc.SEQUENCIA = 10
--  AND coc.ITEM_ITEM = e.ITEM_ITEM
;

SELECT
coc.ITEM_ITEM || ' -> ' || coc.ITEM_COMP
FROM BASI_040 coc -- combinação cor
WHERE 1=1
--  AND e.ITEM_COMP = '000000'
AND coc.SUB_ITEM = '000'
AND coc.GRUPO_ITEM = '0156R'
AND coc.ALTERNATIVA_ITEM = 4
AND coc.SEQUENCIA = 140
--  AND coc.ITEM_ITEM = e.ITEM_ITEM
;

SELECT
count(*)
FROM BASI_040 coc -- combinação cor
WHERE 1=1
--  AND e.ITEM_COMP = '000000'
AND coc.SUB_ITEM = '000'
AND coc.GRUPO_ITEM = '0156R'
AND coc.ALTERNATIVA_ITEM = 4
AND coc.SEQUENCIA = 10
AND coc.ITEM_ITEM != coc.ITEM_COMP
;

SELECT
LISTAGG(coc.ITEM_ITEM || ' -> ' || coc.ITEM_COMP, ', ')
WITHIN GROUP (ORDER BY coc.ITEM_ITEM)
FROM BASI_040 coc -- combinação cor
WHERE 1=1
--  AND e.ITEM_COMP = '000000'
AND coc.SUB_ITEM = '000'
AND coc.GRUPO_ITEM = '0156R'
AND coc.ALTERNATIVA_ITEM = 4
AND coc.SEQUENCIA = 140
--  AND coc.ITEM_ITEM = e.ITEM_ITEM
;


SELECT DISTINCT
e.SEQUENCIA
, (
SELECT
LISTAGG(ee.ITEM_ITEM, ', ')
WITHIN GROUP (ORDER BY ee.ITEM_ITEM)
FROM BASI_050 ee
WHERE ee.SEQUENCIA = e.SEQUENCIA
AND ee.NIVEL_ITEM = e.NIVEL_ITEM
AND ee.GRUPO_ITEM = e.GRUPO_ITEM
AND ee.ALTERNATIVA_ITEM = e.ALTERNATIVA_ITEM
AND ee.NIVEL_COMP = e.NIVEL_COMP
AND ee.GRUPO_COMP = e.GRUPO_COMP
AND ee.SUB_COMP = e.SUB_COMP
AND ee.ITEM_COMP = e.ITEM_COMP
AND ee.ALTERNATIVA_COMP = e.ALTERNATIVA_COMP
AND ee.CONSUMO = e.CONSUMO
AND ee.ESTAGIO = e.ESTAGIO
) COR_REF
, e.NIVEL_COMP NIVEL
, e.GRUPO_COMP REF
, r.DESCR_REFERENCIA DESCR
, e.SUB_COMP TAM
, CASE WHEN cocv.SUB_ITEM IS NULL
THEN
CASE WHEN e.ITEM_COMP = '000000'
THEN '=='
ELSE e.ITEM_COMP
END
ELSE coc.ITEM_ITEM || ' -> ' || coc.ITEM_COMP
END COR
, coc.ITEM_ITEM
, e.ALTERNATIVA_COMP ALTERN
, e.CONSUMO
, e.ESTAGIO || '-' || es.DESCRICAO ESTAGIO
FROM BASI_050 e
LEFT JOIN BASI_040 cocv -- combinação cor - verifica se todos iguais
ON e.ITEM_COMP = '000000'
AND cocv.SUB_ITEM = '000'
AND cocv.GRUPO_ITEM = e.GRUPO_ITEM
AND cocv.ALTERNATIVA_ITEM = e.ALTERNATIVA_ITEM
AND cocv.SEQUENCIA = e.SEQUENCIA
AND cocv.ITEM_ITEM != cocv.ITEM_COMP
LEFT JOIN BASI_040 coc -- combinação cor
ON e.ITEM_COMP = '000000'
AND cocv.SUB_ITEM IS NOT NULL
AND coc.SUB_ITEM = '000'
AND coc.GRUPO_ITEM = e.GRUPO_ITEM
AND coc.ALTERNATIVA_ITEM = e.ALTERNATIVA_ITEM
AND coc.SEQUENCIA = e.SEQUENCIA
LEFT JOIN basi_030 r
ON r.NIVEL_ESTRUTURA = e.NIVEL_COMP
AND r.REFERENCIA = e.GRUPO_COMP
LEFT JOIN MQOP_005 es
ON es.CODIGO_ESTAGIO = e.ESTAGIO
WHERE e.NIVEL_ITEM = 1
AND e.GRUPO_ITEM = '0156R'
AND e.ALTERNATIVA_ITEM = 4
ORDER BY
e.SEQUENCIA
, 2
, coc.ITEM_ITEM
;

SELECT
count(DISTINCT coc.ITEM_COMP)
FROM BASI_040 coc -- combinação cor
WHERE 1=1
--  AND e.ITEM_COMP = '000000'
AND coc.SUB_ITEM = '000'
AND coc.GRUPO_ITEM = '0156R'
AND coc.ALTERNATIVA_ITEM = 4
AND coc.SEQUENCIA = 140
--  AND coc.ITEM_ITEM = e.ITEM_ITEM
;

SELECT DISTINCT
e.SEQUENCIA
, (
SELECT
LISTAGG(ee.ITEM_ITEM, ', ')
WITHIN GROUP (ORDER BY ee.ITEM_ITEM)
FROM BASI_050 ee
WHERE ee.SEQUENCIA = e.SEQUENCIA
AND ee.NIVEL_ITEM = e.NIVEL_ITEM
AND ee.GRUPO_ITEM = e.GRUPO_ITEM
AND ee.ALTERNATIVA_ITEM = e.ALTERNATIVA_ITEM
AND ee.NIVEL_COMP = e.NIVEL_COMP
AND ee.GRUPO_COMP = e.GRUPO_COMP
AND ee.SUB_COMP = e.SUB_COMP
AND ee.ITEM_COMP = e.ITEM_COMP
AND ee.ALTERNATIVA_COMP = e.ALTERNATIVA_COMP
AND ee.CONSUMO = e.CONSUMO
AND ee.ESTAGIO = e.ESTAGIO
) COR_REF
, e.NIVEL_COMP NIVEL
, e.GRUPO_COMP REF
, r.DESCR_REFERENCIA DESCR
, e.SUB_COMP TAM
, CASE WHEN cocv.SUB_ITEM IS NULL
THEN
CASE WHEN e.ITEM_COMP = '000000'
THEN '=='
ELSE e.ITEM_COMP
END
ELSE
CASE WHEN
( SELECT
  count(DISTINCT coc1.ITEM_COMP)
FROM BASI_040 coc1 -- combinação cor - verifica se é sempre a mesma
WHERE e.ITEM_COMP = '000000'
  AND coc1.SUB_ITEM = '000'
  AND coc1.GRUPO_ITEM = e.GRUPO_ITEM
  AND coc1.ALTERNATIVA_ITEM = e.ALTERNATIVA_ITEM
  AND coc1.SEQUENCIA = e.SEQUENCIA
) = 1
THEN '=' || CASE WHEN coc.ITEM_COMP = '000000' THEN '?' ELSE coc.ITEM_COMP END
ELSE
CASE WHEN e.NIVEL_COMP = 1
THEN coc.ITEM_ITEM
ELSE
( SELECT
    LISTAGG(coc1.ITEM_ITEM, ', ')
      WITHIN GROUP (ORDER BY coc1.ITEM_ITEM)
  FROM BASI_040 coc1 -- combinação cor - verifica se é sempre a mesma
  WHERE e.ITEM_COMP = '000000'
    AND coc1.SUB_ITEM = '000'
    AND coc1.GRUPO_ITEM = e.GRUPO_ITEM
    AND coc1.ALTERNATIVA_ITEM = e.ALTERNATIVA_ITEM
    AND coc1.SEQUENCIA = e.SEQUENCIA
    AND coc1.ITEM_COMP = coc.ITEM_COMP
)
END
|| ' -> ' || CASE WHEN coc.ITEM_COMP = '000000' THEN '?' ELSE coc.ITEM_COMP END
END
END COR
, e.ALTERNATIVA_COMP ALTERN
, e.CONSUMO
, e.ESTAGIO || '-' || es.DESCRICAO ESTAGIO
FROM BASI_050 e
LEFT JOIN BASI_040 cocv -- combinação cor - verifica se todos iguais
ON e.ITEM_COMP = '000000'
AND cocv.SUB_ITEM = '000'
AND cocv.GRUPO_ITEM = e.GRUPO_ITEM
AND cocv.ALTERNATIVA_ITEM = e.ALTERNATIVA_ITEM
AND cocv.SEQUENCIA = e.SEQUENCIA
AND cocv.ITEM_ITEM != cocv.ITEM_COMP
LEFT JOIN BASI_040 coc -- combinação cor
ON e.ITEM_COMP = '000000'
AND cocv.SUB_ITEM IS NOT NULL
AND coc.SUB_ITEM = '000'
AND coc.GRUPO_ITEM = e.GRUPO_ITEM
AND coc.ALTERNATIVA_ITEM = e.ALTERNATIVA_ITEM
AND coc.SEQUENCIA = e.SEQUENCIA
LEFT JOIN basi_030 r
ON r.NIVEL_ESTRUTURA = e.NIVEL_COMP
AND r.REFERENCIA = e.GRUPO_COMP
LEFT JOIN MQOP_005 es
ON es.CODIGO_ESTAGIO = e.ESTAGIO
WHERE e.NIVEL_ITEM = 1
AND e.GRUPO_ITEM = '5156H'
AND e.ALTERNATIVA_ITEM = 4
ORDER BY
e.SEQUENCIA
, 2
, 7
;

SELECT
LISTAGG(coc.ITEM_ITEM, ', ')
WITHIN GROUP (ORDER BY coc.ITEM_ITEM)
|| ' -> ' || coc.ITEM_COMP
FROM BASI_040 coc -- combinação cor
WHERE 1=1
--  AND e.ITEM_COMP = '000000'
AND coc.SUB_ITEM = '000'
AND coc.GRUPO_ITEM = '5156H'
AND coc.ALTERNATIVA_ITEM = 4
AND coc.SEQUENCIA = 90
--  AND coc.ITEM_ITEM = e.ITEM_ITEM
GROUP BY
coc.ITEM_COMP
;

SELECT
LISTAGG(coc.ITEM_ITEM, ', ')
WITHIN GROUP (ORDER BY coc.ITEM_ITEM)
FROM BASI_040 coc -- combinação cor
WHERE 1=1
--  AND e.ITEM_COMP = '000000'
AND coc.SUB_ITEM = '000'
AND coc.GRUPO_ITEM = '5156H'
AND coc.ALTERNATIVA_ITEM = 4
AND coc.SEQUENCIA = 90
AND coc.ITEM_COMP = '0000BR'
;

SELECT
cp.*
FROM SUPR_050 cp
;

SELECT
o.*
FROM PCPC_020 o
WHERE o.ORDEM_PRODUCAO = 7748
;

SELECT
lote.*
FROM PCPC_040 lote
WHERE lote.ORDEM_PRODUCAO = 7748
AND lote.ORDEM_CONFECCAO = 3946
;

-- para descancelar OP - passo 1/2
UPDATE PCPC_020 o -- OP
SET
o.COD_CANCELAMENTO = 0
, o.SITUACAO = 4
WHERE o.ORDEM_PRODUCAO = 7748
;

-- para descancelar OP - passo 2/2
UPDATE PCPC_040 lote
SET
SITUACAO_ORDEM = 1
WHERE lote.ORDEM_PRODUCAO = 7748
--  AND lote.ORDEM_CONFECCAO = 3946
AND lote.SITUACAO_ORDEM <> 1
;


SELECT
r.*
, r.SEQ_OPERACAO SEQ
--, r.CODIGO_OPERACAO || ' - ' || o.NOME_OPERACAO OPERACAO
, r.CODIGO_OPERACAO OPERACAO
--, r.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO ESTAGIO
, r.CODIGO_ESTAGIO ESTAGIO
, CASE WHEN r.IND_ESTAGIO_GARGALO = 1
THEN 'Gargalo'
ELSE ' '
END GARGALO
FROM MQOP_050 r -- roteiro
--JOIN MQOP_005 e -- estagio
--  ON e.CODIGO_ESTAGIO = r.CODIGO_ESTAGIO
--JOIN MQOP_040 o -- operacao
--  ON o.CODIGO_OPERACAO = r.CODIGO_OPERACAO
WHERE r.NIVEL_ESTRUTURA = 1
AND r.GRUPO_ESTRUTURA = 'C0692'
AND r.NUMERO_ALTERNATI = 5
AND r.NUMERO_ROTEIRO = 5
ORDER BY
r.SEQ_OPERACAO
;


SELECT DISTINCT
ia.ALTERNATIVA_ITEM ALTERNATIVA
, ia.SUB_ITEM TAM
, ia.ITEM_ITEM COR
, COALESCE( al.DESCRICAO, '' ) DESCR
, COALESCE(
( SELECT
LISTAGG(COALESCE(ec.GRUPO_COMP, ''), ', ')
WITHIN GROUP (ORDER BY ec.ALTERNATIVA_ITEM) REF
FROM BASI_050 ec
WHERE ec.NIVEL_ITEM = ia.NIVEL_ITEM
AND ec.GRUPO_ITEM = ia.GRUPO_ITEM
AND ec.ALTERNATIVA_ITEM = ia.ALTERNATIVA_ITEM
AND ec.SUB_ITEM = ia.SUB_ITEM
AND ec.ITEM_ITEM = ia.ITEM_ITEM
AND ec.NIVEL_COMP = 1
), ' ') REF
FROM BASI_050 ia -- insumos de alternativa
LEFT JOIN BASI_070 al -- cadastro de altern. de estrutura e de roteiro
ON al.ROTEIRO = 0 -- seleciona cadastro de alternativas de estrutura
AND al.ALTERNATIVA = ia.ALTERNATIVA_ITEM
WHERE ia.NIVEL_ITEM = 1
AND ia.GRUPO_ITEM = 'R0417'
ORDER BY
ia.ALTERNATIVA_ITEM
;

SELECT DISTINCT
r.NUMERO_ALTERNATI
, r.NUMERO_ROTEIRO
, r.NUMERO_ALTERNATI || ' (' ||
COALESCE( al.DESCRICAO, COALESCE( alg.DESCRICAO, '' ) ) || ')' ALTERNATIVA
, r.NUMERO_ROTEIRO || ' (' ||
COALESCE( ro.DESCRICAO,
COALESCE( alg.DESCRICAO, '' ) ) || ')' ROTEIRO
, r.SUBGRU_ESTRUTURA TAM
, r.ITEM_ESTRUTURA COR
FROM MQOP_050 r
LEFT JOIN BASI_070 ro
ON ro.ALTERNATIVA = r.NUMERO_ALTERNATI
AND ro.ROTEIRO = r.NUMERO_ROTEIRO
AND ro.NIVEL = r.NIVEL_ESTRUTURA
AND ro.GRUPO = r.GRUPO_ESTRUTURA
AND ro.SUBGRUPO = r.SUBGRU_ESTRUTURA
AND ro.ITEM = r.ITEM_ESTRUTURA
LEFT JOIN BASI_070 al -- cadastro de altern. de estrutura e de roteiro - específico
ON al.ROTEIRO = 0 -- seleciona cadastro de alternativas de estrutura
AND al.ALTERNATIVA = r.NUMERO_ALTERNATI
AND al.GRUPO = r.GRUPO_ESTRUTURA -- seleciona nome esclusivo da referência
LEFT JOIN BASI_070 alg -- cadastro de altern. de estrutura e de roteiro - genérico
ON alg.ROTEIRO = 0 -- seleciona cadastro de alternativas de estrutura
AND alg.ALTERNATIVA = r.NUMERO_ALTERNATI
WHERE r.NIVEL_ESTRUTURA = 1
AND r.GRUPO_ESTRUTURA = 'C0692'
ORDER BY
r.NUMERO_ALTERNATI
, r.NUMERO_ROTEIRO
, r.SUBGRU_ESTRUTURA
, r.ITEM_ESTRUTURA
;

SELECT
ar.*
FROM BASI_070 ar -- alternativa / roteiro
WHERE 1=1
AND ar.ALTERNATIVA = 13
--  AND ar.GRUPO = 'R0417'
--  AND ar.DESCRICAO LIKE '%TESTA%'
;

SELECT
r.*
FROM MQOP_050 r
--WHERE r.GRUPO_ESTRUTURA = 'R0417'
WHERE r.GRUPO_ESTRUTURA = 'C0692'
;

SELECT
ia.GRUPO_COMP
, ia.*
FROM BASI_050 ia -- insumos de alternativa
;

SELECT DISTINCT
ia.ALTERNATIVA_ITEM ALTERNATIVA
, ia.SUB_ITEM TAM
, ia.ITEM_ITEM COR
, COALESCE( al.DESCRICAO, COALESCE( alg.DESCRICAO, '' ) ) DESCR
, al.ROTEIRO al_roteiro
, al.ALTERNATIVA al_ALTERNATIVA
, COALESCE(
( SELECT
LISTAGG(COALESCE(ec.GRUPO_COMP, ''), ', ')
WITHIN GROUP (ORDER BY ec.ALTERNATIVA_ITEM) REF
FROM BASI_050 ec
WHERE ec.NIVEL_ITEM = ia.NIVEL_ITEM
AND ec.GRUPO_ITEM = ia.GRUPO_ITEM
AND ec.ALTERNATIVA_ITEM = ia.ALTERNATIVA_ITEM
AND ec.SUB_ITEM = ia.SUB_ITEM
AND ec.ITEM_ITEM = ia.ITEM_ITEM
AND ec.NIVEL_COMP = 1
), ' ') REF
FROM BASI_050 ia -- insumos de alternativa
LEFT JOIN BASI_070 al -- cadastro de altern. de estrutura e de roteiro - específico
ON al.ROTEIRO = 0 -- seleciona cadastro de alternativas de estrutura
AND al.ALTERNATIVA = ia.ALTERNATIVA_ITEM
AND al.GRUPO = ia.GRUPO_ITEM -- seleciona nome esclusivo da referência
LEFT JOIN BASI_070 alg -- cadastro de altern. de estrutura e de roteiro - genérico
ON alg.ROTEIRO = 0 -- seleciona cadastro de alternativas de estrutura
AND alg.ALTERNATIVA = ia.ALTERNATIVA_ITEM
WHERE ia.NIVEL_ITEM = 1
AND ia.GRUPO_ITEM = 'R0417'
ORDER BY
ia.ALTERNATIVA_ITEM
;

SELECT
r.SEQ_OPERACAO SEQ
, r.CODIGO_OPERACAO || ' - ' || o.NOME_OPERACAO OPERACAO
, r.CODIGO_ESTAGIO || ' - ' || e.DESCRICAO ESTAGIO
, CASE WHEN r.IND_ESTAGIO_GARGALO = 1
THEN 'Gargalo'
ELSE ' '
END GARGALO
FROM MQOP_050 r -- roteiro
JOIN MQOP_005 e -- estagio
ON e.CODIGO_ESTAGIO = r.CODIGO_ESTAGIO
JOIN MQOP_040 o -- operacao
ON o.CODIGO_OPERACAO = r.CODIGO_OPERACAO
WHERE r.NIVEL_ESTRUTURA = 1
AND r.GRUPO_ESTRUTURA = 'C0692'
AND r.NUMERO_ALTERNATI = 5
AND r.NUMERO_ROTEIRO = 5
AND r.SUBGRU_ESTRUTURA = '000'
AND r.ITEM_ESTRUTURA = '0000PR'
ORDER BY
r.SEQ_OPERACAO
;


WITH op_os AS
( SELECT DISTINCT
l.ORDEM_PRODUCAO
, l.PROCONF_GRUPO
, l.PROCONF_SUBGRUPO
, l.PROCONF_ITEM
, l.NUMERO_ORDEM
FROM PCPC_040 l -- lote
)
SELECT
oo.ORDEM_PRODUCAO OP
, oo.PROCONF_GRUPO REF
, oo.PROCONF_ITEM COR
--, oo.PROCONF_SUBGRUPO TAM
, os.NUMERO_ORDEM OS
, SUM(osi.QTDE_ENVIADA) QTD
, nf.DATA_EMISSAO DT
, nf.NUM_NOTA_FISCAL NF
, cind.NOME_CLIENTE
|| ' (' || lpad(cind.CGC_9, 8, '0')
|| '/' || lpad(cind.CGC_4, 4, '0')
|| '-' || lpad(cind.CGC_2, 2, '0')
|| ')' FACCAO
, nfec.DATA_EMISSAO DT_RET
, nfec.DOCUMENTO NF_RET
, sum(nfei.QUANTIDADE) QTD_RET
, op.PEDIDO_VENDA PED
, ped.COD_PED_CLIENTE PED_CLI
, c.NOME_CLIENTE
|| ' (' || lpad(c.CGC_9, 8, '0')
|| '/' || lpad(c.CGC_4, 4, '0')
|| '-' || lpad(c.CGC_2, 2, '0')
|| ')' CLI
FROM OBRF_080 os -- OS - capa
JOIN op_os oo -- relação de OP com OS
ON oo.NUMERO_ORDEM = os.NUMERO_ORDEM
JOIN PCPC_020 op -- OP - capa
ON op.ordem_producao = oo.ORDEM_PRODUCAO
LEFT JOIN PEDI_100 ped -- pedido de venda
ON ped.PEDIDO_VENDA = op.PEDIDO_VENDA
LEFT JOIN PEDI_010 c -- cliente - do pedido de venda
ON c.CGC_9 = ped.CLI_PED_CGC_CLI9
AND c.CGC_4 = ped.CLI_PED_CGC_CLI4
JOIN OBRF_082 osi -- OS - item de nota
ON osi.NUMERO_ORDEM = os.NUMERO_ORDEM
AND osi.PRODSAI_GRUPO = oo.PROCONF_GRUPO
JOIN FATU_050 nf -- nota fiscal da Tussor - capa
ON nf.NUM_NOTA_FISCAL = osi.NUM_NF_SAI
LEFT JOIN PEDI_010 cind -- cliente - industrializador
ON cind.CGC_9 = nf.CGC_9
AND cind.CGC_4 = nf.CGC_4
LEFT JOIN OBRF_015 nfei -- nota fiscal de entrada - item
ON osi.NUM_NF_SAI <> 0
AND nfei.NUM_NOTA_ORIG = osi.NUM_NF_SAI
AND nfei.CODITEM_NIVEL99 = osi.PRODSAI_NIVEL99
AND nfei.CODITEM_GRUPO = osi.PRODSAI_GRUPO
AND nfei.CODITEM_SUBGRUPO = osi.PRODSAI_SUBGRUPO
AND nfei.CODITEM_ITEM = osi.PRODSAI_ITEM
LEFT JOIN OBRF_010 nfec -- nota fiscal de entrada - capa
ON nfec.DOCUMENTO = nfei.CAPA_ENT_NRDOC
AND nfec.CGC_CLI_FOR_9 = nfei.CAPA_ENT_FORCLI9
AND nfec.CGC_CLI_FOR_4 = nfei.CAPA_ENT_FORCLI4
LEFT JOIN BASI_220 t -- tamanhos
ON t.TAMANHO_REF = oo.PROCONF_SUBGRUPO
WHERE 1=1
--  AND op.ordem_producao = 3480 -- op
--{op_filter}
--  AND os.NUMERO_ORDEM = 2170 -- os
--{os_filter}
--  AND nf.DATA_EMISSAO = TO_DATE('19/03/2018','DD/MM/YYYY')
                                         -- dt_saida
--{dt_saida_filter}
--  AND nf.NUM_NOTA_FISCAL = 63422 -- nf_saida
--{nf_saida_filter}
--  AND nfec.DATA_EMISSAO = TO_DATE('26/03/2018','DD/MM/YYYY')
                                         -- dt_entrada
--{dt_entrada_filter}
--  AND nfec.DOCUMENTO = 54603 -- nf_entrada
--{nf_entrada_filter}
--  AND cind.NOME_CLIENTE
--      || ' (' || lpad(cind.CGC_9, 8, '0')
--      || '/' || lpad(cind.CGC_4, 4, '0')
--      || '-' || lpad(cind.CGC_2, 2, '0')
--      || ')' LIKE '%LAU%'  -- faccao
--{faccao_filter}
--  AND op.PEDIDO_VENDA = 3472 -- pedido
--{pedido_filter}
AND ped.COD_PED_CLIENTE like '2341494' -- pedido_cliente
--{pedido_cliente_filter}
--  AND c.NOME_CLIENTE
--      || ' (' || lpad(c.CGC_9, 8, '0')
--      || '/' || lpad(c.CGC_4, 4, '0')
--      || '-' || lpad(c.CGC_2, 2, '0')
--      || ')' LIKE '%RENN%'  -- cliente
--{cliente_filter}
--{retorno_filter} -- retorno_filter
GROUP BY
oo.ORDEM_PRODUCAO
, oo.PROCONF_GRUPO
, oo.PROCONF_ITEM
--, t.ORDEM_TAMANHO
--, oo.PROCONF_SUBGRUPO
, os.NUMERO_ORDEM
, nf.DATA_EMISSAO
, nf.NUM_NOTA_FISCAL
, cind.NOME_CLIENTE
, cind.CGC_9
, cind.CGC_4
, cind.CGC_2
, nfec.DATA_EMISSAO
, nfec.DOCUMENTO
, op.PEDIDO_VENDA
, ped.COD_PED_CLIENTE
, c.NOME_CLIENTE
, c.CGC_9
, c.CGC_4
, c.CGC_2
ORDER BY
oo.ORDEM_PRODUCAO -- op
, os.NUMERO_ORDEM -- os
, oo.PROCONF_GRUPO -- ref
, oo.PROCONF_ITEM -- cor
--, t.ORDEM_TAMANHO -- tam
, nf.DATA_EMISSAO -- data remessa
, nf.NUM_NOTA_FISCAL -- nf remessa
, nfec.DATA_EMISSAO -- data retorno
, nfec.DOCUMENTO -- nf retorno
;

SELECT DISTINCT
os.NUMERO_ORDEM OS
, os.CODIGO_SERVICO || '-' || s.DESC_TERCEIRO SERV
, os.CGCTERC_FORNE9 CNPJ9
, os.CGCTERC_FORNE4 CNPJ4
, os.CGCTERC_FORNE2 CNPJ2
, f.NOME_FANTASIA NOME
, CASE os.SITUACAO_ORDEM
WHEN 1 THEN '1-Aberta'
WHEN 2 THEN '2-Em Processo'
WHEN 3 THEN '3-Baixa Parcial'
WHEN 4 THEN '4-Baixa Total'
ELSE '-'
END SITUACAO
, os.COD_CANC_ORDEM || '-' || c.DESCR_CANC_ORDEM CANC
, count(l.ORDEM_CONFECCAO) LOTES
, sum(
CASE WHEN l.QTDE_A_PRODUZIR_PACOTE <> 0
THEN l.QTDE_A_PRODUZIR_PACOTE
ELSE --l.QTDE_PECAS_PROG
QTDE_PECAS_PROD
+ QTDE_CONSERTO
+ QTDE_PECAS_2A
+ QTDE_PERDAS
END
) QTD
, os.DATA_EMISSAO
, os.DATA_ENTREGA
, os.OBSERVACAO
FROM OBRF_080 os
JOIN OBRF_070 s
ON s.CODIGO_TERCEIRO = os.CODIGO_SERVICO
JOIN SUPR_010 f
ON f.FORNECEDOR9 = os.CGCTERC_FORNE9
AND f.FORNECEDOR4 = os.CGCTERC_FORNE4
JOIN OBRF_087 c
ON c.COD_CANC_ORDEM = os.COD_CANC_ORDEM
LEFT JOIN pcpc_040 l
ON l.NUMERO_ORDEM = os.NUMERO_ORDEM
WHERE 1=1
AND os.NUMERO_ORDEM = 3604
--  AND (os.NUMERO_ORDEM = %s or %s IS NULL)
--  AND (l.ORDEM_PRODUCAO = %s or %s IS NULL)
--  AND (l.PERIODO_PRODUCAO = %s or %s IS NULL)
--  AND (l.ORDEM_CONFECCAO = %s or %s IS NULL)
--  AND l.NUMERO_ORDEM <> 0
GROUP BY
os.NUMERO_ORDEM
, os.CODIGO_SERVICO
, s.DESC_TERCEIRO
, os.CGCTERC_FORNE9
, os.CGCTERC_FORNE4
, os.CGCTERC_FORNE2
, f.NOME_FANTASIA
, os.SITUACAO_ORDEM
, os.COD_CANC_ORDEM
, c.DESCR_CANC_ORDEM
, os.DATA_EMISSAO
, os.DATA_ENTREGA
, os.OBSERVACAO
ORDER BY
os.NUMERO_ORDEM
;

WITH op_os AS
( SELECT DISTINCT
l.ORDEM_PRODUCAO
, l.PROCONF_GRUPO
, l.PROCONF_SUBGRUPO
, l.PROCONF_ITEM
, l.NUMERO_ORDEM
FROM PCPC_040 l -- lote
)
SELECT
oo.ORDEM_PRODUCAO OP
, oo.PROCONF_GRUPO REF
, oo.PROCONF_ITEM COR
, NULL TAM -- , oo.PROCONF_SUBGRUPO TAM
, os.NUMERO_ORDEM OS
, SUM(osi.QTDE_ENVIADA) QTD
, nf.DATA_EMISSAO DT
, nf.NUM_NOTA_FISCAL NF
, cind.NOME_CLIENTE
|| ' (' || lpad(cind.CGC_9, 8, '0')
|| '/' || lpad(cind.CGC_4, 4, '0')
|| '-' || lpad(cind.CGC_2, 2, '0')
|| ')' FACCAO
, nfec.DATA_EMISSAO DT_RET
, nfec.DOCUMENTO NF_RET
, sum(nfei.QUANTIDADE) QTD_RET
, op.PEDIDO_VENDA PED
, ped.COD_PED_CLIENTE PED_CLI
, c.NOME_CLIENTE
|| ' (' || lpad(c.CGC_9, 8, '0')
|| '/' || lpad(c.CGC_4, 4, '0')
|| '-' || lpad(c.CGC_2, 2, '0')
|| ')' CLI
FROM OBRF_080 os -- OS - capa
JOIN op_os oo -- relação de OP com OS
ON oo.NUMERO_ORDEM = os.NUMERO_ORDEM
JOIN PCPC_020 op -- OP - capa
ON op.ordem_producao = oo.ORDEM_PRODUCAO
LEFT JOIN PEDI_100 ped -- pedido de venda
ON ped.PEDIDO_VENDA = op.PEDIDO_VENDA
LEFT JOIN PEDI_010 c -- cliente - do pedido de venda
ON c.CGC_9 = ped.CLI_PED_CGC_CLI9
AND c.CGC_4 = ped.CLI_PED_CGC_CLI4
JOIN OBRF_082 osi -- OS - item de nota
ON osi.NUMERO_ORDEM = os.NUMERO_ORDEM
AND osi.PRODSAI_GRUPO = oo.PROCONF_GRUPO
AND osi.PRODSAI_SUBGRUPO = oo.PROCONF_SUBGRUPO
AND osi.PRODSAI_ITEM = oo.PROCONF_ITEM
JOIN FATU_050 nf -- nota fiscal da Tussor - capa
ON nf.NUM_NOTA_FISCAL = osi.NUM_NF_SAI
LEFT JOIN PEDI_010 cind -- cliente - industrializador
ON cind.CGC_9 = nf.CGC_9
AND cind.CGC_4 = nf.CGC_4
LEFT JOIN OBRF_015 nfei -- nota fiscal de entrada - item
ON osi.NUM_NF_SAI <> 0
AND nfei.NUM_NOTA_ORIG = osi.NUM_NF_SAI
AND nfei.CODITEM_NIVEL99 = osi.PRODSAI_NIVEL99
AND nfei.CODITEM_GRUPO = osi.PRODSAI_GRUPO
AND nfei.CODITEM_SUBGRUPO = osi.PRODSAI_SUBGRUPO
AND nfei.CODITEM_ITEM = osi.PRODSAI_ITEM
LEFT JOIN OBRF_010 nfec -- nota fiscal de entrada - capa
ON nfec.DOCUMENTO = nfei.CAPA_ENT_NRDOC
AND nfec.CGC_CLI_FOR_9 = nfei.CAPA_ENT_FORCLI9
AND nfec.CGC_CLI_FOR_4 = nfei.CAPA_ENT_FORCLI4
--LEFT JOIN BASI_220 t -- tamanhos
--  ON t.TAMANHO_REF = oo.PROCONF_SUBGRUPO
-- detalhe_join
WHERE 1=1
AND op.ordem_producao = 8280 -- op
-- op_filter
--  AND os.NUMERO_ORDEM = 2170 -- os
-- os_filter
--  AND nf.DATA_EMISSAO = TO_DATE('19/03/2018','DD/MM/YYYY')
                                         -- dt_saida
--
AND nf.DATA_EMISSAO >= TO_DATE('2018-08-23', 'YYYY-MM-DD')
--
AND nf.DATA_EMISSAO <= TO_DATE('2018-08-23', 'YYYY-MM-DD')
-- dt_saida_filter
--  AND nf.NUM_NOTA_FISCAL = 63422 -- nf_saida
-- nf_saida_filter
--  AND nfec.DATA_EMISSAO = TO_DATE('26/03/2018','DD/MM/YYYY')
                                         -- dt_entrada
-- dt_entrada_filter
--  AND nfec.DOCUMENTO = 54603 -- nf_entrada
-- nf_entrada_filter
--  AND cind.NOME_CLIENTE
--      || ' (' || lpad(cind.CGC_9, 8, '0')
--      || '/' || lpad(cind.CGC_4, 4, '0')
--      || '-' || lpad(cind.CGC_2, 2, '0')
--      || ')' LIKE '%LAU%'  -- faccao
--
AND cind.NOME_CLIENTE
|| ' (' || lpad(cind.CGC_9, 8, '0')
|| '/' || lpad(cind.CGC_4, 4, '0')
|| '-' || lpad(cind.CGC_2, 2, '0')
|| ')' LIKE '%TIMAVO%'
-- faccao_filter
--  AND op.PEDIDO_VENDA = 3472 -- pedido
-- pedido_filter
--  AND ped.COD_PED_CLIENTE like '2341494' -- pedido_cliente
-- pedido_cliente_filter
--  AND c.NOME_CLIENTE
--      || ' (' || lpad(c.CGC_9, 8, '0')
--      || '/' || lpad(c.CGC_4, 4, '0')
--      || '-' || lpad(c.CGC_2, 2, '0')
--      || ')' LIKE '%RENN%'  -- cliente
-- cliente_filter
AND nfec.DOCUMENTO is NULL -- retorno_filter
GROUP BY
oo.ORDEM_PRODUCAO
, oo.PROCONF_GRUPO
, oo.PROCONF_ITEM
-- , t.ORDEM_TAMANHO
-- , oo.PROCONF_SUBGRUPO
-- detalhe_group
, os.NUMERO_ORDEM
, nf.DATA_EMISSAO
, nf.NUM_NOTA_FISCAL
, cind.NOME_CLIENTE
, cind.CGC_9
, cind.CGC_4
, cind.CGC_2
, nfec.DATA_EMISSAO
, nfec.DOCUMENTO
, op.PEDIDO_VENDA
, ped.COD_PED_CLIENTE
, c.NOME_CLIENTE
, c.CGC_9
, c.CGC_4
, c.CGC_2
ORDER BY
oo.ORDEM_PRODUCAO -- op
, os.NUMERO_ORDEM -- os
, oo.PROCONF_GRUPO -- ref
, oo.PROCONF_ITEM -- cor
-- , t.ORDEM_TAMANHO -- tam
, nf.DATA_EMISSAO -- data remessa
, nf.NUM_NOTA_FISCAL -- nf remessa
, nfec.DATA_EMISSAO -- data retorno
, nfec.DOCUMENTO -- nf retorno
;


WITH op_os AS
( SELECT DISTINCT
l.ORDEM_PRODUCAO
, l.PROCONF_GRUPO
, l.PROCONF_SUBGRUPO
, l.PROCONF_ITEM
, l.NUMERO_ORDEM
FROM PCPC_040 l -- lote
)
SELECT
oo.ORDEM_PRODUCAO OP
, oo.PROCONF_GRUPO REF
, oo.PROCONF_SUBGRUPO TAM
, oo.PROCONF_ITEM COR
, os.NUMERO_ORDEM OS
, SUM(osi.QTDE_ENVIADA) QTD
FROM OBRF_080 os -- OS - capa
JOIN op_os oo -- relação de OP com OS
ON oo.NUMERO_ORDEM = os.NUMERO_ORDEM
JOIN OBRF_082 osi -- OS - item de nota
ON osi.NUMERO_ORDEM = os.NUMERO_ORDEM
AND osi.PRODSAI_GRUPO = oo.PROCONF_GRUPO
AND osi.PRODSAI_SUBGRUPO = oo.PROCONF_ITEM
AND osi.PRODSAI_ITEM = oo.PROCONF_ITEM
WHERE 1=1
AND oo.ORDEM_PRODUCAO = 8280 -- op
GROUP BY
oo.ORDEM_PRODUCAO
, oo.PROCONF_GRUPO
, oo.PROCONF_ITEM
, oo.PROCONF_SUBGRUPO
, os.NUMERO_ORDEM
;

SELECT
osi.QTDE_ENVIADA
, osi.*
FROM OBRF_082 osi -- OS - item de nota
WHERE osi.NUMERO_ORDEM = 3616
;

SELECT DISTINCT
l.ORDEM_PRODUCAO
, l.PROCONF_GRUPO
, l.PROCONF_SUBGRUPO
, l.PROCONF_ITEM
, l.NUMERO_ORDEM
FROM PCPC_040 l -- lote
WHERE l.ORDEM_PRODUCAO = 8280
AND l.NUMERO_ORDEM = 3616
;
