csv:

  fields:

    - CONTA_ESTOQUE:
        type: integer

  keys:
    - NIVEL_ESTRUTURA
    - REFERENCIA

sql:

  db: systextil

  key_count: |
    SELECT
      count(REFERENCIA)
    FROM BASI_030
    WHERE NIVEL_ESTRUTURA=:NIVEL_ESTRUTURA
      AND REFERENCIA=:REFERENCIA

  update: |
    UPDATE BASI_030 SET
      DESCR_REFERENCIA=:DESCRITEMDEPRODUCAO
    , UNIDADE_MEDIDA=:UNIDMEDIDA
    , CONTA_ESTOQUE=:CONTA_ESTOQUE
    , CODIGO_CONTABIL=:CODIGO_CONTABIL
    , COMPRADO_FABRIC=1
    , CLASSIFIC_FISCAL='0'
    , LINHA_PRODUTO=:LINHA_PRODUTO
    , ARTIGO =
      ( SELECT
          min(art.ARTIGO)
        FROM SYSTEXTIL.BASI_290 art
        where art.NIVEL_ESTRUTURA='2'
          AND art.ARTIGO >= 2000
          AND INSTR( :DESCRITEMDEPRODUCAO, SUBSTR( art.DESCR_ARTIGO, 1, LENGTH(art.DESCR_ARTIGO)-1) ) <> 0
      )
    , TIPO_PRODUTO = case when INSTR( :DESCRITEMDEPRODUCAO, 'LISTRA' ) <> 0 then 2 else 1 end
    WHERE NIVEL_ESTRUTURA=:NIVEL_ESTRUTURA
      AND REFERENCIA=:REFERENCIA

  insert: |
    INSERT INTO BASI_030
    ( NIVEL_ESTRUTURA
    , REFERENCIA
    , DESCR_REFERENCIA
    , UNIDADE_MEDIDA
    , CONTA_ESTOQUE
    , CODIGO_CONTABIL
    , COMPRADO_FABRIC
    , CLASSIFIC_FISCAL
    , LINHA_PRODUTO
    , ARTIGO
    , TIPO_PRODUTO
    ) VALUES (
      :NIVEL_ESTRUTURA
    , :REFERENCIA
    , :DESCRITEMDEPRODUCAO
    , :UNIDMEDIDA
    , :CONTA_ESTOQUE
    , :CODIGO_CONTABIL -- identificador de carga = 99
    , 1
    , '0'
    , :LINHA_PRODUTO
    , ( SELECT
          min(art.ARTIGO)
        FROM SYSTEXTIL.BASI_290 art
        where art.NIVEL_ESTRUTURA='2'
          AND art.ARTIGO >= 2000
          AND INSTR( :DESCRITEMDEPRODUCAO, SUBSTR( art.DESCR_ARTIGO, 1, LENGTH(art.DESCR_ARTIGO)-1) ) <> 0
      )
    , case when INSTR( :DESCRITEMDEPRODUCAO, 'LISTRA' ) <> 0 then 2 else 1 end
    )

  key_list: |
    SELECT
      NIVEL_ESTRUTURA
    , REFERENCIA
    FROM BASI_030
    WHERE NIVEL_ESTRUTURA = '2'

  delete: |
    DELETE FROM BASI_030
    WHERE NIVEL_ESTRUTURA=:NIVEL_ESTRUTURA
      AND REFERENCIA=:REFERENCIA
